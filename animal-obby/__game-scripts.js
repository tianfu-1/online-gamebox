var TouchJoystick=pc.createScript("touchJoystick");TouchJoystick.attributes.add("identifier",{type:"string",default:"joystick0",title:"Identifier",description:"A unique name for the joystick to refer to it by in the API. Joysticks are also buttons so this will also be the name of button in the API. It will give a warning in browser tools if the name is not unique."}),TouchJoystick.attributes.add("type",{type:"string",default:"fixed",enum:[{"Fixed in place":"fixed"},{"Move to first touch and fixed":"relative"},{"Move to first touch and drags":"drag"}],title:"Type",description:"Set type of behavior for the joystick."}),TouchJoystick.attributes.add("baseEntity",{type:"entity",title:"Base Entity",description:"Image Element Entity that shows the base of the joystick."}),TouchJoystick.attributes.add("nubEntity",{type:"entity",title:"Nub Entity",description:"Image Element Entity that shows the nub (top) of the joystick."}),TouchJoystick.attributes.add("axisDeadZone",{type:"number",default:10,title:"Axis Dead Zone",description:"The number of UI units from the position of the Base Entity where input is not registered."}),TouchJoystick.attributes.add("axisRange",{type:"number",default:50,title:"Axis Range",description:"The number of UI units from the position of the Base Entity that the Nub Entity can move to and is the maximum range"}),TouchJoystick.attributes.add("hideOnRelease",{type:"boolean",default:!1,title:"Hide on Release",description:"Will only show the joystick when the user is using it and will hide it on touch end. This is commonly used if you don't want the joystick to block what's being shown on screen."}),TouchJoystick.attributes.add("positionOnRelease",{type:"string",default:"stay",enum:[{Stay:"stay"},{Original:"original"},{"Last start":"lastStart"}],title:"Position on Release",description:"Where to move the joystick on release and can help keep the screen tidy so that there are clear areas to show the game and arrange controls."}),TouchJoystick.attributes.add("vibrationPress",{type:"number",default:0,title:"Vibration duration (ms)",description:"If the device supports vibration with 'Navigator.vibrate', it will vibrate for the duration set here on touch down.Set to 0 to disable."}),TouchJoystick.attributes.add("sensitivity",{type:"number",default:1,title:"Sensitivity",description:"Adjusts the sensitivity of the joystick. Higher values make the joystick more responsive."}),TouchJoystick.attributes.add("controlMode",{type:"string",default:"gradual",enum:[{Gradual:"gradual"},{Constant:"constant"}],title:"Control Mode",description:"Toggle between gradual axis values based on distance from center and a constant power value."}),TouchJoystick.attributes.add("constantPower",{type:"number",default:.5,title:"Constant Power",description:"The constant power value to use when control mode is set to constant."}),TouchJoystick.prototype.initialize=function(){window.touchJoypad&&void 0!==window.touchJoypad.sticks[this.identifier]?console.warn("Touch joystick identifier already used, please use another for Entity: "+this.entity.name):(this._originalLocalPosition=this.baseEntity.getLocalPosition().clone(),this._lastPointerDownPosition=new pc.Vec3,this._setAxisValues(0,0),this._inputDown=!1,this._pointerId=-1,this._canVibrate=!!navigator.vibrate,this._setButtonState(!1),this.on("state",(t=>{this._setEvents(t?"on":"off")})),this.on("destroy",(()=>{window.touchJoypad&&(window.touchJoypad.sticks[this.identifier]=void 0)})),this._setEvents("on"),this.app.on("optimizeSettings:joyStickHideOnRelease",(t=>{this.hideOnRelease=t,this.baseEntity&&(this.baseEntity.enabled=!this.hideOnRelease)}),this),this.app.on("perDeviceUIScaling:joystickBaseShifted",(t=>{t===this.baseEntity.tags.list()[0]&&(this._originalLocalPosition=this.baseEntity.getLocalPosition().clone())}),this),this.app.fire("touchJoystick:initialized"))},TouchJoystick.prototype._setEvents=function(t){this._setAxisValues(0,0),this._pointerDown=!1,this._pointerId=-1,this.baseEntity.enabled=!this.hideOnRelease,this.app.touch&&(this.entity.element[t]("touchstart",this._onTouchDown,this),this.entity.element[t]("touchmove",this._onTouchMove,this),this.entity.element[t]("touchend",this._onTouchUp,this),this.entity.element[t]("touchcancel",this._onTouchUp,this))},TouchJoystick.__uiPos=new pc.Vec2,TouchJoystick.prototype.screenToUi=function(t){const i=TouchJoystick.__uiPos,e=this.app.graphicsDevice.canvas.clientWidth,o=this.app.graphicsDevice.canvas.clientHeight;return i.x=t.x/e,i.y=t.y/o,i.mulScalar(2).subScalar(1),i.y*=-1,i},TouchJoystick.prototype._onTouchDown=function(t){if(this._pointerDown)return;const i=this._pointerDown;t.id=t.touch.identifier,this._onPointerDown(t),!i&&this._pointerDown&&t.stopPropagation()},TouchJoystick.prototype._onTouchMove=function(t){t.id=t.touch.identifier,this._onPointerMove(t),this._pointerDown&&t.stopPropagation(),t.event.preventDefault()},TouchJoystick.prototype._onTouchUp=function(t){this._pointerDown&&(t.id=t.touch.identifier,this._onPointerUp(t),t.stopPropagation()),t.event.preventDefault()},TouchJoystick.prototype._onPointerDown=function(t){const i=this.screenToUi(t);switch(this.type){case"drag":case"relative":this.baseEntity.setPosition(i.x,i.y,0),this.nubEntity.setLocalPosition(0,0,0),this._pointerDown=!0;break;case"fixed":this.nubEntity.setPosition(i.x,i.y,0),this._updateAxisValuesFromNub(),this._pointerDown=!0}this._pointerDown&&(this._canVibrate&&0!==this.vibrationPress&&navigator.vibrate(this.vibrationPress),this._pointerId=t.id?t.id:0,this._setButtonState(!0),this._lastPointerDownPosition.copy(this.baseEntity.getLocalPosition()),this.baseEntity.enabled=!0,this._onPointerMove(t))},TouchJoystick.__tempNubPos=new pc.Vec3,TouchJoystick.__tempBasePos=new pc.Vec3,TouchJoystick.prototype._onPointerMove=function(t){if(this._pointerDown&&this._pointerId==t.id){const i=this.screenToUi(t),e=this.axisRange*this.axisRange;this.nubEntity.setPosition(i.x,i.y,0);const o=TouchJoystick.__tempNubPos;o.copy(this.nubEntity.getLocalPosition());if(o.lengthSq()>=e){if("drag"===this.type){const t=o.length()-this.axisRange,i=TouchJoystick.__tempBasePos;i.copy(o),i.normalize().mulScalar(t),i.add(this.baseEntity.getLocalPosition()),this.baseEntity.setLocalPosition(i)}o.normalize().mulScalar(this.axisRange),this.nubEntity.setLocalPosition(o)}this._updateAxisValuesFromNub()}},TouchJoystick.prototype._onPointerUp=function(t){if(this._pointerDown&&this._pointerId==t.id){switch(this.nubEntity.setLocalPosition(0,0,0),this.hideOnRelease&&(this.baseEntity.enabled=!1),this.positionOnRelease){case"original":this.baseEntity.setLocalPosition(this._originalLocalPosition);break;case"lastStart":this.baseEntity.setLocalPosition(this._lastPointerDownPosition)}this._pointerId=-1,this._updateAxisValuesFromNub(),this._setButtonState(!1),this._pointerDown=!1}},TouchJoystick.prototype._updateAxisValuesFromNub=function(){const t=this.axisRange-this.axisDeadZone,i=this.nubEntity.getLocalPosition(),e=Math.sign(i.x),o=Math.sign(i.y);if("constant"===this.controlMode){const t=this.constantPower*e*this.sensitivity,i=this.constantPower*o*this.sensitivity;this._setAxisValues(t,i)}else{const s=pc.math.clamp(Math.abs(i.x)-this.axisDeadZone,0,t)*e,n=pc.math.clamp(Math.abs(i.y)-this.axisDeadZone,0,t)*o;this._setAxisValues(s/t*this.sensitivity,n/t*this.sensitivity)}},TouchJoystick.prototype._setAxisValues=function(t,i){window.touchJoypad&&(window.touchJoypad.sticks[this.identifier]={x:t,y:i}),this.axisX=t,this.axisY=i},TouchJoystick.prototype._setButtonState=function(t){window.touchJoypad&&(window.touchJoypad.buttonStates[this.identifier]=t?Date.now():null),this._state=t};var SdkManager=pc.createScript("sdkManager");SdkManager.attributes.add("enableSdkInDevelopment",{type:"boolean",default:!1,title:"Enable SDK in Development"}),SdkManager.prototype.initialize=function(){this.app.isAdPlaying=!1,this.activeSdk=null,this.sdks={},this.registerSdk("Poki",PokiSdkPlugin),this.currentPlayState=!1},SdkManager.prototype.registerSdk=function(a,e){this.sdks[a]=e,this.activeSdk||(this.activeSdk=e)},SdkManager.prototype.initSdk=async function(){if(!(!window.location.href.includes("playcanvas.com")||this.enableSdkInDevelopment))return this.activeSdk=null,console.log("Skipping SDK initialization in PlayCanvas development environment."),void this.app.fire("gameAnalytics:disableEvents");if(this.activeSdk&&this.activeSdk.init)try{await this.activeSdk.init(),console.log(`${this.activeSdk.name} SDK initialized successfully.`),this.activeSdk.gameLoadingFinished&&this.activeSdk.gameLoadingFinished()}catch(a){console.error(`Failed to initialize ${this.activeSdk.name} SDK:`,a)}},SdkManager.prototype.showRewardedAd=function(a,e,i){if(!this.activeSdk||!this.activeSdk.rewardedBreak)return console.log("No active SDK or rewarded ad function available. Triggering success callback as fallback."),void(a&&a());this.app.isAdPlaying=!0,this.muteSound(),console.log("calling sdk with options:",i);(i?this.activeSdk.rewardedBreak(i):this.activeSdk.rewardedBreak()).then((i=>{this.restoreSound(),this.app.isAdPlaying=!1,i?a&&a():(console.log("Ad was skipped or failed to load."),e&&e())})).catch((a=>{console.error("Failed to load rewarded ad:",a),this.restoreSound(),this.app.isAdPlaying=!1,e&&e()}))},SdkManager.prototype.showCommercialBreak=function(a){if(!this.activeSdk||!this.activeSdk.commercialBreak)return console.warn("No active SDK or commercial break function available. Triggering success callback as fallback."),void(a&&a());this.app.isAdPlaying=!0,this.muteSound(),this.activeSdk.commercialBreak().then((()=>{this.restoreSound(),this.app.isAdPlaying=!1,a&&a()})).catch((a=>{console.error("Failed to load commercial break:",a),this.restoreSound(),this.app.isAdPlaying=!1}))},SdkManager.prototype.muteSound=function(){this.app.systems.sound.volume=0},SdkManager.prototype.restoreSound=function(){this.app.systems.sound.volume=1},SdkManager.prototype.updateGameplayStatus=function(a){this.activeSdk&&(a&&this.activeSdk.gameplayStart&&!1===this.currentPlayState?(this.currentPlayState=!0,this.activeSdk.gameplayStart(),console.log("gameplay status updated",a)):!a&&this.activeSdk.gameplayStop&&!0===this.currentPlayState&&(this.currentPlayState=!1,this.activeSdk.gameplayStop(),console.log("gameplay status updated",a)))};const PokiSdkPlugin={name:"Poki",init:async function(){await PokiSDK.init()},gameLoadingFinished:function(){PokiSDK.gameLoadingFinished()},rewardedBreak:function(a){return PokiSDK.rewardedBreak(a)},commercialBreak:function(){return PokiSDK.commercialBreak()},gameplayStart:function(){PokiSDK.gameplayStart()},gameplayStop:function(){PokiSDK.gameplayStop()}};var InputTypeChecker=pc.createScript("inputTypeChecker");InputTypeChecker.prototype.initialize=function(){this.currentDeviceMode=this.getDeviceMode(),this.keyboardMovementPrompt=this.app.root.findByName("keyboardMovementPrompt"),this.mouseViewPrompt=this.app.root.findByName("mouseViewPrompt"),this.leftJoystick=this.app.root.findByName("Left Half Touch Joystick"),this.rightJoystick=this.app.root.findByName("Right Half Touch Joystick"),this.leftJoystickBase=this.leftJoystick?this.leftJoystick.findByName("joyStickBase"):null,this.rightJoystickBase=this.rightJoystick?this.rightJoystick.findByName("joyStickBase"):null,this.setPromptVisibility(this.currentDeviceMode),this.app.fire("inputTypeChecker:modeChange",this.currentDeviceMode)},InputTypeChecker.prototype.getDeviceMode=function(){return window.matchMedia("(pointer: fine)").matches?"computer":"mobile"},InputTypeChecker.prototype.update=function(){const e=this.getDeviceMode();e!==this.currentDeviceMode&&(this.currentDeviceMode=e,this.setPromptVisibility(this.currentDeviceMode),this.app.fire("inputTypeChecker:modeChange",this.currentDeviceMode))},InputTypeChecker.prototype.setPromptVisibility=function(e){console.log("Setting prompt visibility for mode:",e),"computer"===e?(this.keyboardMovementPrompt&&(this.keyboardMovementPrompt.enabled=!0),this.mouseViewPrompt&&(this.mouseViewPrompt.enabled=!0),this.leftJoystickBase&&(this.leftJoystickBase.enabled=!1),this.rightJoystickBase&&(this.rightJoystickBase.enabled=!1)):"mobile"===e&&(this.keyboardMovementPrompt&&(this.keyboardMovementPrompt.enabled=!1),this.mouseViewPrompt&&(this.mouseViewPrompt.enabled=!1),this.leftJoystickBase&&(this.leftJoystickBase.enabled=!0),this.rightJoystickBase&&(this.rightJoystickBase.enabled=!0))};var CreateHimat=pc.createScript("createHIMat");CreateHimat.attributes.add("materialName",{type:"string",default:"",title:"Material Name"}),CreateHimat.attributes.add("materialAssetId",{type:"number",default:0,title:"Material Asset ID"}),CreateHimat.prototype.initialize=function(){this.materialName?this.findMaterialByName(this.materialName):this.materialAssetId?this.findMaterialById(this.materialAssetId):console.error("No material name or asset ID specified.")},CreateHimat.prototype.findMaterialByName=function(e){var n=this.app.assets.find(e,"material");n?(n.ready(function(e){var n=e.resource;this.modifyMaterial(n)}.bind(this)),this.app.assets.load(n)):console.error("Material not found: "+e)},CreateHimat.prototype.findMaterialById=function(e){var n=this.app.assets.get(e);n?(n.ready(function(e){var n=e.resource;this.modifyMaterial(n)}.bind(this)),this.app.assets.load(n)):console.error("Material not found: "+e)},CreateHimat.prototype.modifyMaterial=function(e){e.onUpdateShader=function(e){return e.useInstancing=!0,e};e.chunks.emissivePS="\n\n#ifndef COLOR_DECLARED\nvarying vec4 color;\n#define COLOR_DECLARED\n#endif\n\n#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\nvoid getEmission() {\n    dEmission = vec3(1.0);\n       float alpha = 1.0; // Default alpha value\n\n    #ifdef MAPFLOAT\n    dEmission *= material_emissiveIntensity;\n    #endif\n\n    #ifdef MAPCOLOR\n    dEmission *= material_emissive;\n    #endif\n\n    #ifdef MAPTEXTURE\n    dEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n    dEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n\n    // Multiply the emissive result by the instance-specific color\n    dEmission *= color.rgb;\n    dEmission *= 0.25;\n\n    // Use the alpha component from the instance-specific color\n    alpha = color.a;\n\n    // Apply alpha to the output (if relevant to your use case)\n    dAlpha = alpha;\n}\n";e.chunks.diffusePS="\n#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\n#ifndef COLOR_DECLARED\nvarying vec4 color;\n#define COLOR_DECLARED\n#endif\n\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n       float alpha = 1.0; // Default alpha value\n#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n#endif\n#ifdef MAPTEXTURE\n\tvec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\tdAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n\ndAlbedo *= color.rgb;\n\n\n    // Use the alpha component from the instance-specific color\n    alpha = color.a;\n\n    // Apply alpha to the output (if relevant to your use case)\n    // Assuming you're using it for transparency control\n    dAlpha = alpha;\n}\n",e.blendType=pc.BLEND_NONE,e.opacity=1,e.update(),console.log("UPDATED MATERIAL",e)};var PlayerMovement=pc.createScript("playerMovement");PlayerMovement.attributes.add("speed",{type:"number",default:.09}),PlayerMovement.attributes.add("jumpForce",{type:"number",default:45}),PlayerMovement.attributes.add("maxAirJumps",{type:"number",default:1}),PlayerMovement.attributes.add("playerGravity",{type:"number",default:-10}),PlayerMovement.attributes.add("heavy",{type:"boolean",default:!1}),PlayerMovement.attributes.add("climb",{type:"boolean",default:!1}),PlayerMovement.attributes.add("safeFall",{type:"boolean",default:!1});const emoteCooldown=750,climbCounter=.4;PlayerMovement.prototype.initialize=function(){var t=this.app.root.findByName("Camera");this.camera=t,this.cameraScript=t.script.cameraMovement,console.log("TIME STEP",this.app.systems.rigidbody.fixedTimeStep),this.physicsTimestep=this.app.systems.rigidbody.fixedTimeStep,this.emoteCooldown=!1;var i=this.app.root.findScript("networkManager");this.networkManagerScript=i;var e=this.app.root.findScript("gameplay");this.gameplayScript=e,this.sdkManager=this.app.root.findScript("sdkManager"),this.app.on("checkPointManager:moveToCheckpoint",this.moveToCheckpoint,this),this.contactResults,this.entity.rigidbody.on("contact",(t=>{this.contactResults=t,this.contactResults.other&&this.contactResults.other.script&&this.contactResults.other.script.breakBlock&&this.heavy&&(this.entity.mainRef&&this.entity.mainRef.animRef?(console.log("[DEBUG] smash animation triggered"),this.entity.mainRef.animRef.setTrigger("playSmash",!0)):this.entity.anim.setTrigger("playSmash",!0))})),this.entity.rigidbody.on("collisionend",(t=>{this.contactResults=null})),this.jumping=!1,this.onGround=!0,this.groundCheck=null,this.airJump=this.maxAirJumps,this.currentRotation=0,this.normalJumpVector=new pc.Vec3(0,this.jumpForce,0),this.finalJumpVector=new pc.Vec3,this.currentPos=new pc.Vec3,this.newPos=new pc.Vec3,this.climbing=!1,this.climbingCounter=0,this.climbEntity=null,this.climbEntityNormal=new pc.Vec3,this.climbingQuat=new pc.Quat,this.climbingGravity=new pc.Vec3,this.climbingRotationMat=new pc.Mat4,this.reverseGravity=new pc.Vec3,this.rotationFrom=new pc.Quat,this.rotationTo=new pc.Quat,this.rotationFinal=new pc.Quat,this.correctionQuat=new pc.Quat,this.forwardCorrection=new pc.Vec3,this.rotationCorrectionMat=new pc.Mat4,this.movementKeyPressed=!1,this.app.on("animalChanger:playerMovementScriptAttrUpdate",this.updateAttribute,this),this.app.on("animalChanger:resetGravity",this.resetGravity,this),this.on("attr",this.onAttributeUpdate,this),this.isMoving=!1,this.app.on("gameplay:updatePlayerPosition",this.sendUpdate,this),this.app.on("breakblock:smashBlock",(()=>{this.entity.sound&&this.entity.sound.play("smash")}),this)},PlayerMovement.worldDirection=new pc.Vec3,PlayerMovement.tempDirection=new pc.Vec3,PlayerMovement.yAxis=new pc.Vec3(0,1,0),PlayerMovement.prototype.resetGravity=function(t){this.playerGravity=t},PlayerMovement.prototype.updateAttribute=function(t,i){switch(t){case"mass":this.entity&&this.entity.rigidbody&&(this.entity.rigidbody.mass=i);break;case"friction":this.entity&&this.entity.rigidbody&&(this.entity.rigidbody.friction=i);break;case"restitution":this.entity&&this.entity.rigidbody&&(this.entity.rigidbody.restitution=i);break;case"speed":this.speed=i;break;case"jumpForce":this.jumpForce=i;break;case"maxAirJumps":this.maxAirJumps=i;break;case"heavy":this.heavy=i;break;case"climb":this.climb=i;break;case"playerGravity":this.playerGravity=i;break;case"safeFall":console.log("[DEBUG] updating safeFall:",i),this.safeFall=i}},PlayerMovement.prototype.onAttributeUpdate=function(t,i,e){},PlayerMovement.prototype.update=function(t){if(!this.sdkManager||!this.sdkManager.isAdPlaying)if(!this.gameplayScript||this.gameplayScript.isCurrentPlayState("playing")){window.touchJoypad.buttons.wasPressed("emote")&&this.playEmote();var i=this.app,e=PlayerMovement.worldDirection;e.set(0,0,0);var s=PlayerMovement.tempDirection,n=this.camera.forward,o=this.camera.right,a=0,r=0;(i.keyboard.isPressed(pc.KEY_A)||i.keyboard.isPressed(pc.KEY_LEFT))&&(a-=1),(i.keyboard.isPressed(pc.KEY_D)||i.keyboard.isPressed(pc.KEY_RIGHT))&&(a+=1),(i.keyboard.isPressed(pc.KEY_W)||i.keyboard.isPressed(pc.KEY_UP))&&(r+=1),(i.keyboard.isPressed(pc.KEY_S)||i.keyboard.isPressed(pc.KEY_DOWN))&&(r-=1);var h=window.touchJoypad.sticks.joystick0;if(0===h.x&&0===h.y||(a=h.x,r=h.y),this.contactResults)if(this.contactResults.contacts.some((t=>Math.abs(t.normal.dot(PlayerMovement.yAxis))>.4))&&(this.groundCheck=this.contactResults.other),this.climb){this.entity.rigidbody?.linearVelocity.lengthSq()>9&&(this.entity.rigidbody.linearVelocity=this.entity.rigidbody.linearVelocity.normalize().scale(3)),this.climbEntity=this.contactResults.other,this.climbPoint=this.contactResults.contacts[0],this.climbEntityNormal.copy(this.contactResults.contacts[0].normal),this.climbEntityNormal.normalize();var y=this.contactResults.contacts[0].point,c=(new pc.Vec3).sub2(y,this.entity.collision.getShapePosition());(new pc.Vec3).copy(this.climbEntityNormal).dot(c.normalize())>0&&this.climbEntityNormal.mulScalar(-1),this.climbing=!0,this.climbCounter=0}else this.climbing&&(this.climbEntity=null,this.climbing=!1,this.climbCounter=0);else this.climbing&&(this.climbCounter+=t,this.climbCounter>.4&&(this.climbEntity&&(this.climbEntity=null),this.climbing=!1,this.climbCounter=0)),this.groundCheck=null;if(0!==this.playerGravity&&(this.climbing||this.entity.flight?(this.updateReverseGravityVector(),this.climbing&&!this.entity.flight&&(this.climbingGravity.copy(this.climbEntityNormal),this.climbingGravity.mulScalar(this.entity.rigidbody.mass),this.climbingGravity.mulScalar(this.app.systems.rigidbody.gravity.y),this.reverseGravity.add(this.climbingGravity)),this.entity.rigidbody.applyForce(this.reverseGravity)):this.entity.rigidbody.applyForce(0,this.playerGravity,0)),this.groundCheck?(this.onGround=!0,this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.getFloat("yDirection")>0&&this.entity.mainRef.animRef.setFloat("yDirection",0):this.entity.anim.getFloat("yDirection")>0&&this.entity.anim.setFloat("yDirection",0),this.airJump=this.maxAirJumps):(this.climbing&&(this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.getFloat("yDirection")>0&&this.entity.mainRef.animRef.setFloat("yDirection",0):this.entity.anim.getFloat("yDirection")>0&&this.entity.anim.setFloat("yDirection",0)),this.onGround=!1),this.rotationFrom.copy(this.entity.getRotation()),0!==a||0!==r)if(this.app.fire("gameplay:attemptFirstGameplayEvent"),this.app.firstMoveInSession||(this.app.firstMoveInSession=!0),this.app.mainPlayerObject&&this.app.mainPlayerObject.movementFrozen)this.app.mainPlayerObject.movementFrozenTicks-=1,0===this.app.mainPlayerObject.movementFrozenTicks&&(this.app.mainPlayerObject.movementFrozen=!1),this.movementKeyPressed=!1;else{this.movementKeyPressed=!0,e.add(s.copy(n).mulScalar(r)),e.add(s.copy(o).mulScalar(a)),e.normalize();var l=0;this.entity.flight&&(l=e.y),this.newPos.set(e.x*t,l*t,e.z*t),this.currentPos=this.entity.getPosition(),this.newPos.normalize();const i=t/this.physicsTimestep,h=30,y=Math.min(Math.max(1,i),h)*this.speed;this.newPos.scale(y),this.entity.speedMultiplier&&this.newPos.scale(this.entity.speedMultiplier),this.entity.flight||this.newPos.set(this.newPos.x,this.entity.rigidbody.linearVelocity.y*Math.min(t,this.physicsTimestep),this.newPos.z),!this.climbing||this.climbEntity&&"Step"===this.climbEntity.name||this.entity.flight?this.entity.flight||(this.currentRotation=Math.atan2(e.x,e.z)*(180/Math.PI)+180,this.rotationTo.setFromEulerAngles(0,this.currentRotation,0)):(this.climbingQuat.setFromDirections(PlayerMovement.yAxis,this.climbEntityNormal),this.newPos=this.climbingQuat.transformVector(this.newPos),setMat4Forward(this.climbingRotationMat,this.newPos,this.climbEntityNormal),this.rotationTo.setFromMat4(this.climbingRotationMat)),this.newPos.add(this.currentPos),this.entity.flight&&(this.entity.lookAt(this.newPos),this.rotationTo.copy(this.entity.getRotation())),this.rotationFinal.slerp(this.rotationFrom,this.rotationTo,.2),this.entity.rigidbody.teleport(this.newPos,this.rotationFinal),this.sendUpdate()}else this.entity.rigidbody&&this.entity.rigidbody.linearVelocity&&this.entity.rigidbody.linearVelocity.lengthSq()>.001?(this.correctRotation(t),this.sendUpdate(),this.movementKeyPressed=!1):(this.movementKeyPressed=!1,this.correctRotation(t),this.isMoving&&(this.networkManagerScript.updateMoveState(0),this.isMoving=!1));var m=window.touchJoypad.buttons;this.safeFall&&this.entity.rigidbody&&this.entity.rigidbody.linearVelocity&&this.entity.rigidbody.linearVelocity.y<-6&&(this.entity.rigidbody.linearVelocity=this.entity.rigidbody.linearVelocity.set(this.entity.rigidbody.linearVelocity.x,3,this.entity.rigidbody.linearVelocity.z)),this.entity.flight||this.entity.jetPackForce&&!(this.entity.jetPackForce<=0)||!this.app.keyboard.wasPressed(pc.KEY_SPACE)&&!m.wasPressed("jump")||this.playerJump(),this.entity.jetPackForce&&this.entity.jetPackForce>0&&(this.app.keyboard.isPressed(pc.KEY_SPACE)||m.isPressed("jump"))&&(this.useJetPack(),this.app.fire("playerMovement:updateFuelCounter",t)),this.entity.mainRef&&this.entity.mainRef.animRef?(this.entity.mainRef.animRef.setFloat("xDirection",a),this.entity.mainRef.animRef.setFloat("zDirection",r),(a||r)&&this.entity.mainRef.animRef.setBoolean("playEmote",!1)):(this.entity.anim.setFloat("xDirection",a),this.entity.anim.setFloat("zDirection",r)),m.wasPressed("restartLevel")&&this.app.fire("playerMovement:returnKeyPressed"),i.keyboard.wasPressed(pc.KEY_G)&&this.playEmote(),this.checkAndPlayMovementSound()}else this.entity.flight||this.entity.jetPackForce&&!(this.entity.jetPackForce<=0)||!this.app.keyboard.wasPressed(pc.KEY_SPACE)&&!window.touchJoypad.buttons.wasPressed("jump")||this.playerJump()},PlayerMovement.prototype.checkAndPlayMovementSound=function(){if(this.entity.sound&&this.movementKeyPressed&&!this.entity.flight&&(this.onGround||this.climbing)&&!this.jumping){if(this.entity.sound.isPlaying("walk"))return;this.entity.sound.play("walk")}},PlayerMovement.prototype.correctRotation=function(t){this.entity.flight||this.climbing||PlayerMovement.yAxis.dot(this.entity.up)<.99&&(this.correctionQuat.setFromDirections(this.entity.up,PlayerMovement.yAxis),this.forwardCorrection=this.correctionQuat.transformVector(this.entity.forward),setMat4Forward(this.rotationCorrectionMat,this.forwardCorrection,PlayerMovement.yAxis),this.rotationTo.setFromMat4(this.rotationCorrectionMat),this.rotationFinal.slerp(this.rotationFrom,this.rotationTo,.2),this.entity.rigidbody.teleport(this.entity.getPosition(),this.rotationFinal))},PlayerMovement.prototype.playEmote=function(){this.emoteCooldown||(this.app.fire("playerMovement:playEmote",this.entity),this.emoteCooldown=!0,setTimeout((()=>{this.emoteCooldown=!1}),750))},PlayerMovement.prototype.updateReverseGravityVector=function(){this.reverseGravity.copy(this.app.systems.rigidbody.gravity),this.reverseGravity.mulScalar(this.entity.rigidbody.mass),this.reverseGravity.mulScalar(-1),this.reverseGravity.x=0,this.reverseGravity.z=0},PlayerMovement.prototype.moveToCheckpoint=function(t,i){console.log("Moving to check point no:",t);var e=i.getPosition(),s=new pc.Vec3(e.x,e.y+.5,e.z);this.entity.rigidbody.linearVelocity=new pc.Vec3(0,0,0),this.entity.rigidbody.teleport(s);var n=this.cameraScript.eulers.x+180;this.sendUpdate(s,n)},PlayerMovement.prototype.sendUpdate=function(){if(this.entity){this.isMoving||this.jumping||!this.networkManagerScript||(this.networkManagerScript.updateMoveState(1),this.isMoving=!0);var t=this.entity.getPosition();if(this.networkManagerScript){const i=this.entity.getEulerAngles(),e={x:Math.floor(i.x),y:Math.floor(i.y),z:Math.floor(i.z)};this.networkManagerScript.updatePosition(t.x,t.y,t.z,e.x,e.y,e.z)}else{var i=this.app.root.findScript("networkManager");i&&(this.networkManagerScript=i)}}},PlayerMovement.prototype.useJetPack=function(){console.log("using jetpack"),this.entity.rigidbody.applyForce(new pc.Vec3(0,this.entity.jetPackForce*this.entity.rigidbody.mass,0))},PlayerMovement.prototype.playerJump=function(){(this.onGround||this.airJump&&this.airJump>0)&&!this.jumping&&(this.networkManagerScript&&this.networkManagerScript.updateMoveState(2),!1===this.onGround&&(this.airJump--,this.entity.rigidbody.linearVelocity=new pc.Vec3(this.entity.rigidbody.linearVelocity.x,0,this.entity.rigidbody.linearVelocity.z)),this.normalJumpVector.set(0,this.jumpForce,0),this.climbing?(this.finalJumpVector=this.climbingQuat.transformVector(this.normalJumpVector),this.entity.rigidbody.applyImpulse(this.finalJumpVector)):this.entity.rigidbody.applyImpulse(this.normalJumpVector),this.onGround=!1,this.jumping=!0,this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.setFloat("yDirection",1):this.entity.anim.setFloat("yDirection",1),this.entity.sound&&this.entity.sound.play("jump"),setTimeout(function(){this.jumping=!1}.bind(this),400))};var setMat4Forward=function(){var t,i,e;return t=new pc.Vec3,i=new pc.Vec3,e=new pc.Vec3,function(s,n,o){e.copy(n).scale(-1),i.copy(o).normalize(),t.cross(i,e).normalize(),i.cross(e,t);var a=s.data;return a[0]=t.x,a[1]=t.y,a[2]=t.z,a[3]=0,a[4]=i.x,a[5]=i.y,a[6]=i.z,a[7]=0,a[8]=e.x,a[9]=e.y,a[10]=e.z,a[11]=0,a[15]=1,s}}();var DeathScript=pc.createScript("deathScript");DeathScript.attributes.add("killOnTouch",{type:"boolean",default:!0,title:"Kill On Touch"}),DeathScript.prototype.initialize=function(){this.entity.collision.on("collisionstart",this.onCollisionStart,this)},DeathScript.prototype.onCollisionStart=function(t){var i=t.other;this.killOnTouch&&!i.invincibility&&"Player"===i.name&&this.app.fire("deathScript:killPlayer")};var RotationManager=pc.createScript("rotationManager");RotationManager.attributes.add("rotationThreshold",{type:"number",default:null,title:"Rotation Threshold",description:"Custom rotation threshold for this entity, in units. If null, the default threshold will be used."}),RotationManager.prototype.initialize=function(){this.globalClock=0,this.entities=[],this.powerups=[],this.generalTweens=[],this.player=this.app.root.findByName("Player"),this.player?(this.playerPos=new pc.Vec3,this.thresholdRotateSq=2500,this.thresholdCheckSq=1e4,this.on("register",this.registerEntity,this),this.on("registerPowerup",this.registerPowerup,this),this.on("registerGeneralTween",this.registerGeneralTween,this),this.on("deregister",this.deregisterEntity,this)):console.error("Player entity not found!")},RotationManager.prototype.registerEntity=function(t,e,i=0){this.registerItem(this.entities,{entity:t,script:e,rigidbody:t.rigidbody,worldPosition:t.getPosition().clone(),currentRotation:null,rotationQuat:new pc.Quat,nextCheckTime:0,rigidbodyWasDisabled:!1,rotationThresholdSq:i>0?i*i:null},t)},RotationManager.prototype.registerPowerup=function(t){this.registerItem(this.powerups,{type:"powerup",entity:t.entity,script:t.script,worldPosition:t.entity.getPosition(),powerUpSprite:t.powerUpSprite,particleSystem:t.particleSystem,rotationSpeed:t.rotationSpeed,cullingDistanceSq:t.cullingDistance*t.cullingDistance,parentPos:new pc.Vec3,nextCheckTime:0},t.entity)},RotationManager.prototype.registerGeneralTween=function(t){this.registerItem(this.generalTweens,{entity:t.entity,script:t.script,modelTween:t.modelTween,cullingDistanceSq:this.thresholdRotateSq,worldPosition:t.entity.getPosition(),nextCheckTime:0},t.entity)},RotationManager.prototype.registerItem=function(t,e,i){i.enabled?t.push(e):console.log("Entity not enabled:",i.name)},RotationManager.prototype.deregisterEntity=function(t){this.deregisterItem(this.entities,t),this.deregisterItem(this.powerups,t),this.deregisterItem(this.generalTweens,t)},RotationManager.prototype.deregisterItem=function(t,e){for(var i=0;i<t.length;i++)if(t[i].entity===e)return void t.splice(i,1)},RotationManager.prototype.update=function(t){if(this.globalClock+=t,this.player){this.playerPos.copy(this.player.getPosition());var e=Date.now()/1e3;this.updateEntities(this.entities,e,t,this.thresholdRotateSq,this.thresholdCheckSq,this.rotateEntity),this.updateEntities(this.powerups,e,t,null,null,this.updatePowerup),this.updateEntities(this.generalTweens,e,t,null,null,this.updateGeneralTween)}},RotationManager.prototype.updateEntities=function(t,e,i,o,n,r){for(var a=0;a<t.length;a++){var s=t[a],l=s.entity;if(!(e<s.nextCheckTime)){var p=s.worldPosition,h=this.playerPos.x-p.x,c=this.playerPos.y-p.y,u=this.playerPos.z-p.z,d=h*h+c*c+u*u;r.call(this,s,l,d,i,e,o,n)}}},RotationManager.prototype.rotateEntity=function(t,e,i,o,n,r,a){var s=t.script;s.ignoreDistance?this.applyRotation(t,e,s.rotationSpeed,o):i<(null!==t.rotationThresholdSq?t.rotationThresholdSq:this.thresholdRotateSq)?this.applyRotation(t,e,s.rotationSpeed,o):t.nextCheckTime=n+(i<a?.5:1)},RotationManager.prototype.updatePowerup=function(t,e,i,o,n){i<=t.cullingDistanceSq?(t.powerUpSprite.enabled||(t.powerUpSprite.enabled=!0),t.particleSystem.enabled||(t.particleSystem.enabled=!0),this.rotatePowerUpSprite(t.powerUpSprite,t.rotationSpeed,o)):(t.powerUpSprite.enabled&&(t.powerUpSprite.enabled=!1),t.particleSystem.enabled&&(t.particleSystem.enabled=!1),t.nextCheckTime=n+1)},RotationManager.prototype.updateGeneralTween=function(t,e,i,o,n){},RotationManager.prototype.applyRotation=function(t,e,i,o){var n=i*o,r=t.rotationQuat;if(r.setFromEulerAngles(0,n,0),t.rigidbody&&t.rigidbody.enabled){if(t.currentRotation||(t.currentRotation=e.getRotation().clone()),void 0!==t.lastRotationTime&&t.lastRotationTime<this.globalClock-o){var a=i*(this.globalClock-t.lastRotationTime)%360;(l=new pc.Quat).setFromEulerAngles(0,a,0),t.currentRotation.mul(l)}t.currentRotation.mul(r),t.rigidbody.teleport(t.worldPosition,t.currentRotation)}else{var s=e.getRotation();if(t.currentRotation=t.currentRotation||s.clone(),t.currentRotation.copy(s),void 0!==t.lastRotationTime&&t.lastRotationTime<this.globalClock-o){var l;a=i*(this.globalClock-t.lastRotationTime)%360;(l=new pc.Quat).setFromEulerAngles(0,a,0),t.currentRotation.mul(l)}t.currentRotation.mul(r),e.setRotation(t.currentRotation)}t.lastRotationTime=this.globalClock},RotationManager.prototype.rotatePowerUpSprite=function(t,e,i){t.rotate(e.x*i,e.y*i,e.z*i)};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);if(this._add.length){for(let t=0;t<this._add.length;t++)this._tweens.indexOf(this._add[t])>-1||this._tweens.push(this._add[t]);this._add.length=0}}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this},from:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,s;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,s))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,void 0!==this._properties.w?(this._fromQuat.copy(this.target),this._toQuat.set(i,e,s,this._properties.w)):(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),this._toQuat.setFromEulerAngles(i,e,s)))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},onUpdate:function(t){return this.on("update",t),this},onComplete:function(t){return this.on("complete",t),this},onLoop:function(t){return this.on("loop",t),this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,s,n=0===this.duration?1:this.time/this.duration,r=this.easing(n);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],s=this._ev[h],this.target[h]=e+(s-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,s=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=s*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*.5+1)}}}()),function(){pc.AppBase.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.AppBase.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.AppBase.getApplication();t&&t.addTweenManager()}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("colyseus.js",["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Colyseus={})}(this,(function(e){"use strict";function _mergeNamespaces(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer}),"undefined"==typeof globalThis&&"undefined"!=typeof window&&(window.globalThis=window);var extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},extendStatics(e,t)};function __extends(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function __(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}var t,__assign=function(){return __assign=Object.assign||function __assign(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)};function __awaiter(e,t,n,r){return new(n||(n=Promise))((function(i,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((r=r.apply(e,t||[])).next())}))}function __generator(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(a){return function(c){return function step(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function __classPrivateFieldGet(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function __classPrivateFieldSet(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}!function(e){e[e.CONSENTED=4e3]="CONSENTED",e[e.DEVMODE_RESTART=4010]="DEVMODE_RESTART"}(t||(t={}));var n=function(e){function ServerError(t,n){var r=e.call(this,n)||this;return r.name="ServerError",r.code=t,r}return __extends(ServerError,e),ServerError}(Error);function Decoder(e,t){if(this._offset=t,e instanceof ArrayBuffer)this._buffer=e,this._view=new DataView(this._buffer);else{if(!ArrayBuffer.isView(e))throw new Error("Invalid argument");this._buffer=e.buffer,this._view=new DataView(this._buffer,e.byteOffset,e.byteLength)}}Decoder.prototype._array=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=this._parse();return t},Decoder.prototype._map=function(e){for(var t={},n=0;n<e;n++)t[this._parse()]=this._parse();return t},Decoder.prototype._str=function(e){var t=function utf8Read$1(e,t,n){for(var r="",i=0,o=t,s=t+n;o<s;o++){var a=e.getUint8(o);if(0!=(128&a))if(192!=(224&a))if(224!=(240&a)){if(240!=(248&a))throw new Error("Invalid byte "+a.toString(16));(i=(7&a)<<18|(63&e.getUint8(++o))<<12|(63&e.getUint8(++o))<<6|(63&e.getUint8(++o))<<0)>=65536?(i-=65536,r+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):r+=String.fromCharCode(i)}else r+=String.fromCharCode((15&a)<<12|(63&e.getUint8(++o))<<6|(63&e.getUint8(++o))<<0);else r+=String.fromCharCode((31&a)<<6|63&e.getUint8(++o));else r+=String.fromCharCode(a)}return r}(this._view,this._offset,e);return this._offset+=e,t},Decoder.prototype._bin=function(e){var t=this._buffer.slice(this._offset,this._offset+e);return this._offset+=e,t},Decoder.prototype._parse=function(){var e,t=this._view.getUint8(this._offset++),n=0,r=0,i=0,o=0;if(t<192)return t<128?t:t<144?this._map(15&t):t<160?this._array(15&t):this._str(31&t);if(t>223)return-1*(255-t+1);switch(t){case 192:return null;case 194:return!1;case 195:return!0;case 196:return n=this._view.getUint8(this._offset),this._offset+=1,this._bin(n);case 197:return n=this._view.getUint16(this._offset),this._offset+=2,this._bin(n);case 198:return n=this._view.getUint32(this._offset),this._offset+=4,this._bin(n);case 199:if(n=this._view.getUint8(this._offset),r=this._view.getInt8(this._offset+1),this._offset+=2,-1===r){var s=this._view.getUint32(this._offset);return i=this._view.getInt32(this._offset+4),o=this._view.getUint32(this._offset+8),this._offset+=12,new Date(1e3*(4294967296*i+o)+s/1e6)}return[r,this._bin(n)];case 200:return n=this._view.getUint16(this._offset),r=this._view.getInt8(this._offset+2),this._offset+=3,[r,this._bin(n)];case 201:return n=this._view.getUint32(this._offset),r=this._view.getInt8(this._offset+4),this._offset+=5,[r,this._bin(n)];case 202:return e=this._view.getFloat32(this._offset),this._offset+=4,e;case 203:return e=this._view.getFloat64(this._offset),this._offset+=8,e;case 204:return e=this._view.getUint8(this._offset),this._offset+=1,e;case 205:return e=this._view.getUint16(this._offset),this._offset+=2,e;case 206:return e=this._view.getUint32(this._offset),this._offset+=4,e;case 207:return i=this._view.getUint32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,i+o;case 208:return e=this._view.getInt8(this._offset),this._offset+=1,e;case 209:return e=this._view.getInt16(this._offset),this._offset+=2,e;case 210:return e=this._view.getInt32(this._offset),this._offset+=4,e;case 211:return i=this._view.getInt32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,i+o;case 212:return r=this._view.getInt8(this._offset),this._offset+=1,0===r?void(this._offset+=1):[r,this._bin(1)];case 213:return r=this._view.getInt8(this._offset),this._offset+=1,[r,this._bin(2)];case 214:return r=this._view.getInt8(this._offset),this._offset+=1,-1===r?(e=this._view.getUint32(this._offset),this._offset+=4,new Date(1e3*e)):[r,this._bin(4)];case 215:return r=this._view.getInt8(this._offset),this._offset+=1,0===r?(i=this._view.getInt32(this._offset)*Math.pow(2,32),o=this._view.getUint32(this._offset+4),this._offset+=8,new Date(i+o)):-1===r?(i=this._view.getUint32(this._offset),o=this._view.getUint32(this._offset+4),this._offset+=8,new Date(1e3*(4294967296*(3&i)+o)+(i>>>2)/1e6)):[r,this._bin(8)];case 216:return r=this._view.getInt8(this._offset),this._offset+=1,[r,this._bin(16)];case 217:return n=this._view.getUint8(this._offset),this._offset+=1,this._str(n);case 218:return n=this._view.getUint16(this._offset),this._offset+=2,this._str(n);case 219:return n=this._view.getUint32(this._offset),this._offset+=4,this._str(n);case 220:return n=this._view.getUint16(this._offset),this._offset+=2,this._array(n);case 221:return n=this._view.getUint32(this._offset),this._offset+=4,this._array(n);case 222:return n=this._view.getUint16(this._offset),this._offset+=2,this._map(n);case 223:return n=this._view.getUint32(this._offset),this._offset+=4,this._map(n)}throw new Error("Could not parse")};function utf8Write(e,t,n){for(var r=0,i=0,o=n.length;i<o;i++)(r=n.charCodeAt(i))<128?e.setUint8(t++,r):r<2048?(e.setUint8(t++,192|r>>6),e.setUint8(t++,128|63&r)):r<55296||r>=57344?(e.setUint8(t++,224|r>>12),e.setUint8(t++,128|r>>6&63),e.setUint8(t++,128|63&r)):(i++,r=65536+((1023&r)<<10|1023&n.charCodeAt(i)),e.setUint8(t++,240|r>>18),e.setUint8(t++,128|r>>12&63),e.setUint8(t++,128|r>>6&63),e.setUint8(t++,128|63&r))}function _encode(e,t,n){var r=typeof n,i=0,o=0,s=0,a=0,c=0,h=0;if("string"===r){if(c=function utf8Length$1(e){for(var t=0,n=0,r=0,i=e.length;r<i;r++)(t=e.charCodeAt(r))<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}(n),c<32)e.push(160|c),h=1;else if(c<256)e.push(217,c),h=2;else if(c<65536)e.push(218,c>>8,c),h=3;else{if(!(c<4294967296))throw new Error("String too long");e.push(219,c>>24,c>>16,c>>8,c),h=5}return t.push({_str:n,_length:c,_offset:e.length}),h+c}if("number"===r)return Math.floor(n)===n&&isFinite(n)?n>=0?n<128?(e.push(n),1):n<256?(e.push(204,n),2):n<65536?(e.push(205,n>>8,n),3):n<4294967296?(e.push(206,n>>24,n>>16,n>>8,n),5):(s=n/Math.pow(2,32)>>0,a=n>>>0,e.push(207,s>>24,s>>16,s>>8,s,a>>24,a>>16,a>>8,a),9):n>=-32?(e.push(n),1):n>=-128?(e.push(208,n),2):n>=-32768?(e.push(209,n>>8,n),3):n>=-2147483648?(e.push(210,n>>24,n>>16,n>>8,n),5):(s=Math.floor(n/Math.pow(2,32)),a=n>>>0,e.push(211,s>>24,s>>16,s>>8,s,a>>24,a>>16,a>>8,a),9):(e.push(203),t.push({_float:n,_length:8,_offset:e.length}),9);if("object"===r){if(null===n)return e.push(192),1;if(Array.isArray(n)){if((c=n.length)<16)e.push(144|c),h=1;else if(c<65536)e.push(220,c>>8,c),h=3;else{if(!(c<4294967296))throw new Error("Array too large");e.push(221,c>>24,c>>16,c>>8,c),h=5}for(i=0;i<c;i++)h+=_encode(e,t,n[i]);return h}if(n instanceof Date){var f=n.getTime(),u=Math.floor(f/1e3),l=1e6*(f-1e3*u);return u>=0&&l>=0&&u<=17179869183?0===l&&u<=4294967295?(e.push(214,255,u>>24,u>>16,u>>8,u),6):(s=u/4294967296,a=4294967295&u,e.push(215,255,l>>22,l>>14,l>>6,s,a>>24,a>>16,a>>8,a),10):(s=Math.floor(u/4294967296),a=u>>>0,e.push(199,12,255,l>>24,l>>16,l>>8,l,s>>24,s>>16,s>>8,s,a>>24,a>>16,a>>8,a),15)}if(n instanceof ArrayBuffer){if((c=n.byteLength)<256)e.push(196,c),h=2;else if(c<65536)e.push(197,c>>8,c),h=3;else{if(!(c<4294967296))throw new Error("Buffer too large");e.push(198,c>>24,c>>16,c>>8,c),h=5}return t.push({_bin:n,_length:c,_offset:e.length}),h+c}if("function"==typeof n.toJSON)return _encode(e,t,n.toJSON());var d=[],p="",y=Object.keys(n);for(i=0,o=y.length;i<o;i++)void 0!==n[p=y[i]]&&"function"!=typeof n[p]&&d.push(p);if((c=d.length)<16)e.push(128|c),h=1;else if(c<65536)e.push(222,c>>8,c),h=3;else{if(!(c<4294967296))throw new Error("Object too large");e.push(223,c>>24,c>>16,c>>8,c),h=5}for(i=0;i<c;i++)h+=_encode(e,t,p=d[i]),h+=_encode(e,t,n[p]);return h}if("boolean"===r)return e.push(n?195:194),1;if("undefined"===r)return e.push(192),1;if("function"==typeof n.toJSON)return _encode(e,t,n.toJSON());throw new Error("Could not encode")}function encode(e){var t=[],n=[],r=_encode(t,n,e),i=new ArrayBuffer(r),o=new DataView(i),s=0,a=0,c=-1;n.length>0&&(c=n[0]._offset);for(var h,f=0,u=0,l=0,d=t.length;l<d;l++)if(o.setUint8(a+l,t[l]),l+1===c){if(f=(h=n[s])._length,u=a+c,h._bin)for(var p=new Uint8Array(h._bin),y=0;y<f;y++)o.setUint8(u+y,p[y]);else h._str?utf8Write(o,u,h._str):void 0!==h._float&&o.setFloat64(u,h._float);a+=f,n[++s]&&(c=n[s]._offset)}return i}var r,i,o=globalThis.WebSocket||function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")},s=function(){function WebSocketTransport(e){this.events=e}return WebSocketTransport.prototype.send=function(e){e instanceof ArrayBuffer?this.ws.send(e):Array.isArray(e)&&this.ws.send(new Uint8Array(e).buffer)},WebSocketTransport.prototype.connect=function(e){this.ws=new o(e,this.protocols),this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror},WebSocketTransport.prototype.close=function(e,t){this.ws.close(e,t)},Object.defineProperty(WebSocketTransport.prototype,"isOpen",{get:function(){return this.ws.readyState===o.OPEN},enumerable:!1,configurable:!0}),WebSocketTransport}(),a=function(){function Connection(){this.events={},this.transport=new s(this.events)}return Connection.prototype.send=function(e){this.transport.send(e)},Connection.prototype.connect=function(e){this.transport.connect(e)},Connection.prototype.close=function(e,t){this.transport.close(e,t)},Object.defineProperty(Connection.prototype,"isOpen",{get:function(){return this.transport.isOpen},enumerable:!1,configurable:!0}),Connection}();function utf8Read(e,t){for(var n=e[t++],r="",i=0,o=t,s=t+n;o<s;o++){var a=e[o];if(0!=(128&a))if(192!=(224&a))if(224!=(240&a)){if(240!=(248&a))throw new Error("Invalid byte "+a.toString(16));(i=(7&a)<<18|(63&e[++o])<<12|(63&e[++o])<<6|(63&e[++o])<<0)>=65536?(i-=65536,r+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):r+=String.fromCharCode(i)}else r+=String.fromCharCode((15&a)<<12|(63&e[++o])<<6|(63&e[++o])<<0);else r+=String.fromCharCode((31&a)<<6|63&e[++o]);else r+=String.fromCharCode(a)}return r}function utf8Length(e){void 0===e&&(e="");for(var t=0,n=0,r=0,i=e.length;r<i;r++)(t=e.charCodeAt(r))<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n+1}e.Protocol=void 0,(r=e.Protocol||(e.Protocol={}))[r.HANDSHAKE=9]="HANDSHAKE",r[r.JOIN_ROOM=10]="JOIN_ROOM",r[r.ERROR=11]="ERROR",r[r.LEAVE_ROOM=12]="LEAVE_ROOM",r[r.ROOM_DATA=13]="ROOM_DATA",r[r.ROOM_STATE=14]="ROOM_STATE",r[r.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",r[r.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",r[r.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES",e.ErrorCode=void 0,(i=e.ErrorCode||(e.ErrorCode={}))[i.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",i[i.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",i[i.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",i[i.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",i[i.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",i[i.AUTH_FAILED=4215]="AUTH_FAILED",i[i.APPLICATION_ERROR=4216]="APPLICATION_ERROR";var c={};function registerSerializer(e,t){c[e]=t}function getSerializer(e){var t=c[e];if(!t)throw new Error("missing serializer: "+e);return t}var h=function(){function EventEmitter(){this.handlers=[]}return EventEmitter.prototype.register=function(e,t){return this.handlers.push(e),this},EventEmitter.prototype.invoke=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.handlers.forEach((function(n){return n.apply(e,t)}))},EventEmitter.prototype.invokeAsync=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Promise.all(this.handlers.map((function(n){return n.apply(e,t)})))},EventEmitter.prototype.remove=function(e){var t=this.handlers.indexOf(e);this.handlers[t]=this.handlers[this.handlers.length-1],this.handlers.pop()},EventEmitter.prototype.clear=function(){this.handlers=[]},EventEmitter}();function createSignal(){var e=new h;function register(t){return e.register(t,null===this)}return register.once=function(t){var callback=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];t.apply(this,n),e.remove(callback)};e.register(callback)},register.remove=function(t){return e.remove(t)},register.invoke=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.invoke.apply(e,t)},register.invokeAsync=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.invokeAsync.apply(e,t)},register.clear=function(){return e.clear()},register}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var f=function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){!function(e){var extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},extendStatics(e,t)};function __extends(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function __(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}function __decorate(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}function __spreadArray(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}var t,n=255,r=213;e.OPERATION=void 0,(t=e.OPERATION||(e.OPERATION={}))[t.ADD=128]="ADD",t[t.REPLACE=0]="REPLACE",t[t.DELETE=64]="DELETE",t[t.DELETE_AND_ADD=192]="DELETE_AND_ADD",t[t.TOUCH=1]="TOUCH",t[t.CLEAR=10]="CLEAR";var i=function(){function ChangeTree(e,t,n){this.changed=!1,this.changes=new Map,this.allChanges=new Set,this.caches={},this.currentCustomOperation=0,this.ref=e,this.setParent(t,n)}return ChangeTree.prototype.setParent=function(e,t,n){var r=this;if(this.indexes||(this.indexes=this.ref instanceof b?this.ref._definition.indexes:{}),this.parent=e,this.parentIndex=n,t)if(this.root=t,this.ref instanceof b){var i=this.ref._definition;for(var o in i.schema){var s=this.ref[o];if(s&&s.$changes){var a=i.indexes[o];s.$changes.setParent(this.ref,t,a)}}}else"object"==typeof this.ref&&this.ref.forEach((function(e,t){if(e instanceof b){var n=e.$changes,i=r.ref.$changes.indexes[t];n.setParent(r.ref,r.root,i)}}))},ChangeTree.prototype.operation=function(e){this.changes.set(--this.currentCustomOperation,e)},ChangeTree.prototype.change=function(t,n){void 0===n&&(n=e.OPERATION.ADD);var r="number"==typeof t?t:this.indexes[t];this.assertValidIndex(r,t);var i=this.changes.get(r);i&&i.op!==e.OPERATION.DELETE&&i.op!==e.OPERATION.TOUCH||this.changes.set(r,{op:i&&i.op===e.OPERATION.DELETE?e.OPERATION.DELETE_AND_ADD:n,index:r}),this.allChanges.add(r),this.changed=!0,this.touchParents()},ChangeTree.prototype.touch=function(t){var n="number"==typeof t?t:this.indexes[t];this.assertValidIndex(n,t),this.changes.has(n)||this.changes.set(n,{op:e.OPERATION.TOUCH,index:n}),this.allChanges.add(n),this.touchParents()},ChangeTree.prototype.touchParents=function(){this.parent&&this.parent.$changes.touch(this.parentIndex)},ChangeTree.prototype.getType=function(e){if(this.ref._definition)return(t=this.ref._definition).schema[t.fieldsByIndex[e]];var t,n=(t=this.parent._definition).schema[t.fieldsByIndex[this.parentIndex]];return Object.values(n)[0]},ChangeTree.prototype.getChildrenFilter=function(){var e=this.parent._definition.childFilters;return e&&e[this.parentIndex]},ChangeTree.prototype.getValue=function(e){return this.ref.getByIndex(e)},ChangeTree.prototype.delete=function(t){var n="number"==typeof t?t:this.indexes[t];if(void 0!==n){var r=this.getValue(n);this.changes.set(n,{op:e.OPERATION.DELETE,index:n}),this.allChanges.delete(n),delete this.caches[n],r&&r.$changes&&(r.$changes.parent=void 0),this.changed=!0,this.touchParents()}else console.warn("@colyseus/schema ".concat(this.ref.constructor.name,": trying to delete non-existing index: ").concat(t," (").concat(n,")"))},ChangeTree.prototype.discard=function(t,n){var r=this;void 0===t&&(t=!1),void 0===n&&(n=!1),this.ref instanceof b||this.changes.forEach((function(t){if(t.op===e.OPERATION.DELETE){var n=r.ref.getIndex(t.index);delete r.indexes[n]}})),this.changes.clear(),this.changed=t,n&&this.allChanges.clear(),this.currentCustomOperation=0},ChangeTree.prototype.discardAll=function(){var e=this;this.changes.forEach((function(t){var n=e.getValue(t.index);n&&n.$changes&&n.$changes.discardAll()})),this.discard()},ChangeTree.prototype.cache=function(e,t){this.caches[e]=t},ChangeTree.prototype.clone=function(){return new ChangeTree(this.ref,this.parent,this.root)},ChangeTree.prototype.ensureRefId=function(){void 0===this.refId&&(this.refId=this.root.getNextUniqueId())},ChangeTree.prototype.assertValidIndex=function(e,t){if(void 0===e)throw new Error('ChangeTree: missing index for field "'.concat(t,'"'))},ChangeTree}();function addCallback(e,t,n,r){return e[t]||(e[t]=[]),e[t].push(n),null==r||r.forEach((function(e,t){return n(e,t)})),function(){return spliceOne(e[t],e[t].indexOf(n))}}function removeChildRefs(t){var n=this,r="string"!=typeof this.$changes.getType();this.$items.forEach((function(i,o){t.push({refId:n.$changes.refId,op:e.OPERATION.DELETE,field:o,value:void 0,previousValue:i}),r&&n.$changes.root.removeRef(i.$changes.refId)}))}function spliceOne(e,t){if(-1===t||t>=e.length)return!1;for(var n=e.length-1,r=t;r<n;r++)e[r]=e[r+1];return e.length=n,!0}var DEFAULT_SORT=function(e,t){var n=e.toString(),r=t.toString();return n<r?-1:n>r?1:0};function getArrayProxy(e){return e.$proxy=!0,e=new Proxy(e,{get:function(e,t){return"symbol"==typeof t||isNaN(t)?e[t]:e.at(t)},set:function(e,t,n){if("symbol"==typeof t||isNaN(t))e[t]=n;else{var r=Array.from(e.$items.keys()),i=parseInt(r[t]||t);null==n?e.deleteAt(i):e.setAt(i,n)}return!0},deleteProperty:function(e,t){return"number"==typeof t?e.deleteAt(t):delete e[t],!0}})}var o=function(){function ArraySchema(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.$changes=new i(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,this.push.apply(this,e)}return ArraySchema.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},ArraySchema.prototype.onRemove=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},ArraySchema.prototype.onChange=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},ArraySchema.is=function(e){return Array.isArray(e)||void 0!==e.array},Object.defineProperty(ArraySchema.prototype,"length",{get:function(){return this.$items.size},set:function(e){0===e?this.clear():this.splice(e,this.length-e)},enumerable:!1,configurable:!0}),ArraySchema.prototype.push=function(){for(var e,t=this,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return n.forEach((function(n){e=t.$refId++,t.setAt(e,n)})),e},ArraySchema.prototype.pop=function(){var e=Array.from(this.$indexes.values()).pop();if(void 0!==e){this.$changes.delete(e),this.$indexes.delete(e);var t=this.$items.get(e);return this.$items.delete(e),t}},ArraySchema.prototype.at=function(e){var t=Array.from(this.$items.keys())[e];return this.$items.get(t)},ArraySchema.prototype.setAt=function(t,n){var r,i;void 0!==n.$changes&&n.$changes.setParent(this,this.$changes.root,t);var o=null!==(i=null===(r=this.$changes.indexes[t])||void 0===r?void 0:r.op)&&void 0!==i?i:e.OPERATION.ADD;this.$changes.indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,n),this.$changes.change(t,o)},ArraySchema.prototype.deleteAt=function(e){var t=Array.from(this.$items.keys())[e];return void 0!==t&&this.$deleteAt(t)},ArraySchema.prototype.$deleteAt=function(e){return this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e)},ArraySchema.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&removeChildRefs.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},ArraySchema.prototype.concat=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new(ArraySchema.bind.apply(ArraySchema,__spreadArray([void 0],(e=Array.from(this.$items.values())).concat.apply(e,t),!1)))},ArraySchema.prototype.join=function(e){return Array.from(this.$items.values()).join(e)},ArraySchema.prototype.reverse=function(){var e=this,t=Array.from(this.$items.keys());return Array.from(this.$items.values()).reverse().forEach((function(n,r){e.setAt(t[r],n)})),this},ArraySchema.prototype.shift=function(){var e=Array.from(this.$items.keys()).shift();if(void 0!==e){var t=this.$items.get(e);return this.$deleteAt(e),t}},ArraySchema.prototype.slice=function(e,t){var n=new ArraySchema;return n.push.apply(n,Array.from(this.$items.values()).slice(e,t)),n},ArraySchema.prototype.sort=function(e){var t=this;void 0===e&&(e=DEFAULT_SORT);var n=Array.from(this.$items.keys());return Array.from(this.$items.values()).sort(e).forEach((function(e,r){t.setAt(n[r],e)})),this},ArraySchema.prototype.splice=function(e,t){void 0===t&&(t=this.length-e);for(var n=Array.from(this.$items.keys()),r=[],i=e;i<e+t;i++)r.push(this.$items.get(n[i])),this.$deleteAt(n[i]);return r},ArraySchema.prototype.unshift=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=this.length,i=t.length,o=Array.from(this.$items.values());return t.forEach((function(t,n){e.setAt(n,t)})),o.forEach((function(t,n){e.setAt(i+n,t)})),r+i},ArraySchema.prototype.indexOf=function(e,t){return Array.from(this.$items.values()).indexOf(e,t)},ArraySchema.prototype.lastIndexOf=function(e,t){return void 0===t&&(t=this.length-1),Array.from(this.$items.values()).lastIndexOf(e,t)},ArraySchema.prototype.every=function(e,t){return Array.from(this.$items.values()).every(e,t)},ArraySchema.prototype.some=function(e,t){return Array.from(this.$items.values()).some(e,t)},ArraySchema.prototype.forEach=function(e,t){Array.from(this.$items.values()).forEach(e,t)},ArraySchema.prototype.map=function(e,t){return Array.from(this.$items.values()).map(e,t)},ArraySchema.prototype.filter=function(e,t){return Array.from(this.$items.values()).filter(e,t)},ArraySchema.prototype.reduce=function(e,t){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)},ArraySchema.prototype.reduceRight=function(e,t){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)},ArraySchema.prototype.find=function(e,t){return Array.from(this.$items.values()).find(e,t)},ArraySchema.prototype.findIndex=function(e,t){return Array.from(this.$items.values()).findIndex(e,t)},ArraySchema.prototype.fill=function(e,t,n){throw new Error("ArraySchema#fill() not implemented")},ArraySchema.prototype.copyWithin=function(e,t,n){throw new Error("ArraySchema#copyWithin() not implemented")},ArraySchema.prototype.toString=function(){return this.$items.toString()},ArraySchema.prototype.toLocaleString=function(){return this.$items.toLocaleString()},ArraySchema.prototype[Symbol.iterator]=function(){return Array.from(this.$items.values())[Symbol.iterator]()},ArraySchema.prototype.entries=function(){return this.$items.entries()},ArraySchema.prototype.keys=function(){return this.$items.keys()},ArraySchema.prototype.values=function(){return this.$items.values()},ArraySchema.prototype.includes=function(e,t){return Array.from(this.$items.values()).includes(e,t)},ArraySchema.prototype.flatMap=function(e,t){throw new Error("ArraySchema#flatMap() is not supported.")},ArraySchema.prototype.flat=function(e){throw new Error("ArraySchema#flat() is not supported.")},ArraySchema.prototype.findLast=function(){var e=Array.from(this.$items.values());return e.findLast.apply(e,arguments)},ArraySchema.prototype.findLastIndex=function(){var e=Array.from(this.$items.values());return e.findLastIndex.apply(e,arguments)},ArraySchema.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},ArraySchema.prototype.getIndex=function(e){return this.$indexes.get(e)},ArraySchema.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},ArraySchema.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},ArraySchema.prototype.toArray=function(){return Array.from(this.$items.values())},ArraySchema.prototype.toJSON=function(){return this.toArray().map((function(e){return"function"==typeof e.toJSON?e.toJSON():e}))},ArraySchema.prototype.clone=function(e){return e?new(ArraySchema.bind.apply(ArraySchema,__spreadArray([void 0],Array.from(this.$items.values()),!1))):new(ArraySchema.bind.apply(ArraySchema,__spreadArray([void 0],this.map((function(e){return e.$changes?e.clone():e})),!1)))},ArraySchema}();function getMapProxy(e){return e.$proxy=!0,e=new Proxy(e,{get:function(e,t){return"symbol"!=typeof t&&void 0===e[t]?e.get(t):e[t]},set:function(e,t,n){return"symbol"!=typeof t&&-1===t.indexOf("$")&&"onAdd"!==t&&"onRemove"!==t&&"onChange"!==t?e.set(t,n):e[t]=n,!0},deleteProperty:function(e,t){return e.delete(t),!0}})}var s=function(){function MapSchema(e){var t=this;if(this.$changes=new i(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e)if(e instanceof Map||e instanceof MapSchema)e.forEach((function(e,n){return t.set(n,e)}));else for(var n in e)this.set(n,e[n])}return MapSchema.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},MapSchema.prototype.onRemove=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},MapSchema.prototype.onChange=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},MapSchema.is=function(e){return void 0!==e.map},MapSchema.prototype[Symbol.iterator]=function(){return this.$items[Symbol.iterator]()},Object.defineProperty(MapSchema.prototype,Symbol.toStringTag,{get:function(){return this.$items[Symbol.toStringTag]},enumerable:!1,configurable:!0}),MapSchema.prototype.set=function(t,n){if(null==n)throw new Error("MapSchema#set('".concat(t,"', ").concat(n,"): trying to set ").concat(n," value on '").concat(t,"'."));var r=void 0!==this.$changes.indexes[t],i=r?this.$changes.indexes[t]:this.$refId++,o=r?e.OPERATION.REPLACE:e.OPERATION.ADD,s=void 0!==n.$changes;return s&&n.$changes.setParent(this,this.$changes.root,i),r?s&&this.$items.get(t)!==n&&(o=e.OPERATION.ADD):(this.$changes.indexes[t]=i,this.$indexes.set(i,t)),this.$items.set(t,n),this.$changes.change(t,o),this},MapSchema.prototype.get=function(e){return this.$items.get(e)},MapSchema.prototype.delete=function(e){return this.$changes.delete(e),this.$items.delete(e)},MapSchema.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&removeChildRefs.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},MapSchema.prototype.has=function(e){return this.$items.has(e)},MapSchema.prototype.forEach=function(e){this.$items.forEach(e)},MapSchema.prototype.entries=function(){return this.$items.entries()},MapSchema.prototype.keys=function(){return this.$items.keys()},MapSchema.prototype.values=function(){return this.$items.values()},Object.defineProperty(MapSchema.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),MapSchema.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},MapSchema.prototype.getIndex=function(e){return this.$indexes.get(e)},MapSchema.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},MapSchema.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},MapSchema.prototype.toJSON=function(){var e={};return this.forEach((function(t,n){e[n]="function"==typeof t.toJSON?t.toJSON():t})),e},MapSchema.prototype.clone=function(e){var t;return e?t=Object.assign(new MapSchema,this):(t=new MapSchema,this.forEach((function(e,n){e.$changes?t.set(n,e.clone()):t.set(n,e)}))),t},MapSchema}(),a={};function registerType(e,t){a[e]=t}function getType(e){return a[e]}var c=function(){function SchemaDefinition(){this.indexes={},this.fieldsByIndex={},this.deprecated={},this.descriptors={}}return SchemaDefinition.create=function(e){var t=new SchemaDefinition;return t.schema=Object.assign({},e&&e.schema||{}),t.indexes=Object.assign({},e&&e.indexes||{}),t.fieldsByIndex=Object.assign({},e&&e.fieldsByIndex||{}),t.descriptors=Object.assign({},e&&e.descriptors||{}),t.deprecated=Object.assign({},e&&e.deprecated||{}),t},SchemaDefinition.prototype.addField=function(e,t){var n=this.getNextFieldIndex();this.fieldsByIndex[n]=e,this.indexes[e]=n,this.schema[e]=Array.isArray(t)?{array:t[0]}:t},SchemaDefinition.prototype.hasField=function(e){return void 0!==this.indexes[e]},SchemaDefinition.prototype.addFilter=function(e,t){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[e]]=t,this.indexesWithFilters.push(this.indexes[e]),!0},SchemaDefinition.prototype.addChildrenFilter=function(e,t){var n=this.indexes[e],r=this.schema[e];if(getType(Object.keys(r)[0]))return this.childFilters||(this.childFilters={}),this.childFilters[n]=t,!0;console.warn("@filterChildren: field '".concat(e,"' can't have children. Ignoring filter."))},SchemaDefinition.prototype.getChildrenFilter=function(e){return this.childFilters&&this.childFilters[this.indexes[e]]},SchemaDefinition.prototype.getNextFieldIndex=function(){return Object.keys(this.schema||{}).length},SchemaDefinition}();function hasFilter(e){return e._context&&e._context.useFilters}var h=function(){function Context(){this.types={},this.schemas=new Map,this.useFilters=!1}return Context.prototype.has=function(e){return this.schemas.has(e)},Context.prototype.get=function(e){return this.types[e]},Context.prototype.add=function(e,t){void 0===t&&(t=this.schemas.size),e._definition=c.create(e._definition),e._typeid=t,this.types[t]=e,this.schemas.set(e,t)},Context.create=function(e){return void 0===e&&(e={}),function(t){return e.context||(e.context=new Context),type(t,e)}},Context}(),f=new h;function type(e,t){return void 0===t&&(t={}),function(n,r){var i=t.context||f,a=n.constructor;if(a._context=i,!e)throw new Error("".concat(a.name,': @type() reference provided for "').concat(r,"\" is undefined. Make sure you don't have any circular dependencies."));i.has(a)||i.add(a);var c=a._definition;if(c.addField(r,e),c.descriptors[r]){if(c.deprecated[r])return;try{throw new Error("@colyseus/schema: Duplicate '".concat(r,"' definition on '").concat(a.name,"'.\nCheck @type() annotation"))}catch(e){var h=e.stack.split("\n")[4].trim();throw new Error("".concat(e.message," ").concat(h))}}var u=o.is(e),l=!u&&s.is(e);if("string"!=typeof e&&!b.is(e)){var d=Object.values(e)[0];"string"==typeof d||i.has(d)||i.add(d)}if(t.manual)c.descriptors[r]={enumerable:!0,configurable:!0,writable:!0};else{var p="_".concat(r);c.descriptors[p]={enumerable:!1,configurable:!1,writable:!0},c.descriptors[r]={get:function(){return this[p]},set:function(e){e!==this[p]&&(null!=e?(!u||e instanceof o||(e=new(o.bind.apply(o,__spreadArray([void 0],e,!1)))),!l||e instanceof s||(e=new s(e)),void 0===e.$proxy&&(l?e=getMapProxy(e):u&&(e=getArrayProxy(e))),this.$changes.change(r),e.$changes&&e.$changes.setParent(this,this.$changes.root,this._definition.indexes[r])):this[p]&&this.$changes.delete(r),this[p]=e)},enumerable:!0,configurable:!0}}}}function filter(e){return function(t,n){var r=t.constructor;r._definition.addFilter(n,e)&&(r._context.useFilters=!0)}}function filterChildren(e){return function(t,n){var r=t.constructor;r._definition.addChildrenFilter(n,e)&&(r._context.useFilters=!0)}}function deprecated(e){return void 0===e&&(e=!0),function(t,n){var r=t.constructor._definition;r.deprecated[n]=!0,e&&(r.descriptors[n]={get:function(){throw new Error("".concat(n," is deprecated."))},set:function(e){},enumerable:!1,configurable:!0})}}function defineTypes(e,t,n){for(var r in void 0===n&&(n={}),n.context||(n.context=e._context||n.context||f),t)type(t[r],n)(e.prototype,r);return e}function utf8Length(e){for(var t=0,n=0,r=0,i=e.length;r<i;r++)(t=e.charCodeAt(r))<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}function utf8Write(e,t,n){for(var r=0,i=0,o=n.length;i<o;i++)(r=n.charCodeAt(i))<128?e[t++]=r:r<2048?(e[t++]=192|r>>6,e[t++]=128|63&r):r<55296||r>=57344?(e[t++]=224|r>>12,e[t++]=128|r>>6&63,e[t++]=128|63&r):(i++,r=65536+((1023&r)<<10|1023&n.charCodeAt(i)),e[t++]=240|r>>18,e[t++]=128|r>>12&63,e[t++]=128|r>>6&63,e[t++]=128|63&r)}function int8$1(e,t){e.push(255&t)}function uint8$1(e,t){e.push(255&t)}function int16$1(e,t){e.push(255&t),e.push(t>>8&255)}function uint16$1(e,t){e.push(255&t),e.push(t>>8&255)}function int32$1(e,t){e.push(255&t),e.push(t>>8&255),e.push(t>>16&255),e.push(t>>24&255)}function uint32$1(e,t){var n=t>>24,r=t>>16,i=t>>8,o=t;e.push(255&o),e.push(255&i),e.push(255&r),e.push(255&n)}function int64$1(e,t){var n=Math.floor(t/Math.pow(2,32));uint32$1(e,t>>>0),uint32$1(e,n)}function uint64$1(e,t){var n=t/Math.pow(2,32)>>0;uint32$1(e,t>>>0),uint32$1(e,n)}function float32$1(e,t){writeFloat32(e,t)}function float64$1(e,t){writeFloat64(e,t)}var u=new Int32Array(2),l=new Float32Array(u.buffer),d=new Float64Array(u.buffer);function writeFloat32(e,t){l[0]=t,int32$1(e,u[0])}function writeFloat64(e,t){d[0]=t,int32$1(e,u[0]),int32$1(e,u[1])}function boolean$1(e,t){return uint8$1(e,t?1:0)}function string$1(e,t){t||(t="");var n=utf8Length(t),r=0;if(n<32)e.push(160|n),r=1;else if(n<256)e.push(217),uint8$1(e,n),r=2;else if(n<65536)e.push(218),uint16$1(e,n),r=3;else{if(!(n<4294967296))throw new Error("String too long");e.push(219),uint32$1(e,n),r=5}return utf8Write(e,e.length,t),r+n}function number$1(e,t){return isNaN(t)?number$1(e,0):isFinite(t)?t!==(0|t)?(e.push(203),writeFloat64(e,t),9):t>=0?t<128?(uint8$1(e,t),1):t<256?(e.push(204),uint8$1(e,t),2):t<65536?(e.push(205),uint16$1(e,t),3):t<4294967296?(e.push(206),uint32$1(e,t),5):(e.push(207),uint64$1(e,t),9):t>=-32?(e.push(224|t+32),1):t>=-128?(e.push(208),int8$1(e,t),2):t>=-32768?(e.push(209),int16$1(e,t),3):t>=-2147483648?(e.push(210),int32$1(e,t),5):(e.push(211),int64$1(e,t),9):number$1(e,t>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER)}var p=Object.freeze({__proto__:null,utf8Write:utf8Write,int8:int8$1,uint8:uint8$1,int16:int16$1,uint16:uint16$1,int32:int32$1,uint32:uint32$1,int64:int64$1,uint64:uint64$1,float32:float32$1,float64:float64$1,writeFloat32:writeFloat32,writeFloat64:writeFloat64,boolean:boolean$1,string:string$1,number:number$1});function utf8Read(e,t,n){for(var r="",i=0,o=t,s=t+n;o<s;o++){var a=e[o];0!=(128&a)?192!=(224&a)?224!=(240&a)?240!=(248&a)?console.error("Invalid byte "+a.toString(16)):(i=(7&a)<<18|(63&e[++o])<<12|(63&e[++o])<<6|(63&e[++o])<<0)>=65536?(i-=65536,r+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):r+=String.fromCharCode(i):r+=String.fromCharCode((15&a)<<12|(63&e[++o])<<6|(63&e[++o])<<0):r+=String.fromCharCode((31&a)<<6|63&e[++o]):r+=String.fromCharCode(a)}return r}function int8(e,t){return uint8(e,t)<<24>>24}function uint8(e,t){return e[t.offset++]}function int16(e,t){return uint16(e,t)<<16>>16}function uint16(e,t){return e[t.offset++]|e[t.offset++]<<8}function int32(e,t){return e[t.offset++]|e[t.offset++]<<8|e[t.offset++]<<16|e[t.offset++]<<24}function uint32(e,t){return int32(e,t)>>>0}function float32(e,t){return readFloat32(e,t)}function float64(e,t){return readFloat64(e,t)}function int64(e,t){var n=uint32(e,t);return int32(e,t)*Math.pow(2,32)+n}function uint64(e,t){var n=uint32(e,t);return uint32(e,t)*Math.pow(2,32)+n}var y=new Int32Array(2),v=new Float32Array(y.buffer),g=new Float64Array(y.buffer);function readFloat32(e,t){return y[0]=int32(e,t),v[0]}function readFloat64(e,t){return y[0]=int32(e,t),y[1]=int32(e,t),g[0]}function boolean(e,t){return uint8(e,t)>0}function string(e,t){var n,r=e[t.offset++];r<192?n=31&r:217===r?n=uint8(e,t):218===r?n=uint16(e,t):219===r&&(n=uint32(e,t));var i=utf8Read(e,t.offset,n);return t.offset+=n,i}function stringCheck(e,t){var n=e[t.offset];return n<192&&n>160||217===n||218===n||219===n}function number(e,t){var n=e[t.offset++];return n<128?n:202===n?readFloat32(e,t):203===n?readFloat64(e,t):204===n?uint8(e,t):205===n?uint16(e,t):206===n?uint32(e,t):207===n?uint64(e,t):208===n?int8(e,t):209===n?int16(e,t):210===n?int32(e,t):211===n?int64(e,t):n>223?-1*(255-n+1):void 0}function numberCheck(e,t){var n=e[t.offset];return n<128||n>=202&&n<=211}function arrayCheck(e,t){return e[t.offset]<160}function switchStructureCheck(e,t){return e[t.offset-1]===n&&(e[t.offset]<128||e[t.offset]>=202&&e[t.offset]<=211)}var m=Object.freeze({__proto__:null,int8:int8,uint8:uint8,int16:int16,uint16:uint16,int32:int32,uint32:uint32,float32:float32,float64:float64,int64:int64,uint64:uint64,readFloat32:readFloat32,readFloat64:readFloat64,boolean:boolean,string:string,stringCheck:stringCheck,number:number,numberCheck:numberCheck,arrayCheck:arrayCheck,switchStructureCheck:switchStructureCheck}),A=function(){function CollectionSchema(e){var t=this;this.$changes=new i(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach((function(e){return t.add(e)}))}return CollectionSchema.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},CollectionSchema.prototype.onRemove=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},CollectionSchema.prototype.onChange=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},CollectionSchema.is=function(e){return void 0!==e.collection},CollectionSchema.prototype.add=function(e){var t=this.$refId++;return void 0!==e.$changes&&e.$changes.setParent(this,this.$changes.root,t),this.$changes.indexes[t]=t,this.$indexes.set(t,t),this.$items.set(t,e),this.$changes.change(t),t},CollectionSchema.prototype.at=function(e){var t=Array.from(this.$items.keys())[e];return this.$items.get(t)},CollectionSchema.prototype.entries=function(){return this.$items.entries()},CollectionSchema.prototype.delete=function(e){for(var t,n,r=this.$items.entries();(n=r.next())&&!n.done;)if(e===n.value[1]){t=n.value[0];break}return void 0!==t&&(this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t))},CollectionSchema.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&removeChildRefs.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},CollectionSchema.prototype.has=function(e){return Array.from(this.$items.values()).some((function(t){return t===e}))},CollectionSchema.prototype.forEach=function(e){var t=this;this.$items.forEach((function(n,r,i){return e(n,r,t)}))},CollectionSchema.prototype.values=function(){return this.$items.values()},Object.defineProperty(CollectionSchema.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),CollectionSchema.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},CollectionSchema.prototype.getIndex=function(e){return this.$indexes.get(e)},CollectionSchema.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},CollectionSchema.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},CollectionSchema.prototype.toArray=function(){return Array.from(this.$items.values())},CollectionSchema.prototype.toJSON=function(){var e=[];return this.forEach((function(t,n){e.push("function"==typeof t.toJSON?t.toJSON():t)})),e},CollectionSchema.prototype.clone=function(e){var t;return e?t=Object.assign(new CollectionSchema,this):(t=new CollectionSchema,this.forEach((function(e){e.$changes?t.add(e.clone()):t.add(e)}))),t},CollectionSchema}(),w=function(){function SetSchema(e){var t=this;this.$changes=new i(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach((function(e){return t.add(e)}))}return SetSchema.prototype.onAdd=function(t,n){return void 0===n&&(n=!0),addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.ADD,t,n?this.$items:void 0)},SetSchema.prototype.onRemove=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},SetSchema.prototype.onChange=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},SetSchema.is=function(e){return void 0!==e.set},SetSchema.prototype.add=function(t){var n,r;if(this.has(t))return!1;var i=this.$refId++;void 0!==t.$changes&&t.$changes.setParent(this,this.$changes.root,i);var o=null!==(r=null===(n=this.$changes.indexes[i])||void 0===n?void 0:n.op)&&void 0!==r?r:e.OPERATION.ADD;return this.$changes.indexes[i]=i,this.$indexes.set(i,i),this.$items.set(i,t),this.$changes.change(i,o),i},SetSchema.prototype.entries=function(){return this.$items.entries()},SetSchema.prototype.delete=function(e){for(var t,n,r=this.$items.entries();(n=r.next())&&!n.done;)if(e===n.value[1]){t=n.value[0];break}return void 0!==t&&(this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t))},SetSchema.prototype.clear=function(t){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),t&&removeChildRefs.call(this,t),this.$items.clear(),this.$changes.operation({index:0,op:e.OPERATION.CLEAR}),this.$changes.touchParents()},SetSchema.prototype.has=function(e){for(var t,n=this.$items.values(),r=!1;(t=n.next())&&!t.done;)if(e===t.value){r=!0;break}return r},SetSchema.prototype.forEach=function(e){var t=this;this.$items.forEach((function(n,r,i){return e(n,r,t)}))},SetSchema.prototype.values=function(){return this.$items.values()},Object.defineProperty(SetSchema.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),SetSchema.prototype.setIndex=function(e,t){this.$indexes.set(e,t)},SetSchema.prototype.getIndex=function(e){return this.$indexes.get(e)},SetSchema.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},SetSchema.prototype.deleteByIndex=function(e){var t=this.$indexes.get(e);this.$items.delete(t),this.$indexes.delete(e)},SetSchema.prototype.toArray=function(){return Array.from(this.$items.values())},SetSchema.prototype.toJSON=function(){var e=[];return this.forEach((function(t,n){e.push("function"==typeof t.toJSON?t.toJSON():t)})),e},SetSchema.prototype.clone=function(e){var t;return e?t=Object.assign(new SetSchema,this):(t=new SetSchema,this.forEach((function(e){e.$changes?t.add(e.clone()):t.add(e)}))),t},SetSchema}(),E=function(){function ClientState(){this.refIds=new WeakSet,this.containerIndexes=new WeakMap}return ClientState.prototype.addRefId=function(e){this.refIds.has(e)||(this.refIds.add(e),this.containerIndexes.set(e,new Set))},ClientState.get=function(e){return void 0===e.$filterState&&(e.$filterState=new ClientState),e.$filterState},ClientState}(),S=function(){function ReferenceTracker(){this.refs=new Map,this.refCounts={},this.deletedRefs=new Set,this.nextUniqueId=0}return ReferenceTracker.prototype.getNextUniqueId=function(){return this.nextUniqueId++},ReferenceTracker.prototype.addRef=function(e,t,n){void 0===n&&(n=!0),this.refs.set(e,t),n&&(this.refCounts[e]=(this.refCounts[e]||0)+1)},ReferenceTracker.prototype.removeRef=function(e){this.refCounts[e]=this.refCounts[e]-1,this.deletedRefs.add(e)},ReferenceTracker.prototype.clearRefs=function(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}},ReferenceTracker.prototype.garbageCollectDeletedRefs=function(){var e=this;this.deletedRefs.forEach((function(t){if(!(e.refCounts[t]>0)){var n=e.refs.get(t);if(n instanceof b)for(var r in n._definition.schema)"string"!=typeof n._definition.schema[r]&&n[r]&&n[r].$changes&&e.removeRef(n[r].$changes.refId);else{var i=n.$changes.parent._definition,o=i.schema[i.fieldsByIndex[n.$changes.parentIndex]];"function"==typeof Object.values(o)[0]&&Array.from(n.values()).forEach((function(t){return e.removeRef(t.$changes.refId)}))}e.refs.delete(t),delete e.refCounts[t]}})),this.deletedRefs.clear()},ReferenceTracker}(),$=function(e){function EncodeSchemaError(){return null!==e&&e.apply(this,arguments)||this}return __extends(EncodeSchemaError,e),EncodeSchemaError}(Error);function assertType(e,t,n,r){var i,o=!1;switch(t){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":i="number",isNaN(e)&&console.log('trying to encode "NaN" in '.concat(n.constructor.name,"#").concat(r));break;case"string":i="string",o=!0;break;case"boolean":return}if(typeof e!==i&&(!o||o&&null!==e)){var s="'".concat(JSON.stringify(e),"'").concat(e&&e.constructor&&" (".concat(e.constructor.name,")")||"");throw new $("a '".concat(i,"' was expected, but ").concat(s," was provided in ").concat(n.constructor.name,"#").concat(r))}}function assertInstanceType(e,t,n,r){if(!(e instanceof t))throw new $("a '".concat(t.name,"' was expected, but '").concat(e.constructor.name,"' was provided in ").concat(n.constructor.name,"#").concat(r))}function encodePrimitiveType(e,t,n,r,i){assertType(n,e,r,i);var o=p[e];if(!o)throw new $("a '".concat(e,"' was expected, but ").concat(n," was provided in ").concat(r.constructor.name,"#").concat(i));o(t,n)}function decodePrimitiveType(e,t,n){return m[e](t,n)}var b=function(){function Schema(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Object.defineProperties(this,{$changes:{value:new i(this,void 0,new S),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});var n=this._definition.descriptors;n&&Object.defineProperties(this,n),e[0]&&this.assign(e[0])}return Schema.onError=function(e){console.error(e)},Schema.is=function(e){return e._definition&&void 0!==e._definition.schema},Schema.prototype.onChange=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.REPLACE,t)},Schema.prototype.onRemove=function(t){return addCallback(this.$callbacks||(this.$callbacks=[]),e.OPERATION.DELETE,t)},Schema.prototype.assign=function(e){return Object.assign(this,e),this},Object.defineProperty(Schema.prototype,"_definition",{get:function(){return this.constructor._definition},enumerable:!1,configurable:!0}),Schema.prototype.setDirty=function(e,t){this.$changes.change(e,t)},Schema.prototype.listen=function(e,t,n){var r=this;return void 0===n&&(n=!0),this.$callbacks||(this.$callbacks={}),this.$callbacks[e]||(this.$callbacks[e]=[]),this.$callbacks[e].push(t),n&&void 0!==this[e]&&t(this[e],void 0),function(){return spliceOne(r.$callbacks[e],r.$callbacks[e].indexOf(t))}},Schema.prototype.decode=function(t,r,i){var a;void 0===r&&(r={offset:0}),void 0===i&&(i=this);var c=[],h=this.$changes.root,f=t.length,u=0;for(h.refs.set(u,this);r.offset<f;){var l=t[r.offset++];if(l!=n){var d=i.$changes,p=void 0!==i._definition,y=p?l>>6<<6:l;if(y!==e.OPERATION.CLEAR){var v=p?l%(y||255):number(t,r),g=p?i._definition.fieldsByIndex[v]:"",m=d.getType(v),E=void 0,S=void 0,$=void 0;if(p?S=i["_".concat(g)]:(S=i.getByIndex(v),(y&e.OPERATION.ADD)===e.OPERATION.ADD?($=i instanceof s?string(t,r):v,i.setIndex(v,$)):$=i.getIndex(v)),(y&e.OPERATION.DELETE)===e.OPERATION.DELETE&&(y!==e.OPERATION.DELETE_AND_ADD&&i.deleteByIndex(v),S&&S.$changes&&h.removeRef(S.$changes.refId),E=null),void 0!==g){if(y===e.OPERATION.DELETE);else if(Schema.is(m)){var b=number(t,r);if(E=h.refs.get(b),y!==e.OPERATION.REPLACE){var O=this.getSchemaType(t,r,m);E||((E=this.createTypeInstance(O)).$changes.refId=b,S&&(E.$callbacks=S.$callbacks,S.$changes.refId&&b!==S.$changes.refId&&h.removeRef(S.$changes.refId))),h.addRef(b,E,E!==S)}}else if("string"==typeof m)E=decodePrimitiveType(m,t,r);else{var T=getType(Object.keys(m)[0]),C=number(t,r),I=h.refs.has(C)?S||h.refs.get(C):new T.constructor;if((E=I.clone(!0)).$changes.refId=C,S&&(E.$callbacks=S.$callbacks,S.$changes.refId&&C!==S.$changes.refId)){h.removeRef(S.$changes.refId);for(var R=S.entries(),x=void 0;(x=R.next())&&!x.done;){var P=(a=x.value)[0],k=a[1];c.push({refId:C,op:e.OPERATION.DELETE,field:P,value:void 0,previousValue:k})}}h.addRef(C,E,I!==S)}if(null!=E)if(E.$changes&&E.$changes.setParent(d.ref,d.root,v),i instanceof Schema)i[g]=E;else if(i instanceof s)P=$,i.$items.set(P,E),i.$changes.allChanges.add(v);else if(i instanceof o)i.setAt(v,E);else if(i instanceof A){var D=i.add(E);i.setIndex(v,D)}else i instanceof w&&!1!==(D=i.add(E))&&i.setIndex(v,D);S!==E&&c.push({refId:u,op:y,field:g,dynamicIndex:$,value:E,previousValue:S})}else{console.warn("@colyseus/schema: definition mismatch");for(var M={offset:r.offset};r.offset<f&&(!switchStructureCheck(t,r)||(M.offset=r.offset+1,!h.refs.has(number(t,M))));)r.offset++}}else i.clear(c)}else{u=number(t,r);var N=h.refs.get(u);if(!N)throw new Error('"refId" not found: '.concat(u));i=N}}return this._triggerChanges(c),h.garbageCollectDeletedRefs(),c},Schema.prototype.encode=function(t,r,i){void 0===t&&(t=!1),void 0===r&&(r=[]),void 0===i&&(i=!1);for(var o=this.$changes,a=new WeakSet,c=[o],h=1,f=0;f<h;f++){var u=c[f],l=u.ref,d=l instanceof Schema;u.ensureRefId(),a.add(u),u!==o&&(u.changed||t)&&(uint8$1(r,n),number$1(r,u.refId));for(var p=t?Array.from(u.allChanges):Array.from(u.changes.values()),y=0,v=p.length;y<v;y++){var g=t?{op:e.OPERATION.ADD,index:p[y]}:p[y],m=g.index,A=d?l._definition.fieldsByIndex&&l._definition.fieldsByIndex[m]:m,w=r.length;if(g.op!==e.OPERATION.TOUCH)if(d)uint8$1(r,m|g.op);else{if(uint8$1(r,g.op),g.op===e.OPERATION.CLEAR)continue;number$1(r,m)}if(d||(g.op&e.OPERATION.ADD)!=e.OPERATION.ADD||l instanceof s&&string$1(r,u.ref.$indexes.get(m)),g.op!==e.OPERATION.DELETE){var E=u.getType(m),S=u.getValue(m);if(S&&S.$changes&&!a.has(S.$changes)&&(c.push(S.$changes),S.$changes.ensureRefId(),h++),g.op!==e.OPERATION.TOUCH){if(Schema.is(E))assertInstanceType(S,E,l,A),number$1(r,S.$changes.refId),(g.op&e.OPERATION.ADD)===e.OPERATION.ADD&&this.tryEncodeTypeId(r,E,S.constructor);else if("string"==typeof E)encodePrimitiveType(E,r,S,l,A);else{var $=getType(Object.keys(E)[0]);assertInstanceType(l["_".concat(A)],$.constructor,l,A),number$1(r,S.$changes.refId)}i&&u.cache(m,r.slice(w))}}}t||i||u.discard()}return r},Schema.prototype.encodeAll=function(e){return this.encode(!0,[],e)},Schema.prototype.applyFilters=function(t,r){var i,o;void 0===r&&(r=!1);for(var a=this,c=new Set,h=E.get(t),f=[this.$changes],u=1,l=[],_loop_1=function(d){var y=f[d];if(c.has(y.refId))return"continue";var v=y.ref,g=v instanceof Schema;uint8$1(l,n),number$1(l,y.refId);var m=h.refIds.has(y),A=r||!m;h.addRefId(y);var w=h.containerIndexes.get(y),E=A?Array.from(y.allChanges):Array.from(y.changes.values());!r&&g&&v._definition.indexesWithFilters&&v._definition.indexesWithFilters.forEach((function(t){!w.has(t)&&y.allChanges.has(t)&&(A?E.push(t):E.push({op:e.OPERATION.ADD,index:t}))}));for(var S=0,$=E.length;S<$;S++){var b=A?{op:e.OPERATION.ADD,index:E[S]}:E[S];if(b.op!==e.OPERATION.CLEAR){var O=b.index;if(b.op!==e.OPERATION.DELETE){var T=y.getValue(O),C=y.getType(O);if(g){if((I=v._definition.filters&&v._definition.filters[O])&&!I.call(v,t,T,a)){T&&T.$changes&&c.add(T.$changes.refId);continue}}else{var I,R=y.parent;if((I=y.getChildrenFilter())&&!I.call(R,t,v.$indexes.get(O),T,a)){T&&T.$changes&&c.add(T.$changes.refId);continue}}if(T.$changes&&(f.push(T.$changes),u++),b.op!==e.OPERATION.TOUCH)if(b.op===e.OPERATION.ADD||g)l.push.apply(l,null!==(i=y.caches[O])&&void 0!==i?i:[]),w.add(O);else if(w.has(O))l.push.apply(l,null!==(o=y.caches[O])&&void 0!==o?o:[]);else{if(w.add(O),uint8$1(l,e.OPERATION.ADD),number$1(l,O),v instanceof s){var x=y.ref.$indexes.get(O);string$1(l,x)}T.$changes?number$1(l,T.$changes.refId):p[C](l,T)}else T.$changes&&!g&&(uint8$1(l,e.OPERATION.ADD),number$1(l,O),v instanceof s&&(x=y.ref.$indexes.get(O),string$1(l,x)),number$1(l,T.$changes.refId))}else g?uint8$1(l,b.op|O):(uint8$1(l,b.op),number$1(l,O))}else uint8$1(l,b.op)}},d=0;d<u;d++)_loop_1(d);return l},Schema.prototype.clone=function(){var e,t=new this.constructor,n=this._definition.schema;for(var r in n)"object"==typeof this[r]&&"function"==typeof(null===(e=this[r])||void 0===e?void 0:e.clone)?t[r]=this[r].clone():t[r]=this[r];return t},Schema.prototype.toJSON=function(){var e=this._definition.schema,t=this._definition.deprecated,n={};for(var r in e)t[r]||null===this[r]||void 0===this[r]||(n[r]="function"==typeof this[r].toJSON?this[r].toJSON():this["_".concat(r)]);return n},Schema.prototype.discardAllChanges=function(){this.$changes.discardAll()},Schema.prototype.getByIndex=function(e){return this[this._definition.fieldsByIndex[e]]},Schema.prototype.deleteByIndex=function(e){this[this._definition.fieldsByIndex[e]]=void 0},Schema.prototype.tryEncodeTypeId=function(e,t,n){t._typeid!==n._typeid&&(uint8$1(e,r),number$1(e,n._typeid))},Schema.prototype.getSchemaType=function(e,t,n){var i;return e[t.offset]===r&&(t.offset++,i=this.constructor._context.get(number(e,t))),i||n},Schema.prototype.createTypeInstance=function(e){var t=new e;return t.$changes.root=this.$changes.root,t},Schema.prototype._triggerChanges=function(t){for(var n,r,i,o,s,a,c,h,f,u=new Set,l=this.$changes.root.refs,_loop_2=function(d){var p=t[d],y=p.refId,v=l.get(y),g=v.$callbacks;if((p.op&e.OPERATION.DELETE)===e.OPERATION.DELETE&&p.previousValue instanceof Schema&&(null===(r=null===(n=p.previousValue.$callbacks)||void 0===n?void 0:n[e.OPERATION.DELETE])||void 0===r||r.forEach((function(e){return e()}))),!g)return"continue";if(v instanceof Schema){if(!u.has(y))try{null===(i=null==g?void 0:g[e.OPERATION.REPLACE])||void 0===i||i.forEach((function(e){return e(t)}))}catch(e){Schema.onError(e)}try{g.hasOwnProperty(p.field)&&(null===(o=g[p.field])||void 0===o||o.forEach((function(e){return e(p.value,p.previousValue)})))}catch(e){Schema.onError(e)}}else p.op===e.OPERATION.ADD&&void 0===p.previousValue?null===(s=g[e.OPERATION.ADD])||void 0===s||s.forEach((function(e){var t;return e(p.value,null!==(t=p.dynamicIndex)&&void 0!==t?t:p.field)})):p.op===e.OPERATION.DELETE?void 0!==p.previousValue&&(null===(a=g[e.OPERATION.DELETE])||void 0===a||a.forEach((function(e){var t;return e(p.previousValue,null!==(t=p.dynamicIndex)&&void 0!==t?t:p.field)}))):p.op===e.OPERATION.DELETE_AND_ADD&&(void 0!==p.previousValue&&(null===(c=g[e.OPERATION.DELETE])||void 0===c||c.forEach((function(e){var t;return e(p.previousValue,null!==(t=p.dynamicIndex)&&void 0!==t?t:p.field)}))),null===(h=g[e.OPERATION.ADD])||void 0===h||h.forEach((function(e){var t;return e(p.value,null!==(t=p.dynamicIndex)&&void 0!==t?t:p.field)}))),p.value!==p.previousValue&&(null===(f=g[e.OPERATION.REPLACE])||void 0===f||f.forEach((function(e){var t;return e(p.value,null!==(t=p.dynamicIndex)&&void 0!==t?t:p.field)})));u.add(y)},d=0;d<t.length;d++)_loop_2(d)},Schema._definition=c.create(),Schema}();function dumpChanges(e){for(var t=[e.$changes],n=1,r={},i=r,_loop_1=function(e){var n=t[e];n.changes.forEach((function(e){var t=n.ref,r=e.index,o=t._definition?t._definition.fieldsByIndex[r]:t.$indexes.get(r);i[o]=n.getValue(r)}))},o=0;o<n;o++)_loop_1(o);return r}var O={context:new h},T=function(e){function ReflectionField(){return null!==e&&e.apply(this,arguments)||this}return __extends(ReflectionField,e),__decorate([type("string",O)],ReflectionField.prototype,"name",void 0),__decorate([type("string",O)],ReflectionField.prototype,"type",void 0),__decorate([type("number",O)],ReflectionField.prototype,"referencedType",void 0),ReflectionField}(b),C=function(e){function ReflectionType(){var t=null!==e&&e.apply(this,arguments)||this;return t.fields=new o,t}return __extends(ReflectionType,e),__decorate([type("number",O)],ReflectionType.prototype,"id",void 0),__decorate([type([T],O)],ReflectionType.prototype,"fields",void 0),ReflectionType}(b),I=function(e){function Reflection(){var t=null!==e&&e.apply(this,arguments)||this;return t.types=new o,t}return __extends(Reflection,e),Reflection.encode=function(e){var t=e.constructor,n=new Reflection;n.rootType=t._typeid;var buildType=function(e,t){for(var r in t){var i=new T;i.name=r;var o=void 0;if("string"==typeof t[r])o=t[r];else{var s=t[r],a=void 0;b.is(s)?(o="ref",a=t[r]):"string"==typeof s[o=Object.keys(s)[0]]?o+=":"+s[o]:a=s[o],i.referencedType=a?a._typeid:-1}i.type=o,e.fields.push(i)}n.types.push(e)},r=t._context.types;for(var i in r){var o=new C;o.id=Number(i),buildType(o,r[i]._definition.schema)}return n.encodeAll()},Reflection.decode=function(e,t){var n=new h,r=new Reflection;r.decode(e,t);var i=r.types.reduce((function(e,t){var r=function(e){function _(){return null!==e&&e.apply(this,arguments)||this}return __extends(_,e),_}(b),i=t.id;return e[i]=r,n.add(r,i),e}),{});r.types.forEach((function(e){var t=i[e.id];e.fields.forEach((function(e){var r;if(void 0!==e.referencedType){var o=e.type,s=i[e.referencedType];if(!s){var a=e.type.split(":");o=a[0],s=a[1]}"ref"===o?type(s,{context:n})(t.prototype,e.name):type(((r={})[o]=s,r),{context:n})(t.prototype,e.name)}else type(e.type,{context:n})(t.prototype,e.name)}))}));var o=i[r.rootType],s=new o;for(var a in o._definition.schema){var c=o._definition.schema[a];"string"!=typeof c&&(s[a]="function"==typeof c?new c:new(getType(Object.keys(c)[0]).constructor))}return s},__decorate([type([C],O)],Reflection.prototype,"types",void 0),__decorate([type("number",O)],Reflection.prototype,"rootType",void 0),Reflection}(b);registerType("map",{constructor:s}),registerType("array",{constructor:o}),registerType("set",{constructor:w}),registerType("collection",{constructor:A}),e.ArraySchema=o,e.CollectionSchema=A,e.Context=h,e.MapSchema=s,e.Reflection=I,e.ReflectionField=T,e.ReflectionType=C,e.Schema=b,e.SchemaDefinition=c,e.SetSchema=w,e.decode=m,e.defineTypes=defineTypes,e.deprecated=deprecated,e.dumpChanges=dumpChanges,e.encode=p,e.filter=filter,e.filterChildren=filterChildren,e.hasFilter=hasFilter,e.registerType=registerType,e.type=type,Object.defineProperty(e,"__esModule",{value:!0})}(t)})),u=function(){function Room(e,t){var n=this;this.onStateChange=createSignal(),this.onError=createSignal(),this.onLeave=createSignal(),this.onJoin=createSignal(),this.hasJoined=!1,this.onMessageHandlers={emit:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=this.events[e]||[],i=0,o=r.length;i<o;i++)r[i].apply(r,t)},events:{},on:function(e,t){var n,r=this;return(null===(n=this.events[e])||void 0===n?void 0:n.push(t))||(this.events[e]=[t]),function(){var n;r.events[e]=null===(n=r.events[e])||void 0===n?void 0:n.filter((function(e){return t!==e}))}}},this.roomId=null,this.name=e,t&&(this.serializer=new(getSerializer("schema")),this.rootSchema=t,this.serializer.state=new t),this.onError((function(e,t){var n;return null===(n=console.warn)||void 0===n?void 0:n.call(console,"colyseus.js - onError => (".concat(e,") ").concat(t))})),this.onLeave((function(){return n.removeAllListeners()}))}return Object.defineProperty(Room.prototype,"id",{get:function(){return this.roomId},enumerable:!1,configurable:!0}),Room.prototype.connect=function(e,n,r){void 0===r&&(r=this);var i=new a;r.connection=i,i.events.onmessage=Room.prototype.onMessageCallback.bind(r),i.events.onclose=function(e){var i;if(!r.hasJoined)return null===(i=console.warn)||void 0===i||i.call(console,"Room connection was closed unexpectedly (".concat(e.code,"): ").concat(e.reason)),void r.onError.invoke(e.code,e.reason);e.code===t.DEVMODE_RESTART&&n?n():(r.onLeave.invoke(e.code),r.destroy())},i.events.onerror=function(e){var t;null===(t=console.warn)||void 0===t||t.call(console,"Room, onError (".concat(e.code,"): ").concat(e.reason)),r.onError.invoke(e.code,e.reason)},i.connect(e)},Room.prototype.leave=function(n){var r=this;return void 0===n&&(n=!0),new Promise((function(i){r.onLeave((function(e){return i(e)})),r.connection?n?r.connection.send([e.Protocol.LEAVE_ROOM]):r.connection.close():r.onLeave.invoke(t.CONSENTED)}))},Room.prototype.onMessage=function(e,t){return this.onMessageHandlers.on(this.getMessageHandlerKey(e),t)},Room.prototype.send=function(t,n){var r,i=[e.Protocol.ROOM_DATA];if("string"==typeof t?f.encode.string(i,t):f.encode.number(i,t),void 0!==n){var o=encode(n);(r=new Uint8Array(i.length+o.byteLength)).set(new Uint8Array(i),0),r.set(new Uint8Array(o),i.length)}else r=new Uint8Array(i);this.connection.send(r.buffer)},Room.prototype.sendBytes=function(t,n){var r,i=[e.Protocol.ROOM_DATA_BYTES];"string"==typeof t?f.encode.string(i,t):f.encode.number(i,t),(r=new Uint8Array(i.length+(n.byteLength||n.length))).set(new Uint8Array(i),0),r.set(new Uint8Array(n),i.length),this.connection.send(r.buffer)},Object.defineProperty(Room.prototype,"state",{get:function(){return this.serializer.getState()},enumerable:!1,configurable:!0}),Room.prototype.removeAllListeners=function(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={}},Room.prototype.onMessageCallback=function(t){var n=Array.from(new Uint8Array(t.data)),r=n[0];if(r===e.Protocol.JOIN_ROOM){var i=1,o=utf8Read(n,i);if(i+=utf8Length(o),this.serializerId=utf8Read(n,i),i+=utf8Length(this.serializerId),!this.serializer){var s=getSerializer(this.serializerId);this.serializer=new s}n.length>i&&this.serializer.handshake&&this.serializer.handshake(n,{offset:i}),this.reconnectionToken="".concat(this.roomId,":").concat(o),this.hasJoined=!0,this.onJoin.invoke(),this.connection.send([e.Protocol.JOIN_ROOM])}else if(r===e.Protocol.ERROR){var a={offset:1},c=f.decode.number(n,a),h=f.decode.string(n,a);this.onError.invoke(c,h)}else if(r===e.Protocol.LEAVE_ROOM)this.leave();else if(r===e.Protocol.ROOM_DATA_SCHEMA){var u={offset:1};(h=new(d=this.serializer.getState().constructor._context.get(f.decode.number(n,u)))).decode(n,u),this.dispatchMessage(d,h)}else if(r===e.Protocol.ROOM_STATE)n.shift(),this.setState(n);else if(r===e.Protocol.ROOM_STATE_PATCH)n.shift(),this.patch(n);else if(r===e.Protocol.ROOM_DATA){var l={offset:1},d=f.decode.stringCheck(n,l)?f.decode.string(n,l):f.decode.number(n,l);h=n.length>l.offset?function decode(e,t){void 0===t&&(t=0);var n=new Decoder(e,t),r=n._parse();if(n._offset!==e.byteLength)throw new Error(e.byteLength-n._offset+" trailing bytes");return r}(t.data,l.offset):void 0;this.dispatchMessage(d,h)}else if(r===e.Protocol.ROOM_DATA_BYTES){var p={offset:1};d=f.decode.stringCheck(n,p)?f.decode.string(n,p):f.decode.number(n,p);this.dispatchMessage(d,new Uint8Array(n.slice(p.offset)))}},Room.prototype.setState=function(e){this.serializer.setState(e),this.onStateChange.invoke(this.serializer.getState())},Room.prototype.patch=function(e){this.serializer.patch(e),this.onStateChange.invoke(this.serializer.getState())},Room.prototype.dispatchMessage=function(e,t){var n,r=this.getMessageHandlerKey(e);this.onMessageHandlers.events[r]?this.onMessageHandlers.emit(r,t):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",e,t):null===(n=console.warn)||void 0===n||n.call(console,"colyseus.js: onMessage() not registered for type '".concat(e,"'."))},Room.prototype.destroy=function(){this.serializer&&this.serializer.teardown()},Room.prototype.getMessageHandlerKey=function(e){switch(typeof e){case"function":return"$".concat(e._typeid);case"string":return e;case"number":return"i".concat(e);default:throw new Error("invalid message type.")}},Room}();function apply(e,t){t.statusMessage=e.statusText,t.statusCode=e.status,t.data=e.body}function send(e,t,n){var r,i,o=(n=n||{}).body;return n.method=e,n.headers=n.headers||{},o instanceof FormData||o&&"object"==typeof o&&(n.headers["content-type"]="application/json",n.body=JSON.stringify(o)),n.withCredentials&&(n.credentials="include"),n.timeout&&(i=new AbortController,n.signal=i.signal,r=setTimeout(i.abort,n.timeout)),new Promise(((e,s)=>{fetch(t,n).then(((t,i)=>{clearTimeout(r),apply(t,t),i=t.status>=400?s:e,(o=t.headers.get("content-type"))&&~o.indexOf("application/json")?t.text().then((e=>{try{t.data=JSON.parse(e,n.reviver),i(t)}catch(e){e.headers=t.headers,apply(t,e),s(e)}})):i(t)})).catch((e=>{e.timeout=i&&i.signal.aborted,s(e)}))}))}var l,d,p,y,v,g=send.bind(send,"GET"),m=send.bind(send,"POST"),A=send.bind(send,"PATCH"),w=send.bind(send,"DELETE"),E=send.bind(send,"PUT"),S={del:w,get:g,patch:A,post:m,put:E,send:send},$=_mergeNamespaces({__proto__:null,default:S,del:w,get:g,patch:A,post:m,put:E,send:send},[S]),b=function(){function HTTP(e){this.client=e}return HTTP.prototype.get=function(e,t){return void 0===t&&(t={}),this.request("get",e,t)},HTTP.prototype.post=function(e,t){return void 0===t&&(t={}),this.request("post",e,t)},HTTP.prototype.del=function(e,t){return void 0===t&&(t={}),this.request("del",e,t)},HTTP.prototype.put=function(e,t){return void 0===t&&(t={}),this.request("put",e,t)},HTTP.prototype.request=function(e,t,r){return void 0===r&&(r={}),$[e](this.client.getHttpEndpoint(t),this.getOptions(r)).catch((function(e){var t;throw new n(e.statusCode||-1,(null===(t=e.data)||void 0===t?void 0:t.error)||e.statusMessage||e.message||"offline")}))},HTTP.prototype.getOptions=function(e){return this.authToken&&(e.headers||(e.headers={}),e.headers.Authorization="Bearer ".concat(this.authToken),e.withCredentials=!0),e},HTTP}();function getStorage(){if(!l)try{l="undefined"!=typeof cc&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:window.localStorage}catch(e){}return l||(l={cache:{},setItem:function(e,t){this.cache[e]=t},getItem:function(e){this.cache[e]},removeItem:function(e){delete this.cache[e]}}),l}var O,T=function(){function Auth(e){var t=this;this.http=e,this.settings={path:"/auth",key:"colyseus-auth-token"},d.set(this,!1),p.set(this,void 0),y.set(this,void 0),v.set(this,{emit:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=this.events[e]||[],i=0,o=r.length;i<o;i++)r[i].apply(r,t)},events:{},on:function(e,t){var n,r=this;return(null===(n=this.events[e])||void 0===n?void 0:n.push(t))||(this.events[e]=[t]),function(){var n;r.events[e]=null===(n=r.events[e])||void 0===n?void 0:n.filter((function(e){return t!==e}))}}}),function getItem(e,t){var n=getStorage().getItem(e);"undefined"!=typeof Promise&&n instanceof Promise?n.then((function(e){return t(e)})):t(n)}(this.settings.key,(function(e){return t.token=e}))}return Object.defineProperty(Auth.prototype,"token",{get:function(){return this.http.authToken},set:function(e){this.http.authToken=e},enumerable:!1,configurable:!0}),Auth.prototype.onChange=function(e){var t=this,n=__classPrivateFieldGet(this,v,"f").on("change",e);return __classPrivateFieldGet(this,d,"f")||__classPrivateFieldSet(this,p,new Promise((function(e,n){t.getUserData().then((function(e){t.emitChange(__assign(__assign({},e),{token:t.token}))})).catch((function(e){t.emitChange({user:null,token:void 0})})).finally((function(){e()}))})),"f"),__classPrivateFieldSet(this,d,!0,"f"),n},Auth.prototype.getUserData=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return this.token?[4,this.http.get("".concat(this.settings.path,"/userdata"))]:[3,2];case 1:return[2,e.sent().data];case 2:throw new Error("missing auth.token")}}))}))},Auth.prototype.registerWithEmailAndPassword=function(e,t,n){return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(i){switch(i.label){case 0:return[4,this.http.post("".concat(this.settings.path,"/register"),{body:{email:e,password:t,options:n}})];case 1:return r=i.sent().data,this.emitChange(r),[2,r]}}))}))},Auth.prototype.signInWithEmailAndPassword=function(e,t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.http.post("".concat(this.settings.path,"/login"),{body:{email:e,password:t}})];case 1:return n=r.sent().data,this.emitChange(n),[2,n]}}))}))},Auth.prototype.signInAnonymously=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return[4,this.http.post("".concat(this.settings.path,"/anonymous"),{body:{options:e}})];case 1:return t=n.sent().data,this.emitChange(t),[2,t]}}))}))},Auth.prototype.sendPasswordResetEmail=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.http.post("".concat(this.settings.path,"/forgot-password"),{body:{email:e}})];case 1:return[2,t.sent().data]}}))}))},Auth.prototype.signInWithProvider=function(e,t){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){return[2,new Promise((function(r,i){var o=t.width||480,s=t.height||768,a=n.token?"?token=".concat(n.token):"",c="Login with ".concat(e[0].toUpperCase()+e.substring(1)),h=n.http.client.getHttpEndpoint("".concat(t.prefix||"".concat(n.settings.path,"/provider"),"/").concat(e).concat(a)),f=screen.width/2-o/2,u=screen.height/2-s/2;__classPrivateFieldSet(n,y,window.open(h,c,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+s+", top="+u+", left="+f),"f");var onMessage=function(e){void 0===e.data.user&&void 0===e.data.token||(clearInterval(l),__classPrivateFieldGet(n,y,"f").close(),__classPrivateFieldSet(n,y,void 0,"f"),window.removeEventListener("message",onMessage),void 0!==e.data.error?i(e.data.error):(r(e.data),n.emitChange(e.data)))},l=setInterval((function(){__classPrivateFieldGet(n,y,"f")&&!__classPrivateFieldGet(n,y,"f").closed||(__classPrivateFieldSet(n,y,void 0,"f"),i("cancelled"),window.removeEventListener("message",onMessage))}),200);window.addEventListener("message",onMessage)}))]}))}))},Auth.prototype.signOut=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return this.emitChange({user:null,token:null}),[2]}))}))},Auth.prototype.emitChange=function(e){void 0!==e.token&&(this.token=e.token,null===e.token?function removeItem(e){getStorage().removeItem(e)}(this.settings.key):function setItem(e,t){getStorage().setItem(e,t)}(this.settings.key,e.token)),__classPrivateFieldGet(this,v,"f").emit("change",e)},Auth}();d=new WeakMap,p=new WeakMap,y=new WeakMap,v=new WeakMap;var C=function(e){function MatchMakeError(t,n){var r=e.call(this,t)||this;return r.code=n,Object.setPrototypeOf(r,MatchMakeError.prototype),r}return __extends(MatchMakeError,e),MatchMakeError}(Error),I="undefined"!=typeof window&&void 0!==(null===(O=null===window||void 0===window?void 0:window.location)||void 0===O?void 0:O.hostname)?"".concat(window.location.protocol.replace("http","ws"),"//").concat(window.location.hostname).concat(window.location.port&&":".concat(window.location.port)):"ws://127.0.0.1:2567",R=function(){function Client(e){if(void 0===e&&(e=I),"string"==typeof e){var t=new URL(e),n="https:"===t.protocol||"wss:"===t.protocol,r=Number(t.port||(n?443:80));this.settings={hostname:t.hostname,pathname:t.pathname,port:r,secure:n}}else void 0===e.port&&(e.port=e.secure?443:80),void 0===e.pathname&&(e.pathname=""),this.settings=e;this.settings.pathname.endsWith("/")&&(this.settings.pathname=this.settings.pathname.slice(0,-1)),this.http=new b(this),this.auth=new T(this.http)}return Client.prototype.joinOrCreate=function(e,t,n){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.createMatchMakeRequest("joinOrCreate",e,t,n)];case 1:return[2,r.sent()]}}))}))},Client.prototype.create=function(e,t,n){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.createMatchMakeRequest("create",e,t,n)];case 1:return[2,r.sent()]}}))}))},Client.prototype.join=function(e,t,n){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.createMatchMakeRequest("join",e,t,n)];case 1:return[2,r.sent()]}}))}))},Client.prototype.joinById=function(e,t,n){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.createMatchMakeRequest("joinById",e,t,n)];case 1:return[2,r.sent()]}}))}))},Client.prototype.reconnect=function(e,t){return __awaiter(this,void 0,void 0,(function(){var n,r,i;return __generator(this,(function(o){switch(o.label){case 0:if("string"==typeof e&&"string"==typeof t)throw new Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");if(n=e.split(":"),r=n[0],i=n[1],!r||!i)throw new Error("Invalid reconnection token format.\nThe format should be roomId:reconnectionToken");return[4,this.createMatchMakeRequest("reconnect",r,{reconnectionToken:i},t)];case 1:return[2,o.sent()]}}))}))},Client.prototype.getAvailableRooms=function(e){return void 0===e&&(e=""),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.http.get("matchmake/".concat(e),{headers:{Accept:"application/json"}})];case 1:return[2,t.sent().data]}}))}))},Client.prototype.consumeSeatReservation=function(e,t,r){return __awaiter(this,void 0,void 0,(function(){var i,o,s,a=this;return __generator(this,(function(c){return(i=this.createRoom(e.room.name,t)).roomId=e.room.roomId,i.sessionId=e.sessionId,o={sessionId:i.sessionId},e.reconnectionToken&&(o.reconnectionToken=e.reconnectionToken),s=r||i,i.connect(this.buildEndpoint(e.room,o),e.devMode&&function(){return __awaiter(a,void 0,void 0,(function(){var n,r,o=this;return __generator(this,(function(a){return console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," Re-establishing connection with room id '").concat(i.roomId,"'...")),n=0,8,r=function(){return __awaiter(o,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:n++,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.consumeSeatReservation(e,t,s)];case 2:return o.sent(),console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(9989)," Successfully re-established connection with room '").concat(i.roomId,"'")),[3,4];case 3:return o.sent(),n<8?(console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," retrying... (").concat(n," out of ").concat(8,")")),setTimeout(r,2e3)):console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(10060)," Failed to reconnect. Is your server running? Please check server logs.")),[3,4];case 4:return[2]}}))}))},setTimeout(r,2e3),[2]}))}))},s),[2,new Promise((function(e,t){var onError=function(e,r){return t(new n(e,r))};s.onError.once(onError),s.onJoin.once((function(){s.onError.remove(onError),e(s)}))}))]}))}))},Client.prototype.createMatchMakeRequest=function(e,t,n,r,i){return void 0===n&&(n={}),__awaiter(this,void 0,void 0,(function(){var o;return __generator(this,(function(s){switch(s.label){case 0:return[4,this.http.post("matchmake/".concat(e,"/").concat(t),{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)})];case 1:if((o=s.sent().data).error)throw new C(o.error,o.code);return"reconnect"===e&&(o.reconnectionToken=n.reconnectionToken),[4,this.consumeSeatReservation(o,r,i)];case 2:return[2,s.sent()]}}))}))},Client.prototype.createRoom=function(e,t){return new u(e,t)},Client.prototype.buildEndpoint=function(e,t){void 0===t&&(t={});var n=[];for(var r in t)t.hasOwnProperty(r)&&n.push("".concat(r,"=").concat(t[r]));var i=this.settings.secure?"wss://":"ws://";return e.publicAddress?i+="".concat(e.publicAddress):i+="".concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname),"".concat(i,"/").concat(e.processId,"/").concat(e.roomId,"?").concat(n.join("&"))},Client.prototype.getHttpEndpoint=function(e){void 0===e&&(e="");var t=e.startsWith("/")?e:"/".concat(e);return"".concat(this.settings.secure?"https":"http","://").concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname).concat(t)},Client.prototype.getEndpointPort=function(){return 80!==this.settings.port&&443!==this.settings.port?":".concat(this.settings.port):""},Client}(),x=function(){function SchemaSerializer(){}return SchemaSerializer.prototype.setState=function(e){return this.state.decode(e)},SchemaSerializer.prototype.getState=function(){return this.state},SchemaSerializer.prototype.patch=function(e){return this.state.decode(e)},SchemaSerializer.prototype.teardown=function(){var e,t;null===(t=null===(e=this.state)||void 0===e?void 0:e.$changes)||void 0===t||t.root.clearRefs()},SchemaSerializer.prototype.handshake=function(e,t){this.state?(new f.Reflection).decode(e,t):this.state=f.Reflection.decode(e,t)},SchemaSerializer}(),P=function(){function NoneSerializer(){}return NoneSerializer.prototype.setState=function(e){},NoneSerializer.prototype.getState=function(){return null},NoneSerializer.prototype.patch=function(e){},NoneSerializer.prototype.teardown=function(){},NoneSerializer.prototype.handshake=function(e){},NoneSerializer}();registerSerializer("schema",x),registerSerializer("none",P),e.Auth=T,e.Client=R,e.Room=u,e.SchemaSerializer=x,e.registerSerializer=registerSerializer,Object.defineProperty(e,"__esModule",{value:!0})}));var EndTeleporter=pc.createScript("endTeleporter");EndTeleporter.prototype.initialize=function(){this.rotationValue=this.entity.getLocalEulerAngles(),this.rotationTween=this.entity.tween(this.rotationValue).to(new pc.Vec3(0,179,0),1,pc.Linear).onUpdate((function(){pc.app.fire("endTeleporter:rotationUpdate")}),this).loop(!0),this.endTeleporterLock=!1,this.app.on("endTeleporter:rotationUpdate",this.onRotationUpdate,this),this.rotationTween.start(),this.entity.collision.on("contact",(e=>{console.log("[DEBUG] entered end teleporter 1"),"Player"!==e.other.name||this.endTeleporterLock||(this.app.fire("endTeleporter:completeRun",e),this.endTeleporterLock=!0,setTimeout(function(){this.endTeleporterLock=!1}.bind(this),500))}),this)},EndTeleporter.prototype.onRotationUpdate=function(){this.entity.setLocalEulerAngles(this.rotationValue)};var RebirthTeleporter=pc.createScript("rebirthTeleporter");RebirthTeleporter.prototype.initialize=function(){this.rotationValue=this.entity.getLocalEulerAngles(),this.rotationTween=this.entity.tween(this.rotationValue).to(new pc.Vec3(0,179,0),1,pc.Linear).onUpdate((()=>{this.onRotationUpdate()}),this).loop(!0),this.rebirthTeleporterLock=!1,this.rotationTween.start(),this.entity.collision.on("contact",(function(t){console.log("[DEBUG]rebirth teleporter enter 1"),"Player"!==t.other.name||this.rebirthTeleporterLock||(this.app.fire("rebirthTeleporter:rebirth",t),this.rebirthTeleporterLock=!0,setTimeout(function(){this.rebirthTeleporterLock=!1}.bind(this),500))}),this)},RebirthTeleporter.prototype.onRotationUpdate=function(){this.entity.setLocalEulerAngles(this.rotationValue)};var TouchInput=pc.createScript("touchInput");TouchInput.attributes.add("orbitSensitivity",{type:"number",default:.4,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),TouchInput.attributes.add("distanceSensitivity",{type:"number",default:.2,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),TouchInput.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.lastTouchPoint=new pc.Vec2,this.lastPinchMidPoint=new pc.Vec2,this.lastPinchDistance=0,this.orbitCamera&&this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.on("destroy",(function(){this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)})))},TouchInput.prototype.getPinchDistance=function(t,i){var o=t.x-i.x,n=t.y-i.y;return Math.sqrt(o*o+n*n)},TouchInput.prototype.calcMidPoint=function(t,i,o){o.set(i.x-t.x,i.y-t.y),o.scale(.5),o.x+=t.x,o.y+=t.y},TouchInput.prototype.onTouchStartEndCancel=function(t){var i=t.touches;1==i.length?this.lastTouchPoint.set(i[0].x,i[0].y):2==i.length&&(this.lastPinchDistance=this.getPinchDistance(i[0],i[1]),this.calcMidPoint(i[0],i[1],this.lastPinchMidPoint))},TouchInput.fromWorldPoint=new pc.Vec3,TouchInput.toWorldPoint=new pc.Vec3,TouchInput.worldDiff=new pc.Vec3,TouchInput.prototype.pan=function(t){var i=TouchInput.fromWorldPoint,o=TouchInput.toWorldPoint,n=TouchInput.worldDiff,h=this.entity.camera,c=this.orbitCamera.distance;h.screenToWorld(t.x,t.y,c,i),h.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,c,o),n.sub2(o,i),this.orbitCamera.pivotPoint.add(n)},TouchInput.pinchMidPoint=new pc.Vec2,TouchInput.prototype.onTouchMove=function(t){var i=TouchInput.pinchMidPoint,o=t.touches;if(1==o.length){var n=o[0];this.orbitCamera.pitch-=(n.y-this.lastTouchPoint.y)*this.orbitSensitivity,this.orbitCamera.yaw-=(n.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.lastTouchPoint.set(n.x,n.y)}else if(2==o.length){var h=this.getPinchDistance(o[0],o[1]),c=h-this.lastPinchDistance;this.lastPinchDistance=h,this.orbitCamera.distance-=c*this.distanceSensitivity*.1*(.1*this.orbitCamera.distance),this.calcMidPoint(o[0],o[1],i),this.pan(i),this.lastPinchMidPoint.copy(i)}};var OrbitCamera=pc.createScript("orbitCamera");OrbitCamera.attributes.add("autoRender",{type:"boolean",default:!0,title:"Auto Render",description:"Disable to only render when camera is moving (saves power when the camera is still)"}),OrbitCamera.attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),OrbitCamera.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"}),OrbitCamera.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"}),OrbitCamera.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"}),OrbitCamera.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),OrbitCamera.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),OrbitCamera.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(OrbitCamera.prototype,"distance",{get:function(){return this._targetDistance},set:function(t){this._targetDistance=this._clampDistance(t)}}),Object.defineProperty(OrbitCamera.prototype,"pitch",{get:function(){return this._targetPitch},set:function(t){this._targetPitch=this._clampPitchAngle(t)}}),Object.defineProperty(OrbitCamera.prototype,"yaw",{get:function(){return this._targetYaw},set:function(t){this._targetYaw=t;var i=(this._targetYaw-this._yaw)%360;this._targetYaw=i>180?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i}}),Object.defineProperty(OrbitCamera.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.copy(t)}}),OrbitCamera.prototype.focus=function(t){this._buildAabb(t,0);var i=this._modelsAabb.halfExtents,e=Math.max(i.x,Math.max(i.y,i.z));e/=Math.tan(.5*this.entity.camera.fov*pc.math.DEG_TO_RAD),e*=2,this.distance=e,this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},OrbitCamera.distanceBetween=new pc.Vec3,OrbitCamera.prototype.resetAndLookAtPoint=function(t,i){this.pivotPoint.copy(i),this.entity.setPosition(t),this.entity.lookAt(i);var e=OrbitCamera.distanceBetween;e.sub2(i,t),this.distance=e.length(),this.pivotPoint.copy(i);var a=this.entity.getRotation();this.yaw=this._calcYaw(a),this.pitch=this._calcPitch(a,this.yaw),this._removeInertia(),this._updatePosition(),this.autoRender||(this.app.renderNextFrame=!0)},OrbitCamera.prototype.resetAndLookAtEntity=function(t,i){this._buildAabb(i,0),this.resetAndLookAtPoint(t,this._modelsAabb.center)},OrbitCamera.prototype.reset=function(t,i,e){this.pitch=i,this.yaw=t,this.distance=e,this._removeInertia(),this.autoRender||(this.app.renderNextFrame=!0)},OrbitCamera.prototype.initialize=function(){this._checkAspectRatio(),this._modelsAabb=new pc.BoundingBox,this._buildAabb(this.focusEntity||this.app.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new pc.Vec3,this._pivotPoint.copy(this._modelsAabb.center),this._lastFramePivotPoint=this._pivotPoint.clone();var t=this.entity.getRotation();if(this._yaw=this._calcYaw(t),this._pitch=this._clampPitchAngle(this._calcPitch(t,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var i=new pc.Vec3;i.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(i.length())}this._targetDistance=this._distance,this._autoRenderDefault=this.app.autoRender,this.app.autoRender&&(this.app.autoRender=this.autoRender),this.autoRender||(this.app.renderNextFrame=!0),this.on("attr:autoRender",(function(t,i){this.app.autoRender=t,this.autoRender||(this.app.renderNextFrame=!0)}),this),this.on("attr:distanceMin",(function(t,i){this._targetDistance=this._clampDistance(this._distance)}),this),this.on("attr:distanceMax",(function(t,i){this._targetDistance=this._clampDistance(this._distance)}),this),this.on("attr:pitchAngleMin",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)}),this),this.on("attr:pitchAngleMax",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)}),this),this.on("attr:focusEntity",(function(t,i){this.frameOnStart?this.focus(t||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),t||this.app.root)}),this),this.on("attr:frameOnStart",(function(t,i){t&&this.focus(this.focusEntity||this.app.root)}),this);var onResizeCanvas=function(){this._checkAspectRatio(),this.autoRender||(this.app.renderNextFrame=!0)};this.app.graphicsDevice.on("resizecanvas",onResizeCanvas,this),this.on("destroy",(function(){this.app.graphicsDevice.off("resizecanvas",onResizeCanvas,this),this.app.autoRender=this._autoRenderDefault}),this)},OrbitCamera.prototype.update=function(t){if(!this.autoRender){var i=Math.abs(this._targetDistance-this._distance),e=Math.abs(this._targetYaw-this._yaw),a=Math.abs(this._targetPitch-this._pitch),s=this._lastFramePivotPoint.distance(this._pivotPoint);this.app.renderNextFrame=this.app.renderNextFrame||i>.01||e>.01||a>.01||s>0}var n=0===this.inertiaFactor?1:Math.min(t/this.inertiaFactor,1);this._distance=pc.math.lerp(this._distance,this._targetDistance,n),this._yaw=pc.math.lerp(this._yaw,this._targetYaw,n),this._pitch=pc.math.lerp(this._pitch,this._targetPitch,n),this._lastFramePivotPoint.copy(this._pivotPoint),this._updatePosition()},OrbitCamera.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var t=this.entity.getPosition();t.copy(this.entity.forward),t.scale(-this._distance),t.add(this.pivotPoint),this.entity.setPosition(t)},OrbitCamera.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},OrbitCamera.prototype._checkAspectRatio=function(){var t=this.app.graphicsDevice.height,i=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=t>i},OrbitCamera.prototype._buildAabb=function(t,i){var e,a=0,s=0;if(t instanceof pc.Entity){var n=[],r=t.findComponents("render");for(a=0;a<r.length;++a)if(e=r[a].meshInstances)for(s=0;s<e.length;s++)n.push(e[s]);var h=t.findComponents("model");for(a=0;a<h.length;++a)if(e=h[a].meshInstances)for(s=0;s<e.length;s++)n.push(e[s]);for(a=0;a<n.length;a++)0===i?this._modelsAabb.copy(n[a].aabb):this._modelsAabb.add(n[a].aabb),i+=1}for(a=0;a<t.children.length;++a)i+=this._buildAabb(t.children[a],i);return i},OrbitCamera.prototype._calcYaw=function(t){var i=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,i),Math.atan2(-i.x,-i.z)*pc.math.RAD_TO_DEG},OrbitCamera.prototype._clampDistance=function(t){return this.distanceMax>0?pc.math.clamp(t,this.distanceMin,this.distanceMax):Math.max(t,this.distanceMin)},OrbitCamera.prototype._clampPitchAngle=function(t){return pc.math.clamp(t,-this.pitchAngleMax,-this.pitchAngleMin)},OrbitCamera.quatWithoutYaw=new pc.Quat,OrbitCamera.yawOffset=new pc.Quat,OrbitCamera.prototype._calcPitch=function(t,i){var e=OrbitCamera.quatWithoutYaw,a=OrbitCamera.yawOffset;a.setFromEulerAngles(0,-i,0),e.mul2(a,t);var s=new pc.Vec3;return e.transformVector(pc.Vec3.FORWARD,s),Math.atan2(s.y,-s.z)*pc.math.RAD_TO_DEG};var MouseInput=pc.createScript("mouseInput");MouseInput.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),MouseInput.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),MouseInput.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var t=this,onMouseOut=function(o){t.onMouseOut(o)};this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.addEventListener("mouseout",onMouseOut,!1),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.removeEventListener("mouseout",onMouseOut,!1)}))}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new pc.Vec2},MouseInput.fromWorldPoint=new pc.Vec3,MouseInput.toWorldPoint=new pc.Vec3,MouseInput.worldDiff=new pc.Vec3,MouseInput.prototype.pan=function(t){var o=MouseInput.fromWorldPoint,e=MouseInput.toWorldPoint,i=MouseInput.worldDiff,s=this.entity.camera,n=this.orbitCamera.distance;s.screenToWorld(t.x,t.y,n,o),s.screenToWorld(this.lastPoint.x,this.lastPoint.y,n,e),i.sub2(e,o),this.orbitCamera.pivotPoint.add(i)},MouseInput.prototype.onMouseDown=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!0;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!0}},MouseInput.prototype.onMouseUp=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!1;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!1}},MouseInput.prototype.onMouseMove=function(t){pc.app.mouse;this.lookButtonDown?(this.orbitCamera.pitch-=t.dy*this.orbitSensitivity,this.orbitCamera.yaw-=t.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)},MouseInput.prototype.onMouseWheel=function(t){this.orbitCamera.distance-=t.wheel*this.distanceSensitivity*(.1*this.orbitCamera.distance),t.event.preventDefault()},MouseInput.prototype.onMouseOut=function(t){this.lookButtonDown=!1,this.panButtonDown=!1};var KeyboardInput=pc.createScript("keyboardInput");KeyboardInput.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera},KeyboardInput.prototype.postInitialize=function(){this.orbitCamera&&(this.startDistance=this.orbitCamera.distance,this.startYaw=this.orbitCamera.yaw,this.startPitch=this.orbitCamera.pitch,this.startPivotPosition=this.orbitCamera.pivotPoint.clone())},KeyboardInput.prototype.update=function(t){this.orbitCamera&&this.app.keyboard.wasPressed(pc.KEY_SPACE)&&(this.orbitCamera.reset(this.startYaw,this.startPitch,this.startDistance),this.orbitCamera.pivotPoint=this.startPivotPosition)};var MyInstancer=pc.createScript("myInstancer");MyInstancer.attributes.add("excludeLayers",{type:"string",array:!0,default:["Depth","Skybox","Immediate","UI"],title:"Exclude Layers",description:"Mesh instances rendered in these layers won't be instanced."}),MyInstancer.attributes.add("excludeTag",{type:"string",default:"instancer-disable",title:"Exclude Tag",description:"An entity tag that can be used to exclude objects from instancing."}),MyInstancer.attributes.add("excludeCullingTag",{type:"string",default:"instancer-culling-disable",title:"Exclude Culling Tag",description:"An entity tag that can be used to exclude objects from frustum culling."}),MyInstancer.attributes.add("excludeVerticalCullingTag",{type:"string",default:"instancer-vertical-culling-disable",title:"Exclude Vertical Culling Tag",description:"An entity tag that can be used to exclude Vertical objects fromculling."}),MyInstancer.attributes.add("excludeCellsTag",{type:"string",default:"instancer-cells-disable",title:"Exclude Cells Tag",description:"An entity tag that can be used to exclude objects from cells."}),MyInstancer.attributes.add("skipCullingFrequencyTag",{type:"string",default:"skip-culling-frequency",title:"Exclude Culling Frequency Tag",description:"All instances of this mesh must have this for this to work."}),MyInstancer.attributes.add("frustumCulling",{type:"boolean",default:!1,title:"Frustum Culling"}),MyInstancer.attributes.add("cullingFrequency",{type:"number",default:300,title:"Culling Frequency",description:"Set the minimum frequency in ms between each culling update. Set to 0.0 to run per frame."}),MyInstancer.attributes.add("verticalDistance",{type:"number",default:50,title:"Vertical Distance",description:"Set the maximum vertical distance to allow."}),MyInstancer.attributes.add("lodLevels",{type:"json",title:"Lod Levels",array:!0,schema:[{name:"index",type:"number",default:0,precision:0,min:0,max:9,description:"The LOD index for this level e.g. 0 for LOD0, 1 for LOD 1 etc"},{name:"start",type:"number",default:0},{name:"end",type:"number",default:0}]}),MyInstancer.attributes.add("deformTag",{type:"string",default:"deform",title:"Deform Tag",description:"A tag to do mesh deformation on an entity"}),MyInstancer.attributes.add("deformationStrength",{type:"number",default:.15,title:"Deformation Strength"}),MyInstancer.attributes.add("deformationWaviness",{type:"number",default:1,title:"Deformation Waviness"}),MyInstancer.attributes.add("variableHIMaterial",{type:"asset",assetType:"material",title:"Variable HI Material",description:"A high-intensity material that can be applied dynamically."}),MyInstancer.attributes.add("cells",{type:"json",title:"Cells",schema:[{name:"enabled",type:"boolean",default:!1,title:"Enabled"},{name:"size",type:"vec3",default:[10,10,10],title:"Size",description:"The size of our cell."}]}),MyInstancer.attributes.add("levelCulling",{type:"boolean",default:!1,title:"Level Culling"}),MyInstancer.attributes.add("levelCullingDistance",{type:"number",default:250,title:"Level Culling Distance",description:"Set the distance on which to cull levels"});const elementsPerInstance=16;var MyInstancerLOD=pc.createScript("myInstancerLOD");MyInstancerLOD.attributes.add("lodLevels",{type:"json",title:"Lod Levels",array:!0,schema:[{name:"index",type:"number",default:0,precision:0,min:0,max:9,description:"The LOD index for this level e.g. 0 for LOD0, 1 for LOD 1 etc"},{name:"start",type:"number",default:0},{name:"end",type:"number",default:0}]}),MyInstancer.prototype.createChangeableMaterial=function(){const e=new pc.StandardMaterial;e.onUpdateShader=function(e){return e.useInstancing=!0,e};e.chunks.transformVS="\n\n    varying vec4 color;\n\n    mat4 getModelMatrix() {\n        color = vec4(instance_line1.w, instance_line2.w, instance_line3.w, instance_line4.w);\n        return mat4(\n            vec4(instance_line1.xyz, 0.0), \n            vec4(instance_line2.xyz, 0.0), \n            vec4(instance_line3.xyz, 0.0), \n            vec4(instance_line4.xyz, 1.0)\n        );\n    }\n\n    vec4 getPosition() {\n        dModelMatrix = getModelMatrix();\n        vec3 localPos = vertex_position;\n        vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n        dPositionW = posW.xyz;\n        vec4 screenPos = matrix_viewProjection * posW;\n        return screenPos;\n    }\n    vec3 getWorldPosition() {\n        return dPositionW;\n    }\n    ",e.chunks.emissivePS="\n    varying vec4 color;\n    vec3 getEmission() {\n        return color.rgb;\n    }\n    ",e.update(),this.baseMaterial=e},MyInstancer.prototype.globallyPatchShader=function(){pc.shaderChunks.transformVS="\n\nvarying vec4 color;\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\n\tuniform vec4 morph_tex_params;\n\t#ifdef WEBGPU\n\t\tivec2 getTextureMorphCoords() {\n\t\t\tivec2 textureSize = ivec2(morph_tex_params.xy);\n\t\t\tint morphGridV = int(morph_vertex_id / textureSize.x);\n\t\t\tint morphGridU = int(morph_vertex_id - (morphGridV * textureSize.x));\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t\treturn ivec2(morphGridU, morphGridV);\n\t\t}\n\t#else\n\t\tvec2 getTextureMorphCoords() {\n\t\t\tvec2 textureSize = morph_tex_params.xy;\n\t\t\tvec2 invTextureSize = morph_tex_params.zw;\n\t\t\tfloat morphGridV = floor(morph_vertex_id * invTextureSize.x);\n\t\t\tfloat morphGridU = morph_vertex_id - (morphGridV * textureSize.x);\n\t\t\treturn vec2(morphGridU, morphGridV) * invTextureSize + (0.5 * invTextureSize);\n\t\t}\n\t#endif\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\tcolor = vec4(instance_line1.w, instance_line2.w, instance_line3.w, instance_line4.w);\n    return mat4(vec4(instance_line1.xyz, 0.0), vec4(instance_line2.xyz, 0.0), vec4(instance_line3.xyz, 0.0), vec4(instance_line4.xyz, 1.0));\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\t\t#ifdef WEBGPU\n\t\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#else\n\t\t\tvec2 morphUV = getTextureMorphCoords();\n\t\t\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\tscreenPos.y *= projectionFlipY;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n    ",console.log("Global shader chunks patched.")},MyInstancer.prototype.initialize=function(){console.log("INITIALISING INSTANCER"),this.worldMatX=new pc.Vec3,this.worldMatY=new pc.Vec3,this.worldMatZ=new pc.Vec3,this.globallyPatchShader(),this.createChangeableMaterial(),MyInstancer.api=this,this.payloads={},this.cellsList={},this.prepare(),this.time=0,this.skipUpdateVertexBuffer=!1,this.app.on("update",this.onUpdate,this),this.app.on("scene:unload",this.cleanup,this)},MyInstancer.prototype.cleanup=function(e){console.log("Cleaning up instancer payloads and layers.");for(let e in this.payloads){const t=this.payloads[e];t.layer&&t.layer.removeMeshInstances([t.meshInstance],!0),t.buffer.vertexBuffer&&t.buffer.vertexBuffer.destroy()}this.payloads={},this.cellsList={},this.levels={}},MyInstancer.prototype.prepare=function(){console.log("CALLING INSTANCER PREPARE"),this.prepareLevels(),this.overrideEngine(),this.parseLayers()},MyInstancer.prototype.parseLayers=function(){const e=this.app.scene.layers.layerList;for(let t=0;t<e.length;t++){const n=e[t];if(!1===this.isLayerValid(n))continue;const i=n.meshInstances.filter((e=>e.material.blendType===pc.BLEND_NONE));n.removeMeshInstances(i),n.addMeshInstances(i)}},MyInstancer.prototype.onUpdate=function(e){if(this.time+=e,this.frustumCulling){const e=this.cellsList;for(let t in e){const n=e[t];for(let e in n.isCameraVisible)n.isCameraVisible[e]=void 0}const t=this.levels;for(let e in t){const n=t[e];for(let e in n.isCameraVisible)n.isCameraVisible[e]=void 0}}else{const e=this.payloads;for(let t in e)this.updatePayload(e[t])}},MyInstancer.prototype.getLevelNumber=function(e){const t=e.name.match(/level\s*(\d+)/i);return t?parseInt(t[1],10):null},MyInstancer.prototype.findLevelAncestor=function(e){let t=e;for(;t;){if(t.tags.has("level"))return t;t=t.parent}return null},MyInstancer.prototype.addMeshInstance=function(e,t,n,i){if(!e.material||e.mesh.skin||e.name&&e.name.includes("Text Element"))return!1;if("instancer-payload"===e.node.name)return!1;const s=e.node;if(!s)return!1;const a={"Block Color Blue":"blue","Block Color Cyan":"cyan","Block Color Green":"green","Block Color Indigo":"indigo","Block Color Orange":"orange","Block Color Red":"pink","Block Color Violet":"violet","Block Color Yellow":"yellow","Material Red":"red","Material Dark":"dark","Material Green":"green","Material Blue":"blue"},r=e.material.name;if(r in a){e.material=this.variableHIMaterial.resource;const t=rainbowColors[a[r]];s._instancerColorData=t}return!0!==s.tags.has(this.excludeTag)&&(!(s.render&&s.render.batchGroupId>-1)&&(i||this.addToPayload(s,e,t,!1),!n&&e.castShadow&&this.addToPayload(s,e,t,!0),!0))},MyInstancer.prototype.removeMeshInstance=function(e,t,n,i){if(!e.material||e.mesh.skin)return!1;if("instancer-payload"===e.node.name)return!1;let s;return i||(s=this.removeFromPayload(e,t,!1)),n||(s=this.removeFromPayload(e,t,!0)),s},MyInstancer.prototype.addToPayload=function(e,t,n,i){const s=this.getPayloadId(t,n,i);let a,r,o,l=this.payloads[s];if(e.tags.has("skip-culling-frequency")&&(a=!0),l||(l=this.createPayload(s,t,n,i,a)),e.name.indexOf("_LOD")>-1){const t=e.name.split("_LOD");r=parseInt(t[1]),o=e.script?.myInstancerLOD?.lodLevels}let c,d,p=!1,u=[];if(e.tags.has(this.deformTag)){e.findComponents("render").forEach((e=>{const t=e.meshInstances;for(let e=0;e<t.length;e++){const n=t[e].mesh,i=[];n.getPositions(i),u.push({mesh:n,srcPositions:i})}})),p=!0}if(this.cells.enabled&&!1===e.tags.has(this.excludeCellsTag)&&(c=this.getCell(e.getPosition(),this.cells.size)),this.levelCulling){const n=this.findLevelAncestor(e);n&&(d=this.getLevelNumber(n)),t.levelId=d}const h={cell:c,entity:e,lodIndex:r,lodLevels:o,excludeFromCulling:e.tags.has(this.excludeCullingTag),meshInstance:t,deformEntity:p,meshes:u,level:d};l.refMeshInstances.push(t),i?h.mainInstance=t.mainInstance:t.mainInstance=h,l.instances.push(h),this.skipUpdateVertexBuffer||this.updateVertexBuffer(l,!0),this.frustumCulling||this.updatePayload(l)},MyInstancer.prototype.getCell=function(e,t){const n=Math.max(t.x,1),i=Math.max(t.y,1),s=Math.max(t.z,1),a=Math.floor(e.x/n)*n,r=Math.floor(e.y/i)*i,o=Math.floor(e.z/s)*s,l=a.toFixed(0)+"_"+r.toFixed(0)+"_"+o.toFixed(0);let c=this.cellsList[l];if(!c){const e=new pc.Vec3(a,r,o),n=new pc.Vec3;n.x=t.x/2,n.y=t.y/2,n.z=t.z/2,c={aabb:new pc.BoundingBox(e,n),center:e,cullingRadius:1.35*n.length(),isCameraVisible:{}},this.cellsList[l]=c}return c},MyInstancer.prototype.removeFromPayload=function(e,t,n){const i=this.getPayloadId(e,t,n);let s=this.payloads[i];if(!s)return!1;if(s.refMeshInstances.length>0){const t=s.refMeshInstances.indexOf(e);if(-1===t)return!1;s.instances.splice(t,1),s.refMeshInstances.splice(t,1)}0===s.instances.length?(this.clearPayload(s),delete this.payloads[i]):(this.updateVertexBuffer(s,!0),this.frustumCulling||this.updatePayload(s))},MyInstancer.prototype.clearPayload=function(e){e.buffer.vertexBuffer.destroy(),e.layer.removeMeshInstances([e.meshInstance],!0)},MyInstancer.prototype.updatePayload=function(e,t){let n;if(t&&this.cullingFrequency>0&&!e.skipCullingFrequency){const t=pc.now();if(n=t-e.cullingFrequencyTime,n<this.cullingFrequency)return;e.cullingFrequencyTime=t}let i=0;const s=e.instances;for(let a=0;a<s.length;a++){const r=s[a];i=this.updateInstance(r,e,i,t,n)}const a=i/16;this.updateVertexBuffer(e,!1,a)},MyInstancer.prototype.updateInstance=function(e,t,n,i){const s=t.buffer.originalStorage;if(i){if(!1===e.excludeFromCulling){if(!this.cullInstance(e,i))return n}if(void 0!==e.lodIndex&&this.lodLevels.length>0){if(!this.isLodVisible(e,i))return n}if(e.deformEntity){const t=[],n=e.meshes[0];t.length=0;const i=n.srcPositions;for(let e=0;e<i.length;e+=3)t[e]=i[e]+this.deformationStrength*Math.sin(this.time+i[e+1]*this.deformationWaviness),t[e+1]=i[e+1],t[e+2]=i[e+2]+this.deformationStrength*Math.sin(this.time+i[e+1]*this.deformationWaviness);const s=n.mesh;s.setPositions(t),s.update()}}const a=e.entity.getWorldTransform().data,r=e.entity._instancerColorData;if(r)for(let e=0;e<16;e++)s[n++]=3===e?r.r:7===e?r.g:11===e?r.b:15===e?1:a[e];else for(let e=0;e<16;e++)s[n++]=a[e];return n},MyInstancer.prototype.cullInstance=function(e,t){const n=e.level;if(n&&0!==n)return this.isLevelVisible(n,t);if(e.cell)return this.isCellVisible(e.cell,t);{const n=e.meshInstance;let i=n._isVisible(t);return n.visibleThisFrame=i,i>0}},MyInstancer.prototype.levels={},MyInstancer.prototype.prepareLevels=function(){if(!this.levelCulling)return;const e=this.app.root.findByTag("level");for(let t=0;t<e.length;t++){const n=e[t],i=n.findByName("Checkpoint Area");let s=null;if(i){const e=i.findByName("platform_011");e&&e.render?s=e.render.meshInstances[0].aabb.clone():console.warn(`"platform_011" not found or has no render component in level: ${n.name}`)}else console.warn(`"Checkpoint Area" not found in level: ${n.name}`);const a=this.getLevelNumber(n);this.levels[a]={level:n,aabb:s,isCameraVisible:{},platformEntity:s},s||console.warn(`No valid AABB found for level: ${n.name}`)}},MyInstancer.prototype.isLevelVisible=function(e,t){const n=this.levels[e];if(!n.aabb)return!1;const i=t.node._guid;if(void 0!==n.isCameraVisible[i])return n.isCameraVisible[i];{const e=t.node.getPosition(),s=n.aabb.center,a=e.distance(s)<this.levelCullingDistance;return n.isCameraVisible[i]=a,a}},MyInstancer.tempSphere=new pc.BoundingSphere,MyInstancer.prototype.isCellVisible=function(e,t){const n=t.node._guid;if(void 0!==e.isCameraVisible[n])return e.isCameraVisible[n];{const i=MyInstancer.tempSphere;i.center=e.center,i.radius=e.cullingRadius;const s=t.frustum.containsSphere(i);return e.isCameraVisible[n]=s,s}},MyInstancer.prototype.isLodVisible=function(e,t){if(e.mainInstance)return e.mainInstance.isLodVisible;const n=e.lodLevels?e.lodLevels[e.lodIndex]:this.lodLevels[e.lodIndex],i=t.node.getPosition().distance(e.entity.getPosition()),s=n.start;let a=n.end>0?n.end:1/0;a>t.farClip&&(a=t.farClip);const r=i>=s&&i<a;return e.mainInstance||(e.isLodVisible=r),r},MyInstancer.prototype.updateVertexBuffer=function(e,t,n){const i=e.buffer,s=e.meshInstance;let a;if(a=void 0!==n?n:e.instances.length,a>0||!i.vertexBuffer){let n;if(n=t||!i.originalStorage?i.originalStorage=new Float32Array(16*a):i.originalStorage.subarray(0,16*a),a>i.instancesCount||!i.vertexBuffer){i.vertexBuffer&&i.vertexBuffer.destroy();const e=pc.VertexFormat.defaultInstancingFormat?pc.VertexFormat.defaultInstancingFormat:pc.VertexFormat.getDefaultInstancingFormat(this.app.graphicsDevice),t=new pc.VertexBuffer(this.app.graphicsDevice,e,a,pc.BUFFER_STATIC,n);s.setInstancing(t,!0),i.vertexBuffer=t}else{const t=i.vertexBuffer,s=t.format;t.numBytes=s.verticesByteSize?s.verticesByteSize:s.size*a,t.setData(n),e.meshInstance.instancingCount=a}}i.instancesCount=a,s.instancingCount=a},MyInstancer.prototype.createPayload=function(e,t,n,i,s){const a=this.getPayloadMaterial(t.material),r=new pc.MeshInstance(t.mesh,a,new pc.GraphNode("instancer-payload"));r.castShadow=i,r.aabb.center.copy(t.aabb.center),r.aabb.halfExtents.copy(t.aabb.halfExtents),i?n.addShadowCasters([r]):n.addMeshInstances([r]);const o={buffer:{instancesCount:0,originalStorage:void 0,vertexBuffer:void 0},cullingFrequencyTime:void 0,id:e,instances:[],layer:n,meshInstance:r,refMeshInstances:[],shadowCaster:i,skipCullingFrequency:s};return this.setPayloadCulling(this.frustumCulling,o),this.payloads[e]=o,o},MyInstancer.prototype.setPayloadCulling=function(e,t){t.meshInstance.cull=e,e&&(t.meshInstance.isVisibleFunc=e=>this.isMeshInstanceVisible(e,t))},MyInstancer.prototype.isMeshInstanceVisible=function(e,t){return this.updatePayload(t,e),!0},MyInstancer.prototype.getPayloadMaterial=function(e){return e.onUpdateShader=function(e){return e.litOptions.useInstancing=!0,e},e.update(),e},MyInstancer.prototype.getPayloadId=function(e,t,n){return`${t.id}_${e.mesh.id}_${e.material.id}_${n?1:0}`},MyInstancer.prototype.isLayerValid=function(e){return-1===this.excludeLayers.indexOf(e.name)},MyInstancer.prototype.overrideEngine=function(){const e=pc.Layer.prototype.addMeshInstances;pc.Layer.prototype.addMeshInstances=function(t,n){if(!0===MyInstancer.api.isLayerValid(this)){let i=[];for(const e of t){MyInstancer.api.addMeshInstance(e,layer=this,n,!1)||i.push(e)}arguments[0]=i,e.apply(this,arguments)}else e.apply(this,arguments)};const t=pc.Layer.prototype.removeMeshInstances;pc.Layer.prototype.removeMeshInstances=function(e,n){if(!0===MyInstancer.api.isLayerValid(this)){let i=[];for(const t of e){MyInstancer.api.removeMeshInstance(t,layer=this,n,!1)||i.push(t)}arguments[0]=i,t.apply(this,arguments)}else t.apply(this,arguments)};const n=pc.Layer.prototype.addShadowCasters;pc.Layer.prototype.addShadowCasters=function(e){if(!0===MyInstancer.api.isLayerValid(this)){let t=[];for(const n of e){MyInstancer.api.addMeshInstance(n,layer=this,!1,!0)||t.push(n)}arguments[0]=t,n.apply(this,arguments)}else n.apply(this,arguments)};const i=pc.Layer.prototype.removeShadowCasters;pc.Layer.prototype.removeShadowCasters=function(e){if(!0===MyInstancer.api.isLayerValid(this)){let t=[];for(const n of e){MyInstancer.api.removeMeshInstance(n,layer=this,!1,!0)||t.push(n)}arguments[0]=t,i.apply(this,arguments)}else i.apply(this,arguments)}};var CameraMovement=pc.createScript("cameraMovement");CameraMovement.attributes.add("zoomIgnoreTag",{type:"string",title:"Zoom Ignore Tag",description:"Ignore tag for zoom",default:"camera-zoom-ignore"}),CameraMovement.attributes.add("mouseSpeed",{type:"number",default:1.4,description:"Mouse Sensitivity"}),CameraMovement.attributes.add("cameraDistanceMin",{type:"number",default:3,description:"Camera Distance"}),CameraMovement.attributes.add("cameraDistanceMax",{type:"number",default:10,description:"Camera Distance"}),CameraMovement.prototype.initialize=function(){this.eulers=new pc.Vec3,this.eulers.y=20,this.eulers.x=-90,this.eulers.z=100,this.entity.setLocalEulerAngles(this.eulers.x,this.eulers.y,this.eulers.z),this.touchCoords=new pc.Vec2;var e=this.app;e.mouse.on("mousemove",this.onMouseMove,this),e.mouse.on("mousedown",this.onMouseDown,this),e.mouse.on("mousewheel",this.onMouseWheel,this),this.mouseLockAllowed=!1,this.app.on("gameplay:currentPlayState",(e=>{"playing"===e?(this.mouseLockAllowed=!0,this.app.mouse.enablePointerLock()):(this.mouseLockAllowed=!1,this.app.mouse.disablePointerLock())}),this),this.rayEnd=e.root.findByName("RaycastEndPoint"),this.cameraDistanceTween,this.on("destroy",(function(){e.mouse.off("mousemove",this.onMouseMove,this),e.mouse.off("mousedown",this.onMouseDown,this),e.mouse.off("mousewheel",this.onMouseWheel,this),e.off("optimizeSettings:defaultCameraDistance",this.applyDeviceSettings,this)}),this),this.nearestRayCastHit=new pc.Vec3,this.nearestRayCastHitFraction=1,this.cloudCamera=e.root.findByName("CloudCamera"),this.mouseMovementUpdate=!1,this.updateCounter=0,this.allowZoom=!0,this.app.on("gameplay:currentPlayState",(e=>{this.allowZoom="playing"===e}),this)},CameraMovement.prototype.postUpdate=function(e){var t=window.touchJoypad.sticks.joystick1;if(t&&(0!==t.x||0!==t.y)&&!this.mouseMovementUpdate){var s=t.x,o=-t.y,i=this.eulers.x-this.mouseSpeed*s*e*75,a=this.eulers.y+this.mouseSpeed*o*e*75;i=(i+360)%360,a=Math.max(Math.min(a,89.9),-15),this.eulers.x=i,this.eulers.y=a,this.entity.setLocalEulerAngles(this.eulers.y,this.eulers.x,0)}this.cloudCamera&&(this.cloudCamera.setPosition(this.entity.getPosition()),this.cloudCamera.setRotation(this.entity.getRotation()));var n=this.entity.parent,r=this.eulers.x+180,h=this.eulers.y,u=new pc.Vec3(-h,r,0);n.setEulerAngles(u),this.updateCounter++,this.updateCounter>=4&&(this.entity.setPosition(this.getWorldPoint()),this.updateCounter=0),this.entity.lookAt(n.getPosition())},CameraMovement.prototype.onMouseWheel=function(e){if(!this.cameraDistanceTween&&this.allowZoom){let t=this.rayEnd.getLocalPosition().z,s=pc.math.clamp(t+e.wheelDelta,this.cameraDistanceMin,this.cameraDistanceMax);this.cameraDistanceTween=this.rayEnd.tween(this.rayEnd.getLocalPosition()).to(new pc.Vec3(0,0,s),.2,pc.SineOut).yoyo(!1).loop(!1).onComplete((()=>{this.cameraDistanceTween=null}),this).start()}},CameraMovement.prototype.onMouseMove=function(e){this.mouseMovementUpdate=!1;var t=window.touchJoypad.sticks.joystick1;if(pc.Mouse.isPointerLocked()&&(!t||0===t.x&&0===t.y)){var s=this.eulers.x-this.mouseSpeed*e.dx/60,o=this.eulers.y+this.mouseSpeed*e.dy/60;s=(s+360)%360;o=Math.max(Math.min(o,89.9),-15),this.eulers.x=s,this.eulers.y=o,this.mouseMovementUpdate=!0}},CameraMovement.prototype.onMouseDown=function(e){this.mouseLockAllowed&&this.app.mouse.enablePointerLock()},CameraMovement.prototype.getWorldPoint=function(){var e=this.entity.parent.getPosition(),t=this.rayEnd.getPosition();this.nearestRayCastHit=t,this.nearestRayCastHitFraction=1;for(var s=this.app.systems.rigidbody.raycastAll(e,t),o=0;o<s.length;++o)s[o].entity.tags.has(this.zoomIgnoreTag)||s[o].hitFraction<this.nearestRayCastHitFraction&&(this.nearestRayCastHit=s[o].point,this.nearestRayCastHitFraction=s[o].hitFraction);return s&&this.nearestRayCastHit?this.nearestRayCastHit:t};var MyCollider=pc.createScript("myCollider");MyCollider.attributes.add("groupByScale",{type:"number",default:.5,title:"Group By Scale"}),MyCollider.attributes.add("refEntity",{type:"entity",title:"Reference Entity"}),MyCollider.overrideInPlace=!1,MyCollider.prototype.initialize=function(){MyCollider.overrideInPlace||(MyCollider.overrideInPlace=!0,this.override())},MyCollider.prototype.postInitialize=function(){this.entity.collision&&(this.entity.collision.enabled=!0)},MyCollider.prototype.getMeshCacheId=function(e,t){return`${e}_${t}`},MyCollider.prototype.override=function(){this.app.systems.collision._createImplementation("mesh");const e=new pc.GraphNode,t=this.app.systems.collision.implementations.mesh;t.createAmmoMesh=function(e,t,o,r=!0,i){let n=e.id;const l=i.script?.myCollider,s=l?.groupByScale;if(s>0){const t=l.refEntity?l.refEntity:i,o=Math.floor(t.getLocalScale().x/s)*s;n=MyCollider.prototype.getMeshCacheId(e.id,o)}const c=this.system;let d;if(c._triMeshCache[n])d=c._triMeshCache[n];else{const t=e.vertexBuffer,o=t.getFormat();let i,l;for(let e=0;e<o.elements.length;e++){const r=o.elements[e];if(r.name===pc.SEMANTIC_POSITION){l=new Float32Array(t.lock(),r.offset),i=r.stride/4;break}}const s=[];e.getIndices(s);const m=e.primitive[0].count/3,h=new Ammo.btVector3;let y,p,f;const u=e.primitive[0].base;d=new Ammo.btTriangleMesh,c._triMeshCache[n]=d;const M=new Map;d.getIndexedMeshArray().at(0).m_numTriangles=m;const addVertex=e=>{const t=l[e*i],o=l[e*i+1],n=l[e*i+2];let s;if(r){const e=`${t}:${o}:${n}`;if(s=M.get(e),void 0!==s)return s;h.setValue(t,o,n),s=d.findOrAddVertex(h,!1),M.set(e,s)}else h.setValue(t,o,n),s=d.findOrAddVertex(h,!1);return s};for(var a=0;a<m;a++)y=addVertex(s[u+3*a]),p=addVertex(s[u+3*a+1]),f=addVertex(s[u+3*a+2]),d.addIndex(y),d.addIndex(p),d.addIndex(f);Ammo.destroy(h)}const m=new Ammo.btBvhTriangleMeshShape(d,!0),h=c._getNodeScaling(t);m.setLocalScaling(h),Ammo.destroy(h);const y=c._getNodeTransform(t);o.addChildShape(y,m),Ammo.destroy(y)}.bind(t),t.createPhysicalShape=function(t,o){if("undefined"!=typeof Ammo&&(o.model||o.render)){const r=new Ammo.btCompoundShape;if(o.model){const e=o.model.meshInstances;for(let i=0;i<e.length;i++)this.createAmmoMesh(e[i].mesh,e[i].node,r,o.checkVertexDuplicates,t)}else if(o.render){const i=o.render.meshes;for(let n=0;n<i.length;n++)this.createAmmoMesh(i[n],e,r,o.checkVertexDuplicates,t)}const i=t.getWorldTransform().getScale(),n=new Ammo.btVector3(i.x,i.y,i.z);return r.setLocalScaling(n),Ammo.destroy(n),r}}.bind(t)};var MyShadow=pc.createScript("myShadow");MyShadow.attributes.add("shadowTime",{type:"vec4",default:[0,.05,.25,.5],title:"Shadow Time"}),MyShadow.prototype.initialize=function(){this.shadowTimers=[1/0,1/0,1/0,1/0],this.shadowDurations=[0,0,0,0],this.shadowUpdateOverrides=[pc.SHADOWUPDATE_THISFRAME,pc.SHADOWUPDATE_THISFRAME,pc.SHADOWUPDATE_THISFRAME,pc.SHADOWUPDATE_THISFRAME],this.entity.light.shadowUpdateOverrides=this.shadowUpdateOverrides},MyShadow.prototype.update=function(t){const e=this.shadowTime,i=this.shadowTimers,s=this.shadowDurations,d=this.shadowUpdateOverrides;s[0]=e.x,s[1]=e.y,s[2]=e.z,s[3]=e.w;for(let e=0;e<4;e++){i[e]+=t;const a=i[e]>=s[e];d[e]=a?pc.SHADOWUPDATE_THISFRAME:pc.SHADOWUPDATE_NONE,a&&(i[e]=0)}this.entity.light.shadowUpdateOverrides=this.shadowUpdateOverrides};var NetworkManager=pc.createScript("networkManager");NetworkManager.prototype.init=async function(){this.updatesPerSecond=5,this.updateInterval=1/this.updatesPerSecond,this.updateLocked=!1,this.updateTimer=0;try{this.app.colyseus=new Colyseus.Client("https://us-ord-05cb11f5.colyseus.cloud")}catch(o){console.log("Failed to connect to Colyseus room. Switching to single-player mode.",o),this.app.singlePlayerMode=!0}this.app.on("networkManager:joinRoom",(async o=>{await this.joinRoom(o)})),this.app.on("gameplay:joinRoomRequest",(o=>{this.joinRoomById(o)}))},NetworkManager.prototype.joinRoom=async function(o){if(this.app.singlePlayerMode)return void this.app.fire("networkManager:joinRoomError");const{world:e,roomId:t}=o;console.log("RECEIVED JOIN ROOM",o);try{this.room&&await this.room.leave(),t?(console.log(`Joining room by ID: ${t}`),await this.registerRoom("joinById",t)):(console.log(`Joining or creating room for world: ${e}`),await this.registerRoom("joinOrCreate","animalObby",o)),console.log("Successfully joined room:",this.room.roomId),console.log("ROOM METADATA AFTER JOIN ROOM",this.room.metadata),e&&(this.app.currentWorld=e)}catch(o){console.error("Failed to join room:",o),this.app.fire("networkManager:joinRoomError",o)}},NetworkManager.prototype.joinRoomById=async function(o){if(this.app.singlePlayerMode)this.app.fire("networkManager:joinRoomError");else{this.app.root.findScript("gameplay");try{await this.registerRoom("joinById",o);const t=this.entity.script.animalChanger;var e=this.app.mainPlayer;let r=3;3===t.currentlyPressed&&(r=2),t.toggleSkins(e,r,!0);this.room.metadata;console.log("ROOM METADATA",this.room.metadata),console.log("joined successfully",this.room),this.app.fire("networkManager:joinSuccess",this.room)}catch(o){console.log("error joining room",o),this.app.fire("networkManager:joinRoomError",this.room)}}},NetworkManager.prototype.setupRoomHandlers=function(){this.room.onMessage("__playground_message_types",(o=>{console.log("message received from server"),console.log(o)})),this.room.connection.onclose=()=>{console.log("websocket connection closed"),this.app.fire("networkManager:connectionClosed")},this.room.connection.onerror=o=>{console.log("websocket connectione error",o),this.app.fire("networkManager:connectionError",o)}},NetworkManager.prototype.registerRoom=async function(o,e,t){if(t||(t={}),console.log("register room called",{identifier:e,options:t}),"create"===o)this.room=await this.app.colyseus.create(e,t);else if("joinOrCreate"===o)this.room=await this.app.colyseus.joinOrCreate(e,t);else if("joinById"===o){const o=await this.app.colyseus.joinById(e,t);o&&(await this.room.leave(),this.room=o)}this.app.root.findScript("gameplay").initPlayers(this.room,!0),this.app.connectedToRoom=!0,this.setupRoomHandlers();const stateChangeHandler=o=>{console.log("World (from state change):",o.world),this.app.fire("networkManager:roomJoined",{roomId:this.room.roomId,options:{world:o.world}}),this.room.onStateChange.remove(stateChangeHandler)};this.room.onStateChange(stateChangeHandler)},NetworkManager.prototype.createRoom=async function(o={}){if(this.app.singlePlayerMode)return console.log("app is in singleplayer mode"),void this.app.fire("networkManager:createRoomError");this.app.root.findScript("gameplay");try{this.app.connectedToRoom=!1,await this.room.leave(),console.log("Left room:",this.room.id),await this.registerRoom("create","animalObby",o),console.log("joined successfully",this.room),console.log("new room id:",this.room.roomId),this.app.connectedToRoom=!0;const t=this.entity.script.animalChanger;var e=this.app.mainPlayer;let r=3;return 3===t.currentlyPressed&&(r=2),t.toggleSkins(e,r,!0),this.room.roomId}catch(o){this.app.fire("networkManager:createRoomError"),console.log("create room error",o)}},NetworkManager.prototype.getRoom=function(){return this.room},NetworkManager.prototype.update=function(o){if(this.updateLocked&&(this.updateTimer-=o,this.updateTimer<=0&&(this.updateLocked=!1)),window.touchJoypad.buttons.wasPressed("copyRoomID")){console.log("copyRoomId presssed");const o=this.room.roomId;navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(o).then((()=>{console.log("Room ID copied to clipboard:",o);const e=this.app.root.findByName("roomIdCopiedText");e&&(e.enabled=!0)})).catch((o=>{console.error("Failed to copy room ID to clipboard:",o)}))}},NetworkManager.prototype.updatePosition=function(o,e,t,r,i,n){this.room&&!this.updateLocked&&this.app.connectedToRoom&&(this.updateLocked=!0,this.updateTimer=this.updateInterval,this.room.send("updatePosition",{x:o,y:e,z:t,rx:r,ry:i,rz:n}))},NetworkManager.prototype.updatePowerUp=function(o){this.room&&this.app.connectedToRoom&&this.room.send("updatePowerUp",{powerUp:o})},NetworkManager.prototype.updateMoveState=function(o){this.room&&this.app.connectedToRoom&&this.room.send("updateMoveState",{moveState:o})},NetworkManager.prototype.updateEmote=function(o){this.room&&this.app.connectedToRoom&&this.room.send("playEmote",{emoteId:o})},NetworkManager.prototype.updateAnimal=function(o){this.room&&this.app.connectedToRoom&&this.room.send("updateAnimal",{animal:o})};var SaveManager=pc.createScript("saveManager");SaveManager.prototype.initialize=function(){},SaveManager.prototype.update=function(e){},SaveManager.prototype.persistanceIsActive=function(){return localStorage},SaveManager.prototype.save=function(e,a){console.log(" called save",e,a),this.persistanceIsActive()&&localStorage.setItem(e,a)},SaveManager.prototype.load=function(e){if(this.persistanceIsActive())return localStorage.getItem(e)},SaveManager.prototype.saveArray=function(e,a){console.log(" called save",e,a),this.persistanceIsActive()&&localStorage.setItem(e,JSON.stringify(a))},SaveManager.prototype.loadArray=function(e){if(this.persistanceIsActive())return JSON.parse(localStorage.getItem(e))};var PowerUpManager=pc.createScript("powerUpManager");const powerUpEnum={none:-1,speedShoes:0,jetPack:1,invincibility:2,flight:3,defaultValues:4},powerUpNameLookup=Object.keys(powerUpEnum).reduce(((e,t)=>(e[powerUpEnum[t]]=t,e)),{});PowerUpManager.attributes.add("powerUps",{type:"json",title:"PowerUp List",array:!0,schema:[{name:"name",type:"string",default:"basePowerUp",description:"Powerup Name"},{name:"duration",type:"number",default:30,description:"Powerup Duration"},{name:"visualAssetEntity",type:"entity",description:"visual entity related to this power"},{name:"jetPackForce",type:"number",default:0,description:"upWardForce of Jet Pack"},{name:"speedMultiplier",type:"number",default:1,description:"speed multiplier"},{name:"fuel",type:"boolean",default:!1,description:"Fuel based"},{name:"fuelMultiplier",type:"number",default:0,description:"Fuel multiplier"}]}),PowerUpManager.prototype.initialize=function(){this.entity&&(this.entity.currentPowerUp=null,this.entity.currentPowerTimer=0,this.entity.invincibility=!1,this.entity.flight=!1),this.networkManager=this.app.root.findScript("networkManager"),this.resetPower(),this.powerUpSoundPaused=!1,this.app.on("toPowerUpManager:updatePower",this.updatePower,this),this.app.on("animalChanger:updateAnimationState",this.updateAnimationState,this),this.app.on("playerMovement:updateFuelCounter",this.updateFuelCounter,this),this.app.on("gameplay:completeRun",this.onRunCompleted,this),this.app.on("rebirthTeleporter:rebirth",this.onRebirth,this),this.app.on("gameplay:pausePowerUpSound",(()=>{this.powerUpSoundPaused=!0}),this),this.app.on("gameplay:resumePowerUpSound",(()=>{this.powerUpSoundPaused=!1}),this),this.fuelCounter=0,this.entity.runCompleted=!1,this.app.on("gameplay:adForPowerup",(e=>{"duck"===e&&(e="speedShoes"),this.updatePower(e);const t=this.app.saveManager.load("currentCheckpoint");if(null==t)return;const i=void 0!==powerUpEnum[e]?powerUpEnum[e]:-1;-1!==i&&this.app.fire("gameAnalytics:design",{eventId:`PowerupAcquired:Skyworld:Checkpoint_${t}:Powerup_${i}`,value:i})}))},PowerUpManager.prototype.updateFuelCounter=function(e){this.fuelActive&&(this.fuelCounter+=e)},PowerUpManager.prototype.onRunCompleted=function(){this.entity.runCompleted||(this.entity.runCompleted=!0)},PowerUpManager.prototype.onRebirth=function(){this.entity.runCompleted&&(this.entity.runCompleted=!1)},PowerUpManager.prototype.update=function(e){this.entity.currentPowerUp&&(this.fuelActive||this.entity.runCompleted||(this.entity.currentPowerTimer+=e),this.fuelCounter>0&&!this.entity.runCompleted&&(this.fuelCounter*=this.fuelTimerMultiplier,this.entity.currentPowerTimer+=this.fuelCounter,this.fuelCounter=0),this.app.fire("powerupManager:updateTimer",this.entity.currentPowerTimer,this.powerDuration),this.entity.currentPowerTimer>this.powerDuration&&(this.resetPower(),this.entity.sound&&this.entity.sound.play("powerupFinished"),this.app.fire("powerupManager:disablePowerupProgressBar")),this.updateSoundEffects())},PowerUpManager.prototype.updateSoundEffects=function(){switch(this.entity.currentPowerUp){case"speedShoes":case"jetPack":case"invincibility":case"flight":this.entity.sound&&!this.powerUpSoundPaused&&(this.entity.sound.isPlaying(`${this.entity.currentPowerUp}`)||this.entity.sound.play(`${this.entity.currentPowerUp}`))}},PowerUpManager.prototype.updateAnimationState=function(){this.entity.flight?this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.setBoolean("flightActive",!0):this.entity.anim.setBoolean("flightActive",!0):this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.setBoolean("flightActive",!1):this.entity.anim.setBoolean("flightActive",!1)},PowerUpManager.prototype.updatePower=function(e){console.log("[DEBUG] updatePower",e),this.entity.currentPowerUp&&this.resetPower();let t=!1;switch(e){case"speedShoes":case"jetPack":t=!0;break;case"invincibility":this.entity.invincibility=!0,t=!0;break;case"flight":this.entity.flight=!0,this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.setBoolean("flightActive",!0):this.entity.anim.setBoolean("flightActive",!0),t=!0;break;default:this.resetPower()}t&&(this.networkManager.updatePowerUp(powerUpEnum[e]),this.setEntityPowerUpAttributes(powerUpEnum[e]),this.entity.currentPowerUp=e,this.app.fire("powerupManager:enablePowerupProgressBar",e),this.entity.sound&&this.entity.sound.play("powerupPickup"))},PowerUpManager.prototype.resetPower=function(){if(this.entity.currentPowerUp){switch(this.networkManager.updatePowerUp(powerUpEnum.none),this.entity.currentPowerUp){case"speedShoes":case"jetPack":default:break;case"invincibility":this.entity.invincibility=!1;break;case"flight":this.entity.flight=!1,this.entity.mainRef&&this.entity.mainRef.animRef?this.entity.mainRef.animRef.setBoolean("flightActive",!1):this.entity.anim.setBoolean("flightActive",!1)}this.setEntityPowerUpAttributes(powerUpEnum.defaultValues),this.app.fire("powerupManager:resetTimer"),this.entity.currentPowerUp=null,this.entity.currentPowerTimer=0}},PowerUpManager.prototype.setEntityPowerUpAttributes=function(e){for(const[t,i]of Object.entries(this.powerUps[e]))switch(t){case"speedMultiplier":this.entity.speedMultiplier=i;break;case"jetPackForce":this.entity.jetPackForce=i;break;case"visualAssetEntity":this.currentVisualEntity&&(this.currentVisualEntity.enabled=!1,this.currentVisualEntity=null),i&&(i.enabled=!0,this.currentVisualEntity=i);break;case"duration":this.powerDuration=i;case"fuel":this.fuelActive=i;case"fuelMultiplier":this.fuelTimerMultiplier=i}},PowerUpManager.prototype.handleOtherPlayerPowerUp=function(e,t){const i=powerUpNameLookup[t];"flight"===i?e.animRef.setBoolean("flightActive",!0):e.animRef.setBoolean("flightActive",!1);const n=e.entity.findByName("PowerUp Entities").findByName("jetPackModelTest");n.enabled="jetPack"===i};var Checkpoint=pc.createScript("checkpoint");Checkpoint.prototype.initialize=function(){this.app;if(this.checkpointNumber=0,"Checkpoint Area"===this.entity.parent.name){const o=this.entity.parent.parent.name.split(" "),a=parseInt(o[1],10);this.checkpointNumber=a;var t=this.entity.parent.findByName("Base Sign");if(t&&t.enabled){var i=t.findByName("SignImage");if(i){var e=i.script&&i.script.signType;if(e){var n=e.signType;this.suggestedAnimal=n.split("-ui")[0]}else console.log("Script 'signType' not found on 'SignImage' entity")}else console.log("'SignImage' entity not found")}}this.arrow=this.entity.findByName("Arrow"),this.arrowChecked=this.entity.findByName("ArrowChecked");var o=this.entity.parent.findByName("platform_011");o?o.collision?o.collision.on("collisionstart",this.onPlatformCollisionStart,this):console.warn("platform_011 does not have a collision component"):console.warn("Sibling entity 'platform_011' not found"),this.lastCheckpointTime=this.app.time-61},Checkpoint.prototype.onPlatformCollisionStart=function(t){if(t.other&&"Player"===t.other.name){var i=this.checkpointNumber;console.log("Checkpoint triggered by platform_011 collision with Player."),this.app.fire("checkpoint:updateCheckPoint",i,t.other,this.entity)}},Checkpoint.prototype.update=function(t){};var Gameplay=pc.createScript("gameplay");Gameplay.attributes.add("audio",{type:"entity"}),Gameplay.attributes.add("uiInGame",{type:"entity"}),Gameplay.attributes.add("currentCheckPoint",{type:"entity"}),Gameplay.attributes.add("useSaveSystem",{type:"boolean",default:!0});const deathFloor=-70,stateMap={0:"mainMenu",1:"subMenu",2:"playing",3:"joinRoomMenu",4:"roomCreatedMenu",5:"creatingRoomMenu",6:"powerUpConfirmMenu",7:"joiningRoomMenu",8:"roomJoinFailedMenu",9:"roomJoinedMenu",10:"createRoomFailedMenu",11:"highScoreMenu",12:"tutorialMenu",13:"skipLevelMenu",14:"privacyNoticeMenu",15:"creditsMenu",16:"cosmeticConfirmMenu",17:"emoteSelectMenu"};function findCheckpointByNumber(e,t){var a=e.find((function(e){if("checkPoint"===e.name){var a=e.script;if(a&&a.checkpoint&&a.checkpoint.checkpointNumber===t)return!0}return!1}));return a.length>0?a[0]:null}Gameplay.prototype.initialize=async function(){this.cheatMode=!1,this.app.firstMoveInSession=!1,this.mainPlayer=this.app.root.findByName("Player"),this.app.mainPlayer=this.mainPlayer,this.entity.script.create("networkManager"),this.networkManagerScript=this.entity.script.networkManager,this.sdkManager=this.entity.script.sdkManager,await this.networkManagerScript.init(),this.saveManager=this.entity.script.saveManager,this.app.saveManager=this.saveManager,this.otherPlayer=this.app.root.findByName("OtherPlayer"),this.mainPlayerId="mainPlayer",this.app.playerObjects={},this.levelTracker=this.entity.findByName("LevelTracker"),this.progressBar=this.entity.findByName("Progress Bar"),this.checkPoints=this.app.root.findByName("checkPoints"),this.sceneLoadingCover=this.entity.findByName("sceneLoadingCover"),this.app.on("screenFade:fadeOutComplete",this.postFadeOut,this),this.volumeOnIcon=this.app.root.findByName("volumeOnIcon"),this.volumeOffIcon=this.app.root.findByName("volumeOffIcon"),this.toggleMenuUI("powerUpConfirmMenu",!1),this.toggleMenuUI("joiningRoomMenu",!1),this.toggleMenuUI("creatingRoomMenu",!1),this.toggleMenuUI("highScoreMenu",!1),this.toggleMenuUI("tutorialMenu",!1),this.toggleMenuUI("skipLevelMenu",!1),this.toggleMenuUI("privacyNoticeMenu",!1),this.toggleMenuUI("creditsMenu",!1),this.toggleMenuUI("cosmeticConfirmMenu",!1),this.toggleMenuUI("emoteSelectMenu",!1),this.currentLevelDeathCounter=0,this.potentialCosmeticType=null,this.currentPowerupType="speedShoes",this.playState=0,this.powerUpManager=this.mainPlayer.script.powerUpManager,this.animalChangerScript=this.entity.script.animalChanger,this.checkpointManager=this.entity.script.checkpointManager,this.checkpointManager.init(this),this.tutorialManager=this.entity.script.tutorialManager,this.tutorialManager.init(this),this.app.mouse.on("mousedown",this.onMouseDown,this),this.app.keyboard.on("keyup",this.onKeyUp,this),this.emoteManager=this.entity.script.emoteManager,this.emoteManager.init(this),this.app.on("sceneManager:initFirstScene",(()=>{this.initMainPlayer("mainPlayer")})),this.app.on("sceneManager:joinScene",(e=>{})),this.app.on("scene:startedLoading",(()=>{this.sceneLoadingCover&&!this.sceneLoadingCover.enabled&&(this.sceneLoadingCover.enabled=!0)}),this),this.app.on("networkManager:roomJoined",(({roomId:e,options:t})=>{console.log(`Room joined: ${e}, Options:`,t);const a=t?.world||null;a&&this.app.currentWorld!==a&&(console.log(`Switching to world: ${a}`),this.loadWorld(a))}));this.app.root.findByName("Ingame Screen");let e=this.app.saveManager.load("currentCheckpoint");if(null!=e&&""!==e&&0!==e&&"0"!==e||this.app.saveManager.load("skyworldRebirthCounter")){this.audio.sound.play("main_menu_music"),this.app.fire("gameAnalytics:design",{eventId:`returningPlayer:${e}`,value:e});let t=+this.app.saveManager.load("returns");t||(t=1),t+=1,this.app.saveManager.save("returns",t),this.app.fire("gameAnalytics:design",{eventId:`playerReturns:${e}`,value:t}),console.log("RETURNS",t)}else console.log("NEW PLAYER - SETTING TO PLAYING"),this.setPlayState("playing",!0),this.loadWorld("Skyworld",!0),this.app.singlePlayerMode||this.app.fire("networkManager:joinRoom",{world:"Skyworld"}),this.audio.sound.play("ambient_music");this.app.fire("startAfterInit"),this.app.on("scene:loaded",(()=>{this.onWorldLoaded()})),await this.sdkManager.initSdk(),this.app.on("gameplay:attemptFirstGameplayEvent",this.attemptFirstGameplayEvent,this)},Gameplay.prototype.attemptFirstGameplayEvent=function(){!this.app.firstGameplayStartCalled&&this.isCurrentPlayState("playing")&&(this.sdkManager.updateGameplayStatus(!0),this.app.firstGameplayStartCalled=!0)},Gameplay.prototype.onMouseDown=function(e){this.attemptFirstGameplayEvent(),this.mouseDown=!0},Gameplay.prototype.onKeyUp=function(e){this.keyUp=e},Gameplay.prototype.loadCheckpointOnEnter=function(){console.log("calling load checkpoint on enter"),this.checkpointManager.loadCheckpointOnEnter()},Gameplay.prototype.playEmote=function(e,t,a){this.emoteManager&&this.emoteManager.playEmote(e,t,a)};const otherPlayerMovementFactor=5,otherPlayerRotationFactor=.1;Gameplay.prototype.createRoom=async function(){const e=this.getCurrentWorld();if(!e)return void console.error("Cannot create a room: Current world is not defined.");const t=await this.networkManagerScript.createRoom({world:e});if(!t)return;console.log("created room",t);const a=this.app.root.findByName("RoomIdValue");if(console.log("found room id value entity",a),a){a.text=t;const e=a.findByName("Text");console.log("found text element",e),e&&(e.element.text=t)}this.setPlayState("roomCreatedMenu")},Gameplay.prototype.getCurrentWorld=function(){return this.app.currentWorld},Gameplay.prototype.skipLevel=function(){const e=this.app.playerObjects[this.mainPlayerId].latestCheckPointId;findCheckpointByNumber(this.app.root,e+1)?this.checkpointManager.updateAndMoveToCheckpoint(e+1):console.log("cannot find next checkpoint entity")},Gameplay.prototype.loadWorld=function(e,t){if(console.log("current world",{appCurrentWorld:this.app.currentWorld,newWorldName:e}),e===this.app.currentWorld)return console.log("WORLD NAME IS SAME - NOT CHANGING"),void this.setPlayState("playing");if(this.app.currentWorld){const e=this.app.root.findByName(this.app.currentWorld);e&&(console.log("FOUND CURRENT WORLD ROOT",e),e.destroy())}this.app.currentWorld=e,t?this.enterWorld(e):this.sdkManager.showCommercialBreak((()=>{this.enterWorld(e)}))},Gameplay.prototype.enterWorld=function(e){console.log(`Loading world: ${e}`),this.audio.sound.isPlaying("main_menu_music")&&this.audio.sound.pause("main_menu_music"),this.audio.sound.volume>0&&!this.audio.sound.isPlaying("ambient_music")&&this.audio.sound.play("ambient_music"),this.mainPlayer.sound.volume>0&&this.app.fire("gameplay:resumePowerUpSound"),this.app.fire("level:load",e),this.setPlayState("playing")},Gameplay.prototype.onWorldLoaded=function(){this.sceneLoadingCover&&this.sceneLoadingCover.enabled&&(this.sceneLoadingCover.enabled=!1),console.log("world loaded - calling load checkpoint on enter"),this.loadCheckpointOnEnter()},Gameplay.prototype.update=function(e){if(!this.app.isAdPlaying){this.app.keyboard.isPressed(pc.KEY_Z)&&this.app.keyboard.isPressed(pc.KEY_L)&&!this.isCheatToggleCooldownActive&&(this.cheatMode=!this.cheatMode,console.log("Cheat mode "+(this.cheatMode?"activated":"deactivated")),this.app.fire("gameAnalytics:disableEvents"),this.isCheatToggleCooldownActive=!0,setTimeout((()=>{this.isCheatToggleCooldownActive=!1}),500)),this.cheatMode&&(this.app.keyboard.wasPressed(pc.KEY_Q)&&this.checkpointManager.updateAndMoveToCheckpoint(120),this.app.keyboard.wasPressed(pc.KEY_Y)&&this.skipLevel(),this.app.keyboard.isPressed(pc.KEY_T)&&this.app.fire("playerMovement:resetCheckPointKeyPressed"),this.app.keyboard.isPressed(pc.KEY_R)&&this.app.fire("playerMovement:returnKeyPressed")),this.app.fire("gameplay:updateTime",e);for(const n in this.app.playerObjects){const r=this.app.playerObjects[n];if(r.mainPlayer&&r.entity.getPosition().y<-70&&(this.currentLevelDeathCounter++,this.onReturnKeyPressed()),!r.mainPlayer){if(!r.finishedRotating){var t=(new pc.Quat).setFromEulerAngles(r.newRx,r.newRy,r.newRz),a=r.entity.getRotation(),i=(new pc.Quat).slerp(a,t,.1);t.equalsApprox(i)&&(r.finishedRotating=!0),r.entity.setRotation(i)}if(r.direction.lengthSq()>0){const t=Math.min(1,5*e);var o=r.entity.getPosition(),s=o.lerp(o,r.targetPosition,t);r.entity.setPosition(s),r.distanceToTravel=r.entity.getPosition().distance(r.targetPosition),r.distanceToTravel<.01&&(r.entity.setPosition(r.targetPosition),r.direction.set(0,0,0))}}}if(this.isCurrentPlayState("playing"))!this.playStateLock&&(this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||this.app.keyboard.wasPressed(pc.KEY_O)||window.touchJoypad.buttons.wasPressed("menu"))?this.setPlayState("subMenu"):this.playStateLock||!this.app.keyboard.wasPressed(pc.KEY_P)&&!window.touchJoypad.buttons.wasPressed("highScoreMenu")?this.playStateLock||!this.app.keyboard.wasPressed(pc.KEY_F)&&!window.touchJoypad.buttons.wasPressed("emote")||(this.app.fire("toMenuLoader:loadMenuItems","emoteSelectMenu"),this.setPlayState("emoteSelectMenu")):(this.app.fire("gameplay:updateScores"),this.setPlayState("highScoreMenu"));else if(this.isCurrentPlayState("subMenu"))this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||this.app.keyboard.wasPressed(pc.KEY_O)||window.touchJoypad.buttons.wasPressed("menu")||window.touchJoypad.buttons.wasReleased("continueGame")?this.setPlayState("playing"):window.touchJoypad.buttons.wasReleased("mainMenu")?(this.audio.sound.volume>0&&(this.audio.sound.isPlaying("ambient_music")&&this.audio.sound.pause("ambient_music"),this.audio.sound.play("main_menu_music")),this.mainPlayer.sound.volume>0&&this.app.fire("gameplay:pausePowerUpSound"),this.setPlayState("mainMenu")):window.touchJoypad.buttons.wasReleased("joinRoomMenu")?this.setPlayState("joinRoomMenu"):window.touchJoypad.buttons.wasReleased("roomCreatedMenu")?(console.log("pressed key to create room"),this.setPlayState("creatingRoomMenu"),this.createRoom()):window.touchJoypad.buttons.wasPressed("volumeToggle")?(console.log("volume toggled"),this.audio.sound.isPlaying("ambient_music")?(this.mainPlayer.sound.volume=0,this.audio.sound.volume=0,this.audio.sound.pause("ambient_music"),this.volumeOffIcon.enabled=!0,this.volumeOnIcon.enabled=!1):(this.mainPlayer.sound.volume=1,this.audio.sound.volume=1,this.audio.sound.play("ambient_music"),this.volumeOffIcon.enabled=!1,this.volumeOnIcon.enabled=!0)):window.touchJoypad.buttons.wasReleased("privacyNoticeMenu")?this.setPlayState("privacyNoticeMenu"):window.touchJoypad.buttons.wasReleased("creditsMenu")?this.setPlayState("creditsMenu"):window.touchJoypad.buttons.wasReleased("discordTrigger")&&(console.log("discord button clicked"),window.open("https://discord.gg/XPknQ29t8M","_blank"));else if(this.isCurrentPlayState("mainMenu"))window.touchJoypad.buttons.wasReleased("startGame")?"Skyworld"!==this.app.currentWorld?(this.loadWorld("Skyworld"),this.app.fire("networkManager:joinRoom",{world:"Skyworld"})):this.setPlayState("playing"):window.touchJoypad.buttons.wasReleased("startSecondGame");else if(this.isCurrentPlayState("skipLevelMenu"))this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||window.touchJoypad.buttons.wasReleased("exitSkipLevelMenu")?(this.app.firstMoveInSession=!1,this.sdkManager.showCommercialBreak((()=>{this.setPlayState("playing")}))):window.touchJoypad.buttons.wasReleased("adForSkipLevel")&&(this.app.firstMoveInSession=!1,this.sdkManager.showRewardedAd((()=>{const e=this.app.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);if(null==e)return this.skipLevel(),void this.setPlayState("playing");this.app.fire("gameAnalytics:design",{eventId:`LevelSkip:Skyworld:Checkpoint_${e}`,value:1}),this.app.fire("gameAnalytics:progression",{status:"complete",progression01:this.app.currentWorld,progression02:`Level_${e}`,progression03:"Level_Skipped",value:1}),this.skipLevel(),this.setPlayState("playing")}),(()=>{console.log("Ad was not completed, level not skipped."),this.setPlayState("playing")})));else if(this.isCurrentPlayState("joinRoomMenu")){if(window.touchJoypad.buttons.wasReleased("exitJoinRoomMenu"))this.setPlayState("subMenu");else if(window.touchJoypad.buttons.wasReleased("joinRoom")){const e=this.app.root.findByName("JoinRoomText");if(e){const t=e.element.text;console.log("found joinroomtext roomid",t),this.setPlayState("joiningRoomMenu"),this.app.fire("gameplay:joinRoomRequest",t)}}}else if(this.isCurrentPlayState("roomCreatedMenu"))window.touchJoypad.buttons.wasReleased("exitRoomCreatedMenu")&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("creatingRoomMenu"))!this.playStateLock&&this.app.keyboard.wasPressed(pc.KEY_ESCAPE)&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("joiningRoomMenu"))!this.playStateLock&&this.app.keyboard.wasPressed(pc.KEY_ESCAPE)&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("roomJoinedMenu"))window.touchJoypad.buttons.wasReleased("exitRoomJoinedMenu")?this.setPlayState("subMenu"):window.touchJoypad.buttons.wasReleased("roomJoinedMenuPlayNow")&&this.setPlayState("playing");else if(this.isCurrentPlayState("roomJoinFailedMenu"))window.touchJoypad.buttons.wasReleased("exitRoomJoinFailedMenu")&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("createRoomFailedMenu"))window.touchJoypad.buttons.wasReleased("exitCreateRoomFailedMenu")&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("powerUpConfirmMenu"))this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||this.app.keyboard.wasPressed(pc.KEY_O)||window.touchJoypad.buttons.wasPressed("menu")||window.touchJoypad.buttons.wasReleased("exitPowerupConfirmMenu")?this.setPlayState("playing"):window.touchJoypad.buttons.wasReleased("adForPowerUp")&&this.sdkManager.showRewardedAd((()=>{this.app.fire("gameplay:adForPowerup",this.currentPowerupType),this.setPlayState("playing")}),(()=>{console.log("Ad was not completed, no power-up granted."),this.setPlayState("playing")}));else if(this.isCurrentPlayState("highScoreMenu"))window.touchJoypad.buttons.wasReleased("exitHighScoreMenu")||this.app.keyboard.wasPressed(pc.KEY_P)?this.setPlayState("playing"):window.touchJoypad.buttons.wasPressed("highScoreModeSwitch")&&this.app.fire("gameplay:showNextModeScores");else if(this.isCurrentPlayState("tutorialMenu"))!this.playStateLock&&(this.mouseDown||this.keyUp||window.touchJoypad.buttons.wasPressed("emote")||window.touchJoypad.buttons.wasPressed("jump")||0!==window.touchJoypad.sticks.joystick0.x||0!==window.touchJoypad.sticks.joystick0.y||0!==window.touchJoypad.sticks.joystick1.x||0!==window.touchJoypad.sticks.joystick1.y||window.touchJoypad.buttons.wasPressed("animal1")||window.touchJoypad.buttons.wasPressed("animal2")||window.touchJoypad.buttons.wasPressed("animal3")||window.touchJoypad.buttons.wasPressed("animal4")||window.touchJoypad.buttons.wasPressed("animal5"))&&(this.tutorialManager.resetHighlightedElements(),this.setPlayState("playing"));else if(this.isCurrentPlayState("privacyNoticeMenu"))(this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||window.touchJoypad.buttons.wasReleased("exitPrivacyNoticeMenu"))&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("creditsMenu"))(this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||window.touchJoypad.buttons.wasReleased("exitCreditsMenu"))&&this.setPlayState("subMenu");else if(this.isCurrentPlayState("cosmeticConfirmMenu")){if(this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||this.app.keyboard.wasPressed(pc.KEY_O)||window.touchJoypad.buttons.wasPressed("menu")||window.touchJoypad.buttons.wasReleased("exitCosmeticConfirmMenu"))this.animalChangerScript.syncModelWorld(),this.setPlayState("playing");else if(window.touchJoypad.buttons.wasReleased("adForCosmetic")){let e="medium";this.potentialCosmeticPrice>1&&(e="large"),this.sdkManager.showRewardedAd((()=>{this.potentialCosmeticProgress++,this.app.fire("gameplay:adForCosmetic",this.potentialCosmeticType),this.potentialCosmeticType=null,this.setPlayState("playing"),this.potentialCosmeticEntity=null,this.potentialCosmeticProgress=0,this.potentialCosmeticPrice=1}),(()=>{console.log("Failed to load rewarded ad."),this.animalChangerScript.syncModelWorld(),this.setPlayState("playing")}),{size:`${e}`})}}else if(this.isCurrentPlayState("emoteSelectMenu")){let e=this.emoteManager.checkForEmoteButtonPress();if(this.app.keyboard.wasPressed(pc.KEY_ESCAPE)||this.app.keyboard.wasPressed(pc.KEY_F)||window.touchJoypad.buttons.wasReleased("exitEmoteSelectMenu"))this.setPlayState("playing");else if("number"==typeof e)if(this.emoteManager.checkUnlockStatus(e))this.emoteManager.setEmote(e),this.setPlayState("playing"),this.app.fire("gameAnalytics:design",{eventId:`emotePlay:Skyworld:${e}`,value:e}),setTimeout(function(){this.playEmote(this.mainPlayer,!0)}.bind(this),100);else{this.emoteManager.getEmotePrice(e)>0?this.sdkManager.showRewardedAd((()=>{this.app.fire("gameAnalytics:design",{eventId:`emoteGet:Skyworld:${e}`,value:e}),this.app.fire("gameAnalytics:design",{eventId:`emotePlay:Skyworld:${e}`,value:e}),this.emoteManager.setEmote(e),this.setPlayState("playing"),setTimeout(function(){this.playEmote(this.mainPlayer,!0)}.bind(this),100)}),(()=>{console.log("Failed to load rewarded ad."),this.setPlayState("playing")})):(this.app.fire("gameAnalytics:design",{eventId:`emotePlay:Skyworld:${e}`,value:e}),this.emoteManager.setEmote(e),this.setPlayState("playing"),setTimeout(function(){this.playEmote(this.mainPlayer,!0)}.bind(this),100))}}this.keyUp&&(this.keyUp=null),this.mouseDown&&(this.mouseDown=!1)}},Gameplay.prototype.lockPlayState=function(e){this.playStateLockDuration=400,e&&(this.playStateLockDuration=e),this.playStateLock=!0,setTimeout(function(){this.playStateLock=!1}.bind(this),this.playStateLockDuration)},Gameplay.prototype.setPlayState=function(e,t){if(console.log("received playstate",e),console.log("current state",this.playState),"playing"===e?2===this.playState||t||this.sdkManager.updateGameplayStatus(!0):2!==this.playState||t||this.sdkManager.updateGameplayStatus(!1),this.toggleMenuUI(this.getCurrentPlayState(),!1),"playing"===e)this.playState=2;else if("subMenu"===e)this.playState=1;else if("mainMenu"===e)this.playState=0;else if("joinRoomMenu"===e)this.playState=3;else if("roomCreatedMenu"===e)this.playState=4;else if("creatingRoomMenu"===e)this.playState=5;else if("powerUpConfirmMenu"===e)this.playState=6;else if("joiningRoomMenu"===e)this.playState=7;else if("roomJoinFailedMenu"===e)this.playState=8;else if("roomJoinedMenu"===e)this.playState=9;else if("createRoomFailedMenu"==e)this.playState=10;else if("highScoreMenu"==e)this.playState=11;else if("tutorialMenu"==e)this.playState=12;else if("skipLevelMenu"==e)this.playState=13;else if("privacyNoticeMenu"==e)this.playState=14;else if("creditsMenu"==e)this.playState=15;else if("cosmeticConfirmMenu"==e)this.playState=16;else{if("emoteSelectMenu"!=e)return this.lockPlayState(),-1;this.playState=17}return this.mainPlayer&&this.mainPlayer.sound&&this.mainPlayer.sound.play("cartoonPop"),"playing"!==e&&this.toggleMenuUI(e,!0),this.app.fire("gameplay:currentPlayState",e),this.lockPlayState(undefined),this.playState},Gameplay.prototype.isCurrentPlayState=function(e){return stateMap[this.playState]===e},Gameplay.prototype.getCurrentPlayState=function(){return stateMap[this.playState]},Gameplay.prototype.toggleMenuUI=function(e,t){let a=this.app.root.findByName(`${e}`);if(a&&a.enabled!==t&&(a.enabled=t,"roomCreatedMenu"===e)){let e=a.findByName("roomIdCopiedText");e&&(e.enabled=!1)}},Gameplay.prototype.setInitialRef=function(e,t){e.mainRef=this.app.playerObjects[t];const a=e.findByName("Monkey");this.app.playerObjects[t].animalRef=a,this.app.playerObjects[t].animRef=a.anim},Gameplay.prototype.initMainPlayer=function(e){this.app.playerObjects[e]={mainPlayer:!1,distanceToTravel:0,direction:new pc.Vec3,targetPosition:new pc.Vec3,newPosition:new pc.Vec3,rotation:0,newRotation:0,latestCheckPointId:0,entity:void 0,rx:0,ry:0,rz:0,newRx:0,newRy:0,newRz:0},console.log("Initializing main player"),this.mainPlayer.rigidbody.enabled=!0,this.app.playerObjects[e].entity=this.mainPlayer,this.setInitialRef(this.mainPlayer,e),this.animalChangerScript.toggleSkins(this.mainPlayer,1,!0),this.app.playerObjects[e].mainPlayer=!0,this.app.mainPlayerObject=this.app.playerObjects[e],console.log("main player obj",this.app.mainPlayerObject),this.app.fire("timer:enable"),this.uiInGame.enabled=!0,this.app.on("deathScript:killPlayer",(()=>{this.currentLevelDeathCounter++,this.onReturnKeyPressed()}),this),this.app.on("playerMovement:returnKeyPressed",this.onReturnKeyPressed,this),this.app.on("playerMovement:resetCheckPointKeyPressed",this.checkpointManager.onCheckPointReset,this.checkpointManager),this.app.on("checkpoint:updateCheckPoint",(e=>{this.checkpointManager.updateCheckpoint(e,!1)}),this.checkpointManager),this.app.on("powerup:filled",(e=>{console.log("Powerup filled of type:",e),this.setPlayState("powerUpConfirmMenu"),this.currentPowerupType=e})),this.app.on("tutorial:filled",(e=>{console.log("tutorialObj filled of type:",e),this.tutorialManager.resetHighlightedElements(e),this.setPlayState("tutorialMenu")})),this.app.on("cosmetics:filled",((e,t)=>{console.log("Cosmetic filled of type:",e),this.potentialCosmeticType=e,t?(this.potentialCosmeticEntity=t,this.potentialCosmeticProgress=t.currentNumberOfAds,this.potentialCosmeticPrice=t.cosmeticPrice):(this.potentialCosmeticProgress=0,this.potentialCosmeticPrice=1),this.setPlayState("cosmeticConfirmMenu")})),this.app.on("tutorialTrigger:triggerActivated",(e=>{console.log("tutorialTrigger activated",e),this.tutorialManager.resetHighlightedElements(e),this.setPlayState("tutorialMenu")})),this.app.on("networkManager:joinSuccess",(()=>{this.setPlayState("roomJoinedMenu")})),this.app.on("networkManager:joinRoomError",(()=>{this.setPlayState("roomJoinFailedMenu")})),this.app.on("networkManager:createRoomError",(()=>{console.log("setting state create room failed"),this.setPlayState("createRoomFailedMenu")})),this.app.on("endTeleporter:completeRun",this.completeRun,this),this.app.on("rebirthTeleporter:rebirth",(()=>{this.onCheckPointReset(),this.app.fire("gameAnalytics:resetProgression");let e=this.app.currentWorld.toLowerCase();const t=this.app.saveManager.load(`${e}RebirthCounter`)||0;this.app.saveManager.save(`${e}RebirthCounter`,+t+1),this.app.fire("gameAnalytics:design",{eventId:`Rebirth:${this.app.currentWorld}`,value:t+1}),console.log("Rebirth design event fired: rebirthCount: "+(+t+1))}),this),this.loadCheckpointOnEnter(),this.app.on("networkClockUpdate",(e=>{0!==this.app.systems.sound.volume&&!this.audio.sound.isPlaying("ambient_music")&&this.audio.sound.volume>0&&this.volumeOnIcon&&!0===this.volumeOnIcon.enabled&&!this.isCurrentPlayState("mainMenu")&&this.audio.sound.play("ambient_music")}),this),this.app.on("playerMovement:playEmote",(e=>{this.playEmote(e,!0)}),this);[200,500,1e3].forEach((e=>{setTimeout((()=>{this.app.fire("gameplay:updatePlayerPosition")}),e)}))},Gameplay.prototype.initPlayers=function(e,t){return console.log("CALLING INIT PLAYERS IN FUNC"),e.state.players.onAdd(((t,a)=>{if(console.log(`Adding player for session: ${a}`),!this.app.playerObjects.hasOwnProperty(a))if(a===e.sessionId);else{this.app.playerObjects[a]={mainPlayer:!1,distanceToTravel:0,direction:new pc.Vec3,targetPosition:new pc.Vec3,newPosition:new pc.Vec3,rotation:0,newRotation:0,latestCheckPointId:0,entity:void 0,rx:0,ry:0,rz:0,newRx:0,newRy:0,newRz:0},console.log("Cloning other player",t);const e=this.otherPlayer.clone();e.enabled=!0,this.otherPlayer.getParent().addChild(e);const i=this.app.playerObjects[a];i.entity=e,this.setInitialRef(e,a),t.onChange((o=>{o.find((e=>"animal"===e.field))&&this.animalChangerScript.toggleSkins(e,t.animal);o.find((e=>"emoteId"===e.field))&&-1!==t.emoteId&&this.playEmote(e,null,t.emoteId);o.find((e=>"powerUp"===e.field))&&this.powerUpManager.handleOtherPlayerPowerUp(i,t.powerUp);o.find((e=>"moveState"===e.field))&&(2===t.moveState?i.animRef&&(i.animRef.setFloat("yDirection",1),i.animRef.setBoolean("playEmote",!1)):(i.animRef.getFloat("yDirection")>0&&i.animRef.setFloat("yDirection",0),1===t.moveState?(i.animRef.setFloat("xDirection",1),i.animRef.setBoolean("playEmote",!1)):i.animRef.setFloat("xDirection",0))),this.app.playerObjects[a]&&!1===this.app.playerObjects[a].mainPlayer&&this.movePlayerTo(this.app.playerObjects[a],new pc.Vec3(t.x,t.y,t.z),t.rx,t.ry,t.rz)}))}})),e.state.players.onRemove(((e,t)=>{this.app.playerObjects[t]&&this.app.playerObjects[t].entity&&this.app.playerObjects[t].entity.destroy(),delete this.app.playerObjects[t]})),e.onLeave((()=>{this.removeAllPlayers(),console.log("left room")})),e.onMessage("updateClock",(e=>{this.app.fire("networkClockUpdate",e)})),e},Gameplay.prototype.removeAllPlayers=function(){console.log("list of players",this.app.playerObjects);for(let e in this.app.playerObjects)this.app.playerObjects.hasOwnProperty(e)&&!this.app.playerObjects[e].mainPlayer&&(this.app.playerObjects[e].entity.destroy(),delete this.app.playerObjects[e]);console.log("list of players after culling",this.app.playerObjects)},Gameplay.prototype.movePlayerTo=function(e,t,a,i,o){e.targetPosition.copy(t),e.direction.sub2(e.targetPosition,e.entity.getPosition()),e.distanceToTravel=e.direction.length(),e.newRx=a,e.newRy=i,e.newRz=o,e.finishedRotating=!1,e.distanceToTravel>0?e.direction.normalize():e.direction.set(0,0,0)},Gameplay.prototype.onReturnKeyPressed=function(){if(this.app.playerObjects[this.mainPlayerId]){this.app.playerObjects[this.mainPlayerId].animRef.setTrigger("playDeath",!0),this.app.fire("toScreenFade:fadeOut",0);const e=this.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);if(e){const t=`Level_${e}`;this.app.fire("gameAnalytics:progression",{status:"fail",progression01:this.app.currentWorld,progression02:t,progression03:"Level_Progress"}),console.log(`Level fail event fired for ${t}`)}}else console.log("not mainplayer")},Gameplay.prototype.completeRun=function(){this.app.fire("gameplay:completeRun"),this.app.fire("gameplay:updateScores"),console.log("Run Completed"),this.app.playerObjects[this.mainPlayerId]&&this.app.fire("toScreenFade:fadeOut",1)},Gameplay.prototype.onCheckPointReset=function(){this.app.playerObjects[this.mainPlayerId]&&this.app.fire("toScreenFade:fadeOut",2)},Gameplay.prototype.postFadeOut=function(e){if(console.log("got request type",e),this.app.playerObjects[this.mainPlayerId]&&(this.app.playerObjects[this.mainPlayerId].movementFrozen=!0,this.app.playerObjects[this.mainPlayerId].movementFrozenTicks=5),e&&0!==e)1===e?(this.checkpointManager.updateAndMoveToCheckpoint(121),this.setPlayState("highScoreMenu")):2===e&&this.checkpointManager.onCheckPointReset();else{const e=this.app.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);console.log("FOUND CHECKPOINT NUMBER",e),this.checkpointManager.updateAndMoveToCheckpoint(e),e<120&&(this.currentLevelDeathCounter%4==1?this.setPlayState("skipLevelMenu"):this.setPlayState("playing"))}this.app.fire("toScreenFade:fadeIn")},Gameplay.prototype.getGameModeString=function(){const e=this.app.currentWorld;let t;return t="Skyworld"===e?"":e,t};var AnimalChanger=pc.createScript("animalChanger");const animalChangingCooldown=700;AnimalChanger.attributes.add("blockTextDuration",{type:"number",default:4}),AnimalChanger.attributes.add("lockTransform",{type:"boolean",default:!1}),AnimalChanger.attributes.add("animalSettings",{type:"json",title:"Animal Settings",array:!0,schema:[{name:"index",type:"number",default:0,description:"animal index",parentType:"script",parentName:"playerMovement"},{name:"mass",type:"number",default:10,description:"mass setting per character",parentType:"entity",parentName:"Player"},{name:"friction",type:"number",default:.75,description:"mass setting per character",parentType:"entity",parentName:"Player"},{name:"restitution",type:"number",default:.5,description:"mass setting per character",parentType:"entity",parentName:"Player"},{name:"playerGravity",type:"number",default:-10,description:"gravity setting per character",parentType:"script",parentName:"playerMovement"},{name:"speed",type:"number",default:.09,description:"speed setting per character",parentType:"script",parentName:"playerMovement"},{name:"jumpForce",type:"number",default:450,description:"jumpForce setting per character",parentType:"script",parentName:"playerMovement"},{name:"maxAirJumps",type:"number",default:1,description:"maxAirJumps setting per character",parentType:"script",parentName:"playerMovement"},{name:"heavy",type:"boolean",default:!1,parentType:"script",parentName:"playerMovement"},{name:"climb",type:"boolean",default:!1,parentType:"script",parentName:"playerMovement"},{name:"safeFall",type:"boolean",default:!1,parentType:"script",parentName:"playerMovement"}]}),AnimalChanger.prototype.initialize=function(){this.currentlyPressed=null,this.animalButtons={1:this.app.root.findByName("Animal 1 Button"),2:this.app.root.findByName("Animal 2 Button"),3:this.app.root.findByName("Animal 3 Button"),4:this.app.root.findByName("Animal 4 Button"),5:this.app.root.findByName("Animal 5 Button")},this.saveManager=this.app.root.findScript("saveManager"),this.currentSkinKeys=this.saveManager.loadArray("currentSkinKeys"),this.currentSkinKeys&&Array.isArray(this.currentSkinKeys)||(this.currentSkinKeys=[1,2,3,4,5]),this.modelWorldModels=this.app.root.findByName("ModelWorld Group"),this.modelWorldAnimals=this.modelWorldModels.findByName("Animal Models"),this.syncModelWorld(),this.pointer=this.app.root.findByName("Animal Button Pointer"),this.animalChangeCooldown=!1,this.app.on("transformLock:lockTransform",(()=>{this.lockTransform=!0})),this.app.on("transformLock:unlockTransform",(()=>{this.lockTransform=!1})),this.app.on("gameplay:adForCosmetic",(e=>{this.setSkin(e);const t=this.app.saveManager.load("currentCheckpoint");if(null==t)return;const n=animMapRev[e]||-1;-1!==n&&this.app.fire("gameAnalytics:design",{eventId:`CosmeticAcquired:Skyworld:Checkpoint_${t}:Cosmetic_${n}`,value:n})}),this),this.app.on("cosmetics:filled",this.temporaryModelChange,this),this.lodCooldown=!1,this.lodTimer=0,this.lodInterval=1,this.app.on("animalChangeTrigger:toggleSkins",this.toggleSkins,this),this.currentOrientation="landscape",this.deviceType=null,this.app.on("optimizeSettings:orientation",(e=>{this.currentOrientation=e}),this),this.app.on("optimizeSettings:deviceSettingApplied",(e=>{this.currentDeviceType=e}),this)};const animMap={1:"gecko",2:"monkey",3:"kangaroo",4:"turkey",5:"elephant",7:"geckoDragon",8:"wyvern",9:"kirin",10:"pheonix",11:"leviathan",13:"chameleon",14:"colobus",15:"gemsbok",16:"kiwi",17:"polarBear",19:"hornedLizard",20:"panda",21:"llama",22:"peacock",23:"rhino"},priceMap={0:[],1:[1,2,3,4,5,13,14,15,16,17,19,20,21,22,23],2:[],3:[],4:[7,9,10,11],5:[8]},animMapRev=Object.entries(animMap).reduce(((e,[t,n])=>(e[n]=parseInt(t),e)),{});AnimalChanger.prototype.getSkinName=function(e){return animMap[e]?animMap[e]:null},AnimalChanger.prototype.getSkinPrice=function(e){let t=null;const n=animMapRev[e];for(i=0;i<Object.keys(priceMap).length;i++)priceMap[i].includes(n)&&(t=i);return t},AnimalChanger.prototype.getSkinKeyByName=function(e){return animMapRev[e]?animMapRev[e]:null},AnimalChanger.prototype.getCurrentSkinKeyList=function(){return this.currentSkinKeys},AnimalChanger.prototype.getCurrentSkinName=function(){return animMap[this.currentSkinKeys[this.currentlyPressed-1]]?animMap[this.currentSkinKeys[this.currentlyPressed-1]]:null},AnimalChanger.prototype.temporaryModelChange=function(e){let t=this.currentSkinKeys.map((e=>({...e})));const n=animMapRev[e]%6,a=animMapRev[e];t[n-1]=a,this.app.fire("animalChanger:cosmeticUITagUpdate",animMap[n]),this.syncModelWorld(t)},AnimalChanger.prototype.syncModelWorld=function(e){for(e||(e=this.currentSkinKeys),i=0;i<e.length;i++){const t=e[i];currentSkin=animMap[t],this.modelWorldAnimals.findByName(`${i+1}`).children.forEach((e=>{"Camera"!==e.name&&e.name!==currentSkin?e.enabled=!1:e.name===currentSkin&&(e.enabled=!0)}))}},AnimalChanger.prototype.setSkin=function(e){const t=animMapRev[e]%6,n=animMapRev[e];this.currentSkinKeys[t-1]=n,this.saveManager.saveArray("currentSkinKeys",this.currentSkinKeys);var a=this.app.mainPlayer;this.toggleSkins(a,t,!0,!0),this.syncModelWorld(),this.app.fire("animalChanger:skinChanged",e)},AnimalChanger.prototype.tweenArrow=function(e){var t=e.getLocalPosition().clone();"portrait"!==this.app.currentOrientation||"android"!==this.app.deviceType&&"ios"!==this.app.deviceType?t.y+=85:t.y+=40;var n,a=this.pointer.getLocalPosition().clone(),i=t.clone().sub(a).normalize();n=Math.abs(i.x)>Math.abs(i.z)?i.x>0?new pc.Vec3(0,0,30):new pc.Vec3(0,0,-30):i.z>0?new pc.Vec3(-30,0,0):new pc.Vec3(30,0,0);var r=new pc.Vec3(0,0,0);const o=this.pointer;o.tween(o.getLocalEulerAngles()).rotate(n,.175,pc.SineOut).start().on("complete",(function(){o.tween(o.getLocalPosition()).to(t,.35,pc.SineOut).start().on("complete",(function(){o.tween(o.getLocalEulerAngles()).rotate(r,.175,pc.SineOut).start()}))}))},AnimalChanger.prototype.changeAnimation=function(e){if(e.mainRef.mainPlayer){var t=e.mainRef.animalRef.clone();this.app.root.addChild(t),t.setPosition(e.mainRef.animalRef.getPosition()),t.script=void 0,t.rigidbody&&(t.rigidbody.enabled=!1);var n=t.findByName("Mesh");if(n||(n=t.findByName("Mesh_LOD0")),n&&n.render){console.log("mesh entity",n);var a=new pc.StandardMaterial;a.diffuse=new pc.Color(.68,.85,.9),a.blendType=pc.BLEND_NORMAL,a.specular=new pc.Color(.68,.85,.9),a.update(),n.render.meshInstances.forEach((function(e){e.material=a,e.castShadow=!1,e.receiveShadow=!1,e.lightmapped=!1})),t.coreMaterial=a}t.addComponent("script"),t.script.create("floatUp"),console.log("Clone is now static at position:",t.getPosition())}},AnimalChanger.prototype.toggleAnimalHint=function(){const e=this.app.root.findScript("gameplay"),t=this.app.mainPlayerObject.latestCheckPointId,n=e.currentCheckpoint.findScript("checkpoint").suggestedAnimal;if(!t||!this.currentlyPressed)return;const a=animMapRev[n]%6;for(const[e,t]of Object.entries(this.animalButtons))e!=this.currentlyPressed&&(this.animalButtons[e].findByName("recommendEffect").enabled=!1);this.currentlyPressed!==a&&a&&(this.animalButtons[a].findByName("recommendEffect").enabled=!0)},AnimalChanger.prototype.toggleSkins=function(e,t,n,a){if(n&&this.animalChangeCooldown)return;const i={monkey:e.findByName("Monkey"),colobus:e.findByName("Colobus"),gecko:e.findByName("Gecko"),elephant:e.findByName("Elephant"),kangaroo:e.findByName("Kangaroo"),kirin:e.findByName("Kirin"),turkey:e.findByName("Turkey"),geckoDragon:e.findByName("GeckoDragon"),leviathan:e.findByName("Leviathan"),pheonix:e.findByName("Pheonix"),wyvern:e.findByName("Wyvern"),chameleon:e.findByName("Chameleon"),hornedLizard:e.findByName("HornedLizard"),panda:e.findByName("Panda"),gemsbok:e.findByName("Gemsbok"),llama:e.findByName("Llama"),kiwi:e.findByName("Kiwi"),peacock:e.findByName("Peacock"),polarBear:e.findByName("PolarBear"),rhino:e.findByName("Rhino")};if(this.currentlyPressed!==t||!n||n&&a){let a;if(a="number"==typeof this.currentSkinKeys[t%6-1]&&n?animMap[this.currentSkinKeys[t%6-1]]:animMap[t],a&&e.mainRef&&(!n||this.isTransformValid(i[a]))){this.currentlyPressed&&this.changeAnimation(e);for(const[e,t]of Object.entries(i))t.enabled=e===a;if(this.currentlyPressed&&n&&e.mainRef.animalRef!==i[a]&&(e.mainRef.animRef&&e.mainRef.animRef.getBoolean("playEmote")&&e.mainRef.animRef.setBoolean("playEmote",!1),e.mainRef.animalRef.enabled=!1),e.mainRef.animRef=i[a].anim,e.mainRef.animalRef=i[a],n){if(this.animalChangeCooldown=!0,setTimeout((()=>{this.animalChangeCooldown=!1}),700),t){let e;console.log("TOGGLING KEY PRESSED",t);for(const[n,a]of Object.entries(this.animalButtons))n==t&&(e=a);e&&this.currentlyPressed&&this.tweenArrow(e)}this.entity.script.networkManager.updateAnimal(this.currentSkinKeys[t-1]),e.c.collision.halfExtents=i[a].collision.halfExtents,e.c.collision.linearOffset=i[a].collision.linearOffset;for(const[e,n]of Object.entries(this.animalSettings[t-1]))switch(e){case"mass":case"friction":case"restitution":case"speed":case"jumpForce":case"maxAirJumps":case"heavy":case"climb":case"playerGravity":case"safeFall":this.app.fire("animalChanger:playerMovementScriptAttrUpdate",e,n)}if(this.app.fire("animalChanger:updateAnimationState"),e&&e.sound&&e.sound.play("animalSwitch"),this.currentlyPressed=t%6,this.app.mainPlayerObject&&this.app.mainPlayerObject.latestCheckPointId){if(this.app.mainPlayerObject.latestCheckPointId&&this.currentlyPressed){const e=this.app.root.findScript("gameplay").currentCheckpoint.findScript("checkpoint").suggestedAnimal,t=animMapRev[e]%6;this.currentlyPressed===t&&(this.animalButtons[t].findByName("recommendEffect").enabled=!1)}}}}else console.log("ANIMATION NOT FOUND")}},AnimalChanger.tempPos=new pc.Vec3,AnimalChanger.tempHalfExtents=new pc.Vec3,AnimalChanger.tempRayCastEnd=new pc.Vec3,AnimalChanger.prototype.isTransformValid=function(e){if(!e||!e.collision)return!1;let t=!this.lockTransform;if(t){AnimalChanger.tempPos.copy(e.collision.getShapePosition()),AnimalChanger.tempHalfExtents.copy(e.collision.halfExtents).addScalar(.1);let n=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(0,AnimalChanger.tempHalfExtents.y,0).add(AnimalChanger.tempPos)),a=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(0,-AnimalChanger.tempHalfExtents.y,0).add(AnimalChanger.tempPos)),i=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(AnimalChanger.tempHalfExtents.x,0,0).add(AnimalChanger.tempPos)),r=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(-AnimalChanger.tempHalfExtents.x,0,0).add(AnimalChanger.tempPos)),o=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(0,0,AnimalChanger.tempHalfExtents.z).add(AnimalChanger.tempPos)),s=this.app.systems.rigidbody.raycastAll(AnimalChanger.tempPos,AnimalChanger.tempRayCastEnd.set(0,0,-AnimalChanger.tempHalfExtents.z).add(AnimalChanger.tempPos));(n.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic()))&&a.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic()))||i.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic()))&&r.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic()))||o.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic()))&&s.some((e=>e.entity.rigidbody&&e.entity.rigidbody.isStatic())))&&(t=!1)}return t||(this.blockText||(this.blockText=this.app.root.findByName("TransformBlockText")),this.blockText&&(this.blockText.enabled=!0,setTimeout(function(){this.blockText.enabled=!1}.bind(this),1e3*this.blockTextDuration))),t};const petLodLevels={0:{min:0,max:5},1:{min:5,max:10},2:{min:10,max:15},3:{min:15,max:100}};AnimalChanger.prototype.update=function(e){var t=this.app.mainPlayer,n=window.touchJoypad.buttons;for(let e=1;e<=5;e++)if(this.app.keyboard.wasPressed(pc["KEY_"+e])||n.wasPressed("animal"+e)){this.toggleSkins(t,e,!0);break}if(this.lodCooldown)this.lodTimer-=e,this.lodTimer<0&&(this.lodCooldown=!1);else{for(const e in this.app.playerObjects){const n=this.app.playerObjects[e];if(!n.mainPlayer){const e=n.entity,a=t.getPosition().distance(e.getPosition()),i=n.animalRef,r={0:i.findByName("Mesh_LOD0"),1:i.findByName("Mesh_LOD1"),2:i.findByName("Mesh_LOD2"),3:i.findByName("Mesh_LOD3")};let o=-1;for(const e in petLodLevels)if(a>=petLodLevels[e].min&&a<petLodLevels[e].max){o=e;break}for(const e in r)r[e].enabled=o===e;i.lodLevel=o,i.enabled=-1!==o}}this.lodTimer=this.lodInterval,this.lodCooldown=!0}};var Timer=pc.createScript("gameTimer");Timer.initialTime=0,Timer.currentTime=0,Timer.prototype.initialize=function(){this.saveManager=this.app.root.findScript("saveManager"),this.time=this.entity.findByName("GameTime"),this.time.on("enable",this.onEnable,this),this.time.on("disable",this.onDisable,this),this.time.on("reset",this.onReset,this),this.reset=!0,this.onEnable(),this.enabled=!1,this.runComplete=!1,this.gameMode="classic",this.gameModeList=["classic","Waterworld"],this.startZone=!1},Timer.prototype.onEnable=function(){var e=Timer.currentTime;if(this.reset||0===e){var t=Timer.initialTime;this.time.element.text=this.formatTime(t),Timer.currentTime=t,this.reset=!1}else this.time.element.text=this.formatTime(e);this.enabled=!0,this.app.on("gameplay:updateTime",this.updateTimer,this),this.app.on("gameplay:completeRun",this.completeRun,this)},Timer.prototype.onDisable=function(){this.app.off("gameplay:updateTime",this.updateTimer,this),this.app.off("gameplay:completeRun",this.completeRun,this)},Timer.prototype.onReset=function(){this.reset=!0,Timer.currentTime=Timer.initialTime,this.onDisable(),this.onEnable()},Timer.prototype.completeRun=function(){this.runComplete=!0;let e=this.app.currentWorld;"Skyworld"===e&&(e="classic"),this.saveTime(Timer.currentTime,e)},Timer.prototype.getTime=function(){return console.log("Called get time:",Timer.currentTime),Timer.currentTime},Timer.prototype.setTime=function(e){Timer.currentTime=e},Timer.prototype.updateTimer=function(e){if(!this.runComplete&&!this.startZone){Timer.currentTime+=e;var t=Timer.currentTime;this.time.element.text=this.formatTime(t)}},Timer.prototype.formatTime=function(e){var t=Math.floor(e/60),i=Math.floor(e%60);return t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")},Timer.prototype.updateSavedCurrentTime=function(){const e=this.getTime(),t=this.app.currentWorld;let i;i="Skyworld"===t?"":t,this.saveManager.save(`currentTime${i}`,e.toString())},Timer.prototype.saveTime=function(e,t){var i=JSON.parse(this.saveManager.load("timerScores"))||[];i.push({time:e,gameMode:t}),this.saveManager.save("timerScores",JSON.stringify(i))},Timer.prototype.getSortedScores=function(e){var t=JSON.parse(this.saveManager.load("timerScores"))||[],i={};return this.gameModeList.forEach((r=>{var s=t.filter((e=>e.gameMode===r)).map((e=>e.time)).sort(((e,t)=>e-t));i[r]=s.slice(0,e)})),i};var CircleAutoFill=pc.createScript("circleAutoFill");CircleAutoFill.prototype.initialize=function(){this.fillDuration=2,this.currentFillTime=0,this.fillAmount=0,this.filling=!0},CircleAutoFill.prototype.update=function(i){this.filling&&(this.currentFillTime+=i,this.fillAmount=this.currentFillTime/this.fillDuration,this.entity.element.fillAmount=this.fillAmount,this.fillAmount>=1&&(this.currentFillTime=0))};!function(){const t={},n={},o={buttons:{isPressed:function(t){return!!n[t]},wasPressed:function(o){const e=n[o],s=t[o];return void 0!==n[o]&&(!s&&e)},wasReleased:function(o){const e=n[o],s=t[o];return void 0!==n[o]&&(s&&!e)},wasTapped:function(n){if(this.wasReleased(n)){return Date.now()-t[n]<=200}return!1}},sticks:{}};o.buttonStates=n;pc.Application.getApplication().on("update",(()=>{for(const o of Object.keys(n)){const e=n[o];t[o]=e}})),window.touchJoypad=o}();var Powerup=pc.createScript("powerup");Powerup.attributes.add("fillupTime",{type:"number",default:.5}),Powerup.attributes.add("powerupXRotation",{type:"number",default:0}),Powerup.attributes.add("powerupYRotation",{type:"number",default:40}),Powerup.attributes.add("powerupZRotation",{type:"number",default:0}),Powerup.attributes.add("goUp",{type:"number",default:0}),Powerup.attributes.add("powerupType",{type:"string",default:"flight",enum:[{flight:"flight"},{speedShoes:"speedShoes"},{jetPack:"jetPack"},{invincibility:"invincibility"}],description:"Select the type of power-up"}),Powerup.attributes.add("autoSelect",{type:"boolean",default:!0}),Powerup.attributes.add("cullingDistance",{type:"number",default:50,title:"Culling Distance",description:"Distance at which the power-up is culled (disabled)"}),Powerup.attributes.add("autoSelectList",{type:"string",default:[],array:!0,description:"This is a dropdown attribute"}),Powerup.prototype.initialize=function(){if(this.collisionLock=!1,this.time=0,this.isColliding=!1,this.player=this.app.root.findByName("Player"),this.player){this.particleSystem=this.entity.findByName("Particle System"),this.initialScale=new pc.Vec3(1,0,1),this.autoSelect&&this.autoSelectPowerupType(this.autoSelectList);var t=this.app.root.findByName("Powerup Options").findByName(this.powerupType);if(t){this.powerUpSprite=t.clone(),this.powerUpSprite.enabled=!0,this.powerUpSprite.name="PowerupSprite";const e=.35;this.powerUpSprite.setLocalPosition(0,e,0),this.entity.addChild(this.powerUpSprite)}else console.error("Matching power-up type not found in Powerup Options!");this.particleSystem||console.error("Particle System child not found!"),this.powerUpSprite||console.error("PowerUpSprite child not found!"),this.basePedestal=this.entity.findByName("BasePedestal"),this.basePedestal&&this.basePedestal.collision&&this.basePedestal.rigidbody?(this.basePedestal.collision.on("collisionstart",this.onCollisionStart,this),this.basePedestal.collision.on("collisionend",this.onCollisionEnd,this)):console.error("BasePedestal or its collision/rigidbody component not found!"),this.registerWithRotationManager(),this.app.on("settings:applyPowerupCullDistance",(function(t){this.cullingDistance=t}),this)}else console.error("Player entity not found!")};const powerupTypeList=["flight","speedShoes","jetPack"];function autoSelectFromArray(t){return Array.isArray(t)?t[Math.floor(Math.random()*t.length)]:null}Powerup.prototype.autoSelectPowerupType=function(t){t&&Array.isArray(t)&&t.length>0?this.powerupType=autoSelectFromArray(t):this.powerupType=autoSelectFromArray(powerupTypeList)},Powerup.prototype.registerWithRotationManager=function(){this.rotationManager=this.app.root.findScript("rotationManager"),this.rotationManager.fire("registerPowerup",{entity:this.entity,script:this,powerUpSprite:this.powerUpSprite,particleSystem:this.particleSystem,rotationSpeed:new pc.Vec3(this.powerupXRotation,this.powerupYRotation,this.powerupZRotation),cullingDistance:this.cullingDistance}),this.entity.on("destroy",this.onDestroy,this),this.entity.on("disable",this.onDisable,this),this.entity.on("enable",this.onEnable,this)},Powerup.prototype.onDestroy=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},Powerup.prototype.onDisable=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},Powerup.prototype.onEnable=function(){this.rotationManager&&this.registerWithRotationManager()},Powerup.prototype.onCollisionStart=function(t){this.collisionLock||(this.isColliding=!0,this.time=0)},Powerup.prototype.onCollisionEnd=function(t){this.time=0,this.isColliding=!1},Powerup.prototype.update=function(t){if(this.isColliding){var e=this.player.getPosition(),i=this.basePedestal.getPosition(),o=new pc.Vec3;o.sub2(e,i);var s=this.basePedestal.getLocalScale().clone().scale(.5);Math.abs(o.x)<=.5*s.x&&Math.abs(o.y)<=.5*s.y&&Math.abs(o.z)<=.5*s.z&&(this.app.fire("powerup:filled",this.powerupType),this.isColliding=!1,this.collisionLock=!0,setTimeout(function(){this.collisionLock=!1}.bind(this),5e3))}};var RotateBasedOnDistance=pc.createScript("rotateBasedOnDistance");RotateBasedOnDistance.attributes.add("rotationSpeed",{type:"number",default:50,title:"Rotation Speed",description:"Speed at which the entity rotates (degrees per second)"}),RotateBasedOnDistance.attributes.add("ignoreDistance",{type:"boolean",default:!1,title:"Ignore Distance",description:"If true, the entity will rotate at full speed regardless of the distance to the player"}),RotateBasedOnDistance.attributes.add("rotationThreshold",{type:"number",default:0,title:"Rotation Threshold",description:"Custom rotation threshold for this entity. If null, the default threshold in RotationManager will be used."}),RotateBasedOnDistance.prototype.initialize=function(){this.registerWithManager()},RotateBasedOnDistance.prototype.registerWithManager=function(){this.rotationManager=this.app.root.findScript("rotationManager"),this.rotationManager&&this.rotationManager.fire("register",this.entity,this,this.rotationThreshold),this.entity.on("destroy",this.onDestroy,this),this.entity.on("disable",this.onDisable,this),this.entity.on("enable",this.onEnable,this)},RotateBasedOnDistance.prototype.onDestroy=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},RotateBasedOnDistance.prototype.onDisable=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},RotateBasedOnDistance.prototype.onEnable=function(){this.rotationManager&&this.rotationManager.fire("register",this.entity,this,this.rotationThreshold)};var OptimizeSettings=pc.createScript("optimizeSettings"),deviceSettingsSchema=[{name:"disableParticles",type:"boolean",default:!1,title:"Disable Particles"},{name:"resolutionRatio",type:"number",default:.75,min:.1,max:1,precision:2,title:"Resolution Ratio"},{name:"devicePixelRatio",type:"number",default:1,min:.1,max:1,precision:2,title:"Device Pixel Ratio"},{name:"cascades",type:"number",default:2,min:1,max:4,title:"Cascades"},{name:"shadowDistance",type:"number",default:75,min:0,title:"Shadow Distance"},{name:"cameraFarClip",type:"number",default:1e3,min:1,title:"Camera Far Clip"},{name:"castShadows",type:"boolean",default:!0,title:"Cast Shadows"},{name:"questionCullDistance",type:"number",default:50,min:0,title:"Question Cull Distance"},{name:"powerupCullDistance",type:"number",default:50,min:0,title:"Powerup Cull Distance"},{name:"transparentCullDistance",type:"number",default:100,min:0,title:"Transparent Cull Distance"},{name:"menuButtonPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"emoteButtonPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"jumpButtonPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"animal1Prompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"animal2Prompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"animal3Prompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"animal4Prompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"animal5Prompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"highScoreButtonPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"keyboardMovementPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"mouseViewPrompt",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"joyStickHideOnRlease",type:"boolean",default:!0,description:"buttonPrompt enable/disable"},{name:"defaultCameraDistance",type:"number",default:4.5,min:3,max:10,precision:2,title:"Default Camera Distance"}];OptimizeSettings.attributes.add("androidSettings",{type:"json",schema:deviceSettingsSchema,title:"Android Settings"}),OptimizeSettings.attributes.add("iosSettings",{type:"json",schema:deviceSettingsSchema,title:"iOS Settings"}),OptimizeSettings.attributes.add("chromebookSettings",{type:"json",schema:deviceSettingsSchema,title:"Chromebook Settings"}),OptimizeSettings.attributes.add("desktopSettings",{type:"json",schema:deviceSettingsSchema,title:"Desktop Settings"}),OptimizeSettings.attributes.add("laptopSettings",{type:"json",schema:deviceSettingsSchema,title:"Laptop Settings"}),OptimizeSettings.attributes.add("lightEntity",{type:"entity",title:"Light Entity"}),OptimizeSettings.attributes.add("cameraEntity",{type:"entity",title:"Camera Entity"}),OptimizeSettings.prototype.initialize=function(){function getOrientation(){try{if("undefined"!=typeof window&&window.screen&&window.screen.orientation&&window.screen.orientation.type)return window.screen.orientation.type;if("undefined"!=typeof window&&window.matchMedia("(orientation: portrait)").matches)return"portrait-primary";if("undefined"!=typeof window&&window.matchMedia("(orientation: landscape)").matches)return"landscape-primary"}catch(t){console.warn("Error detecting orientation:",t)}return"landscape-primary"}console.log("init optim settings"),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,(function(t){t.event.preventDefault(),console.log("Mouse wheel used")})),this.app.keyboard.on(pc.EVENT_KEYDOWN,(function(t){t.key!==pc.KEY_LEFT&&t.key!==pc.KEY_UP&&t.key!==pc.KEY_RIGHT&&t.key!==pc.KEY_DOWN||(t.event.preventDefault(),console.log("Arrow key pressed:",t.key))})),this.app.on("start",this.applySettings,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,(function(t){t.event.preventDefault(),console.log("Mouse wheel used")})),this.app.keyboard.on(pc.EVENT_KEYDOWN,(function(t){t.key!==pc.KEY_LEFT&&t.key!==pc.KEY_UP&&t.key!==pc.KEY_RIGHT&&t.key!==pc.KEY_DOWN||(t.event.preventDefault(),console.log("Arrow key pressed:",t.key))})),this.on("attr:androidSettings",this.applySettings,this),this.on("attr:iosSettings",this.applySettings,this),this.on("attr:chromebookSettings",this.applySettings,this),this.on("attr:desktopSettings",this.applySettings,this),this.on("attr:laptopSettings",this.applySettings,this),this.deviceType=this.getDeviceType(),this.app.deviceType=this.deviceType,this.app.fire("deviceTypeRegistered",this.deviceType),this.app.on("scene:loaded",this.findCullableEntities,this),this.applySettings(),this.checkDistanceTime=0,this.updateCulling(),this.app.on("touchJoystick:initialized",(()=>{this.app.fire("optimizeSettings:joyStickHideOnRelease",this.currentJoyStickSettings)}),this),this.app.currentOrientation="landscape",this.currentOrientation="landscape";try{if("undefined"!=typeof window){let t=getOrientation();"portrait-primary"===t||"portrait-secondary"===t?(this.app.fire("optimizeSettings:orientation","portrait"),this.app.currentOrientation="portrait",this.currentOrientation="portrait"):(this.app.fire("optimizeSettings:orientation","landscape"),this.app.currentOrientation="landscape",this.currentOrientation="landscape"),window.screen&&window.screen.orientation&&"function"==typeof window.screen.orientation.addEventListener?window.screen.orientation.addEventListener("change",function(t){try{let t=getOrientation();"portrait-primary"===t||"portrait-secondary"===t?this.app.fire("optimizeSettings:orientation","portrait"):this.app.fire("optimizeSettings:orientation","landscape")}catch(t){console.warn("Error handling orientation change event:",t)}}.bind(this)):window.addEventListener("resize",function(){try{let t=getOrientation();"portrait-primary"===t||"portrait-secondary"===t?this.app.fire("optimizeSettings:orientation","portrait"):this.app.fire("optimizeSettings:orientation","landscape")}catch(t){console.warn("Error handling resize event:",t)}}.bind(this))}else console.error("Window object is not available. Orientation detection is disabled.")}catch(t){console.error("Critical error initializing orientation detection:",t),this.app.fire("optimizeSettings:orientation","landscape"),this.app.currentOrientation="landscape",this.currentOrientation="landscape"}},OptimizeSettings.prototype.getDeviceType=function(){var t=navigator.userAgent.toLowerCase();return/android/.test(t)?"android":/iphone|ipad|ipod/.test(t)?"ios":/cros/.test(t)?"chromebook":/windows|macintosh|linux/.test(t)?"desktop":"laptop"},OptimizeSettings.prototype.applySettings=function(){switch(this.deviceType){case"android":this.applyDeviceSettings(this.androidSettings);break;case"ios":this.applyDeviceSettings(this.iosSettings);break;case"chromebook":this.applyDeviceSettings(this.chromebookSettings);break;case"desktop":this.applyDeviceSettings(this.desktopSettings);break;default:this.applyDeviceSettings(this.laptopSettings)}this.app.fire("optimizeSettings:deviceSettingApplied",this.deviceType),console.log("Device Type: "+this.deviceType)},OptimizeSettings.prototype.applyDeviceSettings=function(t){console.log("applying device settings"),this.app.graphicsDevice.maxPixelRatio=t.devicePixelRatio,console.log("DISABLE PARTICLES VALUE",t.disableParticles),t.disableParticles?console.log("disable particles set to true"):(console.log("disable particles set to false"),this.enableParticleSystems()),this.lightEntity&&this.lightEntity.light&&(this.lightEntity.light.shadowCascadeCount=t.cascades,this.lightEntity.light.shadowDistance=t.shadowDistance,this.lightEntity.light.castShadows=t.castShadows),this.cameraEntity&&this.cameraEntity.camera&&(this.cameraEntity.camera.renderScale=t.resolutionRatio,this.cameraEntity.camera.farClip=t.cameraFarClip),this.arrowCullDistance=50,this.signCullDistance=47,this.questionCullDistance=t.questionCullDistance,this.powerupCullDistance=t.powerupCullDistance,this.transparentCullDistance=t.transparentCullDistance;let e=this.entity.findByName("menuButtonPrompt"),i=this.entity.findByName("emoteButtonPrompt"),n=this.entity.findByName("jumpButtonPrompt"),a=this.entity.findByName("animal1Prompt"),o=this.entity.findByName("animal2Prompt"),s=this.entity.findByName("animal3Prompt"),r=this.entity.findByName("animal4Prompt"),p=this.entity.findByName("animal5Prompt"),l=this.entity.findByName("highScoreButtonPrompt"),c=this.entity.findByName("keyboardMovementPrompt"),d=this.entity.findByName("mouseViewPrompt");if(e&&(e.enabled=t.menuButtonPrompt),i&&(i.enabled=t.emoteButtonPrompt),n&&(n.enabled=t.jumpButtonPrompt),a&&(a.enabled=t.animal1Prompt),o&&(o.enabled=t.animal2Prompt),s&&(s.enabled=t.animal3Prompt),r&&(r.enabled=t.animal4Prompt),p&&(p.enabled=t.animal5Prompt),l&&(l.enabled=t.highScoreButtonPrompt),c&&(c.enabled=t.keyboardMovementPrompt),d&&(d.enabled=t.mouseViewPrompt),t.joyStickHideOnRlease&&(this.currentJoyStickSettings=t.joyStickHideOnRlease),t.defaultCameraDistance){let e=this.cameraEntity.parent.findByName("RaycastEndPoint");e&&e.setLocalPosition(new pc.Vec3(0,0,t.defaultCameraDistance))}console.log("Resolution Ratio: "+t.resolutionRatio),console.log("Device Pixel Ratio: "+t.devicePixelRatio),console.log("Shadow Cascades: "+t.cascades),console.log("Shadow Distance: "+t.shadowDistance),console.log("Camera Far Clip: "+t.cameraFarClip),console.log("Cast Shadows: "+t.castShadows),console.log("Question Cull Distance: "+t.questionCullDistance),console.log("Powerup Cull Distance: "+t.powerupCullDistance),this.app.fire("settings:applyPowerupCullDistance",this.powerupCullDistance)},OptimizeSettings.prototype.disableParticleSystems=function(){for(var t=this.app.root.findByTag("particles"),e=0;e<t.length;e++){var i=t[e].particleSystem;i&&(i.enabled=!1,console.log("Particle system disabled:",t[e].name))}},OptimizeSettings.prototype.enableParticleSystems=function(){for(var t=this.app.root.findByTag("particles"),e=0;e<t.length;e++){const n=t[e];n.enabled=!0;var i=n.particlesystem;i?(i.enabled=!0,i.reset(),i.play()):console.log("No particle system found on entity:",t[e].name)}},OptimizeSettings.prototype.findCullableEntities=function(){this.signEntities=this.app.root.find((function(t){return t.enabled&&t.name.includes("SignImage")})),this.transparentCullableEntities=this.app.root.findByTag("transparentCullable"),this.animalGates=[];for(var t=this.app.root.find((function(t){return t.enabled&&t.name.includes("Animal Gate")})),e=0;e<t.length;e++){var i=t[e],n=i.findByName("Animal"),a=i.findByName("Particle System"),o=i.findByName("backgroundTest");this.animalGates.push({gate:i,explanation:n,particleSystem:a,background:o})}this.questionEntities=this.app.root.find((function(t){return t.enabled&&t.name.includes("Question")})),console.log("Found Sign Entities:",this.signEntities.length),console.log("Found Question Entities:",this.questionEntities.length)},OptimizeSettings.prototype.update=function(t){this.checkDistanceTime+=t,this.checkDistanceTime>=1&&(this.updateCulling(),this.checkDistanceTime=0)},OptimizeSettings.prototype.updateCulling=function(){if(this.app.sceneLoaded){var t=this.app.root.findByName("Player");if(t){for(var e=t.getPosition(),i=0;i<this.animalGates.length;i++){var n=this.animalGates[i],a=n.gate,o=e.distance(a.getPosition()),s=Math.abs(e.y-a.getPosition().y);n.particleSystem.enabled=o<=50&&s<=30,n.background.enabled=o<=200&&s<=70}for(i=0;i<this.signEntities.length;i++){a=this.signEntities[i],o=e.distance(a.getPosition());a.enabled=o<=this.signCullDistance}for(var r=0;r<this.questionEntities.length;r++){a=this.questionEntities[r],o=e.distance(a.getPosition());a.enabled=o<=this.questionCullDistance}}else console.error("Player entity not found!")}},OptimizeSettings.prototype.swap=function(t){this.applySettings(),this.findCullableEntities()},pc.script.create("optimizeSettings",OptimizeSettings);var TouchButton=pc.createScript("touchButton");TouchButton.attributes.add("identifier",{type:"string",default:"button0",title:"Identifier",description:"A unique name for the button to refer to it by in the API. Will give a warning in browser tools if the name is not unique."}),TouchButton.attributes.add("vibration",{type:"number",default:0,title:"Vibration duration (ms)",description:"If the device supports vibration with 'Navigator.vibrate', it will vibrate for the duration set here on touch down.Set to 0 to disable."}),TouchButton.prototype.initialize=function(){window.touchJoypad&&void 0!==window.touchJoypad.buttonStates[this.identifier]?console.warn("Touch button identifier already used, please use another for Entity: "+this.entity.name):(this.entity.button&&(this.entity.button.on("hoverstart",(()=>{document.body.style.cursor="pointer"})),this.entity.button.on("hoverend",(()=>{document.body.style.cursor="default"}))),this._canVibrate=!!navigator.vibrate,this._setState(!1),this.on("state",(t=>{this._setEvents(t?"on":"off")})),this.on("destroy",(()=>{window.touchJoypad&&(window.touchJoypad.buttonStates[this.identifier]=void 0)})),this._setEvents("on"),this.intializeCompleted=!0)},TouchButton.prototype._setEvents=function(t){this._state=!1,this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.app.touch&&(this.entity.element[t]("touchstart",this._onTouchDown,this),this.entity.element[t]("touchend",this._onTouchUp,this),this.entity.element[t]("touchcancel",this._onTouchUp,this))},TouchButton.prototype._onMouseDown=function(t){this._state||(this._onPointerDown(),t.stopPropagation())},TouchButton.prototype._onMouseUp=function(t){this._state&&(this._onPointerUp(),t.stopPropagation())},TouchButton.prototype._onTouchDown=function(t){this._state||(this._onPointerDown(),t.stopPropagation())},TouchButton.prototype._onTouchUp=function(t){this._state&&(this._onPointerUp(),t.stopPropagation()),t.event.preventDefault()},TouchButton.prototype._onPointerDown=function(){this._canVibrate&&0!==this.vibration&&navigator.vibrate(this.vibration),this._setState(!0)},TouchButton.prototype._onPointerUp=function(){this._setState(!1)},TouchButton.prototype._setState=function(t){window.touchJoypad&&(window.touchJoypad.buttonStates[this.identifier]=t?Date.now():null),this._state=t};var ProgressBar=pc.createScript("progressBar");ProgressBar.attributes.add("progressImage",{type:"entity"}),ProgressBar.prototype.initialize=function(){this.imageRect=this.progressImage.element.rect.clone(),this.setProgress(0),this.increase=!0,this.app.on("optimizeSettings:orientation",(e=>{setTimeout(function(){this.setProgress(this.progress)}.bind(this),150)}),this)},ProgressBar.prototype.setProgress=function(e){e=pc.math.clamp(e,0,1),this.progress=e;var t=pc.math.lerp(0,.98*this.entity.element.width,e);this.progressImage.element.width=t,this.progressImage.element.height=.85*this.entity.element.height,this.imageRect.copy(this.progressImage.element.rect),this.imageRect.z=e,this.progressImage.element.rect=this.imageRect};var PowerUpConfirmText=pc.createScript("PowerUpConfirmText");PowerUpConfirmText.prototype.initialize=function(){this.app.on("powerup:filled",(e=>{"duck"===e&&(e="speedShoes");let t=pc.app.root.findByName("powerUpConfirmTextEntity");var i="Jet Pack";switch(e){case"speedShoes":i="Speed Shoes";break;case"jetPack":i="Jet Pack";break;case"invincibility":i="Invincibility Star";break;case"flight":i="Flight"}t.element.text=`${i}`}))};var TransformBlockTextScript=pc.createScript("transformBlockTextScript");TransformBlockTextScript.prototype.initialize=function(){this.entity.tween(this.entity.getLocalScale()).to(new pc.Vec3(1.5,1.5,1.5),.5,pc.SineOut).loop(!0).yoyo(!0).start()},TransformBlockTextScript.prototype.update=function(t){};var Staircase=pc.createScript("staircase");Staircase.attributes.add("numberOfSteps",{type:"number",default:10,title:"Number of Steps"}),Staircase.attributes.add("maxGradientSteps",{type:"number",default:25,title:"Steps for one rainbow loop"}),Staircase.attributes.add("baseStepEntity",{type:"entity",title:"Base Step Entity"}),Staircase.attributes.add("stepHeight",{type:"number",default:.2,title:"Step Height"}),Staircase.attributes.add("stepWidthX",{type:"number",default:.2,title:"Step Width X"}),Staircase.attributes.add("stepWidthZ",{type:"number",default:.2,title:"Step Width Z"}),Staircase.attributes.add("rotationIncrementX",{type:"number",default:0,title:"Rotation Increment (Degrees)"}),Staircase.attributes.add("rotationIncrementY",{type:"number",default:0,title:"Rotation Increment (Degrees)"}),Staircase.attributes.add("rotationIncrementZ",{type:"number",default:0,title:"Rotation Increment (Degrees)"}),Staircase.attributes.add("invertStepNumber",{type:"number",default:0,title:"Invert Step Interval"}),Staircase.attributes.add("enableDisappearingSteps",{type:"boolean",default:!0,title:"Enable Scaling on Touch"}),Staircase.attributes.add("initialTimerBeforeChange",{type:"number",default:0,title:"Initial Timer Before Color Change (seconds)"}),Staircase.attributes.add("colorChangeDuration",{type:"number",default:5,title:"Color Change Duration (seconds)"}),Staircase.attributes.add("lighteningFactor",{type:"number",default:1.5,title:"Lightening Factor"}),Staircase.attributes.add("disappearDelay",{type:"number",default:2,title:"Delay Before Scaling Down (seconds)"}),Staircase.attributes.add("reappearDelay",{type:"number",default:5,title:"Delay Before Scaling Up (seconds)"}),Staircase.attributes.add("scaleDownFactor",{type:"number",default:.001,title:"Scale Down Factor"}),Staircase.attributes.add("xRotationAxisPoint",{type:"json",title:"Rotation Axis Point for X Axis",schema:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0},{name:"z",type:"number",default:0},{name:"angleIncrement",type:"number",default:0}]}),Staircase.attributes.add("yRotationAxisPoint",{type:"json",title:"Rotation Axis Point for Y Axis",schema:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0},{name:"z",type:"number",default:0},{name:"angleIncrement",type:"number",default:0}]}),Staircase.attributes.add("zRotationAxisPoint",{type:"json",title:"Rotation Axis Point for Z Axis",schema:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0},{name:"z",type:"number",default:0},{name:"angleIncrement",type:"number",default:0}]}),Staircase.prototype.initialize=function(){var t=this;setTimeout((()=>{this.staircaseHasDelay=!0,t.createStaircase()}),200)},Staircase.prototype.createStaircase=function(){var t=this.baseStepEntity;if(!t)return void console.error("Base Step Entity is not assigned.");t.enabled=!0;var e=t.getLocalPosition().clone(),i=e.y,o=e.x,n=e.z,a=0,s=0,r=0;this.tempRotationPoint=new pc.Vec3,this.tempRotationAxis=new pc.Vec3,this.tempRotationIncrement=0,this.tempRotationQuat=new pc.Quat,this.tempCurrentPosition=new pc.Vec3,this.tempAxisToPosition=new pc.Vec3,this.tempAxisToNewPosition=new pc.Vec3,this.xRotationAxisPointVector=new pc.Vec3(this.xRotationAxisPoint.x,this.xRotationAxisPoint.y,this.xRotationAxisPoint.z),this.yRotationAxisPointVector=new pc.Vec3(this.yRotationAxisPoint.x,this.yRotationAxisPoint.y,this.yRotationAxisPoint.z),this.zRotationAxisPointVector=new pc.Vec3(this.zRotationAxisPoint.x,this.zRotationAxisPoint.y,this.zRotationAxisPoint.z),0===this.xRotationAxisPointVector.lengthSq()&&0===this.xRotationAxisPoint.angleIncrement||(this.customRotationX=!0),0===this.yRotationAxisPointVector.lengthSq()&&0===this.yRotationAxisPoint.angleIncrement||(this.customRotationY=!0),0===this.zRotationAxisPointVector.lengthSq()&&0===this.zRotationAxisPoint.angleIncrement||(this.customRotationZ=!0);this.attachPrimitiveColorScript(t,0,this.numberOfSteps);var c=this.app.root.findScript("levelCuller"),l=this.findParentLevel();if(!l)return void console.error("Staircase could not find the parent level!");var p=l._guid;const h=this.app.root.findScript("myInstancer");h.skipUpdateVertexBuffer=!0;for(var u=0;u<this.numberOfSteps;u++){u===this.numberOfSteps-1&&(h.skipUpdateVertexBuffer=!1);var m=t.clone();0!==u&&0!==this.invertStepNumber&&u%this.invertStepNumber==0&&(this.stepHeight=-this.stepHeight,m.collision.angularOffset=m.collision.angularOffset.invert()),0!==u&&(i+=this.stepHeight,o+=this.stepWidthX,n+=this.stepWidthZ,a+=this.rotationIncrementX,s+=this.rotationIncrementY,r+=this.rotationIncrementZ,this.tempCurrentPosition.set(o,i,n),this.customRotationX&&(this.rotateAround("x"),a+=this.xRotationAxisPoint.angleIncrement),this.customRotationY&&(this.rotateAround("y"),s+=this.yRotationAxisPoint.angleIncrement),this.customRotationZ&&(this.rotateAround("z"),r+=this.zRotationAxisPoint.angleIncrement),o=this.tempCurrentPosition.x,i=this.tempCurrentPosition.y,n=this.tempCurrentPosition.z),m.setLocalPosition(o,i,n),m.setLocalEulerAngles(a,s,r),this.attachPrimitiveColorScript(m,u,this.numberOfSteps),m.originalScale=m.getLocalScale().clone(),m.originalColor=m._instancerColorData.clone(),m.touching=!1,this.enableDisappearingSteps&&this.registerCollisionHandler(m),this.entity.addChild(m),this.staircaseHasDelay&&c.addEntitiesToCullingWithLevel(m,p)}t.enabled=!1},Staircase.prototype.findParentLevel=function(){for(var t=this.entity;t;){if(t.tags&&t.tags.has("level"))return t;t=t.parent}return null},Staircase.prototype.attachPrimitiveColorScript=function(t,e,i){let o=e%(2*this.maxGradientSteps);o>=this.maxGradientSteps&&(o=2*this.maxGradientSteps-o);const n=this.getRainbowColor(o/this.maxGradientSteps);t._instancerColorData=n,t.originalColor=n.clone()},Staircase.prototype.getRainbowColor=function(t){const e=t,i=this.hsvToRgb(e,1,1);return new pc.Color(i.r,i.g,i.b)},Staircase.prototype.hsvToRgb=function(t,e,i){let o,n,a,s=Math.floor(6*t),r=6*t-s,c=i*(1-e),l=i*(1-r*e),p=i*(1-(1-r)*e);switch(s%6){case 0:o=i,n=p,a=c;break;case 1:o=l,n=i,a=c;break;case 2:o=c,n=i,a=p;break;case 3:o=c,n=l,a=i;break;case 4:o=p,n=c,a=i;break;case 5:o=i,n=c,a=l}return{r:o,g:n,b:a}},Staircase.prototype.rotateAround=function(t){switch(t){case"x":this.tempRotationPoint.set(this.tempCurrentPosition.x,this.xRotationAxisPointVector.y,this.xRotationAxisPointVector.z),this.tempRotationAxis.set(1,0,0),this.tempRotationIncrement=this.xRotationAxisPoint.angleIncrement;break;case"y":this.tempRotationPoint.set(this.yRotationAxisPointVector.x,this.tempCurrentPosition.y,this.yRotationAxisPointVector.z),this.tempRotationAxis.set(0,1,0),this.tempRotationIncrement=this.yRotationAxisPoint.angleIncrement;break;case"z":this.tempRotationPoint.set(this.zRotationAxisPointVector.x,this.zRotationAxisPointVector.y,this.tempCurrentPosition.z),this.tempRotationAxis.set(0,0,1),this.tempRotationIncrement=this.zRotationAxisPoint.angleIncrement;break;default:return}this.tempRotationQuat.setFromAxisAngle(this.tempRotationAxis,this.tempRotationIncrement),this.tempAxisToPosition.sub2(this.tempCurrentPosition,this.tempRotationPoint),this.tempAxisToNewPosition=this.tempRotationQuat.transformVector(this.tempAxisToPosition),this.tempCurrentPosition.add2(this.tempRotationPoint,this.tempAxisToNewPosition)},Staircase.prototype.registerCollisionHandler=function(t){var e=this;t.collision.on("collisionstart",(function(i){t.touching||(t.touching=!0,setTimeout((function(){e.makeLighter(t),e.scheduleScaleDown(t),e.scheduleRevertColor(t)}),1e3*e.initialTimerBeforeChange))}))},Staircase.prototype.makeLighter=function(t){if(this.enableDisappearingSteps&&t.originalColor){let e=t.originalColor,i=this.rgbToHsl(e.r,e.g,e.b);i.l=Math.min(i.l+.015,1);let o=this.hslToRgb(i.h,i.s,i.l);t._instancerColorData=o}},Staircase.prototype.scheduleScaleDown=function(t){var e=this;this.enableDisappearingSteps&&setTimeout((function(){t.setLocalScale(e.scaleDownFactor,e.scaleDownFactor,e.scaleDownFactor),t.collision&&(t.collision.enabled=!1),t.rigidbody&&(t.rigidbody.enabled=!1),e.scheduleScaleUp(t)}),1e3*e.disappearDelay)},Staircase.prototype.scheduleScaleUp=function(t){this.enableDisappearingSteps&&setTimeout((function(){t.setLocalScale(t.originalScale),t.collision&&(t.collision.enabled=!0),t.rigidbody&&(t.rigidbody.enabled=!0),t.touching=!1}),1e3*this.reappearDelay)},Staircase.prototype.scheduleRevertColor=function(t){this.enableDisappearingSteps&&setTimeout((function(){t.originalColor&&(t._instancerColorData=t.originalColor.clone())}),1e3*this.colorChangeDuration)},Staircase.prototype.rgbToHsl=function(t,e,i){t/=255,e/=255,i/=255;let o,n,a=Math.max(t,e,i),s=Math.min(t,e,i),r=(a+s)/2;if(a==s)o=n=0;else{let c=a-s;switch(n=r>.5?c/(2-a-s):c/(a+s),a){case t:o=(e-i)/c+(e<i?6:0);break;case e:o=(i-t)/c+2;break;case i:o=(t-e)/c+4}o/=6}return{h:o,s:n,l:r}},Staircase.prototype.hslToRgb=function(t,e,i){let o,n,a;if(0==e)o=n=a=i;else{function hue2rgb(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}let s=i<.5?i*(1+e):i+e-i*e,r=2*i-s;o=hue2rgb(r,s,t+1/3),n=hue2rgb(r,s,t),a=hue2rgb(r,s,t-1/3)}return{r:Math.round(255*o),g:Math.round(255*n),b:Math.round(255*a)}};var DisappearOnTouch=pc.createScript("disappearOnTouch");DisappearOnTouch.attributes.add("initialTimerBeforeTransparent",{type:"number",default:0,title:"Initial Timer Before Transparent (seconds)"}),DisappearOnTouch.attributes.add("disappearDelay",{type:"number",default:2,title:"Disappear Delay (seconds)"}),DisappearOnTouch.attributes.add("reappearDelay",{type:"number",default:5,title:"Reappear Delay (seconds)"}),DisappearOnTouch.attributes.add("semiTransparentAlpha",{type:"number",default:.3,title:"Semi-Transparent Alpha"}),DisappearOnTouch.prototype.initialize=function(){this.originalAlpha=1,this.touching=!1,this.entity.collision.on("collisionstart",this.onCollisionStart,this)},DisappearOnTouch.prototype.onCollisionStart=function(e){this.touching||(console.log("registered touch!"),this.touching=!0,setTimeout((()=>{this.makeSemiTransparent(),this.scheduleDisappear()}),1e3*this.initialTimerBeforeTransparent))},DisappearOnTouch.prototype.makeSemiTransparent=function(){this.entity.render.meshInstances.forEach((function(e){e.material.opacity=this.semiTransparentAlpha,e.material.update(),console.log("updating to become semi transparent")}),this)},DisappearOnTouch.prototype.scheduleDisappear=function(){setTimeout((()=>{console.log("disappearing at",performance.now()),this.entity.enabled=!1,this.scheduleReappear()}),1e3*this.disappearDelay)},DisappearOnTouch.prototype.scheduleReappear=function(){setTimeout((()=>{console.log("reappearing at",performance.now()),this.entity.enabled=!0,this.entity.render.meshInstances.forEach((e=>{e.material.opacity=this.originalAlpha,e.material.update()})),this.touching=!1}),1e3*this.reappearDelay)};var LevelCuller=pc.createScript("levelCuller");LevelCuller.prototype.addEntitiesToCullingWithLevel=function(e,i){if(!this.levelsState[i])return void console.warn(`Level with GUID ${i} not found in levelsState.`,this.levelsState);const l=e.rigidbody,t=e.collision;this.levelsState[i].rigidbodies.push(l),this.levelsState[i].collisions.push(t),this.levelsState[i].rigidbodiesState.push(!0),this.levelsState[i].collisionsState.push(!0)},LevelCuller.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.player?(this.elapsedTime=0,this.levelsState={},this.levels=[],this.app.on("scene:unload",(()=>{this.initialised=!1})),this.app.on("scene:loaded",(()=>{this.initialiseCulling()})),this.app.on("gameplay:completeRun",(()=>{this.toggleLocalDeathFloor(!1)}),this),this.app.on("rebirthTeleporter:rebirth",(()=>{this.toggleLocalDeathFloor(!0)}),this)):console.error("Player entity not found!")},LevelCuller.prototype.initialiseCulling=function(){console.log("INITIALISING LEVELCULLER"),this.levels=this.app.root.findByTag("level"),this.levelsState={};for(let e=0;e<this.levels.length;e++){const i=this.levels[e];this.levelsState[i._guid]={rigidbodies:i.findComponents("rigidbody"),collisions:i.findComponents("collision"),isPhysicsEnabled:!1},this.levelsState[i._guid].rigidbodiesState=this.levelsState[i._guid].rigidbodies.map((e=>e.enabled)),this.levelsState[i._guid].collisionsState=this.levelsState[i._guid].collisions.map((e=>e.enabled)),this.levelsState[i._guid].collisions.forEach((e=>{e.enabled=!1})),this.levelsState[i._guid].rigidbodies.forEach((e=>{e.enabled=!1}))}this.initialised=!0,this.updateCulling(!0),console.log("INITIALISED LEVELCULLER",{levels:this.levels,levelState:this.levelsState})},LevelCuller.prototype.toggleLocalDeathFloor=function(e){for(let i=0;i<this.levels.length;i++){const l=this.levels[i];this.levelsState[l._guid].rigidbodies.forEach(((i,t)=>{"LocalDeathFloor"===i.entity.name&&(this.levelsState[l._guid].rigidbodiesState[t]=e)}))}},LevelCuller.prototype.update=function(e){this.initialised&&(this.elapsedTime+=e,this.elapsedTime>=.5&&(this.elapsedTime=0,this.updateCulling(!1)))},LevelCuller.prototype.updateCulling=function(e){var i=this.player.getPosition();for(let s=0;s<this.levels.length;s++){const o=this.levels[s],a=o.findByName("Checkpoint Area");if(a){var l=a.getPosition(),t=i.distance(l);const s=this.levelsState[o._guid];t<=90?s.isPhysicsEnabled&&!e||(s.rigidbodies.forEach(((e,i)=>{e.enabled=s.rigidbodiesState[i]})),s.collisions.forEach(((e,i)=>{e.enabled=s.collisionsState[i]})),s.isPhysicsEnabled=!0):s.isPhysicsEnabled&&(s.rigidbodies.forEach((e=>{e.enabled=!1})),s.collisions.forEach((e=>{e.enabled=!1})),s.isPhysicsEnabled=!1)}else console.warn(`"Checkpoint Area" not found in level: ${o.name}`)}};var FloatUp=pc.createScript("floatUp");FloatUp.prototype.initialize=function(){this.elapsedTime=0,this.duration=.7,this.initialPosition=this.entity.getPosition().clone(),this.initialRotation=this.entity.getEulerAngles().clone(),this.material=this.entity.coreMaterial},FloatUp.prototype.update=function(t){this.elapsedTime+=t;var i=this.initialPosition.clone();i.y+=.5*this.elapsedTime,this.entity.setPosition(i);var e=this.initialRotation.clone();if(e.x+=10*this.elapsedTime,e.y+=20*this.elapsedTime,e.z+=30*this.elapsedTime,this.entity.setEulerAngles(e),this.material){var a=1-this.elapsedTime/this.duration;this.material.opacity=pc.math.clamp(a,0,1),this.material.update()}this.elapsedTime>=this.duration&&this.entity.destroy()};var BreakBlock=pc.createScript("breakBlock");BreakBlock.attributes.add("respawnTimer",{type:"number",default:5,title:"Respawn timer after breaking"}),BreakBlock.attributes.add("cubeTemplate",{type:"entity",title:"Cube Template"}),BreakBlock.attributes.add("cubesCount",{type:"number",default:10,title:"Number of cubes to spawn"}),BreakBlock.prototype.initialize=function(){this.originalScale=this.entity.getLocalScale().clone(),this.entity.rigidbody.on("contact",(function(t){this.onContact(t)}),this),this.cubePool=[]},BreakBlock.prototype.onContact=function(t){t.other&&t.other.script&&t.other.script.playerMovement&&t.other.script.playerMovement.heavy&&(this.app.fire("breakblock:smashBlock"),this.breakUp(),setTimeout(function(){this.reset()}.bind(this),1e3*this.respawnTimer))},BreakBlock.prototype.breakUp=function(){this.entity.setLocalScale(.001,.001,.001),this.entity.collision&&(this.entity.collision.enabled=!1),this.spawnCubes()},BreakBlock.prototype.reset=function(){this.entity.setLocalScale(this.originalScale),this.entity.collision&&(this.entity.collision.enabled=!0),this.entity.enabled=!0},BreakBlock.prototype.spawnCubes=function(){if(this.entity.render)for(var t=this.entity.getPosition(),e=0;e<this.cubesCount;e++){var o=this.getCubeFromPool(),i=t.x+3*(Math.random()-.5),n=t.y+1+2*(Math.random()-.5),r=t.z+3*(Math.random()-.5);o.setPosition(i,n,r),o.enabled=!0,o.rigidbody.teleport(i,n,r),setTimeout(function(t){t.enabled=!1,this.returnCubeToPool(t)}.bind(this,o),1500)}else console.error("Entity does not have a render component")},BreakBlock.prototype.getCubeFromPool=function(){if(this.cubePool.length>0)return this.cubePool.pop();var t=this.cubeTemplate.clone();return this.app.root.addChild(t),t.enabled=!1,t},BreakBlock.prototype.returnCubeToPool=function(t){this.cubePool.push(t)};var CustomOpacity=pc.createScript("customOpacity");CustomOpacity.attributes.add("customOpacity",{type:"number",default:.99,title:"Opacity"}),CustomOpacity.prototype.postInitialize=function(){this.entity.render.material=this.originalMaterial,this.app.on("scene:loaded",this.onEnable,this),this.entity.render&&this.entity.render.meshInstances?(console.log("initialising custom opacity"),this.entity.render.meshInstances.forEach((t=>{console.log("setting custom opacity on mesh instance"),t.setParameter("material_opacity",this.customOpacity)}))):console.log("ATTEMPTED TO DO CUSTOM OPACITY BUT PROBLEM")},CustomOpacity.prototype.onEnable=function(){console.log("enabling on opacity entity"),this.entity.render&&this.entity.render.meshInstances&&this.entity.render.meshInstances.forEach((t=>{t.setParameter("material_opacity",this.customOpacity)}))},CustomOpacity.prototype.update=function(t){};var TransformLockScript=pc.createScript("transformLockScript");TransformLockScript.attributes.add("lockTransform",{type:"boolean",default:!0,title:"Lock Animal Transform"}),TransformLockScript.prototype.initialize=function(){this.entity.collision.on("triggerenter",(function(o){this.onTriggerEnter(o)}),this),this.entity.collision.on("triggerleave",(function(o){this.onTriggerLeave(o)}),this)},TransformLockScript.prototype.onTriggerEnter=function(o){console.log(o.name+" has entered lock box."),this.lockTransform&&this.app.fire("transformLock:lockTransform")},TransformLockScript.prototype.onTriggerLeave=function(o){console.log(o.name+" has left lock box."),this.lockTransform&&this.app.fire("transformLock:unlockTransform")};var PrimitiveColor=pc.createScript("primitiveColor");PrimitiveColor.attributes.add("usePrimitiveColor",{type:"boolean",default:!1,title:"Use Primitive Color"}),PrimitiveColor.attributes.add("primitiveColor",{type:"json",title:"Primitive Color Setting",schema:[{name:"R",type:"number",default:0,precision:0,min:0,max:255,description:"Red"},{name:"G",type:"number",default:0,precision:0,min:0,max:255,description:"Green"},{name:"B",type:"number",default:0,precision:0,min:0,max:255,description:"Blue"},{name:"A",type:"number",default:1,precision:2,min:0,max:1,description:"Alpha"}]}),PrimitiveColor.attributes.add("basicColorSetting",{type:"string",default:"Custom",enum:[{Red:"red"},{Orange:"orange"},{Yellow:"yellow"},{Green:"green"},{Blue:"blue"},{Indigo:"indigo"},{Violet:"violet"},{"Cyan:":"cyan"},{Dark:"dark"},{"Opacity Changes":"opacityChanges"},{Custom:"custom"}],description:"This is a dropdown attribute"});let rainbowColors={red:new pc.Color(1,0,0),orange:new pc.Color(1,.5,0),yellow:new pc.Color(1,1,0),green:new pc.Color(0,1,0),cyan:new pc.Color(0,.875,1),blue:new pc.Color(0,0,1),indigo:new pc.Color(.29,0,.51),violet:new pc.Color(.56,0,1),opacityChanges:new pc.Color(0,101,243),dark:new pc.Color(48,39,38),pink:new pc.Color(1,.08,.58)};PrimitiveColor.prototype.createChangeableMaterial=function(){const e=new pc.StandardMaterial;e.onUpdateShader=function(e){return e.useInstancing=!0,e};e.chunks.transformVS="\n\n    varying vec4 color;\n\n    mat4 getModelMatrix() {\n        color = vec4(instance_line1.w, instance_line2.w, instance_line3.w, instance_line4.w);\n        return mat4(\n            vec4(instance_line1.xyz, 0.0), \n            vec4(instance_line2.xyz, 0.0), \n            vec4(instance_line3.xyz, 0.0), \n            vec4(instance_line4.xyz, 1.0)\n        );\n    }\n\n    vec4 getPosition() {\n        dModelMatrix = getModelMatrix();\n        vec3 localPos = vertex_position;\n        vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n        dPositionW = posW.xyz;\n        vec4 screenPos = matrix_viewProjection * posW;\n        return screenPos;\n    }\n    vec3 getWorldPosition() {\n        return dPositionW;\n    }\n    ",e.chunks.emissivePS="\n    varying vec4 color;\n    vec3 getEmission() {\n        return color.rgb;\n    }\n    ",e.update(),this.baseMaterial=e};var RenderCameraToElement=pc.createScript("renderCameraToElement");RenderCameraToElement.attributes.add("elementTags",{type:"string",array:!0,description:"Render to elements that have these tags"}),RenderCameraToElement.attributes.add("renderResolution",{type:"vec2",description:"Resolution to render at"}),RenderCameraToElement.attributes.add("renderOnce",{type:"boolean",description:"Renders the first frame only"}),RenderCameraToElement.prototype.initialize=function(){this.createNewRenderTexture(),this.renderOnceFrameCount=0,this.on("destroy",(function(){this.assignTextureToElements(null),this.renderTarget.destroy(),this.texture.destroy()}),this),this.app.on("signType:signTypeUpdate",this.updateElementTexture,this),this.app.on("powerupConfirm:renderUpdate",this.updateElementTexture,this),this.app.on("cosmeticConfirm:renderUpdate",this.updateElementTexture,this),this.app.on("menuItemLoader:renderUpdate",this.updateElementTexture,this)},RenderCameraToElement.prototype.updateElementTexture=function(e){e&&e.tags.has(this.elementTags)&&e.element&&e.element.texture&&this.texture&&(e.element.texture=this.texture)},RenderCameraToElement.prototype.update=function(e){this.renderOnce&&(this.renderOnceFrameCount+=1,this.renderOnceFrameCount>4&&(this.entity.enabled=!1))},RenderCameraToElement.prototype.createNewRenderTexture=function(){var e=this.app.graphicsDevice;if(this.texture&&this.renderTarget){var t=this.renderTarget,r=this.texture;this.renderTarget=null,this.texture=null,t.destroy(),r.destroy()}var n=new pc.Texture(e,{width:this.renderResolution.x,height:this.renderResolution.y,format:pc.PIXELFORMAT_R8_G8_B8,autoMipmap:!0});n.minFilter=pc.FILTER_LINEAR,n.magFilter=pc.FILTER_LINEAR;var a=new pc.RenderTarget(e,n,{depth:!0,flipY:!0,samples:2});this.entity.camera.renderTarget=a,this.texture=n,this.renderTarget=a,this.assignTextureToElements(this.texture)},RenderCameraToElement.prototype.assignTextureToElements=function(e){for(var t,r=0;r<this.elementTags.length;++r){t=this.app.root.findByTag(this.elementTags[r]);for(var n=0;n<t.length;++n)t[n].element.texture=e}};pc.script.create("globalMaterialManager",(function(e){var GlobalMaterialManager=function(e){this.entity=e};return GlobalMaterialManager.prototype.initialize=function(){this.disableReflectivityForAllMaterials(),e.assets.on("add",this.onAssetAdded,this)},GlobalMaterialManager.prototype.disableReflectivityForAllMaterials=function(){e.assets.filter((function(e){return e.resource&&e.resource instanceof pc.StandardMaterial})).forEach((function(e){var t=e.resource;t.metalness=0,t.specular=0,t.update()}))},GlobalMaterialManager.prototype.onAssetAdded=function(e){if(e.resource&&e.resource instanceof pc.StandardMaterial){var t=e.resource;t.metalness=0,t.specular=0,t.update()}},GlobalMaterialManager}));var PowerupBar=pc.createScript("powerupBar");PowerupBar.attributes.add("progressImage",{type:"entity"}),PowerupBar.attributes.add("progressImageMaxWidth",{type:"number"}),PowerupBar.prototype.initialize=function(){this.imageRect=this.progressImage.element.rect.clone(),this.setProgress(1),this.increase=!1,this.entity.parent.enabled=!1,this.titleRef=this.entity.parent.findByName("Title"),this.currentText="Power",this.app.on("powerupManager:updateTimer",this.updateProgress,this),this.app.on("powerupManager:resetTimer",this.resetProgressBar,this),this.app.on("powerupManager:enablePowerupProgressBar",this.enableProgressBar,this),this.app.on("powerupManager:disablePowerupProgressBar",(()=>{this.entity.parent.enabled=!1}),this)},PowerupBar.prototype.enableProgressBar=function(e){if(this.titleRef){switch(e){case"speedShoes":this.currentText="Speed Shoes";break;case"jetPack":this.currentText="Jet Pack";break;case"invincibility":this.currentText="Super Star";break;case"flight":this.currentText="Flight";break;default:this.currentText="Power"}this.titleRef.element.text=this.currentText}else this.titleRef=this.entity.parent.findByName("Title");this.entity.parent.enabled=!0},PowerupBar.prototype.updateProgress=function(e,t){this.progress=this.increase?Math.round(e/t*100)/100:1-Math.round(e/t*100)/100,this.setProgress(this.progress)},PowerupBar.prototype.resetProgressBar=function(e,t){this.setProgress(1)},PowerupBar.prototype.setProgress=function(e){e=pc.math.clamp(e,0,1),this.progress=e;var t=pc.math.lerp(0,this.progressImageMaxWidth,e);this.progressImage.element.width=t,this.imageRect.copy(this.progressImage.element.rect),this.imageRect.z=e,this.progressImage.element.rect=this.imageRect},PowerupBar.prototype.update=function(e){};var RecommendationEffect=pc.createScript("recommendationEffect");RecommendationEffect.prototype.initialize=function(){this.entity.tween(this.entity.getLocalScale()).to(new pc.Vec3(3,3,3),1,pc.SineOut).loop(!0).start(),this.entity.opacityTest=new pc.Vec2(1,0),this.entity.tween(this.entity.opacityTest).to(new pc.Vec2(0,0),1,pc.SineOut).onUpdate(this.onOpacityChange,this).loop(!0).start(),this.entity.enabled=!1},RecommendationEffect.prototype.onOpacityChange=function(){this.entity.element.opacity=this.entity.opacityTest.x};var SignType=pc.createScript("signType");SignType.attributes.add("signType",{type:"string",default:"monkey-ui",enum:[{Gecko:"gecko-ui"},{Monkey:"monkey-ui"},{Kangaroo:"kangaroo-ui"},{Turkey:"turkey-ui"},{Elephant:"elephant-ui"}],description:"This is a dropdown attribute"}),SignType.prototype.initialize=function(){this.entityParsed=!1,setTimeout((()=>{this.updateSignType(),this.on("attr",this.updateSignType,this)}),500)},SignType.prototype.updateSignType=function(t,i,e){this.signType&&(this.entity.tags.clear(),this.entity.tags.add(this.signType),this.app.fire("signType:signTypeUpdate",this.entity))};var ScreenFade=pc.createScript("screenFade");ScreenFade.prototype.initialize=function(){this.self=this,this.appRef=this.app,this.app.on("toScreenFade:fadeOut",this.fadeOutScreen,this),this.app.on("toScreenFade:fadeIn",this.fadeInScreen,this),this.app.on("toScreenFade:disableFadeElement",this.disableScreenFade,this),this.app.on("screenFade:postProcessFade",this.onFadeTweenComplete,this),this.entity.opacityTweenValue=new pc.Vec2(0,0),this.opacityTweenTarget=new pc.Vec2(0,0),this.entity.enabled=!1},ScreenFade.prototype.disableScreenFade=function(){this.entity.enabled=!1},ScreenFade.prototype.fadeOutScreen=function(e){this.screenFadeInOut(!1,e)},ScreenFade.prototype.fadeInScreen=function(e){this.screenFadeInOut(!0,e)},ScreenFade.prototype.screenFadeInOut=function(e,t){"number"==typeof t&&(this.requestType=t),this.currentTween||(this.entity.opacityTweenValue=e?new pc.Vec2(1,0):new pc.Vec2(0,0),this.opacityTweenTarget=e?new pc.Vec2(0,0):new pc.Vec2(1,0),this.opacityTweenDuration=e?1:.5,this.fadeDirection=e,this.onOpacityChange(),this.entity.enabled=!0,this.currentTween=this.entity.tween(this.entity.opacityTweenValue).to(this.opacityTweenTarget,this.opacityTweenDuration,pc.SineOut).onUpdate(this.onOpacityChange,this).onComplete((function(){pc.app.fire("screenFade:postProcessFade")}),this).loop(!1),this.currentTween.start())},ScreenFade.prototype.onOpacityChange=function(){this.entity.element.opacity=this.entity.opacityTweenValue.x},ScreenFade.prototype.onFadeTweenComplete=function(){delete this.currentTween,this.fadeDirection?(this.entity.enabled=!1,this.app.fire("screenFade:fadeInComplete",this.requestType)):this.app.fire("screenFade:fadeOutComplete",this.requestType)};var MenuTintResize=pc.createScript("menuTintResize");MenuTintResize.prototype.initialize=function(){this.entity.element.width=window.inner.width,this.entity.element.height=window.inner.height},MenuTintResize.prototype.update=function(e){};var UiInputField=pc.createScript("uiInputField");UiInputField.attributes.add("textEntity",{type:"entity",title:"Text Entity",description:"The Entity that has the text Element to update with the inputted text."}),UiInputField.attributes.add("inputType",{type:"string",title:"Input Type",description:"What type of input will this field accept. On some devices, the virtual keyboard layout may change as well. For example, 'Number' will bring up a numpad instead of the full keyboard.",default:"text",enum:[{Text:"text"},{"Text (no spellcheck)":"text no spellcheck"},{Email:"email"},{Number:"number"},{Decimal:"decimal"},{Password:"password"}]}),UiInputField.attributes.add("enterKeyHint",{type:"string",title:"Enter Key Hint",description:"Change what the enter key shows on the virutal keyboard. Different OSs will have different representations of the hint.",default:"enter",enum:[{Enter:"enter"},{Done:"done"},{Go:"go"},{Search:"search"},{Send:"send"}]}),UiInputField.attributes.add("maxLength",{type:"number",default:32,title:"Max Length",description:"Maximum length of the text can be."}),UiInputField.attributes.add("placeHolder",{type:"string",default:"Placeholder text...",title:"Place Holder String",description:"When the inputted text is empty, what should show as placeholder? Usually this is a prompt such as 'Enter your email here'."}),UiInputField.attributes.add("placeHolderColor",{type:"rgb",title:"Place Holder Text Color",description:"What color the text should be when the placeholder string is used."}),UiInputField.prototype.initialize=function(){this._textElement=this.textEntity.element,this._textColor=this._textElement.color.clone(),this.value="",this.setEvents("on"),this.on("destroy",(()=>{this.setEvents("off")})),this._onValueChange("")},UiInputField.prototype.setEvents=function(t){this.entity[t]("uiinput:updatevalue",this._onValueChange,this),this.entity.element[t]("click",this._onClick,this)},UiInputField.prototype._onValueChange=function(t){if(this.value=t,t.length>0){if("password"===this.inputType){let e="";for(let i=0;i<t.length;++i)e+="*";this._textElement.text=e}else this._textElement.text=t;this._textElement.color=this._textColor}else this._textElement.text=this.placeHolder,this._textElement.color=this.placeHolderColor;this.entity.fire("updatedvalue",t)},UiInputField.prototype._onClick=function(t){this.app.fire("uiinput:clicked",this,t)};var MaterialManager=pc.createScript("materialManager");MaterialManager.attributes.add("materials",{type:"asset",assetType:"material",array:!0,title:"Materials"}),MaterialManager.attributes.add("transparentMaterials",{type:"asset",assetType:"material",array:!0,title:"Transparent Materials"}),MaterialManager.prototype.initialize=function(){var a=this.materials.map((a=>a.resource)),t=this.transparentMaterials.map((a=>a.resource));GlobalMaterialPool.initialize(a,t),this.app.globalMaterialPool=GlobalMaterialPool};var GlobalMaterialPool={materials:[],transparentMaterials:[],isInitialized:!1,initialize:function(a,t){this.isInitialized||(this.materials=a||[],t.length>0?this.transparentMaterials=t:this.transparentMaterials=this.materials.map((a=>{var t=a.clone();return t.opacity=.5,t.blendType=pc.BLEND_NORMAL,t.update(),t})),this.isInitialized=!0)}};var Leaderboard=pc.createScript("leaderboard");Leaderboard.attributes.add("template",{type:"entity"}),Leaderboard.attributes.add("personal",{type:"entity"}),Leaderboard.attributes.add("leaderboard",{type:"entity"}),Leaderboard.prototype.initialize=function(){var e=this;this.entries=[],this.load((function(t){e.clear();var a=-75;e.addEntry(e.personal,a,t.personal.position,t.personal.name,t.personal.score),a=-60;for(var r=0;r<Math.min(t.leaderboard.length,10);r++)e.addEntry(e.leaderboard,a,r+1,t.leaderboard[r].name,t.leaderboard[r].score),a-=99}))},Leaderboard.prototype.clear=function(){for(var e=0;e<this.entries.length;e++)this.entries[e].destroy();this.entries=[]},Leaderboard.prototype.addEntry=function(e,t,a,r,d){var o=this.template.clone();o.enabled=!0,o.findByName("Position").element.text=a.toString(),o.findByName("Name").element.text=r.toUpperCase(),o.findByName("Score").element.text=d.toString(),this.entries.push(o),e.addChild(o),o.translateLocal(0,t,0)},Leaderboard.prototype.load=function(e){var t=this.app.assets.find("leaderboard-data.json");t.ready((function(){e(t.resource)})),this.app.assets.load(t)};!function(){const e=function getIosVersion(){if(/iP(hone|od|ad)/.test(navigator.platform)){var e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3]||0,10)]}return null}();document.documentElement.style.setProperty("--sat","env(safe-area-inset-top)"),document.documentElement.style.setProperty("--sab","env(safe-area-inset-bottom)"),document.documentElement.style.setProperty("--sal","env(safe-area-inset-left)"),document.documentElement.style.setProperty("--sar","env(safe-area-inset-right)");const t=pc.Application.getApplication();let n=null;function createInputDom(){n&&n.remove(),n=document.createElement("input"),n.setAttribute("type","text"),n.style.position="absolute",n.style.fontFamily="Arial, sans-serif",n.style.background="white",n.style.paddingLeft="10px",n.style.paddingRight="10px",n.style.margin="0px",n.style.visibility="hidden",n.style.zIndex=1e3,resetStyle(),n.value="",document.body.appendChild(n)}createInputDom();let i=!1,o=!1,l=null;function onInputFieldClick(e,t){t.stopPropagation(),function showDom(e,t){if(o===e)return;o&&o!==e&&onBlur();o=e,"visible"!==n.style.visibility&&(t.changedTouches?(t.event.preventDefault(),i=!1):i=!0,n.style.visibility="visible",n.onblur=onBlur,n.addEventListener("keydown",onKeyDown),n.addEventListener("keyup",onKeyUp));switch(n.value=e.value,n.maxLength=e.maxLength,n.placeholder=e.placeHolder,n.pattern=null,n.spellcheck=!1,e.inputType){case"text":default:n.type="text",n.spellcheck=!0;break;case"text no spellcheck":n.type="text";break;case"number":n.type="number",n.pattern="[0-9]*";break;case"decimal":n.type="number";break;case"email":n.type="email";break;case"password":n.type="password"}n.enterKeyHint=e.enterKeyHint,n.focus(),updateStyle(),o.entity.element.on("resize",updateStyle)}(e,t)}function onBlur(){n.onblur=null,n.removeEventListener("keydown",onKeyDown),n.removeEventListener("keyup",onKeyUp),n.style.visibility="hidden",function onElementSwitch(){o.entity.fire("uiinput:updatevalue",n.value),o.entity.element.off("resize",updateStyle),"password"===o.inputType&&createInputDom(),o=null}()}function onKeyDown(e){e.stopPropagation()}function onKeyUp(e){e.preventDefault(),e.stopPropagation(),13===e.keyCode&&n.blur()}function resetStyle(){const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sal")),t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sar"));n.style.left="20px",n.style.height="40px",n.style.width=window.innerWidth-64-e-t+"px",n.style.fontSize="100%",n.style.top="20px",n.style.marginTop="env(safe-area-inset-top)",n.style.marginLeft="env(safe-area-inset-left)",n.style.bottom=null}function updateStyle(){if(o)if(i&&o.entity.element.screenCorners){const e=o.entity.element.screenCorners,i=Math.min(t.graphicsDevice.maxPixelRatio,window.devicePixelRatio);n.style.left=e[0].x/i-2+"px",n.style.bottom=e[0].y/i-2+"px",n.style.top=null;const l=(e[2].x-e[0].x)/i-20,s=(e[2].y-e[0].y)/i;n.style.width=l+"px",n.style.height=s+"px",n.style.fontSize=Math.round(.5*s)+"px"}else resetStyle()}function onIosResizeTimeout(){t.on("uiinput:clicked",onInputFieldClick),l=null}e?l=setTimeout(onIosResizeTimeout,2100):t.on("uiinput:clicked",onInputFieldClick),t.graphicsDevice.on("resizecanvas",(function onResize(){e&&!l&&(t.off("uiinput:clicked",onInputFieldClick),l=setTimeout(onIosResizeTimeout,2100)),setTimeout((()=>{updateStyle()}))}))}();var PowerupConfirmImg=pc.createScript("powerupConfirmImg");PowerupConfirmImg.prototype.initialize=function(){this.app.on("powerup:filled",(p=>{"duck"===p&&(p="speedShoes");let e=pc.app.root.findByName("powerUpConfirmImgPanel");e.tags.clear(),e.tags.add(`${p}-ui`),pc.app.fire("powerupConfirm:renderUpdate",e)}))};var EnvironmentManager=pc.createScript("environmentManager");EnvironmentManager.attributes.add("sceneName",{type:"string",default:"skyworld",title:"Scene Name",description:"The name of the current scene root."}),EnvironmentManager.attributes.add("centerEntity",{type:"entity",title:"Center Entity",description:"The entity around which other entities will be placed."}),EnvironmentManager.attributes.add("minY",{type:"number",default:-5,title:"Minimum Y Offset"}),EnvironmentManager.attributes.add("maxY",{type:"number",default:5,title:"Maximum Y Offset"}),EnvironmentManager.attributes.add("radius",{type:"number",default:40,title:"Radius"}),EnvironmentManager.attributes.add("numEntities",{type:"number",default:5,title:"Number of Entities"}),EnvironmentManager.attributes.add("scaleFactor",{type:"number",default:1,title:"Scale Factor"}),EnvironmentManager.attributes.add("enableRotation",{type:"boolean",default:!1,title:"Enable Rotation"}),EnvironmentManager.attributes.add("rotationSpeed",{type:"number",default:.01,title:"Rotation Speed"}),EnvironmentManager.attributes.add("minY2",{type:"number",default:-5,title:"Minimum Y Offset 2"}),EnvironmentManager.attributes.add("maxY2",{type:"number",default:5,title:"Maximum Y Offset 2"}),EnvironmentManager.attributes.add("radius2",{type:"number",default:60,title:"Radius 2"}),EnvironmentManager.attributes.add("numEntities2",{type:"number",default:5,title:"Number of Entities 2"}),EnvironmentManager.attributes.add("scaleFactor2",{type:"number",default:1,title:"Scale Factor 2"}),EnvironmentManager.attributes.add("preventOverlap",{type:"json",array:!0,schema:[{name:"name",type:"string",title:"Entity Name"}],title:"Prevent Overlap",description:"List of entity names to check for overlap."}),EnvironmentManager.attributes.add("customRotationSpeeds",{type:"json",array:!0,schema:[{name:"name",type:"string",title:"Entity Name"},{name:"speedMultiplier",type:"number",title:"Rotation Speed Multiplier"}],title:"Custom Rotation Speeds",description:"Set custom rotation speed multipliers for specific entities."}),EnvironmentManager.attributes.add("noRotation",{type:"json",array:!0,schema:[{name:"name",type:"string",title:"Entity Name"}],title:"No Rotation",description:"List of entity names that should stay at original rotation position."}),EnvironmentManager.attributes.add("faceRotationDirection",{type:"json",array:!0,schema:[{name:"name",type:"string",title:"Entity Name"}],title:"Face Rotation DIrection",description:"List of entity names that should face rotation direction instead of center"}),EnvironmentManager.prototype.initialize=function(){var t=this;setTimeout((function(){t.performInitialization()}),2e3)},EnvironmentManager.prototype.performInitialization=function(){this.allMeshes=[],this.time=0,this.rotationAccumulatedTime=0;const t=this.app.root.findByName(this.sceneName);this.currentSceneRoot=t,t?t?(console.log(`Using scene root: ${t.name}`),this.environmentEntity=t.findByName("Environment Entities"),this.environmentEntity?(this.environmentEntities=this.environmentEntity.children,this.centerEntity?(this.centerEntityPosition=this.centerEntity.getPosition(),this.entityPositions=[],this.placeEntities(this.numEntities,this.radius,this.minY,this.maxY,this.scaleFactor,this.entityPositions,!1),this.placeEntities(this.numEntities2,this.radius2,this.minY2,this.maxY2,this.scaleFactor2,this.entityPositions,!0)):console.error("Center entity is not set. Please assign a center entity in the editor.")):console.error("Environemnt etity not found in the current scene.")):console.error("No valid scene root found. Check your sceneRoots attribute."):console.error(`Scene root '${this.sceneName}' not found. Ensure the name matches the scene hierarchy.`)},EnvironmentManager.prototype.placeEntities=function(t,e,n,i,a,o,s){for(var r=2*Math.PI/t,m=7*a,c=0;c<t;c++){let t=this.environmentEntities.length;s||(t=10);var l=Math.floor(Math.random()*t),u=this.environmentEntities[l].clone();this.currentSceneRoot.addChild(u);for(var d=!1,h=0,y=this.preventOverlap.some((t=>t.name===u.name));!d&&h<10;){h++;var p=c*r,E=this.centerEntityPosition.x+e*Math.cos(p),f=this.centerEntityPosition.z+e*Math.sin(p),v=this.centerEntityPosition.y+Math.random()*(i-n)+n;u.setPosition(E,v,f);var g=!1;if(y)for(var M=0;M<o.length;M++){var b=o[M].entity;if(u.getPosition().distance(b.getPosition())<m){g=!0;break}}g||(d=!0,o.push({entity:u,angle:p,radius:e}),y||(u.lookAt(this.centerEntityPosition),u.setLocalScale(a,a,a)))}d||(u.enabled=!1);const P=u.findComponents("render");P&&P.forEach((t=>{const e=t.meshInstances;for(let t=0;t<e.length;t++){const n=e[t].mesh,i=[];n.getPositions(i),this.allMeshes.push({mesh:n,srcPositions:i})}}))}},EnvironmentManager.prototype.update=function(t){if(this.entityPositions&&(this.time+=t,this.enableRotation&&(this.rotationAccumulatedTime+=t,this.rotationAccumulatedTime>=.15))){for(var e=0;e<this.entityPositions.length;e++){var n=this.entityPositions[e];let t=this.rotationSpeed,s=this.customRotationSpeeds.find((t=>t.name===n.entity.name));s&&(t*=s.speedMultiplier),n.angle+=t*this.rotationAccumulatedTime;var i=this.centerEntityPosition.x+n.radius*Math.cos(n.angle),a=this.centerEntityPosition.z+n.radius*Math.sin(n.angle),o=n.entity.getPosition().y;if(n.entity.setPosition(i,o,a),this.noRotation.some((t=>t.name===n.entity.name)));else if(this.faceRotationDirection.some((t=>t.name===n.entity.name))){let t=this.centerEntityPosition.clone().sub(n.entity.getPosition()).normalize(),e=(new pc.Quat).setFromMat4((new pc.Mat4).setLookAt(pc.Vec3.ZERO,t,pc.Vec3.UP)),i=(new pc.Quat).setFromEulerAngles(0,270,0);e.mul(i),n.entity.setRotation(e)}else n.entity.lookAt(this.centerEntityPosition)}this.rotationAccumulatedTime-=.15}};var ConnectingRoomText=pc.createScript("connectingRoomText");ConnectingRoomText.attributes.add("minimumScrollingInterval",{type:"number",default:75,title:"minimumInterval"}),ConnectingRoomText.prototype.initialize=function(){this.scrollingInterval=0,this.entity.element&&this.entity.element.text&&(this.originalRangeStart=this.entity.element.rangeStart,this.originalRangeEnd=this.entity.element.rangeEnd,this.entity.element.rangeStart=0,this.entity.element.rangeEnd=0)},ConnectingRoomText.prototype.update=function(t){this.entity.enabled&&(this.scrollingInterval+=t,this.scrollingInterval>this.minimumScrollingInterval&&(this.entity.element.rangeEnd<this.originalRangeEnd?this.entity.element.rangeEnd+=1:this.entity.element.rangeStart<this.originalRangeEnd?this.entity.element.rangeStart+=1:(this.entity.element.rangeStart=0,this.entity.element.rangeEnd=0),this.scrollingInterval=0))};var CheckpointManager=pc.createScript("checkpointManager");function findCheckpointByNumber(e,t){var o=e.find((function(e){if("checkPoint"===e.name){var o=e.script;if(o&&o.checkpoint&&o.checkpoint.checkpointNumber===t)return!0}return!1}));return o.length>0?o[0]:null}CheckpointManager.prototype.init=function(e){this.maxLevel=120,this.gameplay=e,this.saveManager=this.app.root.findScript("saveManager")},CheckpointManager.prototype.getGameModeString=function(){const e=this.app.currentWorld;let t;return t="Skyworld"===e?"":e,t},CheckpointManager.prototype.loadCheckpointOnEnter=function(){const e=this.getGameModeString(),t=this.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);if(t&&this.gameplay.useSaveSystem){const o=this.app.root.findScript("gameTimer"),n=o.getSortedScores(10);console.log("BEST TIMES",n),this.app.fire("scores:bestTimes",n);const i=parseFloat(this.saveManager.load(`currentTime${e}`));isNaN(i)||o.setTime(i),"121"===t&&(o.updateTimer(0),o.runComplete=!0,this.app.fire("gameplay:completeRun")),this.updateAndMoveToCheckpoint(t,!0)}else this.updateAndMoveToCheckpoint(0,!0);this.app.playerObjects&&this.app.playerObjects[this.mainPlayerId]&&(this.app.playerObjects[this.mainPlayerId].latestCheckPointId=t)},CheckpointManager.prototype.updateCheckpoint=function(e,t){console.log("update checkpoint called");const o=this.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);if(!t&&+e<+o)return void console.log("not proceeding because not valid",{checkpointId:e,currentCheckPointId:o});console.log("UPDATING CHECKPOINT",{allowLower:t,checkpointId:e,currentCheckPointId:o});const n=this.app.root.findByName(`level ${e}`);if(n){const t=n.findByName("Checkpoint Area");if(t){const n=t.findByName("checkPoint");if(n){o<e&&(this.gameplay.currentLevelDeathCounter=0),this.app.playerObjects[this.gameplay.mainPlayerId].latestCheckPointId=e,this.gameplay.currentCheckpoint=n,this.updateCheckpointBar(e);const t=this.app.root.findScript("gameTimer");if(t.startZone&&+e>0&&(t.startZone=!1),t.updateSavedCurrentTime(),this.saveManager.save(`currentCheckpoint${this.getGameModeString()}`,e),+e>0){const t=+e-1;this.app.fire("gameAnalytics:progression",{status:"Complete",progression01:this.app.currentWorld,progression02:"Level_"+t,progression03:"Level_Progress"}),console.log(`Level ${t} marked as completed.`)}return this.app.fire("gameAnalytics:progression",{status:"Start",progression01:this.app.currentWorld,progression02:"Level_"+e,progression03:"Level_Progress"}),console.log(`Level ${e} marked as started.`),n}}}},CheckpointManager.prototype.updateAndMoveToCheckpoint=function(e,t){console.log("update and move to checkpoint called",{checkpointId:e,allowLower:t});const o=this.saveManager.load(`currentCheckpoint${this.getGameModeString()}`);if(!t&&+e<+o)return void console.log("not proceeding because not valid",{checkpointId:e,currentCheckPointId:o,allowLower:t});console.log("proceeding to change checkpoint",{checkpointId:e,currentCheckPointId:o});const n=this.updateCheckpoint(e,t);if(n){this.app.fire("checkPointManager:moveToCheckpoint",e,n);this.app.root.findScript("levelCuller").updateCulling(!0)}if(0==+e){this.app.root.findScript("gameTimer").startZone=!0}},CheckpointManager.prototype.updateCheckpointBar=function(e){e>this.maxLevel&&(e=this.maxLevel);let t=e/this.maxLevel;t>1&&(t=1);let o=(100*t).toFixed(1);o.endsWith(".0")&&(o=o.slice(0,-2)),this.gameplay.levelTracker.element.text=`Level ${e}/${this.maxLevel} (${o}%)`,this.gameplay.progressBar.script.progressBar.setProgress(t),console.log("[DEBUG] updateCheckPoint updated: ",this.app.playerObjects[this.gameplay.mainPlayerId].latestCheckPointId),this.gameplay.animalChangerScript.toggleAnimalHint()},CheckpointManager.prototype.onCheckPointReset=function(){this.updateAndMoveToCheckpoint(0,!0),this.saveManager.save(`currentCheckpoint${this.getGameModeString()}`,0),this.saveManager.save(`currentTime${this.getGameModeString()}`,"0");const e=this.app.root.findScript("gameTimer");e.setTime(0),e.runComplete=!1,e.startZone=!1,e.updateTimer(.01),e.startZone=!0},CheckpointManager.prototype.loadWorldSpecificSave=function(e){return this.saveManager.load(`${e}_${this.app.currentWorld}`)};var HighScore=pc.createScript("highScore");const gameModeList=["classic","???","???!!!"];HighScore.prototype.initialize=function(){this.app.on("scores:bestTimes",this.updateScores,this),this.currentMode="classic",this.currentBestTimes={},this.app.on("gameplay:showNextModeScores",this.cycleMode,this),this.app.on("gameplay:updateScores",this.updateScores,this),this.updateScores()},HighScore.prototype.updateScores=function(e){if(e)this.currentBestTimes=e;else{const e=this.app.root.findScript("gameTimer").getSortedScores(10);e&&(this.currentBestTimes=e)}this.setScoreBoard(this.currentMode)},HighScore.prototype.setScoreBoard=function(e){if(gameModeList.includes(e)){let t=this.entity.findByName("highScoreModeText");t&&(t.element.text="classic"===e?"SkyWorld":`${e}`);const i=this.app.root.findScript("gameTimer");for(let t=0;t<3;t++){let s=this.entity.findByName(`highScoreEntry${t+1}Text`);this.currentBestTimes&&this.currentBestTimes[e]&&this.currentBestTimes[e][t]&&i?s.element.text=i.formatTime(this.currentBestTimes[e][t]):s.element.text="00:00"}this.currentMode=gameModeList.find((e=>e==e))}},HighScore.prototype.cycleMode=function(){let e=gameModeList.indexOf(this.currentMode);e>=0?e+1===gameModeList.length?(this.setScoreBoard(gameModeList[0]),this.currentMode=gameModeList[0]):(this.setScoreBoard(gameModeList[e+1]),this.currentMode=gameModeList[e+1]):(console.log("mode not found. reset to classic"),this.setScoreBoard(gameModeList[0]),this.currentMode=gameModeList[0])},HighScore.prototype.switchMode=function(){};var ModelWorldTween=pc.createScript("modelWorldTween");ModelWorldTween.attributes.add("xRotation",{type:"number",default:0}),ModelWorldTween.attributes.add("yRotation",{type:"number",default:40}),ModelWorldTween.attributes.add("zRotation",{type:"number",default:0}),ModelWorldTween.attributes.add("goUp",{type:"number",default:0}),ModelWorldTween.attributes.add("powerupType",{type:"string",default:"flight",enum:[{flight:"flight"},{speedShoes:"speedShoes"},{jetPack:"jetPack"},{invincibility:"invincibility"}],description:"This is a dropdown attribute"}),ModelWorldTween.prototype.initialize=function(){if(this.goUp>0){let e=new pc.Vec3;e.copy(this.entity.getLocalPosition()),this.modelTween=this.entity.tween(this.entity.getLocalPosition()).to(new pc.Vec3(0,e.y+this.goUp,0),1,pc.SineOut).loop(!0).yoyo(!0)}this.rotateAllowed=!1,this.app.on("powerup:filled",(e=>{"duck"===e&&(e="speedShoes"),this.powerupType===e&&(this.rotateAllowed=!0,this.modelTween&&this.modelTween.start())}),this),this.app.on("gameplay:currentPlayState",(e=>{"powerUpConfirmMenu"!==e&&(this.rotateAllowed=!1,this.modelTween&&this.modelTween.stop())}),this)},ModelWorldTween.prototype.update=function(e){this.rotateAllowed&&this.entity.rotate(this.xRotation*e,this.yRotation*e,this.zRotation*e)};var GuideArrow=pc.createScript("guideArrow");GuideArrow.prototype.initialize=function(){this.app.on("checkpoint:updateCheckPoint",this.updateGuideArrow,this),this.app.on("gameplay:completeRun",(()=>{this.runComplete=!0,this.entity.setPosition(new pc.Vec3(-194,455,-175))}),this),this.app.on("rebirthTeleporter:rebirth",(()=>{this.runComplete=!1}),this),this.runComplete=!1},GuideArrow.prototype.update=function(t){},GuideArrow.prototype.updateGuideArrow=function(t){if("number"!=typeof t||void 0===t)return;const e=this.app.root.findByName(`level ${t+1}`);if(e)if(this.movementTween&&(this.movementTween.stop(),this.movementTween=null),t<120){if(!this.runComplete){const t=e.findByName("Checkpoint Area");if(t){const e=t.findByName("checkPoint");if(e){const t=e.getPosition();this.movementTween=this.entity.tween(this.entity.getLocalPosition()).to(new pc.Vec3(t.x,t.y+1.5,t.z),5,pc.SineOut).start()}}}}else this.runComplete?this.entity.setPosition(new pc.Vec3(-194,455,-175)):this.movementTween=this.entity.tween(this.entity.getLocalPosition()).to(new pc.Vec3(-231,205,-181),5,pc.SineOut).start()};var ForceImpulse=pc.createScript("forceImpulse");ForceImpulse.attributes.add("impulseForce",{type:"number",default:50,title:"Impulse Force",description:"Forch with which objects are pushed"}),ForceImpulse.attributes.add("impulseByLocalAxis",{type:"string",default:"y",title:"Impulse direction by Axis",description:"Force direction by local object Axis. use for manipulating force by adjusting object rotation itself"}),ForceImpulse.attributes.add("impulseByVector",{type:"boolean",default:!1,title:"Impulse direction by Vector",description:"Force direction by vector switch. use for manipulating force direction with limited volume scope but free direction"}),ForceImpulse.attributes.add("impulseByContact",{type:"boolean",default:!1,title:"Impulse direction by Vector",description:"Force direction by vector switch. use for manipulating force direction with limited volume scope but free direction"}),ForceImpulse.attributes.add("impulseDirectionX",{type:"number",default:1,title:"Impulse direction",description:"Forch direction X"}),ForceImpulse.attributes.add("impulseDirectionY",{type:"number",default:1,title:"Impulse direction",description:"Forch direction Y"}),ForceImpulse.attributes.add("impulseDirectionZ",{type:"number",default:1,title:"Impulse direction",description:"Forch direction Z"}),ForceImpulse.prototype.initialize=function(){this.entity.rigidbody&&this.impulseByContact?this.entity.rigidbody.on("contact",(function(i){this.onContact(i)}),this):this.entity.rigidbody||this.impulseByContact||this.entity.collision.on("triggerenter",(function(i){this.onTriggerEnter(i)}),this),this.impulse=new pc.Vec3,this.on("attr",(function(){this.applySettings()}),this),this.applySettings()},ForceImpulse.prototype.applySettings=function(){if(this.impulseByVector)this.impulseDirectionX||this.impulseDirectionY||this.impulseDirectionZ?(this.impulseDirectionX||(this.impulseDirectionX=0),this.impulseDirectionY||(this.impulseDirectionX=0),this.impulseDirectionZ||(this.impulseDirectionX=0)):(this.impulseDirectionX=0,this.impulseDirectionY=1,this.impulseDirectionZ=0),this.impulse.set(this.impulseDirectionX,this.impulseDirectionY,this.impulseDirectionZ),this.impulseForce&&(this.impulse.normalize(),this.impulse.mulScalar(this.impulseForce));else{switch(this.impulseForce||(this.impulseForce=1),this.impulseByLocalAxis){case"x":this.impulse.copy(this.entity.right);break;case"z":this.impulse.copy(this.entity.forward);break;default:this.impulse.copy(this.entity.up)}this.impulse.normalize().mulScalar(this.impulseForce)}},ForceImpulse.prototype.onContact=function(i){if(i&&i.other&&i.other.rigidbody){this.impulse=i.contacts[0].normal,this.impulse.normalize();var t=i.contacts[0].point,e=(new pc.Vec3).sub2(t,this.entity.collision.getShapePosition());(new pc.Vec3).copy(this.impulse).dot(e.normalize())>0&&this.impulse.mulScalar(-1),this.impulse.mulScalar(-1),this.impulse.mulScalar(this.impulseForce),i.other.rigidbody.applyImpulse(this.impulse)}},ForceImpulse.prototype.onTriggerEnter=function(i){console.log("[DEBUG] impulse test",i),i&&i.rigidbody&&!this.impulseByContact&&i.rigidbody.applyImpulse(this.impulse)};var AnimalChangeTrigger=pc.createScript("animalChangeTrigger");AnimalChangeTrigger.attributes.add("animalNumber",{type:"number",default:1}),AnimalChangeTrigger.prototype.initialize=function(){this.entity.collision.on("triggerenter",(function(i){this.onTriggerEnter(i)}),this)},AnimalChangeTrigger.prototype.onTriggerEnter=function(i){i&&"Player"===i.name&&this.animalNumber&&this.app.fire("animalChangeTrigger:toggleSkins",i,this.animalNumber,!0)};var RocketBlock=pc.createScript("rocketBlock");RocketBlock.attributes.add("movementDirectionX",{type:"number",default:0,title:"X-movement",description:"X axis movement"}),RocketBlock.attributes.add("movementDirectionY",{type:"number",default:0,title:"Y-movement",description:"Y axis movement"}),RocketBlock.attributes.add("movementDirectionZ",{type:"number",default:0,title:"Z-movement",description:"Z axis movement"}),RocketBlock.attributes.add("duration",{type:"number",default:5,title:"duration",description:"duration"}),RocketBlock.attributes.add("delay",{type:"number",default:0,title:"delay",description:"delay"}),RocketBlock.attributes.add("loop",{type:"boolean",default:!0,title:"loop",description:"loop"}),RocketBlock.attributes.add("yoyo",{type:"boolean",default:!0,title:"yoyo",description:"yoyo"}),RocketBlock.attributes.add("isUI",{type:"boolean",default:!1,title:"UI",description:"is UI"});var easings=[{Linear:"Linear"},{QuadraticIn:"QuadraticIn"},{QuadraticOut:"QuadraticOut"},{QuadraticInOut:"QuadraticInOut"},{CubicIn:"CubicIn"},{CubicOut:"CubicOut"},{CubicInOut:"CubicInOut"},{QuarticIn:"QuarticIn"},{QuarticOut:"QuarticOut"},{QuarticInOut:"QuarticInOut"},{QuinticIn:"QuinticIn"},{QuinticOut:"QuinticOut"},{QuinticInOut:"QuinticInOut"},{SineIn:"SineIn"},{SineOut:"SineOut"},{SineInOut:"SineInOut"},{ExponentialIn:"ExponentialIn"},{ExponentialOut:"ExponentialOut"},{ExponentialInOut:"ExponentialInOut"},{CircularIn:"CircularIn"},{CircularOut:"CircularOut"},{CircularInOut:"CircularInOut"},{BackIn:"BackIn"},{BackOut:"BackOut"},{BackInOut:"BackInOut"},{BounceIn:"BounceIn"},{BounceOut:"BounceOut"},{BounceInOut:"BounceInOut"},{ElasticIn:"ElasticIn"},{ElasticOut:"ElasticOut"},{ElasticInOut:"ElasticInOut"}];RocketBlock.attributes.add("easing",{type:"string",default:"SineOut",enum:easings,description:"easing"}),RocketBlock.prototype.initialize=function(){var t=this.entity.getLocalPosition();0===this.movementDirectionX||"number"!=typeof this.movementDirectionX?this.movementDirectionX=t.x:this.movementDirectionX+=t.x,0===this.movementDirectionY||"number"!=typeof this.movementDirectionY?this.movementDirectionY=t.y:this.movementDirectionY+=t.y,0===this.movementDirectionZ||"number"!=typeof this.movementDirectionZ?this.movementDirectionZ=t.z:this.movementDirectionZ+=t.z;var e=new pc.Vec3(this.movementDirectionX,this.movementDirectionY,this.movementDirectionZ);this.movementTween=this.entity.tween(this.entity.getLocalPosition()).to(e,this.duration,pc[this.easing],this.delay).loop(this.loop).yoyo(this.yoyo),this.movementTween.start(),this.isUI||this.registerWithRotationManager()},RocketBlock.prototype.registerWithRotationManager=function(){this.rotationManager=this.app.root.findScript("rotationManager"),this.rotationManager.fire("registerGeneralTween",{entity:this.entity,script:this,modelTween:this.movementTween}),this.entity.on("destroy",this.onDestroy,this),this.entity.on("disable",this.onDisable,this),this.entity.on("enable",this.onEnable,this)},RocketBlock.prototype.onDestroy=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},RocketBlock.prototype.onDisable=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},RocketBlock.prototype.onEnable=function(){this.rotationManager&&this.registerWithRotationManager()};var GeneralTween=pc.createScript("generalTween");GeneralTween.attributes.add("goUp",{type:"number",default:0}),GeneralTween.prototype.initialize=function(){if(this.goUp>0){var t=this.entity.getLocalPosition().clone();this.targetPos=new pc.Vec3(t.x,t.y+this.goUp,t.z),this.modelTween=this.entity.tween(this.entity.getLocalPosition()).to(this.targetPos,1,pc.SineOut).loop(!0).yoyo(!0)}this.registerWithRotationManager()},GeneralTween.prototype.registerWithRotationManager=function(){this.rotationManager=this.app.root.findScript("rotationManager"),this.rotationManager.fire("registerGeneralTween",{entity:this.entity,script:this,modelTween:this.modelTween}),this.entity.on("destroy",this.onDestroy,this),this.entity.on("disable",this.onDisable,this),this.entity.on("enable",this.onEnable,this)},GeneralTween.prototype.onDestroy=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},GeneralTween.prototype.onDisable=function(){this.rotationManager&&this.rotationManager.fire("deregister",this.entity)},GeneralTween.prototype.onEnable=function(){this.rotationManager&&this.registerWithRotationManager()};var Tutorial=pc.createScript("tutorial");Tutorial.attributes.add("fillupTime",{type:"number",default:.5}),Tutorial.attributes.add("powerupXRotation",{type:"number",default:0}),Tutorial.attributes.add("powerupYRotation",{type:"number",default:40}),Tutorial.attributes.add("powerupZRotation",{type:"number",default:0}),Tutorial.attributes.add("goUp",{type:"number",default:0}),Tutorial.attributes.add("tutorialType",{type:"entity",default:[],array:!0,description:"This is a dropdown attribute"}),Tutorial.prototype.initialize=function(){this.cullingDistance=50,this.time=0,this.isInsideTrigger=!1,this.circleFilled=!1,this.player=this.app.root.findByName("Player"),this.particleSystem=this.entity.findByName("Particle System"),this.highlighter=this.entity.findByName("Highlighter"),this.initialScale=new pc.Vec3(1,0,1),this.powerUpSprite=this.entity.findByName("sprite"),this.powerUpSprite.enabled=!0;this.powerUpSprite.setLocalPosition(0,.35,0),this.particleSystem||console.error("Particle System child not found!"),this.powerUpSprite||console.error("PowerUpSprite child not found!"),this.triggerVolume=this.entity.findByName("TriggerVolume");var t=this.triggerVolume.collision;t.on("triggerenter",this.onTriggerEnter,this),t.on("triggerleave",this.onTriggerLeave,this),this.goUp>0&&this.powerUpSprite.tween(this.powerUpSprite.getLocalPosition()).to(new pc.Vec3(0,.35+this.goUp,0),1,pc.SineOut).loop(!0).yoyo(!0).start(),this.checkDistanceTime=0,this.updateDistance(),this.app.on("settings:applyPowerupCullDistance",(function(t){this.cullingDistance=t}),this)},Tutorial.prototype.update=function(t){if(this.isInsideTrigger){this.time+=t;var i=pc.math.clamp(this.time/this.fillupTime,0,1);1!==i||this.circleFilled||(this.circleFilled=!0,this.app.fire("tutorial:filled",this.tutorialType)),this.highlighter.enabled||(this.highlighter.enabled=!0),this.highlighter.setLocalScale(this.initialScale.clone().scale(i))}else this.highlighter.enabled&&(this.highlighter.enabled=!1);this.powerUpSprite.rotate(this.powerupXRotation*t,this.powerupYRotation*t,this.powerupZRotation*t),this.checkDistanceTime+=t,this.checkDistanceTime>=1&&(this.updateDistance(),this.checkDistanceTime=0)},Tutorial.prototype.onTriggerEnter=function(t){t&&"Player"===t.name&&(this.isInsideTrigger=!0,this.time=0)},Tutorial.prototype.onTriggerLeave=function(t){t&&"Player"===t.name&&(this.isInsideTrigger=!1,this.highlighter.setLocalScale(new pc.Vec3),this.circleFilled=!1)},Tutorial.prototype.updateDistance=function(){if(this.player){var t=this.player.getPosition(),i=this.entity.getPosition();t.distance(i)<=this.cullingDistance?(this.particleSystem.enabled=!0,this.powerUpSprite.enabled=!0):(this.particleSystem.enabled=!1,this.powerUpSprite.enabled=!1)}else console.error("Player object not found!")};var TutorialManager=pc.createScript("tutorialManager");TutorialManager.prototype.init=function(t){this.maxLevel=120,this.gameplay=t,this.saveManager=this.app.root.findScript("saveManager")},TutorialManager.prototype.initialize=function(){console.log("FINDING ROOT",this.app.root);const t=this.app.root.findByTag("tutorialMenu");console.log("FOUND TUTORIAL SCREENS",t),t.length>0?(this.tutorialScreen=t[0],this.tutorialElements=this.tutorialScreen.children):(console.warn("No entities found with the 'tutorialMenu' tag."),this.tutorialScreen=null,this.tutorialElements=[])},TutorialManager.prototype.resetHighlightedElements=function(t){for(let t=0;t<this.tutorialElements.length;t++)"TutorialHighlighter"!==this.tutorialElements[t].name&&(this.tutorialElements[t].enabled=!1);if(t&&t instanceof Array)for(let e=0;e<t.length;e++){let i;t[e]instanceof pc.Entity&&t[e].isDescendantOf(this.tutorialScreen)?i=t[e]:"string"==typeof t[e]&&(i=this.tutorialElements.find((i=>i.name===t[e]))),i&&(i.enabled=!0)}};var TutorialTrigger=pc.createScript("tutorialTrigger");TutorialTrigger.attributes.add("tutorialTags",{type:"string",default:[],array:!0,description:"List of tags to find tutorial elements."}),TutorialTrigger.prototype.initialize=function(){this.entity.collision.on("triggerenter",(function(t){this.onTriggerEnter(t)}),this),this.saveManager=this.app.root.findScript("saveManager"),this.deviceSettingScript=this.app.root.findScript("optimizeSettings"),this.app.on("inputTypeChecker:modeChange",this.setDeviceMode,this),this.currentDeviceMode=this.deviceSettingScript&&this.deviceSettingScript.currentJoyStickSettings?"computer":"mobile",this.setDeviceMode(this.currentDeviceMode,!0),this.tutorialState="",this.animalButtonTutorialNumber=null,this.animalChangerScript=this.app.root.findScript("animalChanger"),this.tutorialElements=[];for(let t=0;t<this.tutorialTags.length;t++){const i=this.app.root.findByTag(this.tutorialTags[t]);this.tutorialElements=this.tutorialElements.concat(i)}0===this.tutorialElements.length&&console.warn("No tutorial elements found for tags:",this.tutorialTags)},TutorialTrigger.prototype.onTriggerEnter=function(t){if(t&&"Player"===t.name&&!this.checkTutorialCompletion(this.entity.name)&&this.tutorialElements&&this.tutorialElements.length>0){this.animalButtonTutorialNumber=null,console.log("FINDING TUTORIAL ELEMENTS",this.tutorialElements);for(let t=0;t<this.tutorialElements.length;t++)if(this.tutorialElements[t].name&&this.tutorialElements[t].name.includes("Animal Buttons")){const i=this.tutorialElements[t].name.split(" "),e=parseInt(i[2],10);this.animalButtonTutorialNumber=e}(!this.animalButtonTutorialNumber||this.animalChangerScript&&this.animalChangerScript.currentlyPressed!==this.animalButtonTutorialNumber)&&this.app.fire("tutorialTrigger:triggerActivated",this.tutorialElements),this.saveTutorialTriggerComplete(this.entity.name)}},TutorialTrigger.prototype.saveTutorialTriggerComplete=function(t){this.saveManager.save(`tutorialTriggerComplete:${t}`,t)},TutorialTrigger.prototype.checkTutorialCompletion=function(t){return this.tutorialState=this.saveManager.load(`tutorialTriggerComplete:${t}`),!!this.tutorialState},TutorialTrigger.prototype.setDeviceMode=function(t,i){this.deviceSettingScript&&(this.currentDeviceMode!==t||i)&&(this.currentDeviceMode=t,"computer"===t?(console.log("Toggling to computer mode"),this.toggleEntities("Computer",!0),this.toggleEntities("Mobile",!1)):"mobile"===t&&(console.log("Toggling to mobile mode"),this.toggleEntities("Mobile",!0),this.toggleEntities("Computer",!1)))},TutorialTrigger.prototype.toggleEntities=function(t,i){this.entity.enabled=this.entity.name.includes(t)?i:!i};var ModelWorldAnim=pc.createScript("modelWorldAnim");ModelWorldAnim.attributes.add("buttonWatcher",{type:"entity",default:null,description:"Button to watch for events"}),ModelWorldAnim.prototype.initialize=function(){this.buttonWatcher&&(this.linkedButton=this.buttonWatcher,this.buttonWatcher.button&&(this.buttonWatcher.button.on("hoverstart",(()=>{this.entity.anim&&this.entity.anim.setBoolean("flightActive",!0)}),this),this.buttonWatcher.button.on("hoverend",(()=>{this.entity.anim&&this.entity.anim.setBoolean("flightActive",!1)}),this),this.buttonWatcher.button.on("mousedown",(()=>{this.entity.anim&&this.entity.anim.setBoolean("flightActive",!1)}),this),this.buttonWatcher.button.on("click",(()=>{this.entity.anim&&this.entity.anim.setBoolean("flightActive",!1)}),this)))};var PerDeviceUiscaling=pc.createScript("perDeviceUiscaling"),scalingSchema=[{name:"offSetX",type:"number",default:0,title:"X Coord Offset"},{name:"offSetY",type:"number",default:0,title:"Y Coord Offset"},{name:"offSetZ",type:"number",default:0,title:"Z Coord Offset"},{name:"uiScalingRatio",type:"number",default:1,min:.1,max:2,precision:2,title:"Device Ui Scaling"},{name:"useEntityScale",type:"boolean",default:!1,title:"Entity Scaling vs Element Width height"}];PerDeviceUiscaling.attributes.add("androidSettings",{type:"json",schema:scalingSchema,title:"Android Settings"}),PerDeviceUiscaling.attributes.add("iosSettings",{type:"json",schema:scalingSchema,title:"iOS Settings"}),PerDeviceUiscaling.attributes.add("chromebookSettings",{type:"json",schema:scalingSchema,title:"Chromebook Settings"}),PerDeviceUiscaling.attributes.add("desktopSettings",{type:"json",schema:scalingSchema,title:"Desktop Settings"}),PerDeviceUiscaling.attributes.add("laptopSettings",{type:"json",schema:scalingSchema,title:"Laptop Settings"}),PerDeviceUiscaling.attributes.add("androidPortraitSettings",{type:"json",schema:scalingSchema,title:"Android Portrait Settings"}),PerDeviceUiscaling.attributes.add("iosPortraitSettings",{type:"json",schema:scalingSchema,title:"iOS Portrait Settings"}),PerDeviceUiscaling.prototype.initialize=function(){this.originalPosition=(new pc.Vec3).copy(this.entity.getLocalPosition()),this.originalScale=(new pc.Vec3).copy(this.entity.getLocalScale()),this.originalWidth,this.originalHeight,this.entity.element&&this.entity.element.width&&(this.originalWidth=this.entity.element.width),this.entity.element&&this.entity.element.height&&(this.originalHeight=this.entity.element.height),this.entity.element&&this.entity.element.sprite&&!this.entity.element.texture&&(this.originalPixelsPerUnit=this.entity.element.pixelsPerUnit),this.deviceSettingScript=this.app.root.findScript("optimizeSettings"),this.currentDeviceType=null,this.currentOrientation="landscape",this.deviceSettingScript&&(this.deviceSettingScript.deviceType?(this.deviceSettingScript.currentOrientation&&(this.currentOrientation=this.deviceSettingScript.currentOrientation),this.applySettings(this.deviceSettingScript.deviceType)):this.applySettings()),this.app.on("optimizeSettings:deviceSettingApplied",(t=>{this.applySettings(t)}),this),this.app.on("optimizeSettings:orientation",(t=>{this.currentOrientation=t,this.applySettings(this.currentDeviceType)}),this)},PerDeviceUiscaling.prototype.applySettings=function(t){switch(t){case"android":"portrait"===this.currentOrientation?this.applyDeviceSettings(this.androidPortraitSettings):this.applyDeviceSettings(this.androidSettings);break;case"ios":"portrait"===this.currentOrientation?this.applyDeviceSettings(this.iosPortraitSettings):this.applyDeviceSettings(this.iosSettings);break;case"chromebook":this.applyDeviceSettings(this.chromebookSettings);break;case"desktop":this.applyDeviceSettings(this.desktopSettings);break;default:this.applyDeviceSettings(this.laptopSettings)}this.currentDeviceType=t,"joyStickBase"===this.entity.name&&this.app.fire("perDeviceUIScaling:joystickBaseShifted",this.entity.tags.list()[0])},PerDeviceUiscaling.prototype.applyDeviceSettings=function(t){this.entity.setLocalPosition(this.originalPosition.x+t.offSetX,this.originalPosition.y+t.offSetY,this.originalPosition.z+t.offSetZ),t.useEntityScale?this.entity.setLocalScale(Math.round(this.originalScale.x*t.uiScalingRatio),Math.round(this.originalScale.y*t.uiScalingRatio),Math.round(this.originalScale.z*t.uiScalingRatio)):this.originalHeight&&this.originalWidth?(this.entity.element.sprite&&!this.entity.element.texture&&(this.entity.element.pixelsPerUnit=this.originalPixelsPerUnit/t.uiScalingRatio),this.entity.element.width=Math.round(this.originalWidth*t.uiScalingRatio),this.entity.element.height=Math.round(this.originalHeight*t.uiScalingRatio)):console.log("ui scaling failed for entity "+this.entity.name+". Width or height is undefined")};var LogDynamicEntities=pc.createScript("logDynamicEntities");LogDynamicEntities.prototype.initialize=function(){console.log('Searching for dynamic, kinematic, and "level" entities...'),this.dynamicCount=0,this.kinematicCount=0,this.triggerCount=0,this.triggerList={},this.kinematicList={},this.findAndLogEntities()},LogDynamicEntities.prototype.findDynamicAndTriggerEntities=function(i,t){var n=i.rigidbody;n&&(n.type===pc.BODYTYPE_DYNAMIC?(console.log("Dynamic Entity:",i.name),this.dynamicCount++):n.type===pc.BODYTYPE_KINEMATIC&&(console.log("Kinematic Entity:",i.name),this.kinematicCount++,t&&(this.kinematicList[t]||(this.kinematicList[t]=[]),this.kinematicList[t].push(i.name)))),i.enabled&&i.trigger&&(console.log("Trigger Entity:",i.name),this.triggerCount++,t&&(this.triggerList[t]||(this.triggerList[t]=[]),this.triggerList[t].push(i.name))),i.name.startsWith("level")&&"level 25"!==i.name&&(console.log("Processing children of entity:",i.name),t=i.name,this.disableRigidBodiesAndTriggersRecursively(i,t));for(var e=i.children,o=0;o<e.length;o++)this.findDynamicAndTriggerEntities(e[o],t)},LogDynamicEntities.prototype.findAndLogEntities=function(){this.dynamicCount=0,this.kinematicCount=0,this.triggerCount=0,this.findDynamicAndTriggerEntities(this.app.root,null),console.log("Total Dynamic Entities:",this.dynamicCount),console.log("Total Kinematic Entities:",this.kinematicCount),console.log("Total Trigger Entities:",this.triggerCount),console.log("Trigger List:",this.triggerList),console.log("Kinematic List:",this.kinematicList)},LogDynamicEntities.prototype.disableRigidBodiesAndTriggersRecursively=function(i,t){var n=this;i.enabled&&i.children.forEach((function(i){i.rigidbody&&i.rigidbody.type===pc.BODYTYPE_KINEMATIC&&(n.kinematicCount++,t&&(n.kinematicList[t]||(n.kinematicList[t]=[]),n.kinematicList[t].push(i.name))),i.enabled&&i.trigger&&(console.log("Found trigger:",i.name),console.log("Trigger Data:",{parent:t,entity:i.name,type:i.collision.type,isTrigger:void 0!==i.trigger,entityData:i}),n.triggerCount++,t&&(n.triggerList[t]||(n.triggerList[t]=[]),n.triggerList[t].push(i.name))),i.enabled&&i.children.length>0&&(!i.collision||i.collision&&"compound"!==i.collision.type)&&n.disableRigidBodiesAndTriggersRecursively(i,t)}))};var CosmeticTrigger=pc.createScript("cosmeticTrigger");CosmeticTrigger.attributes.add("fillupTime",{type:"number",default:.5}),CosmeticTrigger.attributes.add("cosmeticXRotation",{type:"number",default:0}),CosmeticTrigger.attributes.add("cosmeticYRotation",{type:"number",default:40}),CosmeticTrigger.attributes.add("cosmeticZRotation",{type:"number",default:0}),CosmeticTrigger.attributes.add("goUp",{type:"number",default:0}),CosmeticTrigger.attributes.add("cosmeticType",{type:"string",default:"colobus",enum:[{colobus:"colobus"},{gecko:"gecko"},{geckoDragon:"geckoDragon"},{monkey:"monkey"},{kangaroo:"kangaroo"},{kirin:"kirin"},{leviathan:"leviathan"},{turkey:"turkey"},{pheonix:"pheonix"},{elephant:"elephant"},{wyvern:"wyvern"},{chameleon:"chameleon"},{hornedLizard:"hornedLizard"},{panda:"panda"},{gemsbok:"gemsbok"},{llama:"llama"},{kiwi:"kiwi"},{peacock:"peacock"},{polarBear:"polarBear"},{rhino:"rhino"}],description:"This is a dropdown attribute"}),CosmeticTrigger.attributes.add("autoSelect",{type:"boolean",default:!0}),CosmeticTrigger.attributes.add("autoSelectList",{type:"string",default:[],enum:[{colobus:"colobus"},{gecko:"gecko"},{geckoDragon:"geckoDragon"},{monkey:"monkey"},{kangaroo:"kangaroo"},{kirin:"kirin"},{leviathan:"leviathan"},{turkey:"turkey"},{pheonix:"pheonix"},{elephant:"elephant"},{wyvern:"wyvern"},{chameleon:"chameleon"},{hornedLizard:"hornedLizard"},{panda:"panda"},{gemsbok:"gemsbok"},{llama:"llama"},{kiwi:"kiwi"},{peacock:"peacock"},{polarBear:"polarBear"},{rhino:"rhino"}],array:!0,description:"This is a dropdown attribute"});const cosmeticTypeList=["colobus","gecko","geckoDragon","monkey","kangaroo","kirin","turkey","elephant","leviathan","pheonix","wyvern","chameleon","hornedLizard","panda","gemsbok","llama","kiwi","peacock","polarBear","rhino"];function autoSelectFromArray(e){return Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:null}CosmeticTrigger.prototype.initialize=function(){this.cullingDistance=50,this.time=0,this.isInsideTrigger=!1,this.circleFilled=!1,this.player=this.app.root.findByName("Player"),this.particleSystem=this.entity.findByName("Particle System"),this.highlighter=this.entity.findByName("Highlighter"),this.initialScale=new pc.Vec3(1,0,1),this.spriteInitialized=!1,this.autoSelect&&this.autoSelectCosmeticType(),this.entity.currentNumberOfAds=0,this.entity.cosmeticPrice=1,this.resetCosmeticPrice(),this.particleSystem||console.error("Particle System child not found!"),this.triggerVolume=this.entity.findByName("TriggerVolume");var e=this.triggerVolume.collision;e.on("triggerenter",this.onTriggerEnter,this),e.on("triggerleave",this.onTriggerLeave,this),this.goUp>0&&this.cosmeticSprite.tween(this.cosmeticSprite.getLocalPosition()).to(new pc.Vec3(0,localPositionY+this.goUp,0),1,pc.SineOut).loop(!0).yoyo(!0).start(),this.checkDistanceTime=0,this.updateDistance(),this.app.on("settings:applyPowerupCullDistance",(function(e){this.cullingDistance=e}),this),this.app.on("animalChanger:skinChanged",this.resetCosmeticTrigger,this)},CosmeticTrigger.prototype.initializeSprite=function(){var e=this.app.root.findByName("Cosmetic Options");if(!e)return void console.error("Cosmetic Options entity not found!");var i=e.findByName(this.cosmeticType);if(!i)return void console.error(`Cosmetic type "${this.cosmeticType}" not found in Cosmetic Options!`);this.cosmeticSprite=i.clone(),this.cosmeticSprite.enabled=!0,this.cosmeticSprite.name="CosmeticSprite";this.cosmeticSprite.setLocalPosition(0,.35,0),this.entity.addChild(this.cosmeticSprite),this.spriteInitialized=!0},CosmeticTrigger.prototype.resetCosmeticPrice=function(){const e=this.app.root.findScript("animalChanger");e?(this.entity.cosmeticPrice=e.getSkinPrice(this.cosmeticType),this.entity.cosmeticPrice||(this.entity.cosmeticPrice=1)):this.entity.cosmeticPrice=1,this.entity.currentNumberOfAds=0},CosmeticTrigger.prototype.resetCosmeticTrigger=function(e){if(this.cosmeticType===e)if(this.autoSelect){this.cosmeticSprite&&(this.entity.removeChild(this.cosmeticSprite),this.cosmeticSprite.destroy(),this.cosmeticSprite=null),this.autoSelectCosmeticType();var i=this.app.root.findByName("Cosmetic Options");if(i){var t=i.findByName(this.cosmeticType);if(t){this.cosmeticSprite=t.clone(),this.cosmeticSprite.enabled=!0,this.cosmeticSprite.name="CosmeticSprite";const e=.35;this.cosmeticSprite.setLocalPosition(0,e,0),this.entity.addChild(this.cosmeticSprite)}else console.error(`Cosmetic type "${this.cosmeticType}" not found in Cosmetic Options!`)}else console.error("Cosmetic Options entity not found!");this.resetCosmeticPrice()}else this.resetCosmeticPrice()},CosmeticTrigger.prototype.update=function(e){if(this.isInsideTrigger){this.time+=e;var i=pc.math.clamp(this.time/this.fillupTime,0,1);1!==i||this.circleFilled||(this.circleFilled=!0,this.app.fire("cosmetics:filled",this.cosmeticType,this.entity)),this.highlighter.enabled||(this.highlighter.enabled=!0),this.highlighter.setLocalScale(this.initialScale.clone().scale(i))}else this.highlighter.enabled&&(this.highlighter.enabled=!1);this.spriteInitialized&&this.cosmeticSprite.rotate(this.cosmeticXRotation*e,this.cosmeticYRotation*e,this.cosmeticZRotation*e),this.checkDistanceTime+=e,this.checkDistanceTime>=1&&(this.updateDistance(),this.checkDistanceTime=0)},CosmeticTrigger.prototype.onTriggerEnter=function(e){e&&"Player"===e.name&&(this.isInsideTrigger=!0,this.time=0)},CosmeticTrigger.prototype.onTriggerLeave=function(e){e&&"Player"===e.name&&(this.isInsideTrigger=!1,this.highlighter.setLocalScale(new pc.Vec3),this.circleFilled=!1)},CosmeticTrigger.prototype.updateDistance=function(){if(this.player){var e=this.player.getPosition(),i=this.entity.getPosition();e.distance(i)<=this.cullingDistance?(this.spriteInitialized||this.initializeSprite(),this.particleSystem.enabled=!0,this.cosmeticSprite&&(this.cosmeticSprite.enabled=!0)):(this.particleSystem.enabled=!1,this.cosmeticSprite&&(this.cosmeticSprite.enabled=!1))}else console.error("Player object not found!")},CosmeticTrigger.prototype.autoSelectCosmeticType=function(){if(this.autoSelectList.length>0){let e=this.autoSelectList.filter((e=>e));const t=this.app.root.findScript("animalChanger");if(t)for(i=0;i<t.currentSkinKeys.length;i++){let o=t.getSkinName(t.currentSkinKeys[i]);o&&this.autoSelectList.includes(o)&&(e=e.filter((e=>e!==o)))}e.length>0&&(this.cosmeticType=autoSelectFromArray(e))}else this.cosmeticType=autoSelectFromArray(cosmeticTypeList)};var TriggerLevelCuller=pc.createScript("triggerLevelCuller");TriggerLevelCuller.attributes.add("levelActivationDistance",{type:"number",default:50,description:"Distance from the player within which triggers are enabled."}),TriggerLevelCuller.prototype.initialize=function(){this.levels=[],this.elapsedTime=0;var e=this.app.root.findByName("Player");if(e){this.player=e;for(var t=this.app.root.find((function(e){return e.name.startsWith("level")})),i=0;i<t.length;i++){var l=t[i],r=[],collectTriggers=function(e){e.collision&&e.trigger&&e.enabled&&r.push(e);for(var t=e.children,i=0;i<t.length;i++)collectTriggers(t[i])};collectTriggers(l);for(var n=0;n<r.length;n++)r[n].enabled=!1;r.length>0&&this.levels.push({levelEntity:l,triggers:r,isActive:!1,levelname:l.name})}console.log("collected levels",this.levels)}else console.error("Player entity not found!")},TriggerLevelCuller.prototype.update=function(e){if(this.elapsedTime+=e,this.elapsedTime>=.5){this.elapsedTime=0;for(var t=this.player.getPosition(),i=0;i<this.levels.length;i++){var l=this.levels[i],r=l.levelEntity,n=l.triggers,s=r.getPosition(),a=t.distance(s)<=this.levelActivationDistance;if(a!==l.isActive){console.log("setting triggers in level",r.name,a),l.isActive=a;for(var o=0;o<n.length;o++)n[o].enabled=a}}}};var CosmeticsConfirmImg=pc.createScript("cosmeticsConfirmImg");CosmeticsConfirmImg.prototype.initialize=function(){this.app.on("animalChanger:cosmeticUITagUpdate",(i=>{let e=pc.app.root.findByName("cosmeticConfirmImgPanel");e.tags.clear(),e.tags.add(`${i}-ui`),pc.app.fire("cosmeticConfirm:renderUpdate",e)}))};!function(a){var o,d,c,m,p,A,h,S,b,T,G,I,k=k||function(a){function t(){}var o={},d=o.lib={},c=d.Base={extend:function(a){t.prototype=this;var o=new t;return a&&o.mixIn(a),o.hasOwnProperty("init")||(o.init=function(){o.$super.init.apply(this,arguments)}),(o.init.prototype=o).$super=this,o},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var o in a)a.hasOwnProperty(o)&&(this[o]=a[o]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},m=d.WordArray=c.extend({init:function(a,o){a=this.words=a||[],this.sigBytes=null!=o?o:4*a.length},toString:function(a){return(a||A).stringify(this)},concat:function(a){var o=this.words,d=a.words,c=this.sigBytes;if(a=a.sigBytes,this.clamp(),c%4)for(var m=0;m<a;m++)o[c+m>>>2]|=(d[m>>>2]>>>24-m%4*8&255)<<24-(c+m)%4*8;else if(65535<d.length)for(m=0;m<a;m+=4)o[c+m>>>2]=d[m>>>2];else o.push.apply(o,d);return this.sigBytes+=a,this},clamp:function(){var o=this.words,d=this.sigBytes;o[d>>>2]&=4294967295<<32-d%4*8,o.length=a.ceil(d/4)},clone:function(){var a=c.clone.call(this);return a.words=this.words.slice(0),a},random:function(o){for(var d=[],c=0;c<o;c+=4)d.push(4294967296*a.random()|0);return new m.init(d,o)}}),p=o.enc={},A=p.Hex={stringify:function(a){var o=a.words;a=a.sigBytes;for(var d=[],c=0;c<a;c++){var m=o[c>>>2]>>>24-c%4*8&255;d.push((m>>>4).toString(16)),d.push((15&m).toString(16))}return d.join("")},parse:function(a){for(var o=a.length,d=[],c=0;c<o;c+=2)d[c>>>3]|=parseInt(a.substr(c,2),16)<<24-c%8*4;return new m.init(d,o/2)}},h=p.Latin1={stringify:function(a){var o=a.words;a=a.sigBytes;for(var d=[],c=0;c<a;c++)d.push(String.fromCharCode(o[c>>>2]>>>24-c%4*8&255));return d.join("")},parse:function(a){for(var o=a.length,d=[],c=0;c<o;c++)d[c>>>2]|=(255&a.charCodeAt(c))<<24-c%4*8;return new m.init(d,o)}},S=p.Utf8={stringify:function(a){try{return decodeURIComponent(escape(h.stringify(a)))}catch(a){throw Error("Malformed UTF-8 data")}},parse:function(a){return h.parse(unescape(encodeURIComponent(a)))}},b=d.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new m.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=S.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(o){var d=this._data,c=d.words,p=d.sigBytes,A=this.blockSize,h=p/(4*A);if(o=(h=o?a.ceil(h):a.max((0|h)-this._minBufferSize,0))*A,p=a.min(4*o,p),o){for(var S=0;S<o;S+=A)this._doProcessBlock(c,S);S=c.splice(0,o),d.sigBytes-=p}return new m.init(S,p)},clone:function(){var a=c.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=b.extend({cfg:c.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){b.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(o,d){return new a.init(d).finalize(o)}},_createHmacHelper:function(a){return function(o,d){return new T.HMAC.init(a,d).finalize(o)}}});var T=o.algo={};return o}(Math);!function(a){function e(a){return 4294967296*(a-(0|a))|0}for(var o=k,d=(m=o.lib).WordArray,c=m.Hasher,m=o.algo,p=[],A=[],h=2,S=0;S<64;){var b;e:{b=h;for(var T=a.sqrt(b),G=2;G<=T;G++)if(!(b%G)){b=!1;break e}b=!0}b&&(S<8&&(p[S]=e(a.pow(h,.5))),A[S]=e(a.pow(h,1/3)),S++),h++}var I=[];m=m.SHA256=c.extend({_doReset:function(){this._hash=new d.init(p.slice(0))},_doProcessBlock:function(a,o){for(var d=this._hash.words,c=d[0],m=d[1],p=d[2],h=d[3],S=d[4],b=d[5],T=d[6],G=d[7],k=0;k<64;k++){if(k<16)I[k]=0|a[o+k];else{var _=I[k-15],w=I[k-2];I[k]=((_<<25|_>>>7)^(_<<14|_>>>18)^_>>>3)+I[k-7]+((w<<15|w>>>17)^(w<<13|w>>>19)^w>>>10)+I[k-16]}_=G+((S<<26|S>>>6)^(S<<21|S>>>11)^(S<<7|S>>>25))+(S&b^~S&T)+A[k]+I[k],w=((c<<30|c>>>2)^(c<<19|c>>>13)^(c<<10|c>>>22))+(c&m^c&p^m&p),G=T,T=b,b=S,S=h+_|0,h=p,p=m,m=c,c=_+w|0}d[0]=d[0]+c|0,d[1]=d[1]+m|0,d[2]=d[2]+p|0,d[3]=d[3]+h|0,d[4]=d[4]+S|0,d[5]=d[5]+b|0,d[6]=d[6]+T|0,d[7]=d[7]+G|0},_doFinalize:function(){var o=this._data,d=o.words,c=8*this._nDataBytes,m=8*o.sigBytes;return d[m>>>5]|=128<<24-m%32,d[14+(64+m>>>9<<4)]=a.floor(c/4294967296),d[15+(64+m>>>9<<4)]=c,o.sigBytes=4*d.length,this._process(),this._hash},clone:function(){var a=c.clone.call(this);return a._hash=this._hash.clone(),a}}),o.SHA256=c._createHelper(m),o.HmacSHA256=c._createHmacHelper(m)}(Math),I=k.enc.Utf8,k.algo.HMAC=k.lib.Base.extend({init:function(a,o){a=this._hasher=new a.init,"string"==typeof o&&(o=I.parse(o));var d=a.blockSize,c=4*d;o.sigBytes>c&&(o=a.finalize(o)),o.clamp();for(var m=this._oKey=o.clone(),p=this._iKey=o.clone(),A=m.words,h=p.words,S=0;S<d;S++)A[S]^=1549556828,h[S]^=909522486;m.sigBytes=p.sigBytes=c,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var o=this._hasher;return a=o.finalize(a),o.reset(),o.finalize(this._oKey.clone().concat(a))}}),G=k.lib.WordArray,k.enc.Base64={stringify:function(a){var o=a.words,d=a.sigBytes,c=this._map;a.clamp(),a=[];for(var m=0;m<d;m+=3)for(var p=(o[m>>>2]>>>24-m%4*8&255)<<16|(o[m+1>>>2]>>>24-(m+1)%4*8&255)<<8|o[m+2>>>2]>>>24-(m+2)%4*8&255,A=0;A<4&&m+.75*A<d;A++)a.push(c.charAt(p>>>6*(3-A)&63));if(o=c.charAt(64))for(;a.length%4;)a.push(o);return a.join("")},parse:function(a){var o=a.length,d=this._map;!(c=d.charAt(64))||-1!=(c=a.indexOf(c))&&(o=c);for(var c=[],m=0,p=0;p<o;p++)if(p%4){var A=d.indexOf(a.charAt(p-1))<<p%4*2,h=d.indexOf(a.charAt(p))>>>6-p%4*2;c[m>>>2]|=(A|h)<<24-m%4*8,m++}return G.create(c,m)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},function(a){var o,d,c,m,p,A,h,S,b,T,G,I,k;(o=a.EGAErrorSeverity||(a.EGAErrorSeverity={}))[o.Undefined=0]="Undefined",o[o.Debug=1]="Debug",o[o.Info=2]="Info",o[o.Warning=3]="Warning",o[o.Error=4]="Error",o[o.Critical=5]="Critical",(d=a.EGAProgressionStatus||(a.EGAProgressionStatus={}))[d.Undefined=0]="Undefined",d[d.Start=1]="Start",d[d.Complete=2]="Complete",d[d.Fail=3]="Fail",(c=a.EGAResourceFlowType||(a.EGAResourceFlowType={}))[c.Undefined=0]="Undefined",c[c.Source=1]="Source",c[c.Sink=2]="Sink",(m=a.EGAAdAction||(a.EGAAdAction={}))[m.Undefined=0]="Undefined",m[m.Clicked=1]="Clicked",m[m.Show=2]="Show",m[m.FailedShow=3]="FailedShow",m[m.RewardReceived=4]="RewardReceived",(p=a.EGAAdError||(a.EGAAdError={}))[p.Undefined=0]="Undefined",p[p.Unknown=1]="Unknown",p[p.Offline=2]="Offline",p[p.NoFill=3]="NoFill",p[p.InternalError=4]="InternalError",p[p.InvalidRequest=5]="InvalidRequest",p[p.UnableToPrecache=6]="UnableToPrecache",(A=a.EGAAdType||(a.EGAAdType={}))[A.Undefined=0]="Undefined",A[A.Video=1]="Video",A[A.RewardedVideo=2]="RewardedVideo",A[A.Playable=3]="Playable",A[A.Interstitial=4]="Interstitial",A[A.OfferWall=5]="OfferWall",A[A.Banner=6]="Banner",(S=(h=a.http||(a.http={})).EGAHTTPApiResponse||(h.EGAHTTPApiResponse={}))[S.NoResponse=0]="NoResponse",S[S.BadResponse=1]="BadResponse",S[S.RequestTimeout=2]="RequestTimeout",S[S.JsonEncodeFailed=3]="JsonEncodeFailed",S[S.JsonDecodeFailed=4]="JsonDecodeFailed",S[S.InternalServerError=5]="InternalServerError",S[S.BadRequest=6]="BadRequest",S[S.Unauthorized=7]="Unauthorized",S[S.UnknownResponseCode=8]="UnknownResponseCode",S[S.Ok=9]="Ok",S[S.Created=10]="Created",(T=(b=a.events||(a.events={})).EGASdkErrorCategory||(b.EGASdkErrorCategory={}))[T.Undefined=0]="Undefined",T[T.EventValidation=1]="EventValidation",T[T.Database=2]="Database",T[T.Init=3]="Init",T[T.Http=4]="Http",T[T.Json=5]="Json",(G=b.EGASdkErrorArea||(b.EGASdkErrorArea={}))[G.Undefined=0]="Undefined",G[G.BusinessEvent=1]="BusinessEvent",G[G.ResourceEvent=2]="ResourceEvent",G[G.ProgressionEvent=3]="ProgressionEvent",G[G.DesignEvent=4]="DesignEvent",G[G.ErrorEvent=5]="ErrorEvent",G[G.InitHttp=9]="InitHttp",G[G.EventsHttp=10]="EventsHttp",G[G.ProcessEvents=11]="ProcessEvents",G[G.AddEventsToStore=12]="AddEventsToStore",G[G.AdEvent=20]="AdEvent",(I=b.EGASdkErrorAction||(b.EGASdkErrorAction={}))[I.Undefined=0]="Undefined",I[I.InvalidCurrency=1]="InvalidCurrency",I[I.InvalidShortString=2]="InvalidShortString",I[I.InvalidEventPartLength=3]="InvalidEventPartLength",I[I.InvalidEventPartCharacters=4]="InvalidEventPartCharacters",I[I.InvalidStore=5]="InvalidStore",I[I.InvalidFlowType=6]="InvalidFlowType",I[I.StringEmptyOrNull=7]="StringEmptyOrNull",I[I.NotFoundInAvailableCurrencies=8]="NotFoundInAvailableCurrencies",I[I.InvalidAmount=9]="InvalidAmount",I[I.NotFoundInAvailableItemTypes=10]="NotFoundInAvailableItemTypes",I[I.WrongProgressionOrder=11]="WrongProgressionOrder",I[I.InvalidEventIdLength=12]="InvalidEventIdLength",I[I.InvalidEventIdCharacters=13]="InvalidEventIdCharacters",I[I.InvalidProgressionStatus=15]="InvalidProgressionStatus",I[I.InvalidSeverity=16]="InvalidSeverity",I[I.InvalidLongString=17]="InvalidLongString",I[I.DatabaseTooLarge=18]="DatabaseTooLarge",I[I.DatabaseOpenOrCreate=19]="DatabaseOpenOrCreate",I[I.JsonError=25]="JsonError",I[I.FailHttpJsonDecode=29]="FailHttpJsonDecode",I[I.FailHttpJsonEncode=30]="FailHttpJsonEncode",I[I.InvalidAdAction=31]="InvalidAdAction",I[I.InvalidAdType=32]="InvalidAdType",I[I.InvalidString=33]="InvalidString",(k=b.EGASdkErrorParameter||(b.EGASdkErrorParameter={}))[k.Undefined=0]="Undefined",k[k.Currency=1]="Currency",k[k.CartType=2]="CartType",k[k.ItemType=3]="ItemType",k[k.ItemId=4]="ItemId",k[k.Store=5]="Store",k[k.FlowType=6]="FlowType",k[k.Amount=7]="Amount",k[k.Progression01=8]="Progression01",k[k.Progression02=9]="Progression02",k[k.Progression03=10]="Progression03",k[k.EventId=11]="EventId",k[k.ProgressionStatus=12]="ProgressionStatus",k[k.Severity=13]="Severity",k[k.Message=14]="Message",k[k.AdAction=15]="AdAction",k[k.AdType=16]="AdType",k[k.AdSdkName=17]="AdSdkName",k[k.AdPlacement=18]="AdPlacement"}(d=d||{}),m=o=o||{},(p=m.EGAErrorSeverity||(m.EGAErrorSeverity={}))[p.Undefined=0]="Undefined",p[p.Debug=1]="Debug",p[p.Info=2]="Info",p[p.Warning=3]="Warning",p[p.Error=4]="Error",p[p.Critical=5]="Critical",(A=m.EGAProgressionStatus||(m.EGAProgressionStatus={}))[A.Undefined=0]="Undefined",A[A.Start=1]="Start",A[A.Complete=2]="Complete",A[A.Fail=3]="Fail",(h=m.EGAResourceFlowType||(m.EGAResourceFlowType={}))[h.Undefined=0]="Undefined",h[h.Source=1]="Source",h[h.Sink=2]="Sink",(S=m.EGAAdAction||(m.EGAAdAction={}))[S.Undefined=0]="Undefined",S[S.Clicked=1]="Clicked",S[S.Show=2]="Show",S[S.FailedShow=3]="FailedShow",S[S.RewardReceived=4]="RewardReceived",(b=m.EGAAdError||(m.EGAAdError={}))[b.Undefined=0]="Undefined",b[b.Unknown=1]="Unknown",b[b.Offline=2]="Offline",b[b.NoFill=3]="NoFill",b[b.InternalError=4]="InternalError",b[b.InvalidRequest=5]="InvalidRequest",b[b.UnableToPrecache=6]="UnableToPrecache",(T=m.EGAAdType||(m.EGAAdType={}))[T.Undefined=0]="Undefined",T[T.Video=1]="Video",T[T.RewardedVideo=2]="RewardedVideo",T[T.Playable=3]="Playable",T[T.Interstitial=4]="Interstitial",T[T.OfferWall=5]="OfferWall",T[T.Banner=6]="Banner",function(a){!function(a){var o,d;(d=o=o||{})[d.Error=0]="Error",d[d.Warning=1]="Warning",d[d.Info=2]="Info",d[d.Debug=3]="Debug";var c=(r.setInfoLog=function(a){r.instance.infoLogEnabled=a},r.setVerboseLog=function(a){r.instance.infoLogVerboseEnabled=a},r.i=function(a){if(r.instance.infoLogEnabled){var d="Info/"+r.Tag+": "+a;r.instance.sendNotificationMessage(d,o.Info)}},r.w=function(a){var d="Warning/"+r.Tag+": "+a;r.instance.sendNotificationMessage(d,o.Warning)},r.e=function(a){var d="Error/"+r.Tag+": "+a;r.instance.sendNotificationMessage(d,o.Error)},r.ii=function(a){if(r.instance.infoLogVerboseEnabled){var d="Verbose/"+r.Tag+": "+a;r.instance.sendNotificationMessage(d,o.Info)}},r.d=function(a){if(r.debugEnabled){var d="Debug/"+r.Tag+": "+a;r.instance.sendNotificationMessage(d,o.Debug)}},r.prototype.sendNotificationMessage=function(a,d){switch(d){case o.Error:console.error(a);break;case o.Warning:console.warn(a);break;case o.Debug:"function"==typeof console.debug?console.debug(a):console.log(a);break;case o.Info:console.log(a)}},r.instance=new r,r.Tag="GameAnalytics",r);function r(){r.debugEnabled=!1}a.GALogger=c}(a.logging||(a.logging={}))}(d=d||{}),function(a){var o,d,c;function u(){}o=a.utilities||(a.utilities={}),d=a.logging.GALogger,u.getHmac=function(a,o){var d=k.HmacSHA256(o,a);return k.enc.Base64.stringify(d)},u.stringMatch=function(a,o){return!(!a||!o)&&o.test(a)},u.joinStringArray=function(a,o){for(var d="",c=0,m=a.length;c<m;c++)0<c&&(d+=o),d+=a[c];return d},u.stringArrayContainsString=function(a,o){if(0===a.length)return!1;for(var d in a)if(a[d]===o)return!0;return!1},u.encode64=function(a){a=encodeURI(a);for(var o,d,c,m,p,A="",h=0,S=0,b=0;c=(o=a.charCodeAt(b++))>>2,m=(3&o)<<4|(d=a.charCodeAt(b++))>>4,p=(15&d)<<2|(h=a.charCodeAt(b++))>>6,S=63&h,isNaN(d)?p=S=64:isNaN(h)&&(S=64),A=A+u.keyStr.charAt(c)+u.keyStr.charAt(m)+u.keyStr.charAt(p)+u.keyStr.charAt(S),o=d=h=0,c=m=p=S=0,b<a.length;);return A},u.decode64=function(a){var o,c,m,p,A="",h=0,S=0,b=0;for(/[^A-Za-z0-9\+\/\=]/g.exec(a)&&d.w("There were invalid base64 characters in the input text. Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='. Expect errors in decoding."),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");o=u.keyStr.indexOf(a.charAt(b++))<<2|(m=u.keyStr.indexOf(a.charAt(b++)))>>4,c=(15&m)<<4|(p=u.keyStr.indexOf(a.charAt(b++)))>>2,h=(3&p)<<6|(S=u.keyStr.indexOf(a.charAt(b++))),A+=String.fromCharCode(o),64!=p&&(A+=String.fromCharCode(c)),64!=S&&(A+=String.fromCharCode(h)),o=c=h=0,m=p=S=0,b<a.length;);return decodeURI(A)},u.timeIntervalSince1970=function(){var a=new Date;return Math.round(a.getTime()/1e3)},u.createGuid=function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(a){return(+a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)}))},u.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=u,o.GAUtilities=c}(d=d||{}),function(a){var o=c.logging.GALogger,d=c.utilities.GAUtilities,m=c.events.EGASdkErrorCategory,p=c.events.EGASdkErrorArea,A=c.events.EGASdkErrorAction,h=c.events.EGASdkErrorParameter,g=function(a,o,d,c,m){this.category=a,this.area=o,this.action=d,this.parameter=c,this.reason=m};a.ValidationResult=g;var S=(f.validateBusinessEvent=function(a,d,c,S,b){return f.validateCurrency(a)?d<0?(o.w("Validation fail - business event - amount. Cannot be less than 0. Failed amount: "+d),new g(m.EventValidation,p.BusinessEvent,A.InvalidAmount,h.Amount,d+"")):f.validateShortString(c,!0)?f.validateEventPartLength(S,!1)?f.validateEventPartCharacters(S)?f.validateEventPartLength(b,!1)?f.validateEventPartCharacters(b)?null:(o.w("Validation fail - business event - itemId: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+b),new g(m.EventValidation,p.BusinessEvent,A.InvalidEventPartCharacters,h.ItemId,b)):(o.w("Validation fail - business event - itemId. Cannot be (null), empty or above 64 characters. String: "+b),new g(m.EventValidation,p.BusinessEvent,A.InvalidEventPartLength,h.ItemId,b)):(o.w("Validation fail - business event - itemType: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+S),new g(m.EventValidation,p.BusinessEvent,A.InvalidEventPartCharacters,h.ItemType,S)):(o.w("Validation fail - business event - itemType: Cannot be (null), empty or above 64 characters. String: "+S),new g(m.EventValidation,p.BusinessEvent,A.InvalidEventPartLength,h.ItemType,S)):(o.w("Validation fail - business event - cartType. Cannot be above 32 length. String: "+c),new g(m.EventValidation,p.BusinessEvent,A.InvalidShortString,h.CartType,c)):(o.w("Validation fail - business event - currency: Cannot be (null) and need to be A-Z, 3 characters and in the standard at openexchangerates.org. Failed currency: "+a),new g(m.EventValidation,p.BusinessEvent,A.InvalidCurrency,h.Currency,a))},f.validateResourceEvent=function(a,S,b,T,G,I,k){return a==c.EGAResourceFlowType.Undefined?(o.w("Validation fail - resource event - flowType: Invalid flow type."),new g(m.EventValidation,p.ResourceEvent,A.InvalidFlowType,h.FlowType,"")):S?d.stringArrayContainsString(I,S)?0<b?T?f.validateEventPartLength(T,!1)?f.validateEventPartCharacters(T)?d.stringArrayContainsString(k,T)?f.validateEventPartLength(G,!1)?f.validateEventPartCharacters(G)?null:(o.w("Validation fail - resource event - itemId: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+G),new g(m.EventValidation,p.ResourceEvent,A.InvalidEventPartCharacters,h.ItemId,G)):(o.w("Validation fail - resource event - itemId: Cannot be (null), empty or above 64 characters. String: "+G),new g(m.EventValidation,p.ResourceEvent,A.InvalidEventPartLength,h.ItemId,G)):(o.w("Validation fail - resource event - itemType: Not found in list of pre-defined available resource itemTypes. String: "+T),new g(m.EventValidation,p.ResourceEvent,A.NotFoundInAvailableItemTypes,h.ItemType,T)):(o.w("Validation fail - resource event - itemType: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+T),new g(m.EventValidation,p.ResourceEvent,A.InvalidEventPartCharacters,h.ItemType,T)):(o.w("Validation fail - resource event - itemType: Cannot be (null), empty or above 64 characters. String: "+T),new g(m.EventValidation,p.ResourceEvent,A.InvalidEventPartLength,h.ItemType,T)):(o.w("Validation fail - resource event - itemType: Cannot be (null)"),new g(m.EventValidation,p.ResourceEvent,A.StringEmptyOrNull,h.ItemType,"")):(o.w("Validation fail - resource event - amount: Float amount cannot be 0 or negative. Value: "+b),new g(m.EventValidation,p.ResourceEvent,A.InvalidAmount,h.Amount,b+"")):(o.w("Validation fail - resource event - currency: Not found in list of pre-defined available resource currencies. String: "+S),new g(m.EventValidation,p.ResourceEvent,A.NotFoundInAvailableCurrencies,h.Currency,S)):(o.w("Validation fail - resource event - currency: Cannot be (null)"),new g(m.EventValidation,p.ResourceEvent,A.StringEmptyOrNull,h.Currency,""))},f.validateProgressionEvent=function(a,d,S,b){if(a==c.EGAProgressionStatus.Undefined)return o.w("Validation fail - progression event: Invalid progression status."),new g(m.EventValidation,p.ProgressionEvent,A.InvalidProgressionStatus,h.ProgressionStatus,"");if(b&&!S&&d)return o.w("Validation fail - progression event: 03 found but 01+02 are invalid. Progression must be set as either 01, 01+02 or 01+02+03."),new g(m.EventValidation,p.ProgressionEvent,A.WrongProgressionOrder,h.Undefined,d+":"+S+":"+b);if(S&&!d)return o.w("Validation fail - progression event: 02 found but not 01. Progression must be set as either 01, 01+02 or 01+02+03"),new g(m.EventValidation,p.ProgressionEvent,A.WrongProgressionOrder,h.Undefined,d+":"+S+":"+b);if(!d)return o.w("Validation fail - progression event: progression01 not valid. Progressions must be set as either 01, 01+02 or 01+02+03"),new g(m.EventValidation,p.ProgressionEvent,A.WrongProgressionOrder,h.Undefined,(d||"")+":"+(S||"")+":"+(b||""));if(!f.validateEventPartLength(d,!1))return o.w("Validation fail - progression event - progression01: Cannot be (null), empty or above 64 characters. String: "+d),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartLength,h.Progression01,d);if(!f.validateEventPartCharacters(d))return o.w("Validation fail - progression event - progression01: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+d),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartCharacters,h.Progression01,d);if(S){if(!f.validateEventPartLength(S,!0))return o.w("Validation fail - progression event - progression02: Cannot be empty or above 64 characters. String: "+S),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartLength,h.Progression02,S);if(!f.validateEventPartCharacters(S))return o.w("Validation fail - progression event - progression02: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+S),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartCharacters,h.Progression02,S)}if(b){if(!f.validateEventPartLength(b,!0))return o.w("Validation fail - progression event - progression03: Cannot be empty or above 64 characters. String: "+b),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartLength,h.Progression03,b);if(!f.validateEventPartCharacters(b))return o.w("Validation fail - progression event - progression03: Cannot contain other characters than A-z, 0-9, -_., ()!?. String: "+b),new g(m.EventValidation,p.ProgressionEvent,A.InvalidEventPartCharacters,h.Progression03,b)}return null},f.validateDesignEvent=function(a){return f.validateEventIdLength(a)?f.validateEventIdCharacters(a)?null:(o.w("Validation fail - design event - eventId: Non valid characters. Only allowed A-z, 0-9, -_., ()!?. String: "+a),new g(m.EventValidation,p.DesignEvent,A.InvalidEventIdCharacters,h.EventId,a)):(o.w("Validation fail - design event - eventId: Cannot be (null) or empty. Only 5 event parts allowed seperated by :. Each part need to be 64 characters or less. String: "+a),new g(m.EventValidation,p.DesignEvent,A.InvalidEventIdLength,h.EventId,a))},f.validateErrorEvent=function(a,d){return a==c.EGAErrorSeverity.Undefined?(o.w("Validation fail - error event - severity: Severity was unsupported value."),new g(m.EventValidation,p.ErrorEvent,A.InvalidSeverity,h.Severity,"")):f.validateLongString(d,!0)?null:(o.w("Validation fail - error event - message: Message cannot be above 8192 characters."),new g(m.EventValidation,p.ErrorEvent,A.InvalidLongString,h.Message,d))},f.validateAdEvent=function(a,d,S,b){return a==c.EGAAdAction.Undefined?(o.w("Validation fail - error event - severity: Severity was unsupported value."),new g(m.EventValidation,p.AdEvent,A.InvalidAdAction,h.AdAction,"")):d==c.EGAAdType.Undefined?(o.w("Validation fail - ad event - adType: Ad type was unsupported value."),new g(m.EventValidation,p.AdEvent,A.InvalidAdType,h.AdType,"")):f.validateShortString(S,!1)?f.validateString(b,!1)?null:(o.w("Validation fail - ad event - message: Ad placement cannot be above 64 characters."),new g(m.EventValidation,p.AdEvent,A.InvalidString,h.AdPlacement,b)):(o.w("Validation fail - ad event - message: Ad SDK name cannot be above 32 characters."),new g(m.EventValidation,p.AdEvent,A.InvalidShortString,h.AdSdkName,S))},f.validateSdkErrorEvent=function(a,d,c,h,S){return!(!f.validateKeys(a,d)||(c===m.Undefined?(o.w("Validation fail - sdk error event - type: Category was unsupported value."),1):h===p.Undefined?(o.w("Validation fail - sdk error event - type: Area was unsupported value."),1):S===A.Undefined&&(o.w("Validation fail - sdk error event - type: Action was unsupported value."),1)))},f.validateKeys=function(a,o){return!(!d.stringMatch(a,/^[A-z0-9]{32}$/)||!d.stringMatch(o,/^[A-z0-9]{40}$/))},f.validateCurrency=function(a){return!!a&&!!d.stringMatch(a,/^[A-Z]{3}$/)},f.validateEventPartLength=function(a,o){return!(!o||a)||!!a&&!(64<a.length)},f.validateEventPartCharacters=function(a){return!!d.stringMatch(a,/^[A-Za-z0-9\s\-_\.\(\)\!\?]{1,64}$/)},f.validateEventIdLength=function(a){return!!a&&!!d.stringMatch(a,/^[^:]{1,64}(?::[^:]{1,64}){0,4}$/)},f.validateEventIdCharacters=function(a){return!!a&&!!d.stringMatch(a,/^[A-Za-z0-9\s\-_\.\(\)\!\?]{1,64}(:[A-Za-z0-9\s\-_\.\(\)\!\?]{1,64}){0,4}$/)},f.validateAndCleanInitRequestResponse=function(a,d){if(null==a)return o.w("validateInitRequestResponse failed - no response dictionary."),null;var c={};try{var m=a.server_ts;if(!(0<m))return o.w("validateInitRequestResponse failed - invalid value in 'server_ts' field."),null;c.server_ts=m}catch(d){return o.w("validateInitRequestResponse failed - invalid type in 'server_ts' field. type="+typeof a.server_ts+", value="+a.server_ts+", "+d),null}if(d){try{var p=a.configs;c.configs=p}catch(d){return o.w("validateInitRequestResponse failed - invalid type in 'configs' field. type="+typeof a.configs+", value="+a.configs+", "+d),null}try{var A=a.configs_hash;c.configs_hash=A}catch(d){return o.w("validateInitRequestResponse failed - invalid type in 'configs_hash' field. type="+typeof a.configs_hash+", value="+a.configs_hash+", "+d),null}try{var h=a.ab_id;c.ab_id=h}catch(d){return o.w("validateInitRequestResponse failed - invalid type in 'ab_id' field. type="+typeof a.ab_id+", value="+a.ab_id+", "+d),null}try{var S=a.ab_variant_id;c.ab_variant_id=S}catch(d){return o.w("validateInitRequestResponse failed - invalid type in 'ab_variant_id' field. type="+typeof a.ab_variant_id+", value="+a.ab_variant_id+", "+d),null}}return c},f.validateBuild=function(a){return!!f.validateShortString(a,!1)},f.validateSdkWrapperVersion=function(a){return!!d.stringMatch(a,/^(unity|unreal|gamemaker|cocos2d|construct|defold|godot|flutter) [0-9]{0,5}(\.[0-9]{0,5}){0,2}$/)},f.validateEngineVersion=function(a){return!(!a||!d.stringMatch(a,/^(unity|unreal|gamemaker|cocos2d|construct|defold|godot) [0-9]{0,5}(\.[0-9]{0,5}){0,2}$/))},f.validateUserId=function(a){return!!f.validateString(a,!1)||(o.w("Validation fail - user id: id cannot be (null), empty or above 64 characters."),!1)},f.validateShortString=function(a,o){return!(!o||a)||!(!a||32<a.length)},f.validateString=function(a,o){return!(!o||a)||!(!a||64<a.length)},f.validateLongString=function(a,o){return!(!o||a)||!(!a||8192<a.length)},f.validateConnectionType=function(a){return d.stringMatch(a,/^(wwan|wifi|lan|offline)$/)},f.validateCustomDimensions=function(a){return f.validateArrayOfStrings(20,32,!1,"custom dimensions",a)},f.validateResourceCurrencies=function(a){if(!f.validateArrayOfStrings(20,64,!1,"resource currencies",a))return!1;for(var c=0;c<a.length;++c)if(!d.stringMatch(a[c],/^[A-Za-z]+$/))return o.w("resource currencies validation failed: a resource currency can only be A-Z, a-z. String was: "+a[c]),!1;return!0},f.validateResourceItemTypes=function(a){if(!f.validateArrayOfStrings(20,32,!1,"resource item types",a))return!1;for(var d=0;d<a.length;++d)if(!f.validateEventPartCharacters(a[d]))return o.w("resource item types validation failed: a resource item type cannot contain other characters than A-z, 0-9, -_., ()!?. String was: "+a[d]),!1;return!0},f.validateDimension01=function(a,o){return!a||!!d.stringArrayContainsString(o,a)},f.validateDimension02=function(a,o){return!a||!!d.stringArrayContainsString(o,a)},f.validateDimension03=function(a,o){return!a||!!d.stringArrayContainsString(o,a)},f.validateArrayOfStrings=function(a,d,c,m,p){var A=m;if(A=A||"Array",!p)return o.w(A+" validation failed: array cannot be null. "),!1;if(0==c&&0==p.length)return o.w(A+" validation failed: array cannot be empty. "),!1;if(0<a&&p.length>a)return o.w(A+" validation failed: array cannot exceed "+a+" values. It has "+p.length+" values."),!1;for(var h=0;h<p.length;++h){var S=p[h]?p[h].length:0;if(0===S)return o.w(A+" validation failed: contained an empty string. Array="+JSON.stringify(p)),!1;if(0<d&&d<S)return o.w(A+" validation failed: a string exceeded max allowed length (which is: "+d+"). String was: "+p[h]),!1}return!0},f.validateClientTs=function(a){return!(a<0||99999999999<a)},f);function f(){}a.GAValidator=S}((c=d=d||{}).validators||(c.validators={})),function(a){!function(a){var n=function(a,o,d){this.name=a,this.value=o,this.version=d};a.NameValueVersion=n;var u=function(a,o){this.name=a,this.version=o};a.NameVersion=u;var o=(r.touch=function(){},r.getRelevantSdkVersion=function(){return r.sdkGameEngineVersion?r.sdkGameEngineVersion:r.sdkWrapperVersion},r.getConnectionType=function(){return r.connectionType},r.updateConnectionType=function(){navigator.onLine?r.connectionType="ios"===r.buildPlatform||"android"===r.buildPlatform?"wwan":"lan":r.connectionType="offline"},r.getOSVersionString=function(){return r.buildPlatform+" "+r.osVersionPair.version},r.runtimePlatformToString=function(){return r.osVersionPair.name},r.getBrowserVersionString=function(){var a,o=navigator.userAgent,d=o.match(/(opera|chrome|safari|firefox|ubrowser|msie|trident|fbav(?=\/))\/?\s*(\d+)/i)||[];if(0==d.length&&"ios"===r.buildPlatform)return"webkit_"+r.osVersion;if(/trident/i.test(d[1]))return"IE "+((a=/\brv[ :]+(\d+)/g.exec(o)||[])[1]||"");if("Chrome"===d[1]&&null!=(a=o.match(/\b(OPR|Edge|UBrowser)\/(\d+)/)))return a.slice(1).join(" ").replace("OPR","Opera").replace("UBrowser","UC").toLowerCase();if(d[1]&&"fbav"===d[1].toLowerCase()&&(d[1]="facebook",d[2]))return"facebook "+d[2];var c=d[2]?[d[1],d[2]]:[navigator.appName,navigator.appVersion,"-?"];return null!=(a=o.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c.join(" ").toLowerCase()},r.getDeviceModel=function(){return"unknown"},r.getDeviceManufacturer=function(){return"unknown"},r.matchItem=function(a,o){var d,c,m,p,A=new u("unknown","0.0.0"),h=0,S=0;for(h=0;h<o.length;h+=1)if(new RegExp(o[h].value,"i").test(a)){if(d=new RegExp(o[h].version+"[- /:;]([\\d._]+)","i"),p="",(c=a.match(d))&&c[1]&&(m=c[1]),m){var b=m.split(/[._]+/);for(S=0;S<Math.min(b.length,3);S+=1)p+=b[S]+(S<Math.min(b.length,3)-1?".":"")}else p="0.0.0";return A.name=o[h].name,A.version=p,A}return A},r.sdkWrapperVersion="javascript 4.4.6",r.osVersionPair=r.matchItem([navigator.platform,navigator.userAgent,navigator.appVersion,navigator.vendor].join(" "),[new n("windows_phone","Windows Phone","OS"),new n("windows","Win","NT"),new n("ios","iPhone","OS"),new n("ios","iPad","OS"),new n("ios","iPod","OS"),new n("android","Android","Android"),new n("blackBerry","BlackBerry","/"),new n("mac_osx","Mac","OS X"),new n("tizen","Tizen","Tizen"),new n("linux","Linux","rv"),new n("kai_os","KAIOS","KAIOS")]),r.buildPlatform=r.runtimePlatformToString(),r.deviceModel=r.getDeviceModel(),r.deviceManufacturer=r.getDeviceManufacturer(),r.osVersion=r.getOSVersionString(),r.browserVersion=r.getBrowserVersionString(),r);function r(){}a.GADevice=o}(a.device||(a.device={}))}(d=d||{}),function(a){var o,d;function i(a){this.deadline=a,this.ignore=!1,this.async=!1,this.running=!1,this.id=++i.idCounter}o=a.threading||(a.threading={}),i.idCounter=0,d=i,o.TimedBlock=d}(d=d||{}),function(a){var o,d;function i(a){this.comparer=a,this._subQueues={},this._sortedKeys=[]}o=a.threading||(a.threading={}),i.prototype.enqueue=function(a,o){-1===this._sortedKeys.indexOf(a)&&this.addQueueOfPriority(a),this._subQueues[a].push(o)},i.prototype.addQueueOfPriority=function(a){var o=this;this._sortedKeys.push(a),this._sortedKeys.sort((function(a,d){return o.comparer.compare(a,d)})),this._subQueues[a]=[]},i.prototype.peek=function(){if(this.hasItems())return this._subQueues[this._sortedKeys[0]][0];throw new Error("The queue is empty")},i.prototype.hasItems=function(){return 0<this._sortedKeys.length},i.prototype.dequeue=function(){if(this.hasItems())return this.dequeueFromHighPriorityQueue();throw new Error("The queue is empty")},i.prototype.dequeueFromHighPriorityQueue=function(){var a=this._sortedKeys[0],o=this._subQueues[a].shift();return 0===this._subQueues[a].length&&(this._sortedKeys.shift(),delete this._subQueues[a]),o},d=i,o.PriorityQueue=d}(d=d||{}),function(a){!function(o){var d,c,m,p,A=a.logging.GALogger;(c=d=o.EGAStoreArgsOperator||(o.EGAStoreArgsOperator={}))[c.Equal=0]="Equal",c[c.LessOrEqual=1]="LessOrEqual",c[c.NotEqual=2]="NotEqual",(p=m=o.EGAStore||(o.EGAStore={}))[p.Events=0]="Events",p[p.Sessions=1]="Sessions",p[p.Progression=2]="Progression";var h=(v.isStorageAvailable=function(){return v.storageAvailable},v.isStoreTooLargeForEvents=function(){return v.instance.eventsStore.length+v.instance.sessionsStore.length>v.MaxNumberOfEntries},v.select=function(a,o,c,m){void 0===o&&(o=[]),void 0===c&&(c=!1),void 0===m&&(m=0);var p=v.getStore(a);if(!p)return null;for(var A=[],h=0;h<p.length;++h){for(var S=p[h],b=!0,T=0;T<o.length;++T){var G=o[T];if(S[G[0]])switch(G[1]){case d.Equal:b=S[G[0]]==G[2];break;case d.LessOrEqual:b=S[G[0]]<=G[2];break;case d.NotEqual:b=S[G[0]]!=G[2];break;default:b=!1}else b=!1;if(!b)break}b&&A.push(S)}return c&&A.sort((function(a,o){return a.client_ts-o.client_ts})),0<m&&A.length>m&&(A=A.slice(0,m+1)),A},v.update=function(a,o,c){void 0===c&&(c=[]);var m=v.getStore(a);if(!m)return!1;for(var p=0;p<m.length;++p){for(var A=m[p],h=!0,S=0;S<c.length;++S){var b=c[S];if(A[b[0]])switch(b[1]){case d.Equal:h=A[b[0]]==b[2];break;case d.LessOrEqual:h=A[b[0]]<=b[2];break;case d.NotEqual:h=A[b[0]]!=b[2];break;default:h=!1}else h=!1;if(!h)break}if(h)for(S=0;S<o.length;++S){var T=o[S];A[T[0]]=T[1]}}return!0},v.delete=function(a,o){var c=v.getStore(a);if(c)for(var m=0;m<c.length;++m){for(var p=c[m],A=!0,h=0;h<o.length;++h){var S=o[h];if(p[S[0]])switch(S[1]){case d.Equal:A=p[S[0]]==S[2];break;case d.LessOrEqual:A=p[S[0]]<=S[2];break;case d.NotEqual:A=p[S[0]]!=S[2];break;default:A=!1}else A=!1;if(!A)break}A&&(c.splice(m,1),--m)}},v.insert=function(a,o,d,c){void 0===d&&(d=!1),void 0===c&&(c=null);var m=v.getStore(a);if(m)if(d){if(!c)return;for(var p=!1,A=0;A<m.length;++A){var h=m[A];if(h[c]==o[c]){for(var S in o)h[S]=o[S];p=!0;break}}p||m.push(o)}else m.push(o)},v.save=function(a){v.isStorageAvailable()?(localStorage.setItem(v.StringFormat(v.KeyFormat,a,v.EventsStoreKey),JSON.stringify(v.instance.eventsStore)),localStorage.setItem(v.StringFormat(v.KeyFormat,a,v.SessionsStoreKey),JSON.stringify(v.instance.sessionsStore)),localStorage.setItem(v.StringFormat(v.KeyFormat,a,v.ProgressionStoreKey),JSON.stringify(v.instance.progressionStore)),localStorage.setItem(v.StringFormat(v.KeyFormat,a,v.ItemsStoreKey),JSON.stringify(v.instance.storeItems))):A.w("Storage is not available, cannot save.")},v.load=function(a){if(v.isStorageAvailable()){try{v.instance.eventsStore=JSON.parse(localStorage.getItem(v.StringFormat(v.KeyFormat,a,v.EventsStoreKey))),v.instance.eventsStore||(v.instance.eventsStore=[])}catch(a){A.w("Load failed for 'events' store. Using empty store."),v.instance.eventsStore=[]}try{v.instance.sessionsStore=JSON.parse(localStorage.getItem(v.StringFormat(v.KeyFormat,a,v.SessionsStoreKey))),v.instance.sessionsStore||(v.instance.sessionsStore=[])}catch(a){A.w("Load failed for 'sessions' store. Using empty store."),v.instance.sessionsStore=[]}try{v.instance.progressionStore=JSON.parse(localStorage.getItem(v.StringFormat(v.KeyFormat,a,v.ProgressionStoreKey))),v.instance.progressionStore||(v.instance.progressionStore=[])}catch(a){A.w("Load failed for 'progression' store. Using empty store."),v.instance.progressionStore=[]}try{v.instance.storeItems=JSON.parse(localStorage.getItem(v.StringFormat(v.KeyFormat,a,v.ItemsStoreKey))),v.instance.storeItems||(v.instance.storeItems={})}catch(a){A.w("Load failed for 'items' store. Using empty store."),v.instance.progressionStore=[]}}else A.w("Storage is not available, cannot load.")},v.setItem=function(a,o,d){var c=v.StringFormat(v.KeyFormat,a,o);d?v.instance.storeItems[c]=d:c in v.instance.storeItems&&delete v.instance.storeItems[c]},v.getItem=function(a,o){var d=v.StringFormat(v.KeyFormat,a,o);return d in v.instance.storeItems?v.instance.storeItems[d]:null},v.getStore=function(a){switch(a){case m.Events:return v.instance.eventsStore;case m.Sessions:return v.instance.sessionsStore;case m.Progression:return v.instance.progressionStore;default:return A.w("GAStore.getStore(): Cannot find store: "+a),null}},v.instance=new v,v.MaxNumberOfEntries=2e3,v.StringFormat=function(a){for(var o=[],d=1;d<arguments.length;d++)o[d-1]=arguments[d];return a.replace(/{(\d+)}/g,(function(a,d){return o[d]||""}))},v.KeyFormat="GA::{0}::{1}",v.EventsStoreKey="ga_event",v.SessionsStoreKey="ga_session",v.ProgressionStoreKey="ga_progression",v.ItemsStoreKey="ga_items",v);function v(){this.eventsStore=[],this.sessionsStore=[],this.progressionStore=[],this.storeItems={};try{"object"==typeof localStorage?(localStorage.setItem("testingLocalStorage","yes"),localStorage.removeItem("testingLocalStorage"),v.storageAvailable=!0):v.storageAvailable=!1}catch(a){}}o.GAStore=h}(a.store||(a.store={}))}(d=d||{}),function(a){var o,d,c,m,p,A,h,S,b;function g(){this.availableCustomDimensions01=[],this.availableCustomDimensions02=[],this.availableCustomDimensions03=[],this.currentGlobalCustomEventFields={},this.availableResourceCurrencies=[],this.availableResourceItemTypes=[],this.configurations={},this.remoteConfigsListeners=[],this.beforeUnloadListeners=[],this.sdkConfigDefault={},this.sdkConfig={},this.progressionTries={},this._isEventSubmissionEnabled=!0,this.isUnloading=!1}o=a.state||(a.state={}),d=a.validators.GAValidator,c=a.utilities.GAUtilities,m=a.logging.GALogger,p=a.store.GAStore,A=a.device.GADevice,h=a.store.EGAStore,S=a.store.EGAStoreArgsOperator,g.setUserId=function(a){g.instance.userId=a,g.cacheIdentifier()},g.getIdentifier=function(){return g.instance.identifier},g.isInitialized=function(){return g.instance.initialized},g.setInitialized=function(a){g.instance.initialized=a},g.getSessionStart=function(){return g.instance.sessionStart},g.getSessionNum=function(){return g.instance.sessionNum},g.getTransactionNum=function(){return g.instance.transactionNum},g.getSessionId=function(){return g.instance.sessionId},g.getCurrentCustomDimension01=function(){return g.instance.currentCustomDimension01},g.getCurrentCustomDimension02=function(){return g.instance.currentCustomDimension02},g.getCurrentCustomDimension03=function(){return g.instance.currentCustomDimension03},g.getGameKey=function(){return g.instance.gameKey},g.getGameSecret=function(){return g.instance.gameSecret},g.getAvailableCustomDimensions01=function(){return g.instance.availableCustomDimensions01},g.setAvailableCustomDimensions01=function(a){d.validateCustomDimensions(a)&&(g.instance.availableCustomDimensions01=a,g.validateAndFixCurrentDimensions(),m.i("Set available custom01 dimension values: ("+c.joinStringArray(a,", ")+")"))},g.getAvailableCustomDimensions02=function(){return g.instance.availableCustomDimensions02},g.setAvailableCustomDimensions02=function(a){d.validateCustomDimensions(a)&&(g.instance.availableCustomDimensions02=a,g.validateAndFixCurrentDimensions(),m.i("Set available custom02 dimension values: ("+c.joinStringArray(a,", ")+")"))},g.getAvailableCustomDimensions03=function(){return g.instance.availableCustomDimensions03},g.setAvailableCustomDimensions03=function(a){d.validateCustomDimensions(a)&&(g.instance.availableCustomDimensions03=a,g.validateAndFixCurrentDimensions(),m.i("Set available custom03 dimension values: ("+c.joinStringArray(a,", ")+")"))},g.getAvailableResourceCurrencies=function(){return g.instance.availableResourceCurrencies},g.setAvailableResourceCurrencies=function(a){d.validateResourceCurrencies(a)&&(g.instance.availableResourceCurrencies=a,m.i("Set available resource currencies: ("+c.joinStringArray(a,", ")+")"))},g.getAvailableResourceItemTypes=function(){return g.instance.availableResourceItemTypes},g.setAvailableResourceItemTypes=function(a){d.validateResourceItemTypes(a)&&(g.instance.availableResourceItemTypes=a,m.i("Set available resource item types: ("+c.joinStringArray(a,", ")+")"))},g.getBuild=function(){return g.instance.build},g.setBuild=function(a){g.instance.build=a,m.i("Set build version: "+a)},g.getUseManualSessionHandling=function(){return g.instance.useManualSessionHandling},g.isEventSubmissionEnabled=function(){return g.instance._isEventSubmissionEnabled},g.getABTestingId=function(){return g.instance.abId},g.getABTestingVariantId=function(){return g.instance.abVariantId},g.prototype.setDefaultId=function(a){this.defaultUserId=a||"",g.cacheIdentifier()},g.getDefaultId=function(){return g.instance.defaultUserId},g.getSdkConfig=function(){var a,o=0;for(var d in g.instance.sdkConfig)0===o&&(a=d),++o;if(a&&0<o)return g.instance.sdkConfig;for(var d in o=0,g.instance.sdkConfigCached)0===o&&(a=d),++o;return a&&0<o?g.instance.sdkConfigCached:g.instance.sdkConfigDefault},g.isEnabled=function(){return!!g.instance.initAuthorized},g.setCustomDimension01=function(a){g.instance.currentCustomDimension01=a,p.setItem(g.getGameKey(),g.Dimension01Key,a),m.i("Set custom01 dimension value: "+a)},g.setCustomDimension02=function(a){g.instance.currentCustomDimension02=a,p.setItem(g.getGameKey(),g.Dimension02Key,a),m.i("Set custom02 dimension value: "+a)},g.setCustomDimension03=function(a){g.instance.currentCustomDimension03=a,p.setItem(g.getGameKey(),g.Dimension03Key,a),m.i("Set custom03 dimension value: "+a)},g.incrementSessionNum=function(){var a=g.getSessionNum()+1;g.instance.sessionNum=a},g.incrementTransactionNum=function(){var a=g.getTransactionNum()+1;g.instance.transactionNum=a},g.incrementProgressionTries=function(a){var o=g.getProgressionTries(a)+1;g.instance.progressionTries[a]=o;var d={};d.progression=a,d.tries=o,p.insert(h.Progression,d,!0,"progression")},g.getProgressionTries=function(a){return a in g.instance.progressionTries?g.instance.progressionTries[a]:0},g.clearProgressionTries=function(a){a in g.instance.progressionTries&&delete g.instance.progressionTries[a];var o=[];o.push(["progression",S.Equal,a]),p.delete(h.Progression,o)},g.setKeys=function(a,o){g.instance.gameKey=a,g.instance.gameSecret=o},g.setManualSessionHandling=function(a){g.instance.useManualSessionHandling=a,m.i("Use manual session handling: "+a)},g.setEnabledEventSubmission=function(a){g.instance._isEventSubmissionEnabled=a},g.getEventAnnotations=function(){var a={v:2};a.event_uuid=c.createGuid(),a.user_id=g.instance.identifier,a.client_ts=g.getClientTsAdjusted(),a.sdk_version=A.getRelevantSdkVersion(),a.os_version=A.osVersion,a.manufacturer=A.deviceManufacturer,a.device=A.deviceModel,a.browser_version=A.browserVersion,a.platform=A.buildPlatform,a.session_id=g.instance.sessionId,a[g.SessionNumKey]=g.instance.sessionNum;var o=A.getConnectionType();if(d.validateConnectionType(o)&&(a.connection_type=o),A.gameEngineVersion&&(a.engine_version=A.gameEngineVersion),g.instance.configurations){var m=0;for(var p in g.instance.configurations){m++;break}0<m&&(a.configurations=g.instance.configurations)}return g.instance.abId&&(a.ab_id=g.instance.abId),g.instance.abVariantId&&(a.ab_variant_id=g.instance.abVariantId),g.instance.build&&(a.build=g.instance.build),a},g.getSdkErrorEventAnnotations=function(){var a={v:2};a.event_uuid=c.createGuid(),a.category=g.CategorySdkError,a.sdk_version=A.getRelevantSdkVersion(),a.os_version=A.osVersion,a.manufacturer=A.deviceManufacturer,a.device=A.deviceModel,a.platform=A.buildPlatform;var o=A.getConnectionType();return d.validateConnectionType(o)&&(a.connection_type=o),A.gameEngineVersion&&(a.engine_version=A.gameEngineVersion),a},g.getInitAnnotations=function(){var a={};return g.getIdentifier()||g.cacheIdentifier(),p.setItem(g.getGameKey(),g.LastUsedIdentifierKey,g.getIdentifier()),a.user_id=g.getIdentifier(),a.sdk_version=A.getRelevantSdkVersion(),a.os_version=A.osVersion,a.platform=A.buildPlatform,g.getBuild()?a.build=g.getBuild():a.build=null,a.session_num=g.getSessionNum(),a.random_salt=g.getSessionNum(),a},g.getClientTsAdjusted=function(){var a=c.timeIntervalSince1970(),o=a+g.instance.clientServerTimeOffset;return d.validateClientTs(o)?o:a},g.sessionIsStarted=function(){return 0!=g.instance.sessionStart},g.cacheIdentifier=function(){g.instance.userId?g.instance.identifier=g.instance.userId:g.instance.defaultUserId&&(g.instance.identifier=g.instance.defaultUserId)},g.ensurePersistedStates=function(){p.isStorageAvailable()&&p.load(g.getGameKey());var a=g.instance;a.setDefaultId(null!=p.getItem(g.getGameKey(),g.DefaultUserIdKey)?p.getItem(g.getGameKey(),g.DefaultUserIdKey):c.createGuid()),a.sessionNum=null!=p.getItem(g.getGameKey(),g.SessionNumKey)?Number(p.getItem(g.getGameKey(),g.SessionNumKey)):0,a.transactionNum=null!=p.getItem(g.getGameKey(),g.TransactionNumKey)?Number(p.getItem(g.getGameKey(),g.TransactionNumKey)):0,a.currentCustomDimension01?p.setItem(g.getGameKey(),g.Dimension01Key,a.currentCustomDimension01):(a.currentCustomDimension01=null!=p.getItem(g.getGameKey(),g.Dimension01Key)?p.getItem(g.getGameKey(),g.Dimension01Key):"",a.currentCustomDimension01),a.currentCustomDimension02?p.setItem(g.getGameKey(),g.Dimension02Key,a.currentCustomDimension02):(a.currentCustomDimension02=null!=p.getItem(g.getGameKey(),g.Dimension02Key)?p.getItem(g.getGameKey(),g.Dimension02Key):"",a.currentCustomDimension02),a.currentCustomDimension03?p.setItem(g.getGameKey(),g.Dimension03Key,a.currentCustomDimension03):(a.currentCustomDimension03=null!=p.getItem(g.getGameKey(),g.Dimension03Key)?p.getItem(g.getGameKey(),g.Dimension03Key):"",a.currentCustomDimension03);var o=null!=p.getItem(g.getGameKey(),g.SdkConfigCachedKey)?p.getItem(g.getGameKey(),g.SdkConfigCachedKey):"";if(o){var d=JSON.parse(c.decode64(o));if(d){var A=p.getItem(g.getGameKey(),g.LastUsedIdentifierKey);null!=A&&A!=g.getIdentifier()&&(m.w("New identifier spotted compared to last one used, clearing cached configs hash!!"),d.configs_hash&&delete d.configs_hash),a.sdkConfigCached=d}}var S=g.getSdkConfig();a.configsHash=S.configs_hash?S.configs_hash:"",a.abId=S.ab_id?S.ab_id:"",a.abVariantId=S.ab_variant_id?S.ab_variant_id:"";var b=p.select(h.Progression);if(b)for(var T=0;T<b.length;++T){var G=b[T];G&&(a.progressionTries[G.progression]=G.tries)}},g.calculateServerTimeOffset=function(a){return a-c.timeIntervalSince1970()},g.formatString=function(a,o){for(var d=a,c=0;c<o.length;c++){var m=new RegExp("\\{"+c+"\\}","gi");d=d.replace(m,arguments[c])}return d},g.validateAndCleanCustomFields=function(a,o){void 0===o&&(o=null);var d={};if(a){var p=0;for(var A in a){var h=a[A];if(A&&h)if(p<g.MAX_CUSTOM_FIELDS_COUNT){var S=new RegExp("^[a-zA-Z0-9_]{1,"+g.MAX_CUSTOM_FIELDS_KEY_LENGTH+"}$");if(c.stringMatch(A,S)){var b=typeof h;if("string"==b||h instanceof String)h.length<=g.MAX_CUSTOM_FIELDS_VALUE_STRING_LENGTH&&0<h.length?(d[A]=h,++p):(I=g.formatString(G="validateAndCleanCustomFields: entry with key={0}, value={1} has been omitted because its value is an empty string or exceeds the max number of characters ("+g.MAX_CUSTOM_FIELDS_VALUE_STRING_LENGTH+")",[A,h]),m.w(I),o&&o(G,I));else if("number"==b||h instanceof Number){var T=h;d[A]=T,++p}else I=g.formatString(G="validateAndCleanCustomFields: entry with key={0}, value={1} has been omitted because its value is not a string or number",[A,h]),m.w(I),o&&o(G,I)}else I=g.formatString(G="validateAndCleanCustomFields: entry with key={0}, value={1} has been omitted because its key contains illegal character, is empty or exceeds the max number of characters ("+g.MAX_CUSTOM_FIELDS_KEY_LENGTH+")",[A,h]),m.w(I),o&&o(G,I)}else I=g.formatString(G="validateAndCleanCustomFields: entry with key={0}, value={1} has been omitted because it exceeds the max number of custom fields ("+g.MAX_CUSTOM_FIELDS_COUNT+")",[A,h]),m.w(I),o&&o(G,I);else{var G,I=g.formatString(G="validateAndCleanCustomFields: entry with key={0}, value={1} has been omitted because its key or value is null",[A,h]);m.w(I),o&&o(G,I)}}}return d},g.validateAndFixCurrentDimensions=function(){d.validateDimension01(g.getCurrentCustomDimension01(),g.getAvailableCustomDimensions01())||g.setCustomDimension01(""),d.validateDimension02(g.getCurrentCustomDimension02(),g.getAvailableCustomDimensions02())||g.setCustomDimension02(""),d.validateDimension03(g.getCurrentCustomDimension03(),g.getAvailableCustomDimensions03())||g.setCustomDimension03("")},g.getConfigurationStringValue=function(a,o){return g.instance.configurations[a]?g.instance.configurations[a].toString():o},g.isRemoteConfigsReady=function(){return g.instance.remoteConfigsIsReady},g.addRemoteConfigsListener=function(a){g.instance.remoteConfigsListeners.indexOf(a)<0&&g.instance.remoteConfigsListeners.push(a)},g.removeRemoteConfigsListener=function(a){var o=g.instance.remoteConfigsListeners.indexOf(a);-1<o&&g.instance.remoteConfigsListeners.splice(o,1)},g.getRemoteConfigsContentAsString=function(){return JSON.stringify(g.instance.configurations)},g.populateConfigurations=function(a){var o=a.configs;if(o){g.instance.configurations={};for(var d=0;d<o.length;++d){var c=o[d];if(c){var m=c.key,p=c.value,A=c.start_ts?c.start_ts:Number.MIN_VALUE,h=c.end_ts?c.end_ts:Number.MAX_VALUE,S=g.getClientTsAdjusted();m&&p&&A<S&&S<h&&(g.instance.configurations[m]=p)}}}g.instance.remoteConfigsIsReady=!0;var b=g.instance.remoteConfigsListeners;for(d=0;d<b.length;++d)b[d]&&b[d].onRemoteConfigsUpdated()},g.addOnBeforeUnloadListener=function(a){g.instance.beforeUnloadListeners.indexOf(a)<0&&g.instance.beforeUnloadListeners.push(a)},g.removeOnBeforeUnloadListener=function(a){var o=g.instance.beforeUnloadListeners.indexOf(a);-1<o&&g.instance.beforeUnloadListeners.splice(o,1)},g.notifyBeforeUnloadListeners=function(){for(var a=g.instance.beforeUnloadListeners,o=0;o<a.length;++o)a[o]&&a[o].onBeforeUnload()},g.CategorySdkError="sdk_error",g.MAX_CUSTOM_FIELDS_COUNT=50,g.MAX_CUSTOM_FIELDS_KEY_LENGTH=64,g.MAX_CUSTOM_FIELDS_VALUE_STRING_LENGTH=256,g.instance=new g,g.DefaultUserIdKey="default_user_id",g.SessionNumKey="session_num",g.TransactionNumKey="transaction_num",g.Dimension01Key="dimension01",g.Dimension02Key="dimension02",g.Dimension03Key="dimension03",g.SdkConfigCachedKey="sdk_config_cached",g.LastUsedIdentifierKey="last_used_identifier",b=g,o.GAState=b}(d=d||{}),function(a){var o,d,c,m;function l(){}o=a.tasks||(a.tasks={}),d=a.utilities.GAUtilities,c=a.logging.GALogger,l.execute=function(a,o,m,p){var A=new Date;if(l.timestampMap[o]||(l.timestampMap[o]=A),l.countMap[o]||(l.countMap[o]=0),3600<=(A.getTime()-l.timestampMap[o].getTime())/1e3&&(l.timestampMap[o]=A,l.countMap[o]=0),!(l.countMap[o]>=l.MaxCount)){var h=d.getHmac(p,m),S=new XMLHttpRequest;S.onreadystatechange=function(){if(4===S.readyState){if(!S.responseText)return;if(200!=S.status)return void c.w("sdk error failed. response code not 200. status code: "+S.status+", description: "+S.statusText+", body: "+S.responseText);l.countMap[o]=l.countMap[o]+1}},S.open("POST",a,!0),S.setRequestHeader("Content-Type","application/json"),S.setRequestHeader("Authorization",h);try{S.send(m)}catch(a){console.error(a)}}},l.MaxCount=10,l.countMap={},l.timestampMap={},m=l,o.SdkErrorTask=m}(d=d||{}),function(a){var o,d,c,m,p,A,h,S,b,T,G;function y(){this.protocol="https",this.hostName="api.gameanalytics.com",this.version="v2",this.remoteConfigsVersion="v1",this.baseUrl=this.protocol+"://"+this.hostName+"/"+this.version,this.remoteConfigsBaseUrl=this.protocol+"://"+this.hostName+"/remote_configs/"+this.remoteConfigsVersion,this.initializeUrlPath="init",this.eventsUrlPath="events",this.useGzip=!1}o=a.http||(a.http={}),d=a.state.GAState,c=a.logging.GALogger,m=a.utilities.GAUtilities,p=a.validators.GAValidator,A=a.tasks.SdkErrorTask,h=a.events.EGASdkErrorCategory,S=a.events.EGASdkErrorArea,b=a.events.EGASdkErrorAction,T=a.events.EGASdkErrorParameter,y.prototype.requestInit=function(a,c){var m=d.getGameKey(),p=this.remoteConfigsBaseUrl+"/"+this.initializeUrlPath+"?game_key="+m+"&interval_seconds=0&configs_hash="+a,A=d.getInitAnnotations(),h=JSON.stringify(A);if(h){var S=this.createPayloadData(h,this.useGzip),b=[];b.push(h),y.sendRequest(p,S,b,this.useGzip,y.initRequestCallback,c)}else c(o.EGAHTTPApiResponse.JsonEncodeFailed,null)},y.prototype.sendEventsInArray=function(a,c,m){if(0!=a.length){var p=d.getGameKey(),A=this.baseUrl+"/"+p+"/"+this.eventsUrlPath,h=JSON.stringify(a);if(h){var S=this.createPayloadData(h,this.useGzip),b=[];b.push(h),b.push(c),b.push(a.length.toString()),y.sendRequest(A,S,b,this.useGzip,y.sendEventInArrayRequestCallback,m)}else m(o.EGAHTTPApiResponse.JsonEncodeFailed,null,c,a.length)}},y.prototype.sendSdkErrorEvent=function(a,o,m,h,S,b,T){if(d.isEventSubmissionEnabled()&&p.validateSdkErrorEvent(b,T,a,o,m)){var G,I=this.baseUrl+"/"+b+"/"+this.eventsUrlPath,k="",_=d.getSdkErrorEventAnnotations(),w=y.sdkErrorCategoryString(a);k+=_.error_category=w;var R=y.sdkErrorAreaString(o);k+=":"+(_.error_area=R);var P=y.sdkErrorActionString(m);_.error_action=P;var D=y.sdkErrorParameterString(h);if(0<D.length&&(_.error_parameter=D),0<S.length){var O=S;S.length>y.MAX_ERROR_MESSAGE_LENGTH&&(O=S.substring(0,y.MAX_ERROR_MESSAGE_LENGTH)),_.reason=O}var U=[];U.push(_),(G=JSON.stringify(U))?A.execute(I,k,G,T):c.w("sendSdkErrorEvent: JSON encoding failed.")}},y.sendEventInArrayRequestCallback=function(a,c,m,p){void 0===p&&(p=null),p[0],p[1];var A,G,I=p[2],k=parseInt(p[3]);A=a.responseText,G=a.status;var _=y.instance.processRequestResponse(G,a.statusText,A,"Events");if(_==o.EGAHTTPApiResponse.Ok||_==o.EGAHTTPApiResponse.Created||_==o.EGAHTTPApiResponse.BadRequest){var w=A?JSON.parse(A):{};if(null==w)return m(o.EGAHTTPApiResponse.JsonDecodeFailed,null,I,k),void y.instance.sendSdkErrorEvent(h.Http,S.EventsHttp,b.FailHttpJsonDecode,T.Undefined,A,d.getGameKey(),d.getGameSecret());o.EGAHTTPApiResponse.BadRequest,m(_,w,I,k)}else m(_,null,I,k)},y.sendRequest=function(a,o,c,p,A,h){var S=new XMLHttpRequest,b=d.getGameSecret(),T=m.getHmac(b,o),G=[];for(var I in G.push(T),c)G.push(c[I]);if(S.onreadystatechange=function(){4===S.readyState&&A(S,a,h,G)},S.open("POST",a,!0),S.setRequestHeader("Content-Type","application/json"),S.setRequestHeader("Authorization",T),p)throw new Error("gzip not supported");try{S.send(o)}catch(a){console.error(a.stack)}},y.initRequestCallback=function(a,c,m,A){var G,I;void 0===A&&(A=null),A[0],A[1],G=a.responseText,I=a.status;var k=G?JSON.parse(G):{},_=y.instance.processRequestResponse(I,a.statusText,G,"Init");if(_==o.EGAHTTPApiResponse.Ok||_==o.EGAHTTPApiResponse.Created||_==o.EGAHTTPApiResponse.BadRequest){if(null==k)return m(o.EGAHTTPApiResponse.JsonDecodeFailed,null,"",0),void y.instance.sendSdkErrorEvent(h.Http,S.InitHttp,b.FailHttpJsonDecode,T.Undefined,G,d.getGameKey(),d.getGameSecret());if(_!==o.EGAHTTPApiResponse.BadRequest){var w=p.validateAndCleanInitRequestResponse(k,_===o.EGAHTTPApiResponse.Created);w?m(_,w,"",0):m(o.EGAHTTPApiResponse.BadResponse,null,"",0)}else m(_,null,"",0)}else m(_,null,"",0)},y.prototype.createPayloadData=function(a,o){if(o)throw new Error("gzip not supported");return a},y.prototype.processRequestResponse=function(a,d,c,m){return c?200===a?o.EGAHTTPApiResponse.Ok:201===a?o.EGAHTTPApiResponse.Created:0===a||401===a?o.EGAHTTPApiResponse.Unauthorized:400===a?o.EGAHTTPApiResponse.BadRequest:500===a?o.EGAHTTPApiResponse.InternalServerError:o.EGAHTTPApiResponse.UnknownResponseCode:o.EGAHTTPApiResponse.NoResponse},y.sdkErrorCategoryString=function(a){switch(a){case h.EventValidation:return"event_validation";case h.Database:return"db";case h.Init:return"init";case h.Http:return"http";case h.Json:return"json"}return""},y.sdkErrorAreaString=function(a){switch(a){case S.BusinessEvent:return"business";case S.ResourceEvent:return"resource";case S.ProgressionEvent:return"progression";case S.DesignEvent:return"design";case S.ErrorEvent:return"error";case S.InitHttp:return"init_http";case S.EventsHttp:return"events_http";case S.ProcessEvents:return"process_events";case S.AddEventsToStore:return"add_events_to_store"}return""},y.sdkErrorActionString=function(a){switch(a){case b.InvalidCurrency:return"invalid_currency";case b.InvalidShortString:return"invalid_short_string";case b.InvalidEventPartLength:return"invalid_event_part_length";case b.InvalidEventPartCharacters:return"invalid_event_part_characters";case b.InvalidStore:return"invalid_store";case b.InvalidFlowType:return"invalid_flow_type";case b.StringEmptyOrNull:return"string_empty_or_null";case b.NotFoundInAvailableCurrencies:return"not_found_in_available_currencies";case b.InvalidAmount:return"invalid_amount";case b.NotFoundInAvailableItemTypes:return"not_found_in_available_item_types";case b.WrongProgressionOrder:return"wrong_progression_order";case b.InvalidEventIdLength:return"invalid_event_id_length";case b.InvalidEventIdCharacters:return"invalid_event_id_characters";case b.InvalidProgressionStatus:return"invalid_progression_status";case b.InvalidSeverity:return"invalid_severity";case b.InvalidLongString:return"invalid_long_string";case b.DatabaseTooLarge:return"db_too_large";case b.DatabaseOpenOrCreate:return"db_open_or_create";case b.JsonError:return"json_error";case b.FailHttpJsonDecode:return"fail_http_json_decode";case b.FailHttpJsonEncode:return"fail_http_json_encode"}return""},y.sdkErrorParameterString=function(a){switch(a){case T.Currency:return"currency";case T.CartType:return"cart_type";case T.ItemType:return"item_type";case T.ItemId:return"item_id";case T.Store:return"store";case T.FlowType:return"flow_type";case T.Amount:return"amount";case T.Progression01:return"progression01";case T.Progression02:return"progression02";case T.Progression03:return"progression03";case T.EventId:return"event_id";case T.ProgressionStatus:return"progression_status";case T.Severity:return"severity";case T.Message:return"message"}return""},y.instance=new y,y.MAX_ERROR_MESSAGE_LENGTH=256,G=y,o.GAHTTPApi=G}(d=d||{}),function(a){var o,d,c,m,p,A,h,S,b,T,G;function C(){}o=a.events||(a.events={}),d=a.store.GAStore,c=a.store.EGAStore,m=a.store.EGAStoreArgsOperator,p=a.state.GAState,A=a.logging.GALogger,h=a.utilities.GAUtilities,S=a.http.EGAHTTPApiResponse,b=a.http.GAHTTPApi,T=a.validators.GAValidator,C.customEventFieldsErrorCallback=function(o,d){if(p.isEventSubmissionEnabled()){var c=new Date;C.timestampMap[o]||(C.timestampMap[o]=c),C.countMap[o]||(C.countMap[o]=0),3600<=(c.getTime()-C.timestampMap[o].getTime())/1e3&&(C.timestampMap[o]=c,C.countMap[o]=0),C.countMap[o]>=C.MAX_ERROR_COUNT||a.threading.GAThreading.performTaskOnGAThread((function(){C.addErrorEvent(a.EGAErrorSeverity.Warning,d,null,!0),C.countMap[o]=C.countMap[o]+1}))}},C.addSessionStartEvent=function(){if(p.isEventSubmissionEnabled()){var a={};a.category=C.CategorySessionStart,p.incrementSessionNum(),d.setItem(p.getGameKey(),p.SessionNumKey,p.getSessionNum().toString()),C.addDimensionsToEvent(a);var o=p.instance.currentGlobalCustomEventFields;C.addCustomFieldsToEvent(a,p.validateAndCleanCustomFields(o,C.customEventFieldsErrorCallback)),C.addEventToStore(a),A.i("Add SESSION START event"),C.processEvents(C.CategorySessionStart,!1)}},C.addSessionEndEvent=function(){if(p.isEventSubmissionEnabled()){var a=p.getSessionStart(),o=p.getClientTsAdjusted()-a;o<0&&(A.w("Session length was calculated to be less then 0. Should not be possible. Resetting to 0."),o=0);var d={};d.category=C.CategorySessionEnd,d.length=o,C.addDimensionsToEvent(d);var c=p.instance.currentGlobalCustomEventFields;C.addCustomFieldsToEvent(d,p.validateAndCleanCustomFields(c,C.customEventFieldsErrorCallback)),C.addEventToStore(d),A.i("Add SESSION END event."),C.processEvents("",!1)}},C.addBusinessEvent=function(a,o,c,m,h,S,G){if(void 0===h&&(h=null),p.isEventSubmissionEnabled()){var I=T.validateBusinessEvent(a,o,h,c,m);if(null==I){var k={};p.incrementTransactionNum(),d.setItem(p.getGameKey(),p.TransactionNumKey,p.getTransactionNum().toString()),k.event_id=c+":"+m,k.category=C.CategoryBusiness,k.currency=a,k.amount=o,k[p.TransactionNumKey]=p.getTransactionNum(),h&&(k.cart_type=h),C.addDimensionsToEvent(k);var _={};if(S&&0<Object.keys(S).length)for(var w in S)_[w]=S[w];else for(var w in p.instance.currentGlobalCustomEventFields)_[w]=p.instance.currentGlobalCustomEventFields[w];if(G&&S&&0<Object.keys(S).length)for(var w in p.instance.currentGlobalCustomEventFields)_[w]||(_[w]=p.instance.currentGlobalCustomEventFields[w]);C.addCustomFieldsToEvent(k,p.validateAndCleanCustomFields(_,C.customEventFieldsErrorCallback)),A.i("Add BUSINESS event: {currency:"+a+", amount:"+o+", itemType:"+c+", itemId:"+m+", cartType:"+h+"}"),C.addEventToStore(k)}else b.instance.sendSdkErrorEvent(I.category,I.area,I.action,I.parameter,I.reason,p.getGameKey(),p.getGameSecret())}},C.addResourceEvent=function(o,d,c,m,h,S,G){if(p.isEventSubmissionEnabled()){var I=T.validateResourceEvent(o,d,c,m,h,p.getAvailableResourceCurrencies(),p.getAvailableResourceItemTypes());if(null==I){o===a.EGAResourceFlowType.Sink&&(c*=-1);var k={},_=C.resourceFlowTypeToString(o);k.event_id=_+":"+d+":"+m+":"+h,k.category=C.CategoryResource,k.amount=c,C.addDimensionsToEvent(k);var w={};if(S&&0<Object.keys(S).length)for(var R in S)w[R]=S[R];else for(var R in p.instance.currentGlobalCustomEventFields)w[R]=p.instance.currentGlobalCustomEventFields[R];if(G&&S&&0<Object.keys(S).length)for(var R in p.instance.currentGlobalCustomEventFields)w[R]||(w[R]=p.instance.currentGlobalCustomEventFields[R]);C.addCustomFieldsToEvent(k,p.validateAndCleanCustomFields(w,C.customEventFieldsErrorCallback)),A.i("Add RESOURCE event: {currency:"+d+", amount:"+c+", itemType:"+m+", itemId:"+h+"}"),C.addEventToStore(k)}else b.instance.sendSdkErrorEvent(I.category,I.area,I.action,I.parameter,I.reason,p.getGameKey(),p.getGameSecret())}},C.addProgressionEvent=function(o,d,c,m,h,S,G,I){if(p.isEventSubmissionEnabled()){var k=C.progressionStatusToString(o),_=T.validateProgressionEvent(o,d,c,m);if(null==_){var w,R={};w=c?m?d+":"+c+":"+m:d+":"+c:d,R.category=C.CategoryProgression,R.event_id=k+":"+w;var P=0;S&&o!=a.EGAProgressionStatus.Start&&(R.score=Math.round(h)),o===a.EGAProgressionStatus.Fail&&p.incrementProgressionTries(w),o===a.EGAProgressionStatus.Complete&&(p.incrementProgressionTries(w),P=p.getProgressionTries(w),R.attempt_num=P,p.clearProgressionTries(w)),C.addDimensionsToEvent(R);var D={};if(G&&0<Object.keys(G).length)for(var O in G)D[O]=G[O];else for(var O in p.instance.currentGlobalCustomEventFields)D[O]=p.instance.currentGlobalCustomEventFields[O];if(I&&G&&0<Object.keys(G).length)for(var O in p.instance.currentGlobalCustomEventFields)D[O]||(D[O]=p.instance.currentGlobalCustomEventFields[O]);C.addCustomFieldsToEvent(R,p.validateAndCleanCustomFields(D,C.customEventFieldsErrorCallback)),A.i("Add PROGRESSION event: {status:"+k+", progression01:"+d+", progression02:"+c+", progression03:"+m+", score:"+h+", attempt:"+P+"}"),C.addEventToStore(R)}else b.instance.sendSdkErrorEvent(_.category,_.area,_.action,_.parameter,_.reason,p.getGameKey(),p.getGameSecret())}},C.addDesignEvent=function(a,o,d,c,m){if(p.isEventSubmissionEnabled()){var h=T.validateDesignEvent(a);if(null==h){var S={};S.category=C.CategoryDesign,S.event_id=a,d&&(S.value=o),C.addDimensionsToEvent(S);var G={};if(c&&0<Object.keys(c).length)for(var I in c)G[I]=c[I];else for(var I in p.instance.currentGlobalCustomEventFields)G[I]=p.instance.currentGlobalCustomEventFields[I];if(m&&c&&0<Object.keys(c).length)for(var I in p.instance.currentGlobalCustomEventFields)G[I]||(G[I]=p.instance.currentGlobalCustomEventFields[I]);C.addCustomFieldsToEvent(S,p.validateAndCleanCustomFields(G,C.customEventFieldsErrorCallback)),A.i("Add DESIGN event: {eventId:"+a+", value:"+o+"}"),C.addEventToStore(S)}else b.instance.sendSdkErrorEvent(h.category,h.area,h.action,h.parameter,h.reason,p.getGameKey(),p.getGameSecret())}},C.addErrorEvent=function(a,o,d,c,m){if(void 0===m&&(m=!1),p.isEventSubmissionEnabled()){var h=C.errorSeverityToString(a),S=T.validateErrorEvent(a,o);if(null==S){var G={};if(G.category=C.CategoryError,G.severity=h,G.message=o,C.addDimensionsToEvent(G),!m){var I={};if(d&&0<Object.keys(d).length)for(var k in d)I[k]=d[k];else for(var k in p.instance.currentGlobalCustomEventFields)I[k]=p.instance.currentGlobalCustomEventFields[k];if(c&&d&&0<Object.keys(d).length)for(var k in p.instance.currentGlobalCustomEventFields)I[k]||(I[k]=p.instance.currentGlobalCustomEventFields[k]);C.addCustomFieldsToEvent(G,p.validateAndCleanCustomFields(I,C.customEventFieldsErrorCallback))}A.i("Add ERROR event: {severity:"+h+", message:"+o+"}"),C.addEventToStore(G)}else b.instance.sendSdkErrorEvent(S.category,S.area,S.action,S.parameter,S.reason,p.getGameKey(),p.getGameSecret())}},C.addAdEvent=function(o,d,c,m,h,S,G,I,k){if(p.isEventSubmissionEnabled()){var _=C.adActionToString(o),w=C.adTypeToString(d),R=C.adErrorToString(h),P=T.validateAdEvent(o,d,c,m);if(null==P){var D={};D.category=C.CategoryAds,D.ad_sdk_name=c,D.ad_placement=m,D.ad_type=w,D.ad_action=_,o==a.EGAAdAction.FailedShow&&0<R.length&&(D.ad_fail_show_reason=R),!G||d!=a.EGAAdType.RewardedVideo&&d!=a.EGAAdType.Video||(D.ad_duration=S),C.addDimensionsToEvent(D);var O={};if(I&&0<Object.keys(I).length)for(var U in I)O[U]=I[U];else for(var U in p.instance.currentGlobalCustomEventFields)O[U]=p.instance.currentGlobalCustomEventFields[U];if(k&&I&&0<Object.keys(I).length)for(var U in p.instance.currentGlobalCustomEventFields)O[U]||(O[U]=p.instance.currentGlobalCustomEventFields[U]);C.addCustomFieldsToEvent(D,p.validateAndCleanCustomFields(O,C.customEventFieldsErrorCallback)),A.i("Add AD event: {ad_sdk_name:"+c+", ad_placement:"+m+", ad_type:"+w+", ad_action:"+_+(o==a.EGAAdAction.FailedShow&&0<R.length?", ad_fail_show_reason:"+R:"")+(!G||d!=a.EGAAdType.RewardedVideo&&d!=a.EGAAdType.Video?"":", ad_duration:"+S)+"}"),C.addEventToStore(D)}else b.instance.sendSdkErrorEvent(P.category,P.area,P.action,P.parameter,P.reason,p.getGameKey(),p.getGameSecret())}},C.processEvents=function(a,S){if(p.isEventSubmissionEnabled())try{var G=h.createGuid();S&&(C.cleanupEvents(),C.fixMissingSessionEndEvents());var I=[];I.push(["status",m.Equal,"new"]);var k=[];k.push(["status",m.Equal,"new"]),a&&(I.push(["category",m.Equal,a]),k.push(["category",m.Equal,a]));var _=[];_.push(["status",G]);var w=d.select(c.Events,I);if(!w||0==w.length)return A.i("Event queue: No events to send"),void C.updateSessionStore();if(w.length>C.MaxEventCount){if(!(w=d.select(c.Events,I,!0,C.MaxEventCount)))return;var R=w[w.length-1].client_ts;if(I.push(["client_ts",m.LessOrEqual,R]),!(w=d.select(c.Events,I)))return;k.push(["client_ts",m.LessOrEqual,R])}if(A.i("Event queue: Sending "+w.length+" events."),!d.update(c.Events,_,k))return;for(var P=[],D=0;D<w.length;++D){var O=w[D],U=JSON.parse(h.decode64(O.event));if(0!=U.length){var F=U.client_ts;F&&!T.validateClientTs(F)&&delete U.client_ts,P.push(U)}}b.instance.sendEventsInArray(P,G,C.processEventsCallback)}catch(a){A.e("Error during ProcessEvents(): "+a.stack),b.instance.sendSdkErrorEvent(o.EGASdkErrorCategory.Json,o.EGASdkErrorArea.ProcessEvents,o.EGASdkErrorAction.JsonError,o.EGASdkErrorParameter.Undefined,a.stack,p.getGameKey(),p.getGameSecret())}},C.processEventsCallback=function(a,o,p,h){var b=[];if(b.push(["status",m.Equal,p]),a===S.Ok)d.delete(c.Events,b),A.i("Event queue: "+h+" events sent.");else if(a===S.NoResponse){var T=[];T.push(["status","new"]),A.w("Event queue: Failed to send events to collector - Retrying next time"),d.update(c.Events,T,b)}else{if(o){var G,I=0;for(var k in o)0==I&&(G=o[k]),++I;a===S.BadRequest&&G.constructor===Array?A.w("Event queue: "+h+" events sent. "+I+" events failed GA server validation."):A.w("Event queue: Failed to send events.")}else A.w("Event queue: Failed to send events.");d.delete(c.Events,b)}},C.cleanupEvents=function(){d.update(c.Events,[["status","new"]])},C.fixMissingSessionEndEvents=function(){if(p.isEventSubmissionEnabled()){var a=[];a.push(["session_id",m.NotEqual,p.getSessionId()]);var o=d.select(c.Sessions,a);if(o&&0!=o.length){A.i(o.length+" session(s) located with missing session_end event.");for(var S=0;S<o.length;++S){var b=JSON.parse(h.decode64(o[S].event)),T=b.client_ts-o[S].timestamp;T=Math.max(0,T),b.category=C.CategorySessionEnd,b.length=T,C.addEventToStore(b)}}}},C.addEventToStore=function(a){if(p.isEventSubmissionEnabled())if(p.isInitialized())try{if(d.isStoreTooLargeForEvents()&&!h.stringMatch(a.category,/^(user|session_end|business)$/))return A.w("Database too large. Event has been blocked."),void b.instance.sendSdkErrorEvent(o.EGASdkErrorCategory.Database,o.EGASdkErrorArea.AddEventsToStore,o.EGASdkErrorAction.DatabaseTooLarge,o.EGASdkErrorParameter.Undefined,"",p.getGameKey(),p.getGameSecret());var S=p.getEventAnnotations();for(var T in a)S[T]=a[T];var G=JSON.stringify(S);A.ii("Event added to queue: "+G);var I={status:"new"};I.category=S.category,I.session_id=S.session_id,I.client_ts=S.client_ts,I.event=h.encode64(JSON.stringify(S)),d.insert(c.Events,I),a.category==C.CategorySessionEnd?d.delete(c.Sessions,[["session_id",m.Equal,S.session_id]]):C.updateSessionStore(),d.isStorageAvailable()&&d.save(p.getGameKey())}catch(T){A.e("addEventToStore: error"),A.e(T.stack),b.instance.sendSdkErrorEvent(o.EGASdkErrorCategory.Database,o.EGASdkErrorArea.AddEventsToStore,o.EGASdkErrorAction.DatabaseTooLarge,o.EGASdkErrorParameter.Undefined,T.stack,p.getGameKey(),p.getGameSecret())}else A.w("Could not add event: SDK is not initialized")},C.updateSessionStore=function(){if(p.sessionIsStarted()){var a={};a.session_id=p.instance.sessionId,a.timestamp=p.getSessionStart();var o=p.getEventAnnotations();C.addDimensionsToEvent(o);var m=p.instance.currentGlobalCustomEventFields;C.addCustomFieldsToEvent(o,p.validateAndCleanCustomFields(m,C.customEventFieldsErrorCallback)),a.event=h.encode64(JSON.stringify(o)),d.insert(c.Sessions,a,!0,"session_id"),d.isStorageAvailable()&&d.save(p.getGameKey())}},C.addDimensionsToEvent=function(a){a&&(p.getCurrentCustomDimension01()&&(a.custom_01=p.getCurrentCustomDimension01()),p.getCurrentCustomDimension02()&&(a.custom_02=p.getCurrentCustomDimension02()),p.getCurrentCustomDimension03()&&(a.custom_03=p.getCurrentCustomDimension03()))},C.addCustomFieldsToEvent=function(a,o){a&&o&&0<Object.keys(o).length&&(a.custom_fields=o)},C.resourceFlowTypeToString=function(o){return o==a.EGAResourceFlowType.Source||o==a.EGAResourceFlowType[a.EGAResourceFlowType.Source]?"Source":o==a.EGAResourceFlowType.Sink||o==a.EGAResourceFlowType[a.EGAResourceFlowType.Sink]?"Sink":""},C.progressionStatusToString=function(o){return o==a.EGAProgressionStatus.Start||o==a.EGAProgressionStatus[a.EGAProgressionStatus.Start]?"Start":o==a.EGAProgressionStatus.Complete||o==a.EGAProgressionStatus[a.EGAProgressionStatus.Complete]?"Complete":o==a.EGAProgressionStatus.Fail||o==a.EGAProgressionStatus[a.EGAProgressionStatus.Fail]?"Fail":""},C.errorSeverityToString=function(o){return o==a.EGAErrorSeverity.Debug||o==a.EGAErrorSeverity[a.EGAErrorSeverity.Debug]?"debug":o==a.EGAErrorSeverity.Info||o==a.EGAErrorSeverity[a.EGAErrorSeverity.Info]?"info":o==a.EGAErrorSeverity.Warning||o==a.EGAErrorSeverity[a.EGAErrorSeverity.Warning]?"warning":o==a.EGAErrorSeverity.Error||o==a.EGAErrorSeverity[a.EGAErrorSeverity.Error]?"error":o==a.EGAErrorSeverity.Critical||o==a.EGAErrorSeverity[a.EGAErrorSeverity.Critical]?"critical":""},C.adActionToString=function(o){return o==a.EGAAdAction.Clicked||o==a.EGAAdAction[a.EGAAdAction.Clicked]?"clicked":o==a.EGAAdAction.Show||o==a.EGAAdAction[a.EGAAdAction.Show]?"show":o==a.EGAAdAction.FailedShow||o==a.EGAAdAction[a.EGAAdAction.FailedShow]?"failed_show":o==a.EGAAdAction.RewardReceived||o==a.EGAAdAction[a.EGAAdAction.RewardReceived]?"reward_received":""},C.adErrorToString=function(o){return o==a.EGAAdError.Unknown||o==a.EGAAdError[a.EGAAdError.Unknown]?"unknown":o==a.EGAAdError.Offline||o==a.EGAAdError[a.EGAAdError.Offline]?"offline":o==a.EGAAdError.NoFill||o==a.EGAAdError[a.EGAAdError.NoFill]?"no_fill":o==a.EGAAdError.InternalError||o==a.EGAAdError[a.EGAAdError.InternalError]?"internal_error":o==a.EGAAdError.InvalidRequest||o==a.EGAAdError[a.EGAAdError.InvalidRequest]?"invalid_request":o==a.EGAAdError.UnableToPrecache||o==a.EGAAdError[a.EGAAdError.UnableToPrecache]?"unable_to_precache":""},C.adTypeToString=function(o){return o==a.EGAAdType.Video||o==a.EGAAdType[a.EGAAdType.Video]?"video":o==a.EGAAdType.RewardedVideo||o==a.EGAAdError[a.EGAAdType.RewardedVideo]?"rewarded_video":o==a.EGAAdType.Playable||o==a.EGAAdError[a.EGAAdType.Playable]?"playable":o==a.EGAAdType.Interstitial||o==a.EGAAdError[a.EGAAdType.Interstitial]?"interstitial":o==a.EGAAdType.OfferWall||o==a.EGAAdError[a.EGAAdType.OfferWall]?"offer_wall":o==a.EGAAdType.Banner||o==a.EGAAdError[a.EGAAdType.Banner]?"banner":""},C.CategorySessionStart="user",C.CategorySessionEnd="session_end",C.CategoryDesign="design",C.CategoryBusiness="business",C.CategoryProgression="progression",C.CategoryResource="resource",C.CategoryError="error",C.CategoryAds="ads",C.MaxEventCount=500,C.MAX_ERROR_COUNT=10,C.countMap={},C.timestampMap={},G=C,o.GAEvents=G}(d=d||{}),function(a){var o,d,c,m,p;function s(){this.blocks=new o.PriorityQueue({compare:function(a,o){return a-o}}),this.id2TimedBlockMap={},s.startThread()}o=a.threading||(a.threading={}),d=a.logging.GALogger,c=a.state.GAState,m=a.events.GAEvents,s.createTimedBlock=function(a){void 0===a&&(a=0);var d=new Date;return d.setUTCSeconds(d.getUTCSeconds()+a),new o.TimedBlock(d)},s.performTaskOnGAThread=function(a,d){void 0===d&&(d=0);var c=new Date;c.setUTCSeconds(c.getUTCSeconds()+d);var m=new o.TimedBlock(c);m.block=a,s.instance.id2TimedBlockMap[m.id]=m,s.instance.addTimedBlock(m)},s.performTimedBlockOnGAThread=function(a){s.instance.id2TimedBlockMap[a.id]=a,s.instance.addTimedBlock(a)},s.scheduleTimer=function(a,d){var c=new Date;c.setUTCSeconds(c.getUTCSeconds()+a);var m=new o.TimedBlock(c);return m.block=d,s.instance.id2TimedBlockMap[m.id]=m,s.instance.addTimedBlock(m),m.id},s.getTimedBlockById=function(a){return a in s.instance.id2TimedBlockMap?s.instance.id2TimedBlockMap[a]:null},s.ensureEventQueueIsRunning=function(){s.instance.keepRunning=!0,s.instance.isRunning||(s.instance.isRunning=!0,s.scheduleTimer(s.ProcessEventsIntervalInSeconds,s.processEventQueue))},s.endSessionAndStopQueue=function(){c.isInitialized()&&(d.i("Ending session."),s.stopEventQueue(),c.isEnabled()&&c.sessionIsStarted()&&(m.addSessionEndEvent(),c.instance.sessionStart=0))},s.stopEventQueue=function(){s.instance.keepRunning=!1},s.ignoreTimer=function(a){a in s.instance.id2TimedBlockMap&&(s.instance.id2TimedBlockMap[a].ignore=!0)},s.setEventProcessInterval=function(a){0<a&&(s.ProcessEventsIntervalInSeconds=a)},s.prototype.addTimedBlock=function(a){this.blocks.enqueue(a.deadline.getTime(),a)},s.run=function(){clearTimeout(s.runTimeoutId);try{for(var a;a=s.getNextBlock();)if(!a.ignore)if(a.async){if(!a.running){a.running=!0,a.block();break}}else a.block();return void(s.runTimeoutId=setTimeout(s.run,s.ThreadWaitTimeInMs))}catch(a){d.e("Error on GA thread"),d.e(a.stack)}},s.startThread=function(){s.runTimeoutId=setTimeout(s.run,0)},s.getNextBlock=function(){var a=new Date;return s.instance.blocks.hasItems()&&s.instance.blocks.peek().deadline.getTime()<=a.getTime()?s.instance.blocks.peek().async&&s.instance.blocks.peek().running?s.instance.blocks.peek():s.instance.blocks.dequeue():null},s.processEventQueue=function(){m.processEvents("",!0),s.instance.keepRunning?s.scheduleTimer(s.ProcessEventsIntervalInSeconds,s.processEventQueue):s.instance.isRunning=!1},s.instance=new s,s.ThreadWaitTimeInMs=1e3,s.ProcessEventsIntervalInSeconds=8,p=s,o.GAThreading=p}(d=d||{}),function(a){var o=a.threading.GAThreading,d=a.logging.GALogger,c=a.store.GAStore,m=a.state.GAState,p=a.http.GAHTTPApi,A=a.device.GADevice,h=a.validators.GAValidator,S=a.http.EGAHTTPApiResponse,b=a.utilities.GAUtilities,T=a.events.GAEvents,G=(E.getGlobalObject=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0},E.init=function(){if(A.touch(),E.methodMap.configureAvailableCustomDimensions01=E.configureAvailableCustomDimensions01,E.methodMap.configureAvailableCustomDimensions02=E.configureAvailableCustomDimensions02,E.methodMap.configureAvailableCustomDimensions03=E.configureAvailableCustomDimensions03,E.methodMap.configureAvailableResourceCurrencies=E.configureAvailableResourceCurrencies,E.methodMap.configureAvailableResourceItemTypes=E.configureAvailableResourceItemTypes,E.methodMap.configureBuild=E.configureBuild,E.methodMap.configureSdkGameEngineVersion=E.configureSdkGameEngineVersion,E.methodMap.configureGameEngineVersion=E.configureGameEngineVersion,E.methodMap.configureUserId=E.configureUserId,E.methodMap.initialize=E.initialize,E.methodMap.addBusinessEvent=E.addBusinessEvent,E.methodMap.addResourceEvent=E.addResourceEvent,E.methodMap.addProgressionEvent=E.addProgressionEvent,E.methodMap.addDesignEvent=E.addDesignEvent,E.methodMap.addErrorEvent=E.addErrorEvent,E.methodMap.addAdEvent=E.addAdEvent,E.methodMap.setEnabledInfoLog=E.setEnabledInfoLog,E.methodMap.setEnabledVerboseLog=E.setEnabledVerboseLog,E.methodMap.setEnabledManualSessionHandling=E.setEnabledManualSessionHandling,E.methodMap.setEnabledEventSubmission=E.setEnabledEventSubmission,E.methodMap.setCustomDimension01=E.setCustomDimension01,E.methodMap.setCustomDimension02=E.setCustomDimension02,E.methodMap.setCustomDimension03=E.setCustomDimension03,E.methodMap.setGlobalCustomEventFields=E.setGlobalCustomEventFields,E.methodMap.setEventProcessInterval=E.setEventProcessInterval,E.methodMap.startSession=E.startSession,E.methodMap.endSession=E.endSession,E.methodMap.onStop=E.onStop,E.methodMap.onResume=E.onResume,E.methodMap.addRemoteConfigsListener=E.addRemoteConfigsListener,E.methodMap.removeRemoteConfigsListener=E.removeRemoteConfigsListener,E.methodMap.getRemoteConfigsValueAsString=E.getRemoteConfigsValueAsString,E.methodMap.isRemoteConfigsReady=E.isRemoteConfigsReady,E.methodMap.getRemoteConfigsContentAsString=E.getRemoteConfigsContentAsString,E.methodMap.addOnBeforeUnloadListener=E.addOnBeforeUnloadListener,E.methodMap.removeOnBeforeUnloadListener=E.removeOnBeforeUnloadListener,void 0!==E.getGlobalObject()&&void 0!==E.getGlobalObject().GameAnalytics&&void 0!==E.getGlobalObject().GameAnalytics.q){var a=E.getGlobalObject().GameAnalytics.q;for(var d in a)E.gaCommand.apply(null,a[d])}window.addEventListener("beforeunload",(function(a){console.log("addEventListener unload"),m.instance.isUnloading=!0,m.notifyBeforeUnloadListeners(),o.endSessionAndStopQueue(),m.instance.isUnloading=!1}))},E.gaCommand=function(){for(var o=[],d=0;d<arguments.length;d++)o[d]=arguments[d];0<o.length&&o[0]in a.GameAnalytics.methodMap&&(1<o.length?a.GameAnalytics.methodMap[o[0]].apply(null,Array.prototype.slice.call(o,1)):a.GameAnalytics.methodMap[o[0]]())},E.configureAvailableCustomDimensions01=function(a){void 0===a&&(a=[]),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Available custom dimensions must be set before SDK is initialized"):m.setAvailableCustomDimensions01(a)}))},E.configureAvailableCustomDimensions02=function(a){void 0===a&&(a=[]),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Available custom dimensions must be set before SDK is initialized"):m.setAvailableCustomDimensions02(a)}))},E.configureAvailableCustomDimensions03=function(a){void 0===a&&(a=[]),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Available custom dimensions must be set before SDK is initialized"):m.setAvailableCustomDimensions03(a)}))},E.configureAvailableResourceCurrencies=function(a){void 0===a&&(a=[]),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Available resource currencies must be set before SDK is initialized"):m.setAvailableResourceCurrencies(a)}))},E.configureAvailableResourceItemTypes=function(a){void 0===a&&(a=[]),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Available resource item types must be set before SDK is initialized"):m.setAvailableResourceItemTypes(a)}))},E.configureBuild=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("Build version must be set before SDK is initialized."):h.validateBuild(a)?m.setBuild(a):d.i("Validation fail - configure build: Cannot be null, empty or above 32 length. String: "+a)}))},E.configureSdkGameEngineVersion=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)||(h.validateSdkWrapperVersion(a)?A.sdkGameEngineVersion=a:d.i("Validation fail - configure sdk version: Sdk version not supported. String: "+a))}))},E.configureGameEngineVersion=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)||(h.validateEngineVersion(a)?A.gameEngineVersion=a:d.i("Validation fail - configure game engine version: Game engine version not supported. String: "+a))}))},E.configureUserId=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){E.isSdkReady(!0,!1)?d.w("A custom user id must be set before SDK is initialized."):h.validateUserId(a)?m.setUserId(a):d.i("Validation fail - configure user_id: Cannot be null, empty or above 64 length. Will use default user_id method. Used string: "+a)}))},E.initialize=function(a,c){void 0===a&&(a=""),void 0===c&&(c=""),A.updateConnectionType();var p=o.createTimedBlock();p.async=!0,E.initTimedBlockId=p.id,p.block=function(){E.isSdkReady(!0,!1)?d.w("SDK already initialized. Can only be called once."):h.validateKeys(a,c)?(m.setKeys(a,c),E.internalInitialize()):d.w("SDK failed initialize. Game key or secret key is invalid. Can only contain characters A-z 0-9, gameKey is 32 length, gameSecret is 40 length. Failed keys - gameKey: "+a+", secretKey: "+c)},o.performTimedBlockOnGAThread(p)},E.addBusinessEvent=function(a,d,c,p,h,S,b){if(void 0===a&&(a=""),void 0===d&&(d=0),void 0===c&&(c=""),void 0===p&&(p=""),void 0===h&&(h=""),void 0===S&&(S={}),void 0===b&&(b=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add business event"))return;T.addBusinessEvent(a,d,c,p,h,S,b)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add business event")&&T.addBusinessEvent(a,d,c,p,h,S,b)}))},E.addResourceEvent=function(d,c,p,h,S,b,G){if(void 0===d&&(d=a.EGAResourceFlowType.Undefined),void 0===c&&(c=""),void 0===p&&(p=0),void 0===h&&(h=""),void 0===S&&(S=""),void 0===b&&(b={}),void 0===G&&(G=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add resource event"))return;T.addResourceEvent(d,c,p,h,S,b,G)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add resource event")&&T.addResourceEvent(d,c,p,h,S,b,G)}))},E.addProgressionEvent=function(d,c,p,h,S,b,G){if(void 0===d&&(d=a.EGAProgressionStatus.Undefined),void 0===c&&(c=""),void 0===p&&(p=""),void 0===h&&(h=""),void 0===b&&(b={}),void 0===G&&(G=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add progression event"))return;var I="number"==typeof S;T.addProgressionEvent(d,c,p,h,I?S:0,I,b,G)}else o.performTaskOnGAThread((function(){if(E.isSdkReady(!0,!0,"Could not add progression event")){var a="number"==typeof S;T.addProgressionEvent(d,c,p,h,a?S:0,a,b,G)}}))},E.addDesignEvent=function(a,d,c,p){if(void 0===c&&(c={}),void 0===p&&(p=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add design event"))return;var h="number"==typeof d;T.addDesignEvent(a,h?d:0,h,c,p)}else o.performTaskOnGAThread((function(){if(E.isSdkReady(!0,!0,"Could not add design event")){var o="number"==typeof d;T.addDesignEvent(a,o?d:0,o,c,p)}}))},E.addErrorEvent=function(d,c,p,h){if(void 0===d&&(d=a.EGAErrorSeverity.Undefined),void 0===c&&(c=""),void 0===p&&(p={}),void 0===h&&(h=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add error event"))return;T.addErrorEvent(d,c,p,h)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add error event")&&T.addErrorEvent(d,c,p,h)}))},E.addAdEventWithNoAdReason=function(d,c,p,h,S,b,G){if(void 0===d&&(d=a.EGAAdAction.Undefined),void 0===c&&(c=a.EGAAdType.Undefined),void 0===p&&(p=""),void 0===h&&(h=""),void 0===S&&(S=a.EGAAdError.Undefined),void 0===b&&(b={}),void 0===G&&(G=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add ad event"))return;T.addAdEvent(d,c,p,h,S,0,!1,b,G)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add ad event")&&T.addAdEvent(d,c,p,h,S,0,!1,b,G)}))},E.addAdEventWithDuration=function(d,c,p,h,S,b,G){if(void 0===d&&(d=a.EGAAdAction.Undefined),void 0===c&&(c=a.EGAAdType.Undefined),void 0===p&&(p=""),void 0===h&&(h=""),void 0===S&&(S=0),void 0===b&&(b={}),void 0===G&&(G=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add ad event"))return;T.addAdEvent(d,c,p,h,a.EGAAdError.Undefined,S,!0,b,G)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add ad event")&&T.addAdEvent(d,c,p,h,a.EGAAdError.Undefined,S,!0,b,G)}))},E.addAdEvent=function(d,c,p,h,S,b){if(void 0===d&&(d=a.EGAAdAction.Undefined),void 0===c&&(c=a.EGAAdType.Undefined),void 0===p&&(p=""),void 0===h&&(h=""),void 0===S&&(S={}),void 0===b&&(b=!1),A.updateConnectionType(),m.instance.isUnloading){if(!E.isSdkReady(!0,!0,"Could not add ad event"))return;T.addAdEvent(d,c,p,h,a.EGAAdError.Undefined,0,!1,S,b)}else o.performTaskOnGAThread((function(){E.isSdkReady(!0,!0,"Could not add ad event")&&T.addAdEvent(d,c,p,h,a.EGAAdError.Undefined,0,!1,S,b)}))},E.setEnabledInfoLog=function(a){void 0===a&&(a=!1),o.performTaskOnGAThread((function(){a?(d.setInfoLog(a),d.i("Info logging enabled")):(d.i("Info logging disabled"),d.setInfoLog(a))}))},E.setEnabledVerboseLog=function(a){void 0===a&&(a=!1),o.performTaskOnGAThread((function(){a?(d.setVerboseLog(a),d.i("Verbose logging enabled")):(d.i("Verbose logging disabled"),d.setVerboseLog(a))}))},E.setEnabledManualSessionHandling=function(a){void 0===a&&(a=!1),o.performTaskOnGAThread((function(){m.setManualSessionHandling(a)}))},E.setEnabledEventSubmission=function(a){void 0===a&&(a=!1),o.performTaskOnGAThread((function(){a?(m.setEnabledEventSubmission(a),d.i("Event submission enabled")):(d.i("Event submission disabled"),m.setEnabledEventSubmission(a))}))},E.setCustomDimension01=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){h.validateDimension01(a,m.getAvailableCustomDimensions01())?m.setCustomDimension01(a):d.w("Could not set custom01 dimension value to '"+a+"'. Value not found in available custom01 dimension values")}))},E.setCustomDimension02=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){h.validateDimension02(a,m.getAvailableCustomDimensions02())?m.setCustomDimension02(a):d.w("Could not set custom02 dimension value to '"+a+"'. Value not found in available custom02 dimension values")}))},E.setCustomDimension03=function(a){void 0===a&&(a=""),o.performTaskOnGAThread((function(){h.validateDimension03(a,m.getAvailableCustomDimensions03())?m.setCustomDimension03(a):d.w("Could not set custom03 dimension value to '"+a+"'. Value not found in available custom03 dimension values")}))},E.setGlobalCustomEventFields=function(a){void 0===a&&(a={}),o.performTaskOnGAThread((function(){d.i("Set global custom event fields: "+JSON.stringify(a)),m.instance.currentGlobalCustomEventFields=a}))},E.setEventProcessInterval=function(a){o.performTaskOnGAThread((function(){o.setEventProcessInterval(a)}))},E.startSession=function(){if(m.isInitialized()){var a=o.createTimedBlock();a.async=!0,E.initTimedBlockId=a.id,a.block=function(){m.isEnabled()&&m.sessionIsStarted()&&o.endSessionAndStopQueue(),E.resumeSessionAndStartQueue()},o.performTimedBlockOnGAThread(a)}},E.endSession=function(){E.onStop()},E.onStop=function(){o.performTaskOnGAThread((function(){try{o.endSessionAndStopQueue()}catch(a){}}))},E.onResume=function(){var a=o.createTimedBlock();a.async=!0,E.initTimedBlockId=a.id,a.block=function(){E.resumeSessionAndStartQueue()},o.performTimedBlockOnGAThread(a)},E.getRemoteConfigsValueAsString=function(a,o){return void 0===o&&(o=null),m.getConfigurationStringValue(a,o)},E.isRemoteConfigsReady=function(){return m.isRemoteConfigsReady()},E.addRemoteConfigsListener=function(a){m.addRemoteConfigsListener(a)},E.removeRemoteConfigsListener=function(a){m.removeRemoteConfigsListener(a)},E.getRemoteConfigsContentAsString=function(){return m.getRemoteConfigsContentAsString()},E.getABTestingId=function(){return m.getABTestingId()},E.getABTestingVariantId=function(){return m.getABTestingVariantId()},E.addOnBeforeUnloadListener=function(a){m.addOnBeforeUnloadListener(a)},E.removeOnBeforeUnloadListener=function(a){m.removeOnBeforeUnloadListener(a)},E.internalInitialize=function(){m.ensurePersistedStates(),c.setItem(m.getGameKey(),m.DefaultUserIdKey,m.getDefaultId()),m.setInitialized(!0),E.newSession(),m.isEnabled()&&o.ensureEventQueueIsRunning()},E.newSession=function(){d.i("Starting a new session."),m.validateAndFixCurrentDimensions(),p.instance.requestInit(m.instance.configsHash,E.startNewSessionCallback)},E.startNewSessionCallback=function(a,p){if(a!==S.Ok&&a!==S.Created||!p)a==S.Unauthorized?(d.w("Initialize SDK failed - Unauthorized"),m.instance.initAuthorized=!1):(a===S.NoResponse||a===S.RequestTimeout?d.i("Init call (session start) failed - no response. Could be offline or timeout."):a===S.BadResponse||a===S.JsonEncodeFailed||a===S.JsonDecodeFailed?d.i("Init call (session start) failed - bad response. Could be bad response from proxy or GA servers."):a!==S.BadRequest&&a!==S.UnknownResponseCode||d.i("Init call (session start) failed - bad request or unknown response."),null==m.instance.sdkConfig?null!=m.instance.sdkConfigCached?(d.i("Init call (session start) failed - using cached init values."),m.instance.sdkConfig=m.instance.sdkConfigCached):(d.i("Init call (session start) failed - using default init values."),m.instance.sdkConfig=m.instance.sdkConfigDefault):d.i("Init call (session start) failed - using cached init values."),m.instance.initAuthorized=!0);else{var A=0;if(p.server_ts){var h=p.server_ts;A=m.calculateServerTimeOffset(h)}if(p.time_offset=A,a!=S.Created){var G=m.getSdkConfig();G.configs&&(p.configs=G.configs),G.configs_hash&&(p.configs_hash=G.configs_hash),G.ab_id&&(p.ab_id=G.ab_id),G.ab_variant_id&&(p.ab_variant_id=G.ab_variant_id)}m.instance.configsHash=p.configs_hash?p.configs_hash:"",m.instance.abId=p.ab_id?p.ab_id:"",m.instance.abVariantId=p.ab_variant_id?p.ab_variant_id:"",c.setItem(m.getGameKey(),m.SdkConfigCachedKey,b.encode64(JSON.stringify(p))),m.instance.sdkConfigCached=p,m.instance.sdkConfig=p,m.instance.initAuthorized=!0}if(m.instance.clientServerTimeOffset=m.getSdkConfig().time_offset?m.getSdkConfig().time_offset:0,m.populateConfigurations(m.getSdkConfig()),!m.isEnabled())return d.w("Could not start session: SDK is disabled."),void o.stopEventQueue();o.ensureEventQueueIsRunning();var I=b.createGuid();m.instance.sessionId=I,m.instance.sessionStart=m.getClientTsAdjusted(),T.addSessionStartEvent();var k=o.getTimedBlockById(E.initTimedBlockId);null!=k&&(k.running=!1),E.initTimedBlockId=-1},E.resumeSessionAndStartQueue=function(){m.isInitialized()&&(d.i("Resuming session."),m.sessionIsStarted()||E.newSession())},E.isSdkReady=function(a,o,c){return void 0===o&&(o=!0),void 0===c&&(c=""),c&&(c+=": "),a&&!m.isInitialized()?(o&&d.w(c+"SDK is not initialized"),!1):a&&!m.isEnabled()?(o&&d.w(c+"SDK is disabled"),!1):!(a&&!m.sessionIsStarted()&&(o&&d.w(c+"Session has not started yet"),1))},E.initTimedBlockId=-1,E.methodMap={},E);function E(){}a.GameAnalytics=G}(d=d||{}),d.GameAnalytics.init();var _=d.GameAnalytics.gaCommand;a.gameanalytics=d,a.GameAnalytics=_}(this);var GameAnalytics=pc.createScript("gameAnalytics");GameAnalytics.isInitialized=!1,GameAnalytics.prototype.initialize=function(){try{gameanalytics.GameAnalytics.configureBuild("1.0.0"),gameanalytics.GameAnalytics.initialize("2f8a361dceaef44740eeba9414963c1e","fb52d76017813be5c582e1a8cb77828956e643a2"),GameAnalytics.isInitialized=!0,console.log("GameAnalytics initialized successfully.")}catch(e){GameAnalytics.isInitialized=!1,console.error("Failed to initialize GameAnalytics:",e)}this.cooldown=1500,this.lastEventTime=0,this.lastEventData=null,this.currentPlayerLevel=0,this.startEventReceived=!1,this.currentProgression={progression01:null,progression02:null,progression03:null,status:null},this.canFireEvents=!0,this.app.on("gameAnalytics:progression",this.handleProgressionEvent,this),this.app.on("gameAnalytics:design",this.handleDesignEvent,this),this.app.on("gameAnalytics:resetProgression",this.resetProgression,this),this.app.on("gameAnalytics:enableEvents",(()=>{this.canFireEvents=!0,console.log("GameAnalytics: Event firing enabled.")})),this.app.on("gameAnalytics:disableEvents",(()=>{this.canFireEvents=!1,console.log("GameAnalytics: Event firing disabled.")}));window.location.href.includes("playcanvas.com")&&this.app.fire("gameAnalytics:disableEvents")},GameAnalytics.prototype.handleProgressionEvent=function(e){if(console.log("progression event attempted",e),console.log("current player level",this.currentPlayerLevel),!GameAnalytics.isInitialized)return void console.warn("GameAnalytics not initialized. Progression event skipped.");if(!this.canFireEvents)return void console.log("GameAnalytics: Progression event skipped (not initialized or disabled).");const{status:t,progression01:s,progression02:n,progression03:r}=e,i=n&&n.match(/^Level_(\d+)$/),a=i?parseInt(i[1],10):null;if(null===a)return void console.warn("Invalid level name in progression02. Event skipped.");const o=t.toLowerCase();if("start"===o&&a<=this.currentPlayerLevel&&this.startEventReceived)return void console.log(`Skipping "start" event for already started level: ${n}.`);if("complete"===o&&a<this.currentPlayerLevel)return void console.log(`Skipping "complete" event for already completed level: ${n}.`);if("complete"===o&&!this.startEventReceived)return void console.log('Skipping "complete" event as no level has been started');if(0!==this.currentPlayerLevel){if("start"===o&&a>this.currentPlayerLevel+1||"complete"===o&&a>this.currentPlayerLevel){let e=`Level_${this.currentPlayerLevel}`;try{gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Complete,s,e,r),console.log(`Progression event fired - Autocompleting current level: Complete, ${s}, ${e}, ${r}`)}catch(e){console.error("Error tracking auto 'start' for skipped level:",e)}for(let e=this.currentPlayerLevel+1;e<a;e++){const n=`Level_${e}`;console.log(`Auto-starting skipped level: ${n}`);try{gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Start,s,n,r),console.log(`Progression event fired: ${t}, ${s}, ${n}, ${r}`)}catch(e){console.error("Error tracking auto 'start' for skipped level:",e)}console.log(`Auto-completing skipped level: ${n}`);try{gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Complete,s,n,r),console.log(`Progression event fired: Complete, ${s}, ${n}, ${r}`)}catch(e){console.error("Error tracking auto 'complete' for skipped level:",e)}}try{gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Start,s,`Level_${a}`,r),console.log(`Progression event fired - Autostarting current level: Start, ${s}, Level_${a}, ${r}`)}catch(e){console.error("Error tracking auto 'start' for skipped level:",e)}}console.log("COMPLETED AUTOCOMPLETE ROUND")}const l=Date.now();if(this.lastEventData&&this.lastEventData.status===t&&this.lastEventData.progression01===s&&this.lastEventData.progression02===n&&this.lastEventData.progression03===r&&l-this.lastEventTime<this.cooldown)return void console.log(`Duplicate progression event skipped: ${t}, ${n}.`);let c;switch(console.log("performing progression event",{currentPlayerLevel:this.currentPlayerLevel,newLevel:a,eventType:t}),o){case"start":c=gameanalytics.EGAProgressionStatus.Start,this.startEventReceived=!0;break;case"complete":c=gameanalytics.EGAProgressionStatus.Complete;break;case"fail":c=gameanalytics.EGAProgressionStatus.Fail;break;default:return void console.warn(`Invalid status provided: ${t}. Progression event skipped.`)}c===gameanalytics.EGAProgressionStatus.Start?this.currentPlayerLevel=a:c===gameanalytics.EGAProgressionStatus.Complete&&(this.currentPlayerLevel=a+1);try{if(gameanalytics.GameAnalytics.addProgressionEvent(c,s,n,r),console.log(`Progression event fired: ${t}, ${s}, ${n}, ${r}`),this.lastEventTime=l,this.lastEventData={status:t,progression01:s,progression02:n,progression03:r},"complete"===o){const e=n.match(/^Level_(\d+)$/);if(e){const t=parseInt(e[1],10),n=`Level_${t+1}`;try{gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Start,s,n,r),console.log(`Progression event fired (auto-start next level): Start, ${s}, ${n}, ${r}`)}catch(e){console.error("Error tracking auto-start for next level:",e)}}else console.warn("Could not parse level number from progression02 for auto-starting next level")}}catch(e){console.error("Error tracking progression event:",e)}},GameAnalytics.prototype.handleDesignEvent=function(e){if(!GameAnalytics.isInitialized)return void console.warn("GameAnalytics not initialized. Design event skipped.");if(!this.canFireEvents)return void console.log("GameAnalytics: Progression event skipped (not initialized or disabled).");const{eventId:t,value:s}=e;try{gameanalytics.GameAnalytics.addDesignEvent(t,s),console.log(`Design event fired: ${t}, value: ${s}`)}catch(e){console.error("Error tracking design event:",e)}},GameAnalytics.prototype.resetProgression=function(){this.currentProgression={progression01:null,progression02:null,progression03:null,status:null},this.currentPlayerLevel=0,this.lastEventData=null,this.startEventReceived=!1,console.log("Progression state reset.")};var SceneManager=pc.createScript("sceneManager");SceneManager.attributes.add("defaultSceneName",{type:"string",default:"Skyworld",title:"Default Scene Name"}),SceneManager.prototype.initialize=function(){this.currentSceneRoot=null,this.app.on("level:load",this.loadScene,this),this.app.sceneLoaded=!1},SceneManager.prototype.loadScene=function(e){if(this.app.fire("scene:startedLoading"),this.currentSceneRoot&&this.currentSceneRoot.name===e)return void console.log(e+" is already loaded.");this.unloadScene();const n=this.app.scenes.find(e);n?(console.log("Loading scene:",e),this.app.scenes.loadSceneHierarchy(n,((t,o)=>{t?console.error("Error loading scene hierarchy:",t):(o.enabled=!0,this.currentSceneRoot=o,console.log(e+" loaded successfully."),this.setSkyboxFromSceneSettings(n),this.app.mainPlayerInitialized||(this.app.fire("sceneManager:initFirstScene"),this.app.mainPlayerInitialized=!0),this.app.fire("sceneManager:joinScene",e),this.app.fire("scene:loaded"),this.app.sceneLoaded=!0)}))):console.error("Scene not found in registry:",e)},SceneManager.prototype.unloadScene=function(){this.currentSceneRoot?(console.log("Unloading current scene:",this.currentSceneRoot.name),this.currentSceneRoot.destroy(),this.currentSceneRoot=null,this.app.fire("scene:unload",this.currentSceneRoot)):console.log("No current scene to unload."),this.app.sceneLoaded=!1},SceneManager.prototype.setSkyboxFromSceneSettings=function(e){this.app.scenes.loadSceneSettings(e,((e,n)=>{e&&console.error("Error loading scene settings:",e)}))};var ModelWorldAnimManager=pc.createScript("modelWorldAnimManager");ModelWorldAnimManager.prototype.initialize=function(){this.animalChangerScript=this.app.root.findScript("animalChanger"),this.app.on("menuItemLoader:animationButtonInitialized",this.setHoverInteraction,this)},ModelWorldAnimManager.prototype.setHoverInteraction=function(t,e){if(t&&t.button){let e=this.animalChangerScript.getCurrentSkinName(),i=t.findByName("buttonImage");if(i){let t=i.tags.list()[0];if(t){let i=t.split("-");e=i[0]}}t.button.on("hoverstart",(()=>{let i=this.entity.findByName(this.animalChangerScript.getSkinName(this.animalChangerScript.getCurrentSkinKeyList()[this.animalChangerScript.getSkinKeyByName(e)-1]));i&&i.anim&&i.enabled&&(t.assetRef&&i.anim.assignAnimation("emote",t.assetRef.resource,null,1,!0),i.anim.setBoolean("playEmote",!0))}),this),t.button.on("hoverend",(()=>{let t=this.entity.findByName(this.animalChangerScript.getSkinName(this.animalChangerScript.getCurrentSkinKeyList()[this.animalChangerScript.getSkinKeyByName(e)-1]));t&&t.anim&&t.enabled&&(t.anim.baseLayer.transition("Idle",.2),t.anim.setBoolean("playEmote",!1))}),this),t.button.on("mousedown",(()=>{let t=this.entity.findByName(this.animalChangerScript.getSkinName(this.animalChangerScript.getCurrentSkinKeyList()[this.animalChangerScript.getSkinKeyByName(e)-1]));t&&t.anim&&t.enabled&&t.anim.setBoolean("playEmote",!1)}),this),t.button.on("click",(()=>{let t=this.entity.findByName(this.animalChangerScript.getSkinName(this.animalChangerScript.getCurrentSkinKeyList()[this.animalChangerScript.getSkinKeyByName(e)-1]));t&&t.anim&&t.enabled&&t.anim.setBoolean("playEmote",!1)}),this)}};var MenuItemLoader=pc.createScript("menuItemLoader");MenuItemLoader.attributes.add("menuName",{type:"string",default:"",title:"Menu Name"});var contentSchema=[{name:"buttonAsset",type:"asset",title:"button asset"},{name:"isButtonAssetTemplate",type:"boolean",default:!0,title:"template status of button asset"},{name:"effectAsset",type:"asset",default:0,title:"effect asset"},{name:"isEffectAssetTemplate",type:"boolean",default:!1,title:"template status of effect asset"},{name:"adsRequired",type:"number",default:0,title:"number of ads"},{name:"tint",type:"number",default:0,title:"tint rgb"},{name:"tintRandom",type:"boolean",default:!1,title:"random tint"}],dataSchema=[{name:"itemClass",type:"number",default:0,title:"item class equivalent to contentScheme index"},{name:"buttonName",type:"string",title:"unique item button name"},{name:"assetName",type:"string",title:"asset name"},{name:"assetType",type:"string",default:"texture",title:"asset type"},{name:"assetSrc",type:"asset",default:0,title:"source asset",description:"source asset if using asset directly"}];MenuItemLoader.attributes.add("contentScheme",{type:"json",schema:contentSchema,array:!0,title:"Content division scheme"}),MenuItemLoader.attributes.add("contentData",{type:"json",schema:dataSchema,array:!0,title:"Data scheme"}),MenuItemLoader.prototype.initialize=function(){this.assetLoadList={},this.loadTriggered=!1,this.animalChangerScript=this.app.root.findScript("animalChanger"),this.currentAnimal,this.animalChangerScript&&(this.currentAnimal=this.animalChangerScript.getSkinName(this.animalChangerScript.currentlyPressed)),this.defaultAsset=this.app.assets.find("Title_Line03_Divider.png","texture"),this.defaultAsset.loaded||(this.defaultAsset.ready((e=>{console.log("menuLoader default asset loaded")})),this.app.assets.load(this.defaultAsset,{force:!0})),this.animItemCounter=0,this.maxAnimCounter=5,this.app.on("toMenuLoader:loadMenuItems",(e=>{e===`${this.menuName}`&&(this.loadTriggered||this.loadMenu())}),this)},MenuItemLoader.prototype.loadMenu=function(e){e?this.loadItems(e):this.loadItems(this.contentData)},MenuItemLoader.prototype.loadItems=function(e){if(e)for(i=0;i<e.length;i++)if(e[i].assetName&&e[i].assetType){let t=this.app.assets.find(`${e[i].assetName}`,`${e[i].assetType}`);e[i].itemClass;t?t.loaded?this.loadItem(t,e[i]):(t.ready((e=>{if(this.assetLoadList[e.name]){let t=this.assetLoadList[e.name];this.loadItem(e,t),this.assetLoadList[e.name]=null}else console.log("asset load error. asset metadata not found")}),this),t.on("error",((e,t)=>{console.error(`Error loading asset ${t.name}: ${e}`)}),this),this.assetLoadList[e[i].assetName]=e[i],this.app.assets.load(t,{force:!0})):console.log("loading menu item failed. asset not found.",e[i])}else if("animation"===e[i].assetType&&e[i].buttonName&&this.animalChangerScript){let t=this.animItemCounter+1;this.animItemCounter<this.maxAnimCounter?(e[i].tagToUse=`${this.animalChangerScript.getSkinName(t)}-ui`,e[i].animSlotKey=t,this.animItemCounter++):e[i].tagToUse="gecko-ui";let a=this.app.assets.findByTag(`${this.animalChangerScript.getSkinName(t)}Anim`);animAsset=a.find((t=>t.name===`${e[i].buttonName}.glb`)),animAsset?animAsset.loaded?this.loadItem(animAsset,e[i]):(animAsset.ready((e=>{if(this.assetLoadList[e.name]){let t=this.assetLoadList[e.name];this.loadItem(e,t),this.assetLoadList[e.name]=null}else console.log("asset load error. asset metadata not found")}),this),animAsset.on("error",((e,t)=>{console.error(`Error loading asset ${t.name}: ${e}`)}),this),this.assetLoadList[`${e[i].buttonName}.glb`]=e[i],this.app.assets.load(animAsset,{force:!0})):console.log("loading menu item failed. asset not found.",e[i])}else console.log("loading menu item failed. no asset name nor type, and is not anim");else console.log("load failed. invalid item content list");this.loadTriggered=!0},MenuItemLoader.prototype.loadItem=function(e,t){if(this.contentScheme[t.itemClass].isButtonAssetTemplate){let a,s=this.contentScheme[t.itemClass].buttonAsset.resource.instantiate();if(s.itemClass=t.itemClass,s.assetType=t.assetType,s.assetRef=e,t.buttonName){a=t.assetName?`${this.menuName}_${e.name}`:`${this.menuName}_${t.buttonName}`;let i=s.findByName("buttonNameText");i&&(i.element.text=t.buttonName,i.enabled=!0)}else a=`${this.menuName}_${e.name}`;if(s.identifier=a,s.reparent(this.entity),s.enabled=!0,e)if("texture"===e.type)s.findByName("buttonImage").element.texture=e.resource;else if("animation"===e.type){let e=s.findByName("buttonImage");e?(e.element.texture||(this.defaultAsset.loaded?e.element.texture=this.defaultAsset.resource:console.log("menu button item texture initialization failed. no texture and default asset not loaded")),t.tagToUse?(e.tags.add(t.tagToUse),s.animSlotKey=t.animSlotKey):e.tags.add("gecko-ui"),this.app.fire("menuItemLoader:renderUpdate",e)):console.log("no button image to add tag to.")}const i=s.script.get("touchButton");i&&(i.identifier=a,i.initializeComplete||i.initialize(),"animation"===e.type&&this.app.fire("menuItemLoader:animationButtonInitialized",s,i.identifier)),this.entity.children.sort(((e,t)=>e.itemClass-t.itemClass)),this.app.fire("menuItemLoader:itemLoaded",s)}else console.log("button initialization failed. no button template")};var EmoteManager=pc.createScript("emoteManager");EmoteManager.attributes.add("emoteImageEntity",{type:"entity",title:"Image emote entity"}),emoteMap={0:"Roll",1:"Spin",2:"Bounce",3:"Sit",4:"Eat",5:"Dog.png",6:"AxolotlAngry.png",7:"SealAnnoyed.png",8:"DuckCry.png",9:"ParrotHappy.png",10:"BunnyScared.png",11:"MonkeyHappy.png",12:"FrogHappy.png"},emoteTypeMap={0:"anim",1:"anim",2:"anim",3:"anim",4:"anim",5:"texture",6:"texture",7:"texture",8:"texture",9:"texture",10:"texture",11:"texture",12:"texture"};const emotePriceMap={0:[0,5,11],1:[1,2,3,4,6,7,8,9,10,12],2:[],3:[],4:[],5:[]},emoteMapRev=Object.entries(emoteMap).reduce(((e,[t,o])=>(e[o]=parseInt(t),e)),{});EmoteManager.prototype.getEmoteName=function(e){return emoteMap[e]?emoteMap[e]:null},EmoteManager.prototype.getEmoteType=function(e){return emoteTypeMap[e]?emoteTypeMap[e]:null},EmoteManager.prototype.init=function(){this.initialized?console.log("emote Manager already initialized"):(this.saveManager=this.app.root.findScript("saveManager"),this.networkManagerScript=this.entity.script.networkManager,this.currentEmoteId=this.saveManager.load("currentEmoteId"),this.currentEmoteId||(this.currentEmoteId=0),this.unlockedEmoteList=this.saveManager.loadArray("unlockedEmoteList"),this.unlockedEmoteList&&Array.isArray(this.unlockedEmoteList)||(this.unlockedEmoteList=emotePriceMap[0]),this.menuItemRefs=[],this.animalChangerScript=this.app.root.findScript("animalChanger"),this.app.on("menuItemLoader:itemLoaded",(e=>{let t=e.identifier.split("_");if("emoteSelectMenu"===t[0]){const o=t[1],a=emoteMapRev[o];if("number"==typeof a){if(!this.checkUnlockStatus(a)){let t=this.getEmotePrice(a);if(0===t);else if(t>0){let t=e.findByName("adNoticeIcon");t&&(t.enabled=!0)}}}else console.log("emoteManager menu item check failed. failed to parse emoteId. emoteName:",o);this.menuItemRefs.push(e)}}),this),this.app.fire("emoteManager:initialized"),this.intialized=!0)},EmoteManager.prototype.getEmotePrice=function(e){let t=null;for(i=0;i<Object.keys(emotePriceMap).length;i++)emotePriceMap[i].includes(e)&&(t=i);return t},EmoteManager.prototype.initialize=function(){this.initialized?console.log("emote Manager already initialized manually"):this.init()},EmoteManager.prototype.getCurrentEmoteId=function(){return this.currentEmoteId},EmoteManager.prototype.checkUnlockStatus=function(e){return this.unlockedEmoteList.includes(e)},EmoteManager.prototype.setEmote=function(e,t){if("number"!=typeof e)if(t){let o=emoteMapRev[t];this.saveManager.save("currentEmoteId",o),this.currentEmoteId=o,this.updateUnlockedEmoteList(e),this.updateUnlockedEmoteInMenu(e,!0)}else console.log("settingEmote failed. no name or id",t,e);else this.saveManager.save("currentEmoteId",e),this.currentEmoteId=e,this.updateUnlockedEmoteList(e),this.updateUnlockedEmoteInMenu(e,!0)},EmoteManager.prototype.checkForEmoteButtonPress=function(){for(i=0;i<Object.keys(emoteMap).length;i++)if(window.touchJoypad.buttons.wasReleased(`emoteSelectMenu_${emoteMap[i]}`))return i;return null},EmoteManager.prototype.updateUnlockedEmoteList=function(e){this.unlockedEmoteList.includes(e)||(this.unlockedEmoteList.push(e),this.saveManager.saveArray("unlockedEmoteList",this.unlockedEmoteList))},EmoteManager.prototype.updateUnlockedEmoteInMenu=function(e,t){let o=this.menuItemRefs.find((t=>t.identifier.split("_")[1]===emoteMap[e]));if(o){let e=o.findByName("adNoticeIcon");e&&(e.enabled=!t)}},EmoteManager.prototype.activateTextureEmote=function(e){e&&!1===e.enabled&&(e.enabled=!0,setTimeout(function(){e.enabled=!1}.bind(e),3e3))},EmoteManager.prototype.playEmote=function(e,t,o){if(e){let a=this.currentEmoteId;o>-1&&(a=o);let n=this.getEmoteType(a);if("anim"===n)if(this.animalChangerScript)if(e.mainRef&&e.mainRef.animRef){let o;if(t?o=this.animalChangerScript.getCurrentSkinName():e.mainRef.animalRef&&(o=e.mainRef.animalRef.name.toLowerCase()),o){let t=this.app.assets.findByTag(`${o}Anim`).find((e=>e.name===`${emoteMap[a]}.glb`));t?t.loaded?(e.mainRef.animRef.assignAnimation("emote",t.resource,null,1,!0),e.mainRef.animRef.setBoolean("playEmote",!0)):(t.ready((t=>{e.mainRef.animRef.assignAnimation("emote",t.resource,null,1,!0),e.mainRef.animRef.setBoolean("playEmote",!0)}),this),this.app.assets.load(t,{force:!0})):(console.log("emote change failed. emote asset not found. play previous emote"),e.mainRef.animRef.setBoolean("playEmote",!0))}}else console.log("no proper ref. fallback playEmote call"),e.anim.setBoolean("playEmote",!0);else this.animalChangerScript=this.app.root.findScript("animalChanger");else if("texture"===n){let t=e.findByName("emoteImgTest"),o=this.app.assets.find(`${emoteMap[a]}`,"texture");o?o.loaded?(t.element.texture=o.resource,this.activateTextureEmote(t)):(o.ready((()=>{t.element.texture=this.app.assets.find(`${emoteMap[a]}`,"texture").resource,this.activateTextureEmote(t)}),this),this.app.assets.load(o,{force:!0})):console.log("failed to play texture emote. texture emote asset not found")}t&&this.networkManagerScript.updateEmote(Number(this.currentEmoteId))}else console.log("failed to play emote. no target entity")};var TrackDirection=pc.createScript("trackDirection");TrackDirection.attributes.add("trackAxisX",{type:"boolean",default:!0,title:"Tracking axis X"}),TrackDirection.attributes.add("trackAxisY",{type:"boolean",default:!0,title:"Tracking axis Y"}),TrackDirection.attributes.add("trackAxisZ",{type:"boolean",default:!0,title:"Tracking axis Z"}),TrackDirection.attributes.add("trackingEntity",{type:"entity",title:"Entity to track"}),TrackDirection.attributes.add("trackingFrequency",{type:"number",default:0,title:"Tracking Frequency"}),TrackDirection.prototype.initialize=function(){this.trackingCounter=0,this.trackCoordX=0,this.trackCoordY=0,this.trackCoordZ=0,this.newCoord=new pc.Vec3},TrackDirection.prototype.update=function(t){this.entity.enabled&&this.trackingEntity&&(0===this.trackingFrequency?this.lookAtEntity():this.trackingCounter%this.trackingFrequency==0?(this.lookAtEntity(),this.trackingCounter++):this.trackingCounter++)},TrackDirection.prototype.lookAtEntity=function(){let t,i=this.trackingEntity.getPosition();this.trackCoordX=i.x,this.trackCoordY=i.y,this.trackCoordZ=i.z,this.trackAxisX&&this.trackAxisY&&this.trackAxisZ||(t=this.entity.getPosition()),this.trackAxisX||(this.trackCoordX=t.x),this.trackAxisY||(this.trackCoordY=t.y),this.trackAxisZ||(this.trackCoordZ=t.z),this.newCoord.set(this.trackCoordX,this.trackCoordY,this.trackCoordZ),this.entity.lookAt(this.newCoord),this.entity.rotateLocal(0,180,0)};var RebirthTracker=pc.createScript("rebirthTracker");RebirthTracker.prototype.initialize=function(){this.saveManager=this.app.root.findScript("saveManager"),this.rebirthCounterArea=this.entity.findByName("RebirthCounterArea"),this.rebirthCounterText=this.rebirthCounterArea.findByName("RebirthCounter"),this.app.on("scene:loaded",this.onSceneLoaded,this),this.app.on("rebirthTeleporter:rebirth",this.onRebirth,this),this.checkRebirthCount()},RebirthTracker.prototype.onDisable=function(){this.app.off("scene:loaded",this.onSceneLoaded,this),this.app.off("rebirthTeleporter:rebirth",this.onRebirth,this)},RebirthTracker.prototype.onSceneLoaded=function(){this.checkRebirthCount()},RebirthTracker.prototype.onRebirth=function(){setTimeout(function(){this.checkRebirthCount()}.bind(this),500)},RebirthTracker.prototype.checkRebirthCount=function(){if(!this.app.currentWorld)return console.log("NO CURRENT WORLD - DISABLING REBIRTH"),void(this.rebirthCounterArea.enabled=!1);var e=this.app.currentWorld.toLowerCase()+"RebirthCounter",t=this.saveManager.load(e);if(null!=t){var r=parseInt(t,10);console.log("REBIRTH COUNT",r),r>0?(console.log("ENABLING REBIRTH COUNTER"),this.rebirthCounterArea.enabled=!0,this.rebirthCounterText.element.text=r.toString()):this.rebirthCounterArea.enabled=!1}else console.log("NO REBIRTHS"),this.rebirthCounterArea.enabled=!1};